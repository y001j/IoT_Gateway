# Transform è¡¨å•ä¿®å¤æ€»ç»“

## ğŸ› é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
å‰ç«¯ ActionForm ç»„ä»¶ä¸­çš„ transform é…ç½®è¡¨å•ä¸åç«¯ TransformHandler å®ç°å®Œå…¨ä¸åŒ¹é…ï¼Œå¯¼è‡´ï¼š

1. **å­—æ®µä¸åŒ¹é…**: å‰ç«¯ä½¿ç”¨ `field`, `transforms[]`, `add_tags` ç­‰å­—æ®µï¼Œåç«¯ä¸æ”¯æŒ
2. **å‚æ•°ç»“æ„é”™è¯¯**: ç¼ºå°‘ `parameters` å¯¹è±¡åŒ…è£…
3. **è½¬æ¢ç±»å‹ä¸å®Œæ•´**: åªæ”¯æŒåŸºç¡€çš„å››åˆ™è¿ç®—ï¼Œç¼ºå°‘åç«¯æ”¯æŒçš„9ç§è½¬æ¢ç±»å‹
4. **é…ç½®ä¸æ ‡å‡†**: ç”Ÿæˆçš„é…ç½®æ— æ³•è¢«åç«¯æ­£ç¡®è§£æ

### åç«¯å®é™…æ”¯æŒçš„ç»“æ„
```go
type TransformConfig struct {
    Type         string                 // è½¬æ¢ç±»å‹
    Parameters   map[string]interface{} // è½¬æ¢å‚æ•°
    OutputKey    string                 // è¾“å‡ºå­—æ®µå
    OutputType   string                 // è¾“å‡ºæ•°æ®ç±»å‹
    Precision    int                    // æ•°å€¼ç²¾åº¦
    ErrorAction  string                 // é”™è¯¯å¤„ç†
    DefaultValue interface{}            // é»˜è®¤å€¼
}
```

## âœ… ä¿®å¤å†…å®¹

### 1. å®Œæ•´é‡æ„è¡¨å•ç»“æ„
- âŒ **æ—§**: åŸºäº `transforms[]` æ•°ç»„å’Œ `field` å­—æ®µ
- âœ… **æ–°**: åŸºäºæ ‡å‡† `type`, `parameters`, `output_key` ç»“æ„

### 2. æ”¯æŒæ‰€æœ‰9ç§è½¬æ¢ç±»å‹
| è½¬æ¢ç±»å‹ | ç”¨é€” | å‚æ•°å­—æ®µ |
|---------|------|---------|
| **scale** | æ•°å€¼ç¼©æ”¾ | `factor` |
| **offset** | æ•°å€¼åç§» | `offset` |
| **expression** | è¡¨è¾¾å¼è®¡ç®— | `expression` |
| **unit_convert** | å•ä½è½¬æ¢ | `from`, `to` |
| **lookup** | æŸ¥æ‰¾è¡¨æ˜ å°„ | `table`, `default` |
| **round** | å››èˆäº”å…¥ | `decimals` |
| **clamp** | æ•°å€¼é™å¹… | `min`, `max` |
| **format** | æ ¼å¼åŒ– | `format` |
| **map** | å€¼æ˜ å°„ | `mapping` |

### 3. å¢åŠ é«˜çº§é…ç½®é€‰é¡¹
- **è¾“å‡ºå­—æ®µå** (`output_key`): æŒ‡å®šè½¬æ¢åçš„å­—æ®µå
- **è¾“å‡ºæ•°æ®ç±»å‹** (`output_type`): string/int/float/bool
- **æ•°å€¼ç²¾åº¦** (`precision`): æ§åˆ¶å°æ•°ä½æ•°
- **é”™è¯¯å¤„ç†ç­–ç•¥** (`error_action`): error/ignore/default
- **é»˜è®¤å€¼** (`default_value`): é”™è¯¯æ—¶ä½¿ç”¨çš„å€¼
- **å‘å¸ƒä¸»é¢˜** (`publish_subject`): NATSå‘å¸ƒä¸»é¢˜

### 4. æ™ºèƒ½è¡¨å•é€»è¾‘
- æ ¹æ®è½¬æ¢ç±»å‹åŠ¨æ€æ˜¾ç¤ºç›¸åº”çš„å‚æ•°è¾“å…¥
- æä¾›è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹
- æ”¯æŒJSONæ ¼å¼çš„å¤æ‚å‚æ•°é…ç½®
- è‡ªåŠ¨å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†

## ğŸ“Š é…ç½®å¯¹æ¯”

### æ—§é…ç½®æ ¼å¼ (âŒ ä¸å…¼å®¹)
```json
{
  "type": "transform",
  "config": {
    "field": "value",
    "scale_factor": 2.0,
    "offset": 32,
    "precision": 2,
    "transforms": [
      {
        "type": "round",
        "precision": 2
      }
    ],
    "add_tags": {
      "converted": "true"
    }
  }
}
```

### æ–°é…ç½®æ ¼å¼ (âœ… å®Œå…¨å…¼å®¹)
```json
{
  "type": "transform",
  "config": {
    "type": "expression",
    "parameters": {
      "expression": "x * 1.8 + 32"
    },
    "output_key": "temperature_fahrenheit",
    "output_type": "float",
    "precision": 2,
    "error_action": "default",
    "default_value": 0,
    "publish_subject": "iot.data.converted"
  }
}
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### 1. **å®Œå…¨å…¼å®¹åç«¯**
- ç”Ÿæˆçš„é…ç½®å¯ä»¥ç›´æ¥è¢« TransformHandler è§£æ
- æ”¯æŒæ‰€æœ‰åç«¯å®ç°çš„è½¬æ¢ç±»å‹å’Œå‚æ•°
- æ­£ç¡®çš„é”™è¯¯å¤„ç†å’Œç±»å‹è½¬æ¢

### 2. **ç”¨æˆ·ä½“éªŒæå‡**
- ç›´è§‚çš„è½¬æ¢ç±»å‹é€‰æ‹©
- æ™ºèƒ½çš„å‚æ•°è¾“å…¥è¡¨å•
- è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹
- å®æ—¶çš„é…ç½®é¢„è§ˆ

### 3. **åŠŸèƒ½å®Œæ•´æ€§**
- æ”¯æŒå¤æ‚çš„æ•°å­¦è¡¨è¾¾å¼ (`x * 1.8 + 32`)
- æ”¯æŒå‡½æ•°è°ƒç”¨ (`abs(x)`, `sqrt(x)`)
- æ”¯æŒå•ä½è½¬æ¢ (æ¸©åº¦ã€é•¿åº¦ã€é‡é‡)
- æ”¯æŒæŸ¥æ‰¾è¡¨å’Œå€¼æ˜ å°„

### 4. **é…ç½®çµæ´»æ€§**
- å¯é€‰çš„è¾“å‡ºå­—æ®µè‡ªå®šä¹‰
- çµæ´»çš„é”™è¯¯å¤„ç†ç­–ç•¥
- NATSå‘å¸ƒä¸»é¢˜é›†æˆ
- ç±»å‹å®‰å…¨çš„è¾“å‡ºæ§åˆ¶

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### æ¸©åº¦è½¬æ¢
```json
{
  "type": "expression",
  "parameters": {
    "expression": "x * 1.8 + 32"
  },
  "output_key": "temperature_fahrenheit",
  "output_type": "float",
  "precision": 1
}
```

### çŠ¶æ€æ˜ å°„
```json
{
  "type": "lookup",
  "parameters": {
    "table": {
      "0": "æ­£å¸¸",
      "1": "è­¦å‘Š", 
      "2": "é”™è¯¯"
    },
    "default": "æœªçŸ¥"
  },
  "output_key": "status_text",
  "output_type": "string"
}
```

### æ•°å€¼é™å¹…
```json
{
  "type": "clamp",
  "parameters": {
    "min": 0,
    "max": 100
  },
  "output_key": "percentage_clamped",
  "precision": 1
}
```

## ğŸ“ æµ‹è¯•å»ºè®®

1. **åŸºç¡€è½¬æ¢æµ‹è¯•**: æµ‹è¯•æ¯ç§è½¬æ¢ç±»å‹çš„å‚æ•°è¾“å…¥å’Œè¾“å‡º
2. **æ•°æ®å›å¡«æµ‹è¯•**: ç¼–è¾‘ç°æœ‰è§„åˆ™æ—¶ç¡®è®¤å­—æ®µæ­£ç¡®å¡«å……
3. **é…ç½®å…¼å®¹æ€§æµ‹è¯•**: ç¡®è®¤ç”Ÿæˆçš„é…ç½®èƒ½è¢«åç«¯æ­£ç¡®å¤„ç†
4. **é”™è¯¯å¤„ç†æµ‹è¯•**: æµ‹è¯•å„ç§é”™è¯¯å¤„ç†ç­–ç•¥çš„è¡Œä¸º
5. **NATSå‘å¸ƒæµ‹è¯•**: éªŒè¯è½¬æ¢ç»“æœæ­£ç¡®å‘å¸ƒåˆ°æ¶ˆæ¯æ€»çº¿

---

**æ€»ç»“**: Transformè¡¨å•å·²å®Œå…¨é‡æ„ï¼Œç°åœ¨ä¸åç«¯TransformHandlerå®Œå…¨å…¼å®¹ï¼Œæ”¯æŒæ‰€æœ‰9ç§è½¬æ¢ç±»å‹ï¼Œæä¾›ä¸°å¯Œçš„é…ç½®é€‰é¡¹å’Œè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚ğŸ‰