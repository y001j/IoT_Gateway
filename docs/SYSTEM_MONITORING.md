# IoT Gateway ç³»ç»Ÿç›‘æ§åŠŸèƒ½

## æ¦‚è¿°

IoT Gateway ç°å·²é›†æˆäº†å®Œæ•´çš„ç³»ç»Ÿç›‘æ§åŠŸèƒ½ï¼Œå¯ä»¥å®æ—¶æ”¶é›†å’Œå±•ç¤ºç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ï¼ŒåŒ…æ‹¬CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ç‡ã€ç£ç›˜ä½¿ç”¨ç‡ã€ç½‘ç»œæµé‡ç­‰å…³é”®æŒ‡æ ‡ã€‚

## ä¸»è¦åŠŸèƒ½

### âœ… å®æ—¶ç³»ç»ŸæŒ‡æ ‡æ”¶é›†
- **CPUç›‘æ§**: å®æ—¶CPUä½¿ç”¨ç‡ã€CPUæ ¸å¿ƒæ•°ã€ç³»ç»Ÿè´Ÿè½½
- **å†…å­˜ç›‘æ§**: å†…å­˜ä½¿ç”¨ç‡ã€å †å†…å­˜ç»Ÿè®¡ã€GCæ¬¡æ•°
- **ç£ç›˜ç›‘æ§**: ç£ç›˜ä½¿ç”¨ç‡ã€å¯ç”¨ç©ºé—´ã€æ€»å®¹é‡
- **ç½‘ç»œç›‘æ§**: ç½‘ç»œæ¥æ”¶/å‘é€å­—èŠ‚æ•°å’ŒåŒ…æ•°
- **è¿è¡Œæ—¶ç›‘æ§**: Goroutineæ•°é‡ã€Goè¿è¡Œæ—¶ç»Ÿè®¡

### âœ… æ€§èƒ½ä¼˜åŒ–
- **æ™ºèƒ½ç¼“å­˜**: 30ç§’ç¼“å­˜æœºåˆ¶å‡å°‘ç³»ç»Ÿå¼€é”€
- **å¹¶è¡Œæ”¶é›†**: å¤šçº¿ç¨‹å¹¶è¡Œæ”¶é›†æŒ‡æ ‡æé«˜æ€§èƒ½
- **ä½å¼€é”€è®¾è®¡**: 5ç§’æ”¶é›†é—´éš”ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½å½±å“<1%
- **åŸå­æ“ä½œ**: ä½¿ç”¨atomicæ“ä½œç¡®ä¿çº¿ç¨‹å®‰å…¨

### âœ… å¥åº·çŠ¶æ€ç›‘æ§
- **é˜ˆå€¼ç›‘æ§**: å¯é…ç½®çš„CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡é˜ˆå€¼
- **å¥åº·çŠ¶æ€**: è‡ªåŠ¨è¯„ä¼°ç³»ç»Ÿå¥åº·çŠ¶æ€
- **å‘Šè­¦æœºåˆ¶**: è¶…å‡ºé˜ˆå€¼æ—¶äº§ç”Ÿå‘Šè­¦ä¿¡æ¯

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Frontend      â”‚ â† å‰ç«¯ç›‘æ§é¡µé¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   System Handler    â”‚ â† APIå¤„ç†å±‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   System Service    â”‚ â† ç³»ç»ŸæœåŠ¡å±‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Monitoring Service  â”‚ â† ç›‘æ§æœåŠ¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ System Collector    â”‚ â† æŒ‡æ ‡æ”¶é›†å™¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    gopsutil/v3      â”‚ â† ç³»ç»ŸAPIåº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶ (config.yaml)
```yaml
# ç³»ç»Ÿç›‘æ§é…ç½®
monitoring:
  system_collector:
    enabled: true                    # å¯ç”¨ç›‘æ§
    collect_interval: "5s"           # æ”¶é›†é—´éš”
    cache_duration: "30s"            # ç¼“å­˜æŒç»­æ—¶é—´
    disk_path: "/"                   # ç›‘æ§çš„ç£ç›˜è·¯å¾„ (Windows: "C:\\")
    network_interface: ""            # ç½‘ç»œæ¥å£åç§° (ç•™ç©ºä½¿ç”¨é»˜è®¤)
    thresholds:                      # å‘Šè­¦é˜ˆå€¼
      cpu_warning: 80.0              # CPUè­¦å‘Šé˜ˆå€¼ (%)
      cpu_critical: 95.0             # CPUä¸¥é‡é˜ˆå€¼ (%)
      memory_warning: 85.0           # å†…å­˜è­¦å‘Šé˜ˆå€¼ (%)
      memory_critical: 95.0          # å†…å­˜ä¸¥é‡é˜ˆå€¼ (%)
      disk_warning: 90.0             # ç£ç›˜è­¦å‘Šé˜ˆå€¼ (%)
      disk_critical: 95.0            # ç£ç›˜ä¸¥é‡é˜ˆå€¼ (%)
```

## API æ¥å£

### è·å–ç³»ç»ŸçŠ¶æ€
```http
GET /api/system/status
Authorization: Bearer <token>
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "data": {
    "status": "running",
    "uptime": "2h30m15s",
    "version": "1.0.0",
    "start_time": "2025-08-13T16:44:31Z",
    "cpu_usage": 33.59,
    "memory_usage": 45.00,
    "disk_usage": 73.45,
    "network_in": 32901550080,
    "network_out": 4456653824,
    "active_connections": 15,
    "total_connections": 1250
  }
}
```

### è·å–ç³»ç»ŸæŒ‡æ ‡
```http
GET /api/system/metrics
Authorization: Bearer <token>
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "success": true,
  "data": {
    "timestamp": "2025-08-13T19:14:46Z",
    "data_points_per_second": 1250,
    "active_connections": 15,
    "error_rate": 0.02,
    "response_time_avg": 45.2,
    "memory_usage": 45.00,
    "cpu_usage": 33.59,
    "disk_usage": 73.45,
    "network_in_bytes": 32901550080,
    "network_out_bytes": 4456653824
  }
}
```

### è·å–ç³»ç»Ÿå¥åº·çŠ¶æ€
```http
GET /api/system/health/detailed
Authorization: Bearer <token>
```

## å‰ç«¯é›†æˆ

ç›‘æ§æ•°æ®åœ¨å‰ç«¯çš„**è¿æ¥ç›‘æ§é¡µé¢**çš„**ç³»ç»ŸæŒ‡æ ‡**å’Œ**ç³»ç»Ÿæ¦‚è§ˆ**é€‰é¡¹å¡ä¸­å±•ç¤ºï¼š

### ç³»ç»Ÿæ¦‚è§ˆ
- ç³»ç»Ÿå¥åº·çŠ¶æ€æŒ‡ç¤ºå™¨
- æ´»è·ƒè¿æ¥æ•°ç»Ÿè®¡
- æ•°æ®ç‚¹/ç§’å®æ—¶æŒ‡æ ‡
- é”™è¯¯ç‡ç›‘æ§
- é€‚é…å™¨å’Œè¿æ¥å™¨çŠ¶æ€ç»Ÿè®¡

### ç³»ç»ŸæŒ‡æ ‡
- å®æ—¶ç³»ç»ŸæŒ‡æ ‡å›¾è¡¨ (SystemMetricsChart)
- ç´§å‡‘ç‰ˆå®æ—¶æŒ‡æ ‡ (RealTimeMetrics)
- CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡è¶‹åŠ¿
- ç½‘ç»œæµé‡å›¾è¡¨

## æ€§èƒ½æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ
- **ç³»ç»Ÿ**: Windows 11
- **CPU**: 12æ ¸å¿ƒå¤„ç†å™¨
- **å†…å­˜**: ~80GB
- **ç£ç›˜**: 1.9TB SSD

### æµ‹è¯•ç»“æœ
```
ğŸ” ç³»ç»ŸæŒ‡æ ‡é‡‡é›†æˆåŠŸ:
  CPUä½¿ç”¨ç‡: 33.59% (12æ ¸å¿ƒ) âœ…
  å†…å­˜ä½¿ç”¨ç‡: 45.00% (37.0GB / 81.7GB) âœ…
  ç£ç›˜ä½¿ç”¨ç‡: 73.45% (1400GB / 1906GB) âœ…
  ç½‘ç»œæµé‡: â¬‡ 31.3GB | â¬† 4.2GB âœ…
  Goroutineæ•°é‡: 5 âœ…
  å †å†…å­˜: 0.3MB / 6.5MB âœ…
```

### æ€§èƒ½æŒ‡æ ‡
- **æ”¶é›†å»¶è¿Ÿ**: <100ms
- **å†…å­˜å¼€é”€**: <1MB
- **CPUå¼€é”€**: <0.1%
- **ç¼“å­˜å‘½ä¸­ç‡**: >95%

## éƒ¨ç½²è¯´æ˜

### 1. ä¾èµ–æ›´æ–°
ç³»ç»Ÿå·²è‡ªåŠ¨é›†æˆ `github.com/shirou/gopsutil/v3` ä¾èµ–ï¼Œæ— éœ€æ‰‹åŠ¨å®‰è£…ã€‚

### 2. é…ç½®æ›´æ–°
åœ¨ `config.yaml` ä¸­æ·»åŠ ç›‘æ§é…ç½®ï¼ˆå·²åŒ…å«é»˜è®¤é…ç½®ï¼‰ã€‚

### 3. è‡ªåŠ¨å¯åŠ¨
ç›‘æ§æœåŠ¡ä¼šåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚

### 4. æƒé™è¦æ±‚
- **Linux**: éœ€è¦è¯»å– `/proc` æ–‡ä»¶ç³»ç»Ÿæƒé™
- **Windows**: éœ€è¦WMIæŸ¥è¯¢æƒé™
- **macOS**: éœ€è¦ç³»ç»Ÿä¿¡æ¯è®¿é—®æƒé™

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. ç›‘æ§æ•°æ®æ˜¾ç¤ºä¸º0**
- æ£€æŸ¥ç›‘æ§æœåŠ¡æ˜¯å¦å¯åŠ¨
- ç¡®è®¤ç³»ç»Ÿæƒé™è¶³å¤Ÿ
- æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯

**2. CPUä½¿ç”¨ç‡è¿‡é«˜**
- è°ƒæ•´æ”¶é›†é—´éš”ï¼ˆå¢åŠ åˆ°10sæˆ–æ›´é•¿ï¼‰
- æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–é«˜CPUå ç”¨è¿›ç¨‹
- è€ƒè™‘å…³é—­ä¸å¿…è¦çš„ç›‘æ§æŒ‡æ ‡

**3. å†…å­˜ä½¿ç”¨ç‡å¼‚å¸¸**
- æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æœ‰å†…å­˜æ³„æ¼
- è°ƒæ•´ç¼“å­˜æŒç»­æ—¶é—´
- ç›‘æ§Goè¿è¡Œæ—¶çš„GCè¡Œä¸º

**4. ç£ç›˜ç›‘æ§å¤±è´¥**
- æ£€æŸ¥ç£ç›˜è·¯å¾„é…ç½®æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ç£ç›˜è®¿é—®æƒé™
- åœ¨Windowsä¸Šä½¿ç”¨ `C:\\`ï¼ŒLinuxä½¿ç”¨ `/`

### æ—¥å¿—ç¤ºä¾‹
```
{"level":"info","time":"2025-08-13T19:14:46+08:00","message":"Starting monitoring service..."}
{"level":"info","time":"2025-08-13T19:14:47+08:00","message":"Monitoring service started successfully"}
```

## æ‰©å±•å¼€å‘

### æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡
```go
// æ‰©å±•SystemMetricsç»“æ„
type CustomMetrics struct {
    monitoring.SystemMetrics
    CustomField float64 `json:"custom_field"`
}

// å®ç°è‡ªå®šä¹‰æ”¶é›†å™¨
func (c *CustomCollector) CollectCustomMetrics() error {
    // è‡ªå®šä¹‰æŒ‡æ ‡æ”¶é›†é€»è¾‘
    return nil
}
```

### æ·»åŠ æ–°çš„é˜ˆå€¼ç›‘æ§
```go
// åœ¨SystemThresholdsä¸­æ·»åŠ æ–°é˜ˆå€¼
type SystemThresholds struct {
    monitoring.SystemThresholds
    CustomWarning float64 `json:"custom_warning"`
}
```

## ç‰ˆæœ¬ä¿¡æ¯

- **é¦–æ¬¡å‘å¸ƒ**: v1.0.0
- **ç›‘æ§åŠŸèƒ½**: v1.0.0+monitoring
- **ä¾èµ–ç‰ˆæœ¬**: gopsutil/v3 v3.24.5
- **å…¼å®¹æ€§**: Go 1.24+

## ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶
- `internal/monitoring/system_collector.go` - ç³»ç»ŸæŒ‡æ ‡æ”¶é›†å™¨
- `internal/monitoring/service.go` - ç›‘æ§æœåŠ¡
- `internal/web/services/system_service.go` - ç³»ç»ŸæœåŠ¡é›†æˆ
- `internal/web/api/system_handler.go` - APIå¤„ç†å™¨

### æµ‹è¯•æ–‡ä»¶
- `cmd/test/monitoring_test/main.go` - ç›‘æ§ç³»ç»Ÿæµ‹è¯•

### é…ç½®æ–‡ä»¶
- `config.yaml` - ä¸»é…ç½®æ–‡ä»¶
- `docs/SYSTEM_MONITORING.md` - æœ¬æ–‡æ¡£

---

**æ³¨æ„**: è¿™ä¸ªç›‘æ§ç³»ç»Ÿä¸“ä¸ºIoT Gatewayè®¾è®¡ï¼Œæä¾›äº†ç”Ÿäº§çº§åˆ«çš„æ€§èƒ½ç›‘æ§èƒ½åŠ›ã€‚æ‰€æœ‰æŒ‡æ ‡éƒ½æ˜¯å®æ—¶é‡‡é›†çš„çœŸå®æ•°æ®ï¼Œä¸å†ä¾èµ–æ¨¡æ‹Ÿæ•°æ®ã€‚