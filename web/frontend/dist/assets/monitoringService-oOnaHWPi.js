import{c}from"./index-BEjgWUn2.js";class w{baseUrl="/monitoring";async getPlugins(){const[t,e]=await Promise.all([c.get("/plugins"),fetch("http://localhost:8080/metrics").catch(()=>null)]),s=t.data;let n=null;e&&e.ok&&(n=await e.json(),console.log("轻量级指标数据:",n));const r=[],i=[],u=s.data?.data||s.data||[];return console.log("插件API原始数据:",s),console.log("解析出的插件数据:",u),Array.isArray(u)&&await Promise.all(u.map(async a=>{let p=0;if(a.status==="running"&&n?.gateway?.start_time){const o=new Date(n.gateway.start_time);p=Math.floor((new Date().getTime()-o.getTime())/1e3)}let d=null;try{d=(await c.get(`/plugins/${a.name}/stats`)).data.data}catch(o){console.warn(`获取插件 ${a.name} 统计数据失败:`,o)}const f=d?.average_latency||a.status==="running"&&n?.connections?.average_response_time_ms||0,m=d?.errors_total||a.error_count||0,_={name:a.name,type:a.type,status:a.status,health:a.status==="running"?"healthy":a.status==="stopped"?"degraded":"unhealthy",health_message:a.status==="running"?"运行正常":a.status==="stopped"?"已停止":"未知状态",connection_uptime:d?.uptime_seconds||p,errors_count:m,response_time_ms:f,last_seen:new Date().toISOString()};if(a.type==="adapter"){const o=n?.data?.total_data_points||0,l=u.filter(h=>h.type==="adapter"&&h.status==="running").length,g=a.status==="running"&&l>0?Math.floor(o/l):0;r.push({..._,data_points_count:g,last_error:"",tags:{}})}else if(a.type==="sink"){const o=n?.data?.total_data_points||0,l=u.filter(h=>h.type==="sink"&&h.status==="running").length,g=a.status==="running"&&l>0?Math.floor(o/l):0;i.push({..._,messages_published:g,last_error:"",tags:{}})}})),console.log("解析后的适配器:",r),console.log("解析后的连接器:",i),{adapters:r,sinks:i}}async getAdapterStatus(){try{const{adapters:t,sinks:e}=await this.getPlugins();let s;try{s=await fetch("http://localhost:8080/metrics").then(r=>r.json())}catch(r){console.warn("轻量级指标服务不可用，使用默认值:",r),s={gateway:{status:"running",total_adapters:t.length,running_adapters:t.filter(i=>i.status==="running").length,total_sinks:e.length,running_sinks:e.filter(i=>i.status==="running").length},connections:{active_connections:t.length+e.length},data:{data_points_per_second:0},errors:{errors_per_second:0}}}const n={system_health:s.gateway.status==="running"?"healthy":"degraded",active_connections:s.connections.active_connections,total_adapters:s.gateway.total_adapters,running_adapters:s.gateway.running_adapters,healthy_adapters:t.filter(r=>r.health==="healthy").length,total_sinks:s.gateway.total_sinks,running_sinks:s.gateway.running_sinks,healthy_sinks:e.filter(r=>r.health==="healthy").length,total_data_points_per_sec:s.data.data_points_per_second,total_errors_per_sec:s.errors.errors_per_second,top_adapters_by_traffic:[]};return{adapters:t,sinks:e,overview:n}}catch(t){throw console.error("获取适配器状态失败:",t),t}}async getDataFlowMetrics(t){const e=new URLSearchParams;t?.time_range&&e.append("time_range",t.time_range),t?.limit&&e.append("limit",t.limit.toString());const s=`${this.baseUrl}/adapters/data-flow${e.toString()?`?${e.toString()}`:""}`;return(await c.get(s)).data.data}async getAdapterDiagnostics(t){return(await c.get(`${this.baseUrl}/adapters/${encodeURIComponent(t)}/diagnostics`)).data.data}async testAdapterConnection(t){return(await c.post(`${this.baseUrl}/adapters/${encodeURIComponent(t)}/test-connection`)).data}async getAdapterPerformance(t,e){const s=new URLSearchParams;e&&s.append("period",e);const n=`${this.baseUrl}/adapters/${encodeURIComponent(t)}/performance${s.toString()?`?${s.toString()}`:""}`;return(await c.get(n)).data}async restartAdapter(t){await c.post(`${this.baseUrl}/adapters/${encodeURIComponent(t)}/restart`)}formatUptime(t){if(t<60)return`${Math.floor(t)}秒`;if(t<3600)return`${Math.floor(t/60)}分钟`;if(t<86400){const e=Math.floor(t/3600),s=Math.floor(t%3600/60);return`${e}小时${s}分钟`}else{const e=Math.floor(t/86400),s=Math.floor(t%86400/3600);return`${e}天${s}小时`}}formatBytes(t){if(t===0)return"0 B";const e=1024,s=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(t)/Math.log(e));return`${parseFloat((t/Math.pow(e,n)).toFixed(1))} ${s[n]}`}formatNumber(t,e=1){return t>=1e6?`${(t/1e6).toFixed(e)}M`:t>=1e3?`${(t/1e3).toFixed(e)}K`:t.toFixed(e)}formatLatency(t){return t<1?`${(t*1e3).toFixed(0)}μs`:t<1e3?`${t.toFixed(1)}ms`:`${(t/1e3).toFixed(2)}s`}getStatusColor(t){switch(t){case"running":return"success";case"stopped":return"default";case"error":return"error";default:return"default"}}getHealthColor(t){switch(t){case"healthy":return"success";case"degraded":return"warning";case"unhealthy":return"error";case"unknown":default:return"default"}}getStatusText(t){switch(t){case"running":return"运行中";case"stopped":return"已停止";case"error":return"错误";default:return"未知"}}getHealthText(t){switch(t){case"healthy":return"健康";case"degraded":return"降级";case"unhealthy":return"不健康";case"unknown":default:return"未知"}}calculateHealthScore(t){let e=100;if(t.status==="error"?e-=50:t.status==="stopped"&&(e-=30),t.health==="unhealthy"?e-=30:t.health==="degraded"&&(e-=15),t.data_points_count>0){const s=t.errors_count/t.data_points_count;e-=s*20}return t.response_time_ms>1e3?e-=10:t.response_time_ms>500&&(e-=5),Math.max(0,Math.min(100,e))}getAdapterIcon(t){switch(t.toLowerCase()){case"modbus":return"🔌";case"mqtt":return"📡";case"http":return"🌐";case"mock":return"🎭";default:return"📱"}}getSinkIcon(t){switch(t.toLowerCase()){case"mqtt":return"📡";case"influxdb":return"📊";case"redis":return"🔄";case"console":return"💻";case"websocket":return"🔗";case"jetstream":return"🚀";default:return"📤"}}}const M=new w;export{M as m};
