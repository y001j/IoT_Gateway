class l{ws=null;url="";token="";callbacks={};reconnectInterval=15e3;maxReconnectAttempts=3;reconnectAttempts=0;isConnecting=!1;isManuallyDisconnected=!1;lastDisconnectReason="";connectionId="";lastConnectAttempt=0;minConnectInterval=5e3;reconnectTimer=null;constructor(){const t=window.location.protocol==="https:"?"wss:":"ws:",n=!1;{const s=window.location.host;this.url=`${t}//${s}/api/v1/ws/realtime`}this.connectionId=this.generateConnectionId(),console.log("ğŸ”§ WebSocketæœåŠ¡åˆå§‹åŒ–",{url:this.url,connectionId:this.connectionId,isDev:n,wsBaseUrl:void 0,debugWs:void 0})}generateConnectionId(){return`ws_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}setToken(t){console.log("ğŸ”‘ è®¾ç½®WebSocketè®¤è¯ä»¤ç‰Œï¼Œé•¿åº¦:",t?t.length:0),this.token=t}setCallbacks(t){this.callbacks={...this.callbacks,...t}}async testWebSocketEndpoint(){try{const t=this.url.replace("ws:","http:").replace("wss:","https:");console.log("ğŸ§ª æµ‹è¯•WebSocketç«¯ç‚¹å¯è¾¾æ€§:",t);const n=await fetch(t.split("?")[0],{method:"GET",headers:{Connection:"upgrade"}});return console.log("ğŸ§ª WebSocketç«¯ç‚¹æµ‹è¯•ç»“æœ:",n.status,n.statusText),!0}catch(t){return console.error("ğŸ§ª WebSocketç«¯ç‚¹ä¸å¯è¾¾:",t),!1}}connect(){return new Promise(async(t,n)=>{const s=Date.now();if(this.isConnecting){console.log("â¸ï¸ WebSocketè¿æ¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è¿æ¥è¯·æ±‚"),t();return}if(this.isConnected()){console.log("âœ… WebSocketå·²è¿æ¥ï¼Œè·³è¿‡è¿æ¥è¯·æ±‚"),t();return}if(s-this.lastConnectAttempt<this.minConnectInterval){const e=this.minConnectInterval-(s-this.lastConnectAttempt);console.log(`â° è¿æ¥é—´éš”é™åˆ¶ï¼Œéœ€ç­‰å¾… ${e}ms`),setTimeout(()=>{this.connect().then(t).catch(n)},e);return}if(!this.token){const e=new Error("è®¤è¯ä»¤ç‰Œæœªè®¾ç½®");console.error("âŒ WebSocketè¿æ¥å¤±è´¥:",e.message),n(e);return}if(this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.isConnecting=!0,this.isManuallyDisconnected=!1,this.lastConnectAttempt=s,console.log(`ğŸ”Œ å¼€å§‹å»ºç«‹WebSocketè¿æ¥... [${this.connectionId}]`),!await this.testWebSocketEndpoint()){const e=new Error(`WebSocketç«¯ç‚¹ä¸å¯è¾¾: ${this.url}`);console.error("âŒ WebSocketç«¯ç‚¹æµ‹è¯•å¤±è´¥"),this.isConnecting=!1,n(e);return}try{const e=`${this.url}?token=${encodeURIComponent(this.token)}`;console.log("ğŸŒ è¿æ¥WebSocket URL:",e.replace(/token=[^&]+/,"token=***")),this.ws=new WebSocket(e),this.ws.onopen=()=>{console.log(`âœ… WebSocketè¿æ¥å·²å»ºç«‹ [${this.connectionId}]`),this.isConnecting=!1,this.reconnectAttempts=0,this.lastDisconnectReason="",this.callbacks.onConnect?.(),t()},this.ws.onmessage=o=>{try{const c=JSON.parse(o.data);console.log(`ğŸ“¨ æ”¶åˆ°WebSocketæ¶ˆæ¯: ${c.type} [${this.connectionId}]`),this.handleMessage(c)}catch(c){console.error(`âŒ è§£æWebSocketæ¶ˆæ¯å¤±è´¥ [${this.connectionId}]:`,c,"åŸå§‹æ•°æ®:",o.data)}},this.ws.onclose=o=>{if(this.lastDisconnectReason=`Code: ${o.code}, Reason: ${o.reason||"æœªçŸ¥"}`,console.log(`ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­ [${this.connectionId}]:`,this.lastDisconnectReason),this.isConnecting=!1,this.ws=null,this.callbacks.onDisconnect?.(),!this.isManuallyDisconnected&&this.reconnectAttempts<this.maxReconnectAttempts){const c=this.reconnectInterval*Math.pow(2,this.reconnectAttempts);console.log(`â° å°†åœ¨${c/1e3}ç§’åå°è¯•é‡è¿ (${this.reconnectAttempts+1}/${this.maxReconnectAttempts}) [${this.connectionId}]`),this.reconnectTimer=setTimeout(()=>{!this.isManuallyDisconnected&&!this.isConnected()&&(this.reconnectAttempts++,console.log(`ğŸ”„ å°è¯•é‡è¿WebSocket (${this.reconnectAttempts}/${this.maxReconnectAttempts}) [${this.connectionId}]`),this.connect().catch(r=>{console.error(`âŒ é‡è¿å¤±è´¥ [${this.connectionId}]:`,r)}))},c)}else this.reconnectAttempts>=this.maxReconnectAttempts&&console.error(`âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿ [${this.connectionId}]`)},this.ws.onerror=o=>{console.error(`âŒ WebSocketè¿æ¥é”™è¯¯ [${this.connectionId}]:`,{error:o,url:this.url,token:this.token?`${this.token.substring(0,20)}...`:"null",readyState:this.ws?.readyState,timestamp:new Date().toISOString()}),this.isConnecting=!1,this.callbacks.onError?.(o),n(new Error(`WebSocketè¿æ¥å¤±è´¥: æ— æ³•è¿æ¥åˆ° ${this.url}`))}}catch(e){console.error(`âŒ åˆ›å»ºWebSocketè¿æ¥å¤±è´¥ [${this.connectionId}]:`,e),this.isConnecting=!1,n(e)}})}disconnect(){console.log(`ğŸ”Œ æ‰‹åŠ¨æ–­å¼€WebSocketè¿æ¥ [${this.connectionId}]`),this.isManuallyDisconnected=!0,this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(1e3,"ç”¨æˆ·ä¸»åŠ¨æ–­å¼€"),this.ws=null),this.isConnecting=!1}resetReconnectAttempts(){console.log(`ğŸ”„ é‡ç½®é‡è¿è®¡æ•°å™¨ [${this.connectionId}]`),this.reconnectAttempts=0}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}send(t,n){if(!this.isConnected()){console.warn(`âš ï¸ WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ [${this.connectionId}]:`,t);return}const s={type:t,data:n,timestamp:Date.now()};try{this.ws.send(JSON.stringify(s)),console.log(`ğŸ“¤ å‘é€WebSocketæ¶ˆæ¯: ${t} [${this.connectionId}]`)}catch(i){console.error(`âŒ å‘é€WebSocketæ¶ˆæ¯å¤±è´¥ [${this.connectionId}]:`,i)}}ping(){this.send("ping",{})}subscribe(t){this.send("subscribe",{topics:t})}unsubscribe(t){this.send("unsubscribe",{topics:t})}handleMessage(t){if(t.type==="pong"){console.log(`ğŸ’“ æ”¶åˆ°å¿ƒè·³å“åº” [${this.connectionId}]`);return}if(t.type==="welcome"){console.log(`ğŸ‘‹ æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯ [${this.connectionId}]:`,t.data);return}t.type==="initial_data"&&console.log(`ğŸ“Š æ”¶åˆ°åˆå§‹æ•°æ® [${this.connectionId}]`),this.callbacks.onMessage&&this.callbacks.onMessage(t)}getConnectionState(){return this.isConnecting?"CONNECTING":this.isConnected()?"CONNECTED":(this.isManuallyDisconnected,"DISCONNECTED")}getConnectionInfo(){return{id:this.connectionId,state:this.getConnectionState(),attempts:this.reconnectAttempts}}getLastDisconnectReason(){return this.lastDisconnectReason}getReconnectInfo(){return{attempts:this.reconnectAttempts,maxAttempts:this.maxReconnectAttempts,interval:this.reconnectInterval}}}const h=new l;export{l as WebSocketService,h as webSocketService};
