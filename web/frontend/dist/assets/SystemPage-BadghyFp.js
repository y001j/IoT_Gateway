import{j as e}from"./index-BEjgWUn2.js";import{A as Q,a as j,F as r,s as l,u as t,k as c,y as b,T as X,w as F,B as v,aE as Y,a1 as E,I as i,h as R,N as u,am as p,aF as Z,X as ee,D as se,ae as te,a5 as re,aG as ne,K as le,a8 as ae}from"./antd-BFy_CllK.js";import{s as y}from"./systemService-9IzLEFsU.js";import{l as ie}from"./lightweightMetricsService-DToKI_sg.js";import"./vendor-DavUf6mE.js";const{Title:N}=X,me=()=>{const{message:o}=Q.useApp(),[A,S]=j.useState(!1),[d,L]=j.useState(null),[h,O]=j.useState(null),[g,$]=j.useState(null),[a,B]=j.useState(null),[x,T]=j.useState(null),[_]=r.useForm(),[H,q]=j.useState("status"),C=()=>({gateway:{id:"iot-gateway",http_port:8080,log_level:"info",nats_url:"nats://localhost:4222",plugins_dir:"./plugins",metrics:{enabled:!0,port:9090}},nats:{enabled:!0,embedded:!0,host:"localhost",port:4222,cluster_port:6222,monitor_port:8222,jetstream:{enabled:!0,store_dir:"./data/jetstream",max_memory:1073741824,max_file:10737418240},cluster:{enabled:!1,name:"iot-cluster",routes:[]},tls:{enabled:!1,cert_file:"",key_file:"",ca_file:""}},web_ui:{enabled:!0,port:3e3,auth:{jwt_secret:"your-secret-key",token_duration:"24h",refresh_duration:"72h",max_login_attempts:5,lockout_duration:"15m",enable_two_factor:!1,session_timeout:"30m",password_min_length:8,bcrypt_cost:12}},database:{sqlite:{path:"./data/iot-gateway.db",max_open_conns:25,max_idle_conns:5,conn_max_lifetime:"5m",conn_max_idle_time:"1m"}},security:{api_keys:{enabled:!1,keys:[]},https:{enabled:!1,cert_file:"",key_file:"",redirect_http:!1},cors:{enabled:!0,allowed_origins:["*"],allowed_methods:["GET","POST","PUT","DELETE","OPTIONS"],allowed_headers:["*"],credentials:!1}},rules:{dir:"./rules"}}),D=async()=>{try{const s=await y.getStatus();L(s)}catch(s){const n=s instanceof Error?s.message:"未知错误";o.error("获取系统状态失败："+n)}},W=async()=>{try{const s=await y.getMetrics();O(s)}catch(s){const n=s instanceof Error?s.message:"未知错误";o.error("获取系统指标失败："+n)}},G=async()=>{try{const s=await y.getHealth();$(s),console.log("健康检查数据:",s)}catch(s){const n=s instanceof Error?s.message:"未知错误";o.error("获取健康检查失败："+n)}},K=async()=>{try{const s=await y.getLightweightMetrics();B(s),console.log("轻量级指标数据:",s)}catch(s){const n=s instanceof Error?s.message:"未知错误";console.warn("获取轻量级指标失败，使用默认数据：",n),B(null)}},P=async()=>{try{const s=await y.getConfig();s&&(T(s),_.setFieldsValue(s))}catch(s){const n=s instanceof Error?s.message:"未知错误";o.error("获取系统配置失败："+n);const m=C();T(m),_.setFieldsValue(m)}},M=async()=>{S(!0);try{await Promise.all([D(),W(),G(),K(),P()])}finally{S(!1)}},U=async()=>{try{const s=await _.validateFields();await y.updateConfig(s),o.success("配置保存成功"),await P()}catch(s){const n=s instanceof Error?s.message:"未知错误";o.error("保存配置失败："+n)}},V=()=>{ae.confirm({title:"确认重启系统",content:"重启系统将会中断所有正在运行的连接和任务，确定要继续吗？",okText:"确认重启",okType:"danger",cancelText:"取消",onOk:async()=>{try{await y.restart(),o.success("系统重启中...")}catch(s){const n=s instanceof Error?s.message:"未知错误";o.error("重启失败："+n)}}})},z=s=>{const n=["B","KB","MB","GB","TB"];let m=s,f=0;for(;m>=1024&&f<n.length-1;)m/=1024,f++;return`${m.toFixed(2)} ${n[f]}`},w=s=>{switch(s.toLowerCase()){case"running":case"healthy":case"connected":return"success";case"warning":case"degraded":return"warning";case"error":case"failed":case"disconnected":return"error";default:return"default"}};j.useEffect(()=>{_.setFieldsValue(C()),M()},[_]);const J=[{key:"status",label:"系统状态",children:e.jsxs("div",{children:[e.jsxs(l,{gutter:[16,16],children:[e.jsx(t,{span:8,children:e.jsx(c,{title:"基本信息",size:"small",children:d&&e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"状态:"})," ",e.jsx(b,{color:w(d.status),children:d.status})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"版本:"})," ",d.version]}),e.jsxs("p",{children:[e.jsx("strong",{children:"运行时间:"})," ",d.uptime]}),e.jsxs("p",{children:[e.jsx("strong",{children:"启动时间:"})," ",new Date(d.start_time).toLocaleString()]})]})})}),e.jsx(t,{span:8,children:e.jsx(c,{title:"资源使用",size:"small",children:a?e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"CPU使用率:"})," ",a.system.cpu_usage_percent.toFixed(1),"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"内存使用:"})," ",ie.formatBytes(a.system.memory_usage_bytes)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"磁盘使用率:"})," ",a.system.disk_usage_percent.toFixed(1),"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"数据吞吐:"})," ",a.data.data_points_per_second.toFixed(2)," 点/秒"]})]}):h?e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"CPU使用率:"})," ",h.cpu_usage?h.cpu_usage.toFixed(1):"0.0","%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"内存使用率:"})," ",h.memory_usage?h.memory_usage.toFixed(1):"0.0","%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"磁盘使用率:"})," ",h.disk_usage?h.disk_usage.toFixed(1):"0.0","%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"数据吞吐:"})," ",h.data_points_per_second||0," 点/秒"]})]}):e.jsx("div",{children:e.jsx("p",{style:{color:"#999"},children:"正在加载资源使用数据..."})})})}),e.jsx(t,{span:8,children:e.jsx(c,{title:"连接状态",size:"small",children:d&&e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"活跃连接:"})," ",d.active_connections||0]}),e.jsxs("p",{children:[e.jsx("strong",{children:"总连接数:"})," ",d.total_connections||0]}),e.jsxs("p",{children:[e.jsx("strong",{children:"网络接收:"})," ",z(d.network_in||0)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"网络发送:"})," ",z(d.network_out||0)]})]})})})]}),g&&e.jsx(l,{gutter:[16,16],style:{marginTop:16},children:e.jsx(t,{span:24,children:e.jsxs(c,{title:"系统健康检查",size:"small",children:[e.jsxs("div",{style:{marginBottom:16},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"服务:"})," ",g.service]}),e.jsxs("p",{children:[e.jsx("strong",{children:"整体状态:"})," ",e.jsx(b,{color:w(g.status),children:g.status})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"检查时间:"})," ",new Date(g.timestamp).toLocaleString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"版本:"})," ",g.version]})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"健康检查项:"}),e.jsx("div",{style:{marginTop:8},children:g.checks?.map((s,n)=>e.jsxs(b,{color:w(s.status),style:{marginBottom:4},children:[s.name,": ",s.status," (",s.duration,")"]},n))})]})]})})}),a&&e.jsxs(l,{gutter:[16,16],style:{marginTop:16},children:[e.jsx(t,{span:12,children:e.jsx(c,{title:"性能指标",size:"small",children:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"数据处理:"})," ",a.data.data_points_per_second||0," 点/秒"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"总数据点:"})," ",a.data.total_data_points||0]}),e.jsxs("p",{children:[e.jsx("strong",{children:"平均延迟:"})," ",a.data.average_latency_ms||0," ms"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"队列长度:"})," ",a.data.data_queue_length||0]})]})})}),e.jsx(t,{span:12,children:e.jsx(c,{title:"规则引擎",size:"small",children:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"状态:"})," ",e.jsx(b,{color:w(a.rules.rule_engine_status),children:a.rules.rule_engine_status})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"规则总数:"})," ",a.rules.total_rules]}),e.jsxs("p",{children:[e.jsx("strong",{children:"启用规则:"})," ",a.rules.enabled_rules]}),e.jsxs("p",{children:[e.jsx("strong",{children:"动作执行:"})," ",a.rules.actions_executed]})]})})})]})]})},{key:"config",label:"系统配置",children:e.jsxs("div",{children:[e.jsxs("div",{style:{marginBottom:"20px",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(N,{level:3,children:"系统配置"}),e.jsx(F,{children:e.jsx(v,{icon:e.jsx(Y,{}),onClick:U,type:"primary",children:"保存配置"})})]}),e.jsx(r,{form:_,layout:"vertical",children:e.jsx(E,{items:[{key:"gateway",label:"网关配置",icon:e.jsx(R,{}),children:e.jsxs(c,{title:"网关基础配置（配置文件）",size:"small",children:[e.jsx("div",{style:{marginBottom:16,padding:"8px 12px",backgroundColor:"#f6f8fa",borderRadius:4,fontSize:12,color:"#666"},children:"ℹ️ 网关配置来自配置文件，只能查看，不能修改。如需修改请编辑配置文件并重启服务。"}),e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:4,fontWeight:500},children:"网关ID"}),e.jsx(i,{value:x?.gateway?.id||"-",readOnly:!0})]})}),e.jsx(t,{span:12,children:e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:4,fontWeight:500},children:"HTTP端口"}),e.jsx(i,{value:x?.gateway?.http_port||"-",readOnly:!0})]})})]}),e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:4,fontWeight:500},children:"日志级别"}),e.jsx(i,{value:x?.gateway?.log_level||"-",readOnly:!0})]})}),e.jsx(t,{span:12,children:e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:4,fontWeight:500},children:"NATS连接地址"}),e.jsx(i,{value:x?.gateway?.nats_url||"-",readOnly:!0})]})})]}),e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:4,fontWeight:500},children:"插件目录"}),e.jsx(i,{value:x?.gateway?.plugins_dir||"-",readOnly:!0})]})}),e.jsx(t,{span:12,children:e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:4,fontWeight:500},children:"指标端口"}),e.jsx(i,{value:x?.gateway?.metrics?.port||"-",readOnly:!0})]})})]}),e.jsx(l,{gutter:16,children:e.jsx(t,{span:12,children:e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("div",{style:{marginBottom:4,fontWeight:500},children:"启用指标"}),e.jsx(b,{color:x?.gateway?.metrics?.enabled?"green":"red",children:x?.gateway?.metrics?.enabled?"已启用":"已禁用"})]})})})]})},{key:"nats",label:"NATS配置",icon:e.jsx(Z,{}),children:e.jsxs("div",{children:[e.jsxs(c,{title:"NATS服务器配置",size:"small",style:{marginBottom:16},children:[e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"启用NATS",name:["nats","enabled"],valuePropName:"checked",children:e.jsx(u,{})})}),e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"内嵌模式",name:["nats","embedded"],valuePropName:"checked",children:e.jsx(u,{})})})]}),e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"主机地址",name:["nats","host"],children:e.jsx(i,{placeholder:"localhost"})})}),e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"端口",name:["nats","port"],children:e.jsx(p,{min:1,max:65535,style:{width:"100%"}})})})]}),e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"集群端口",name:["nats","cluster_port"],children:e.jsx(p,{min:1,max:65535,style:{width:"100%"}})})}),e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"监控端口",name:["nats","monitor_port"],children:e.jsx(p,{min:1,max:65535,style:{width:"100%"}})})})]})]}),e.jsxs(c,{title:"JetStream配置",size:"small",style:{marginBottom:16},children:[e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"启用JetStream",name:["nats","jetstream","enabled"],valuePropName:"checked",children:e.jsx(u,{})})}),e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"存储目录",name:["nats","jetstream","store_dir"],children:e.jsx(i,{placeholder:"./data/jetstream"})})})]}),e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"最大内存(字节)",name:["nats","jetstream","max_memory"],children:e.jsx(p,{min:0,style:{width:"100%"}})})}),e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"最大文件大小(字节)",name:["nats","jetstream","max_file"],children:e.jsx(p,{min:0,style:{width:"100%"}})})})]})]})]})},{key:"database",label:"数据库配置",icon:e.jsx(ee,{}),children:e.jsxs(c,{title:"SQLite数据库配置",size:"small",children:[e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"数据库路径",name:["database","sqlite","path"],children:e.jsx(i,{placeholder:"./data/iot-gateway.db"})})}),e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"最大连接数",name:["database","sqlite","max_open_conns"],children:e.jsx(p,{min:1,max:100,style:{width:"100%"}})})})]}),e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"最大空闲连接数",name:["database","sqlite","max_idle_conns"],children:e.jsx(p,{min:1,max:50,style:{width:"100%"}})})}),e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"连接最大生存时间",name:["database","sqlite","conn_max_lifetime"],children:e.jsx(i,{placeholder:"5m"})})})]}),e.jsx(l,{gutter:16,children:e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"连接最大空闲时间",name:["database","sqlite","conn_max_idle_time"],children:e.jsx(i,{placeholder:"1m"})})})})]})},{key:"security",label:"安全配置",icon:e.jsx(ne,{}),children:e.jsxs("div",{children:[e.jsxs(c,{title:"HTTPS配置",size:"small",style:{marginBottom:16},children:[e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"启用HTTPS",name:["security","https","enabled"],valuePropName:"checked",children:e.jsx(u,{})})}),e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"重定向HTTP",name:["security","https","redirect_http"],valuePropName:"checked",children:e.jsx(u,{})})})]}),e.jsxs(l,{gutter:16,children:[e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"证书文件",name:["security","https","cert_file"],children:e.jsx(i,{placeholder:"./certs/server.crt"})})}),e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"私钥文件",name:["security","https","key_file"],children:e.jsx(i,{placeholder:"./certs/server.key"})})})]})]}),e.jsxs(c,{title:"API密钥管理",size:"small",style:{marginBottom:16},children:[e.jsx(l,{gutter:16,children:e.jsx(t,{span:12,children:e.jsx(r.Item,{label:"启用API密钥",name:["security","api_keys","enabled"],valuePropName:"checked",children:e.jsx(u,{})})})}),e.jsx(se,{children:"API密钥列表"}),e.jsx(r.List,{name:["security","api_keys","keys"],children:(s,{add:n,remove:m})=>e.jsxs(e.Fragment,{children:[s.map(({key:f,name:I,...k})=>e.jsxs("div",{style:{display:"flex",marginBottom:8,alignItems:"center"},children:[e.jsx(r.Item,{...k,name:[I,"name"],style:{flex:1,marginRight:8},children:e.jsx(i,{placeholder:"密钥名称"})}),e.jsx(r.Item,{...k,name:[I,"key"],style:{flex:2,marginRight:8},children:e.jsx(i,{placeholder:"密钥值"})}),e.jsx(r.Item,{...k,name:[I,"enabled"],valuePropName:"checked",style:{marginRight:8},children:e.jsx(u,{size:"small"})}),e.jsx(v,{type:"link",danger:!0,icon:e.jsx(te,{}),onClick:()=>m(I)})]},f)),e.jsx(r.Item,{children:e.jsx(v,{type:"dashed",onClick:()=>n(),block:!0,icon:e.jsx(re,{}),children:"添加API密钥"})})]})})]})]})}]})})]})}];return e.jsxs("div",{style:{padding:"20px"},children:[e.jsxs("div",{style:{marginBottom:"20px",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(N,{level:2,children:"系统管理"}),e.jsxs(F,{children:[e.jsx(v,{icon:e.jsx(le,{}),onClick:M,loading:A,children:"刷新"}),e.jsx(v,{danger:!0,icon:e.jsx(R,{}),onClick:V,children:"重启系统"})]})]}),e.jsx(E,{activeKey:H,onChange:q,items:J})]})};export{me as default};
