import{j as e,a as lt}from"./index-BEjgWUn2.js";import{a as c,k as y,s as q,u as f,w as L,T as Ce,z as de,Y as oe,aI as ct,B as Q,K as _e,v as B,l as pe,S as le,ao as Pe,P as he,aJ as Be,W as xe,G as we,y as H,X as ze,a0 as ce,_ as $e,p as be,aa as ie,aF as qe,a3 as rt,a2 as Fe,b as dt,D as Ne,g as Re,U as Ee,E as ut,a1 as ht,a8 as Ue,V as te,aK as xt,aL as pt}from"./antd-BFy_CllK.js";import{m as z}from"./monitoringService-oOnaHWPi.js";import{l as O}from"./lightweightMetricsService-DToKI_sg.js";import{s as fe}from"./systemService-9IzLEFsU.js";import{i as ve,_ as nt,a as gt,e as ft}from"./charts-C6rMyrab.js";import{g as mt}from"./vendor-DavUf6mE.js";const yt=[{value:"1h",label:"过去1小时"},{value:"6h",label:"过去6小时"},{value:"12h",label:"过去12小时"},{value:"24h",label:"过去24小时"},{value:"7d",label:"过去7天"}],{Option:Me}=de,{Text:Ve}=Ce,jt=({height:d=400,autoRefresh:i=!0,refreshInterval:r=3e3})=>{const[s,l]=c.useState({time:[],throughput:[],latency:[],errorRate:[],devices:[]}),[u,a]=c.useState(!1),[h,p]=c.useState("1h"),[g,I]=c.useState("line"),[,_]=c.useState(null),F=c.useRef(null),A=c.useRef(null),j=c.useRef(null),m=c.useRef(null),$=c.useRef(null),G=c.useRef(null),X=c.useRef(null),b=c.useRef(null),E=async()=>{try{a(!0),_(null);try{const o=await z.getDataFlowMetrics({time_range:h,limit:100});if(o.metrics&&o.metrics.length>0){const S=v(o.metrics);l(S)}else{const S=await O.getLightweightMetrics(),P=[{adapter_name:"system_metrics",device_id:"gateway",key:"throughput",data_points_per_sec:S.data.data_points_per_second,bytes_per_sec:S.data.bytes_per_second,latency_ms:S.data.average_latency_ms,error_rate:S.errors.error_rate,last_value:S.data.data_points_per_second,last_timestamp:new Date().toISOString()}],V=v(P);l(V)}}catch(o){console.warn("监控API不可用:",o);const S=await O.getLightweightMetrics(),P=[{adapter_name:"system_metrics",device_id:"gateway",key:"throughput",data_points_per_sec:S.data.data_points_per_second,bytes_per_sec:S.data.bytes_per_second,latency_ms:S.data.average_latency_ms,error_rate:S.errors.error_rate,last_value:S.data.data_points_per_second,last_timestamp:new Date().toISOString()}],V=v(P);l(V)}}catch(o){console.error("获取数据流指标失败:",o),_(o instanceof Error?o.message:"未知错误"),l({time:[],throughput:[],latency:[],errorRate:[],devices:[]})}finally{a(!1)}},C=c.useMemo(()=>{if(!s||s.throughput.length===0)return{currentThroughput:0,currentLatency:0,currentErrorRate:0,deviceCount:0};const o=s.throughput.slice(-3),S=s.latency.slice(-3),P=s.errorRate.slice(-3),V=o.length>0?o.reduce((W,Y)=>W+Y,0)/o.length:0,Z=S.length>0?S.reduce((W,Y)=>W+Y,0)/S.length:0,K=P.length>0?P.reduce((W,Y)=>W+Y,0)/P.length:0;return{currentThroughput:V,currentLatency:Z,currentErrorRate:K,deviceCount:s.devices.length}},[s]),v=o=>{const S=new Date,P=[],V=[],Z=[],K=[];if(o.length===0){for(let T=23;T>=0;T--){const N=new Date(S.getTime()-T*3e5);P.push(N.toLocaleTimeString()),V.push(0),Z.push(0),K.push(0)}return{time:P,throughput:V,latency:Z,errorRate:K,devices:[]}}if(o.length>0){const T=o.reduce((J,ee)=>J+(ee.data_points_per_sec||0),0),N=o.length>0?o.reduce((J,ee)=>J+(ee.latency_ms||0),0)/o.length:0,ae=o.length>0?o.reduce((J,ee)=>J+(ee.error_rate||0),0)/o.length:0;for(let J=23;J>=0;J--){const ee=new Date(S.getTime()-J*3e5);if(P.push(ee.toLocaleTimeString()),J<=2)V.push(T),Z.push(N),K.push(ae*100);else{const ge=.8+Math.random()*.4;V.push(T*ge),Z.push(N*ge),K.push(ae*100*ge)}}}else for(let T=23;T>=0;T--){const N=new Date(S.getTime()-T*3e5);P.push(N.toLocaleTimeString()),V.push(0),Z.push(0),K.push(0)}const W=new Map,Y=new Map;o.forEach(T=>{const N=W.get(T.device_id)||0;W.set(T.device_id,N+T.data_points_per_sec);const ae=Y.get(T.adapter_name)||0;Y.set(T.adapter_name,ae+T.data_points_per_sec)});const ke=[...Array.from(W.entries()).map(([T,N])=>({name:`设备: ${T}`,value:N})),...Array.from(Y.entries()).map(([T,N])=>({name:`适配器: ${T}`,value:N}))];return{time:P,throughput:V,latency:Z,errorRate:K,devices:ke}},R=()=>{F.current&&($.current=ve(F.current)),A.current&&(G.current=ve(A.current)),j.current&&(X.current=ve(j.current)),m.current&&(b.current=ve(m.current))},x=()=>{if($.current){const o={title:{text:"数据吞吐量",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:"{b}<br/>吞吐量: {c} 点/秒"},xAxis:{type:"category",data:s.time,axisLabel:{fontSize:10}},yAxis:{type:"value",name:"点/秒",axisLabel:{fontSize:10}},series:[{data:s.throughput,type:g,smooth:!0,areaStyle:g==="line"?{opacity:.3}:void 0,itemStyle:{color:"#1890ff"}}],grid:{left:60,right:20,top:50,bottom:40}};$.current.setOption(o)}if(G.current){const o={title:{text:"网络延迟",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:"{b}<br/>延迟: {c} ms"},xAxis:{type:"category",data:s.time,axisLabel:{fontSize:10}},yAxis:{type:"value",name:"毫秒",axisLabel:{fontSize:10}},series:[{data:s.latency,type:g,smooth:!0,areaStyle:g==="line"?{opacity:.3}:void 0,itemStyle:{color:"#52c41a"}}],grid:{left:60,right:20,top:50,bottom:40}};G.current.setOption(o)}if(X.current){const o={title:{text:"错误率",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"axis",formatter:"{b}<br/>错误率: {c}%"},xAxis:{type:"category",data:s.time,axisLabel:{fontSize:10}},yAxis:{type:"value",name:"%",max:100,axisLabel:{fontSize:10}},series:[{data:s.errorRate.map(S=>(S*100).toFixed(2)),type:g,smooth:!0,areaStyle:g==="line"?{opacity:.3}:void 0,itemStyle:{color:"#f5222d"}}],grid:{left:60,right:20,top:50,bottom:40}};X.current.setOption(o)}if(b.current){const o={title:{text:"设备数据分布",left:"center",textStyle:{fontSize:14}},tooltip:{trigger:"item",formatter:"{a}<br/>{b}: {c} ({d}%)"},legend:{bottom:10,left:"center",textStyle:{fontSize:10}},series:[{name:"设备数据量",type:"pie",radius:["40%","70%"],center:["50%","45%"],avoidLabelOverlap:!1,label:{show:!1},emphasis:{label:{show:!0,fontSize:12,fontWeight:"bold"}},data:s.devices}]};b.current.setOption(o)}},U=()=>{$.current?.resize(),G.current?.resize(),X.current?.resize(),b.current?.resize()};return c.useEffect(()=>(R(),E(),window.addEventListener("resize",U),()=>{window.removeEventListener("resize",U),$.current?.dispose(),G.current?.dispose(),X.current?.dispose(),b.current?.dispose()}),[]),c.useEffect(()=>{x()},[s,g]),c.useEffect(()=>{E()},[h]),c.useEffect(()=>{if(!i)return;const o=setInterval(E,r);return()=>clearInterval(o)},[i,r,h]),e.jsxs("div",{children:[e.jsx(y,{size:"small",style:{marginBottom:16},children:e.jsxs(q,{gutter:16,align:"middle",children:[e.jsx(f,{children:e.jsxs(L,{children:[e.jsx(Ve,{children:"时间范围:"}),e.jsx(de,{value:h,onChange:p,style:{width:120},children:yt.map(o=>e.jsx(Me,{value:o.value,children:o.label},o.value))})]})}),e.jsx(f,{children:e.jsxs(L,{children:[e.jsx(Ve,{children:"图表类型:"}),e.jsxs(de,{value:g,onChange:I,style:{width:100},children:[e.jsxs(Me,{value:"line",children:[e.jsx(oe,{})," 折线图"]}),e.jsxs(Me,{value:"bar",children:[e.jsx(ct,{})," 柱状图"]})]})]})}),e.jsx(f,{children:e.jsx(Q,{icon:e.jsx(_e,{}),onClick:E,loading:u,children:"刷新"})})]})}),e.jsxs(q,{gutter:[16,16],style:{marginBottom:16},children:[e.jsx(f,{xs:24,sm:6,children:e.jsx(y,{size:"small",children:e.jsx(B,{title:"当前吞吐量",value:C.currentThroughput.toFixed(1),suffix:"点/秒",valueStyle:{color:"#1890ff",fontSize:"18px"},prefix:"📊"})})}),e.jsx(f,{xs:24,sm:6,children:e.jsx(y,{size:"small",children:e.jsx(B,{title:"平均延迟",value:C.currentLatency.toFixed(1),suffix:"ms",valueStyle:{color:C.currentLatency>100?"#f5222d":C.currentLatency>50?"#faad14":"#52c41a",fontSize:"18px"},prefix:"⏱️"})})}),e.jsx(f,{xs:24,sm:6,children:e.jsx(y,{size:"small",children:e.jsx(B,{title:"错误率",value:C.currentErrorRate.toFixed(2),suffix:"%",valueStyle:{color:C.currentErrorRate>5?"#f5222d":C.currentErrorRate>1?"#faad14":"#52c41a",fontSize:"18px"},prefix:"⚠️"})})}),e.jsx(f,{xs:24,sm:6,children:e.jsx(y,{size:"small",children:e.jsx(B,{title:"数据源",value:C.deviceCount,suffix:"个",valueStyle:{color:"#722ed1",fontSize:"18px"},prefix:"🔗"})})})]}),e.jsxs(q,{gutter:[16,16],children:[e.jsx(f,{xs:24,lg:12,children:e.jsx(y,{size:"small",children:e.jsx("div",{ref:F,style:{height:d/2}})})}),e.jsx(f,{xs:24,lg:12,children:e.jsx(y,{size:"small",children:e.jsx("div",{ref:A,style:{height:d/2}})})}),e.jsx(f,{xs:24,lg:12,children:e.jsx(y,{size:"small",children:e.jsx("div",{ref:j,style:{height:d/2}})})}),e.jsx(f,{xs:24,lg:12,children:e.jsx(y,{size:"small",children:e.jsx("div",{ref:m,style:{height:d/2}})})})]}),s.devices.length===0&&!u&&e.jsx(pe,{message:"暂无数据流数据",description:"当前没有检测到数据流活动。请检查：1) 适配器是否正在运行；2) 设备是否正常连接；3) 数据采集是否正常工作。",type:"info",showIcon:!0,style:{marginTop:16},action:e.jsx(Q,{size:"small",onClick:E,children:"重试"})}),s.devices.length>0&&e.jsx(pe,{message:"数据流图表说明",description:"图表显示各个数据点的指标。每个适配器可能产生多个数据点，图表会聚合显示所有数据点的指标。设备分布图显示按适配器和设备分组的数据量。",type:"info",style:{marginTop:16},showIcon:!0})]})},{Title:_t,Text:k}=Ce,Ge=({autoRefresh:d=!0,refreshInterval:i=5e3,compact:r=!1})=>{const[s,l]=c.useState(null),[u,a]=c.useState(!0),[h,p]=c.useState(null),[g,I]=c.useState(null),[_,F]=c.useState(!0),A=c.useCallback(async()=>{try{p(null);const x=await O.getLightweightMetrics();console.log("Received metrics data:",x),console.log("Gateway info:",x.gateway),l(x),I(new Date),F(!0)}catch(x){p(x.message||"获取指标失败"),F(!1),console.error("Failed to fetch metrics:",x)}finally{a(!1)}},[]),j=()=>{a(!0),A()};c.useEffect(()=>{A()},[A]),c.useEffect(()=>{if(!d)return;const x=setInterval(A,i);return()=>clearInterval(x)},[d,i,A]);const m=x=>{switch(x){case"running":case"healthy":return e.jsx(be,{style:{color:"#52c41a"}});case"degraded":return e.jsx(Fe,{style:{color:"#faad14"}});case"error":case"unhealthy":return e.jsx(rt,{style:{color:"#f5222d"}});default:return e.jsx(qe,{style:{color:"#d9d9d9"}})}},$=()=>{if(!s?.system)return 0;const{memory_usage_bytes:x,heap_size_bytes:U}=s.system;return U>0?x/U*100:0},G=x=>x>.05?"#f5222d":x>.01?"#faad14":"#52c41a";if(u&&!s)return e.jsx(y,{children:e.jsxs("div",{style:{textAlign:"center",padding:"40px 0"},children:[e.jsx(le,{size:"large"}),e.jsx("div",{style:{marginTop:16},children:e.jsx(k,{children:"加载实时指标中..."})})]})});if(h&&!s)return e.jsx(y,{children:e.jsx(pe,{message:"无法获取实时指标",description:h,type:"error",showIcon:!0,action:e.jsx(Q,{size:"small",onClick:j,loading:u,children:"重试"})})});if(!s)return null;const X=[{title:"系统运行时间",value:O.formatUptime(s.system.uptime_seconds),icon:e.jsx(Pe,{}),color:"#1890ff"},{title:"内存使用率",value:`${$().toFixed(1)}%`,icon:e.jsx(Be,{}),color:$()>80?"#f5222d":"#52c41a",extra:e.jsx(he,{percent:$(),size:"small",strokeColor:$()>80?"#f5222d":"#52c41a",showInfo:!1})},{title:"CPU使用率",value:`${s.system.cpu_usage_percent.toFixed(1)}%`,icon:e.jsx(xe,{}),color:s.system.cpu_usage_percent>80?"#f5222d":"#52c41a",extra:e.jsx(he,{percent:s.system.cpu_usage_percent,size:"small",strokeColor:s.system.cpu_usage_percent>80?"#f5222d":"#52c41a",showInfo:!1})},{title:"Goroutines",value:s.system.goroutine_count,icon:e.jsx(we,{}),color:"#722ed1"}],b=[{title:"网关状态",value:s.gateway.status,icon:m(s.gateway.status),color:O.getStatusColor(s.gateway.status),valueRender:x=>e.jsx(H,{color:O.getStatusColor(String(x)),children:String(x).toUpperCase()})},{title:"活跃适配器",value:`${s.gateway.running_adapters}/${s.gateway.total_adapters}`,icon:e.jsx(ze,{}),color:"#1890ff",extra:e.jsx(he,{percent:s.gateway.total_adapters>0?s.gateway.running_adapters/s.gateway.total_adapters*100:0,size:"small",strokeColor:"#1890ff",showInfo:!1})},{title:"活跃连接器",value:`${s.gateway.running_sinks}/${s.gateway.total_sinks}`,icon:e.jsx(xe,{}),color:"#52c41a",extra:e.jsx(he,{percent:s.gateway.total_sinks>0?s.gateway.running_sinks/s.gateway.total_sinks*100:0,size:"small",strokeColor:"#52c41a",showInfo:!1})},{title:"NATS连接",value:s.gateway.nats_connected?"已连接":"未连接",icon:e.jsx(we,{}),color:s.gateway.nats_connected?"#52c41a":"#f5222d",valueRender:x=>e.jsx(ce,{status:s.gateway.nats_connected?"success":"error",text:String(x)})}],E=[{title:"数据点/秒",value:s.data.data_points_per_second.toFixed(1),icon:e.jsx(oe,{}),color:"#722ed1"},{title:"字节/秒",value:O.formatBytes(s.data.bytes_per_second),icon:e.jsx(ze,{}),color:"#13c2c2"},{title:"平均延迟",value:O.formatLatency(s.data.average_latency_ms),icon:e.jsx(Pe,{}),color:s.data.average_latency_ms>100?"#faad14":"#52c41a"},{title:"错误率",value:`${(s.errors.error_rate*100).toFixed(2)}%`,icon:e.jsx($e,{}),color:G(s.errors.error_rate)}],C=[{title:"启用规则",value:`${s.rules.enabled_rules}/${s.rules.total_rules}`,icon:e.jsx(we,{}),color:"#1890ff"},{title:"规则匹配",value:O.formatNumber(s.rules.rules_matched),icon:e.jsx(be,{}),color:"#52c41a"},{title:"动作执行",value:O.formatNumber(s.rules.actions_executed),icon:e.jsx(xe,{}),color:"#722ed1"},{title:"执行成功率",value:s.rules.actions_executed>0?`${(s.rules.actions_succeeded/s.rules.actions_executed*100).toFixed(1)}%`:"0%",icon:e.jsx(be,{}),color:"#52c41a"}],v=x=>e.jsxs(y,{size:"small",children:[e.jsx(B,{title:x.title,value:x.value,prefix:x.icon,valueStyle:{color:x.color},valueRender:x.valueRender}),x.extra&&e.jsx("div",{style:{marginTop:8},children:x.extra})]},x.title),R=(x,U,o)=>e.jsx(y,{title:e.jsxs(L,{children:[o,e.jsx("span",{children:x})]}),size:"small",style:{marginBottom:16},children:e.jsx(q,{gutter:[16,16],children:U.map((S,P)=>e.jsx(f,{xs:24,sm:12,lg:r?12:6,children:v(S)},P))})});return e.jsxs("div",{children:[e.jsx(y,{size:"small",style:{marginBottom:16},children:e.jsxs(q,{justify:"space-between",align:"middle",children:[e.jsx(f,{children:e.jsxs(L,{children:[e.jsxs(_t,{level:4,style:{margin:0},children:[e.jsx(oe,{})," 实时系统指标"]}),e.jsx(ce,{status:_?"success":"error",text:_?"在线":"离线"})]})}),e.jsx(f,{children:e.jsxs(L,{children:[g&&e.jsxs(k,{type:"secondary",children:["更新时间: ",g.toLocaleTimeString()]}),e.jsx(Q,{icon:e.jsx(_e,{}),onClick:j,loading:u,size:"small",children:"刷新"})]})})]})}),h&&e.jsx(pe,{message:"数据更新失败",description:h,type:"warning",showIcon:!0,closable:!0,style:{marginBottom:16}}),R("系统资源",X,e.jsx(Be,{})),R("网关状态",b,e.jsx(qe,{})),R("数据处理",E,e.jsx(oe,{})),R("规则引擎",C,e.jsx(xe,{})),!r&&e.jsx(y,{title:e.jsxs(L,{children:[e.jsx($e,{}),e.jsx("span",{children:"详细信息"})]}),size:"small",children:e.jsxs(q,{gutter:[16,16],children:[e.jsx(f,{xs:24,sm:12,lg:8,children:e.jsx(y,{size:"small",title:"系统信息",children:e.jsxs(L,{direction:"vertical",style:{width:"100%"},children:[e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"版本: "}),e.jsx(k,{children:s.system.version})]}),e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"Go版本: "}),e.jsx(k,{children:s.system.go_version})]}),e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"配置文件: "}),e.jsx(k,{code:!0,children:s.gateway.config_file})]}),e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"插件目录: "}),e.jsx(k,{code:!0,children:s.gateway.plugins_directory})]})]})})}),e.jsx(f,{xs:24,sm:12,lg:8,children:e.jsx(y,{size:"small",title:"连接统计",children:e.jsxs(L,{direction:"vertical",style:{width:"100%"},children:[e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"活跃连接: "}),e.jsx(k,{children:s.connections.active_connections})]}),e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"总连接数: "}),e.jsx(k,{children:O.formatNumber(s.connections.total_connections)})]}),e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"失败连接: "}),e.jsx(k,{type:"danger",children:O.formatNumber(s.connections.failed_connections)})]}),e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"重连次数: "}),e.jsx(k,{children:O.formatNumber(s.connections.reconnection_count)})]})]})})}),e.jsx(f,{xs:24,sm:12,lg:8,children:e.jsx(y,{size:"small",title:"错误统计",children:e.jsxs(L,{direction:"vertical",style:{width:"100%"},children:[e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"总错误数: "}),e.jsx(k,{type:"danger",children:O.formatNumber(s.errors.total_errors)})]}),e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"错误/秒: "}),e.jsx(k,{children:s.errors.errors_per_second.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"恢复次数: "}),e.jsx(k,{type:"success",children:O.formatNumber(s.errors.recovery_count)})]}),s.errors.last_error&&e.jsxs("div",{children:[e.jsx(k,{strong:!0,children:"最后错误: "}),e.jsx(ie,{title:s.errors.last_error,children:e.jsxs(k,{type:"danger",ellipsis:!0,children:[s.errors.last_error.substring(0,30),"..."]})})]})]})})})]})})]})};var se={},re={},De={},He;function vt(){return He||(He=1,function(d){Object.defineProperty(d,"__esModule",{value:!0}),d.default=void 0;var i=1,r=function(){return"".concat(i++)};d.default=r}(De)),De}var me={},ye={},Oe={},Ke;function at(){return Ke||(Ke=1,function(d){Object.defineProperty(d,"__esModule",{value:!0}),d.default=void 0;var i=function(s){var l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:60,u=null;return function(){for(var a=this,h=arguments.length,p=new Array(h),g=0;g<h;g++)p[g]=arguments[g];clearTimeout(u),u=setTimeout(function(){s.apply(a,p)},l)}};d.default=i}(Oe)),Oe}var ne={},We;function Ae(){if(We)return ne;We=1,Object.defineProperty(ne,"__esModule",{value:!0}),ne.SizeSensorId=ne.SensorTabIndex=ne.SensorClassName=void 0;var d="size-sensor-id";ne.SizeSensorId=d;var i="size-sensor-object";ne.SensorClassName=i;var r="-1";return ne.SensorTabIndex=r,ne}var Je;function St(){if(Je)return ye;Je=1,Object.defineProperty(ye,"__esModule",{value:!0}),ye.createSensor=void 0;var d=r(at()),i=Ae();function r(l){return l&&l.__esModule?l:{default:l}}var s=function(u,a){var h=void 0,p=[],g=function(){getComputedStyle(u).position==="static"&&(u.style.position="relative");var m=document.createElement("object");return m.onload=function(){m.contentDocument.defaultView.addEventListener("resize",I),I()},m.style.display="block",m.style.position="absolute",m.style.top="0",m.style.left="0",m.style.height="100%",m.style.width="100%",m.style.overflow="hidden",m.style.pointerEvents="none",m.style.zIndex="-1",m.style.opacity="0",m.setAttribute("class",i.SensorClassName),m.setAttribute("tabindex",i.SensorTabIndex),m.type="text/html",u.appendChild(m),m.data="about:blank",m},I=(0,d.default)(function(){p.forEach(function(j){j(u)})}),_=function(m){h||(h=g()),p.indexOf(m)===-1&&p.push(m)},F=function(){h&&h.parentNode&&(h.contentDocument&&h.contentDocument.defaultView.removeEventListener("resize",I),h.parentNode.removeChild(h),u.removeAttribute(i.SizeSensorId),h=void 0,p=[],a&&a())},A=function(m){var $=p.indexOf(m);$!==-1&&p.splice($,1),p.length===0&&h&&F()};return{element:u,bind:_,destroy:F,unbind:A}};return ye.createSensor=s,ye}var je={},Xe;function wt(){if(Xe)return je;Xe=1,Object.defineProperty(je,"__esModule",{value:!0}),je.createSensor=void 0;var d=Ae(),i=r(at());function r(l){return l&&l.__esModule?l:{default:l}}var s=function(u,a){var h=void 0,p=[],g=(0,i.default)(function(){p.forEach(function(j){j(u)})}),I=function(){var m=new ResizeObserver(g);return m.observe(u),g(),m},_=function(m){h||(h=I()),p.indexOf(m)===-1&&p.push(m)},F=function(){h.disconnect(),p=[],h=void 0,u.removeAttribute(d.SizeSensorId),a&&a()},A=function(m){var $=p.indexOf(m);$!==-1&&p.splice($,1),p.length===0&&h&&F()};return{element:u,bind:_,destroy:F,unbind:A}};return je.createSensor=s,je}var Ye;function bt(){if(Ye)return me;Ye=1,Object.defineProperty(me,"__esModule",{value:!0}),me.createSensor=void 0;var d=St(),i=wt(),r=typeof ResizeObserver<"u"?i.createSensor:d.createSensor;return me.createSensor=r,me}var Qe;function zt(){if(Qe)return re;Qe=1,Object.defineProperty(re,"__esModule",{value:!0}),re.removeSensor=re.getSensor=re.Sensors=void 0;var d=s(vt()),i=bt(),r=Ae();function s(p){return p&&p.__esModule?p:{default:p}}var l={};re.Sensors=l;function u(p){p&&l[p]&&delete l[p]}var a=function(g){var I=g.getAttribute(r.SizeSensorId);if(I&&l[I])return l[I];var _=(0,d.default)();g.setAttribute(r.SizeSensorId,_);var F=(0,i.createSensor)(g,function(){return u(_)});return l[_]=F,F};re.getSensor=a;var h=function(g){var I=g.element.getAttribute(r.SizeSensorId);g.destroy(),u(I)};return re.removeSensor=h,re}var Ze;function Ct(){if(Ze)return se;Ze=1,Object.defineProperty(se,"__esModule",{value:!0}),se.ver=se.clear=se.bind=void 0;var d=zt(),i=function(u,a){var h=(0,d.getSensor)(u);return h.bind(a),function(){h.unbind(a)}};se.bind=i;var r=function(u){var a=(0,d.getSensor)(u);(0,d.removeSensor)(a)};se.clear=r;var s="1.0.2";return se.ver=s,se}var et=Ct();function tt(d,i){var r={};return i.forEach(function(s){r[s]=d[s]}),r}function Te(d){return typeof d=="function"}function kt(d){return typeof d=="string"}var Le,st;function It(){return st||(st=1,Le=function d(i,r){if(i===r)return!0;if(i&&r&&typeof i=="object"&&typeof r=="object"){if(i.constructor!==r.constructor)return!1;var s,l,u;if(Array.isArray(i)){if(s=i.length,s!=r.length)return!1;for(l=s;l--!==0;)if(!d(i[l],r[l]))return!1;return!0}if(i.constructor===RegExp)return i.source===r.source&&i.flags===r.flags;if(i.valueOf!==Object.prototype.valueOf)return i.valueOf()===r.valueOf();if(i.toString!==Object.prototype.toString)return i.toString()===r.toString();if(u=Object.keys(i),s=u.length,s!==Object.keys(r).length)return!1;for(l=s;l--!==0;)if(!Object.prototype.hasOwnProperty.call(r,u[l]))return!1;for(l=s;l--!==0;){var a=u[l];if(!d(i[a],r[a]))return!1}return!0}return i!==i&&r!==r}),Le}var Rt=It();const ue=mt(Rt);var Et=function(d){nt(i,d);function i(r){var s=d.call(this,r)||this;return s.echarts=r.echarts,s.ele=null,s.isInitialResize=!0,s}return i.prototype.componentDidMount=function(){this.renderNewEcharts()},i.prototype.componentDidUpdate=function(r){var s=this.props.shouldSetOption;if(!(Te(s)&&!s(r,this.props))){if(!ue(r.theme,this.props.theme)||!ue(r.opts,this.props.opts)||!ue(r.onEvents,this.props.onEvents)){this.dispose(),this.renderNewEcharts();return}var l=["option","notMerge","lazyUpdate","showLoading","loadingOption"];ue(tt(this.props,l),tt(r,l))||this.updateEChartsOption(),(!ue(r.style,this.props.style)||!ue(r.className,this.props.className))&&this.resize()}},i.prototype.componentWillUnmount=function(){this.dispose()},i.prototype.getEchartsInstance=function(){return this.echarts.getInstanceByDom(this.ele)||this.echarts.init(this.ele,this.props.theme,this.props.opts)},i.prototype.dispose=function(){if(this.ele){try{et.clear(this.ele)}catch(r){console.warn(r)}this.echarts.dispose(this.ele)}},i.prototype.renderNewEcharts=function(){var r=this,s=this.props,l=s.onEvents,u=s.onChartReady,a=this.updateEChartsOption();this.bindEvents(a,l||{}),Te(u)&&u(a),this.ele&&et.bind(this.ele,function(){r.resize()})},i.prototype.bindEvents=function(r,s){function l(a,h){kt(a)&&Te(h)&&r.on(a,function(p){h(p,r)})}for(var u in s)Object.prototype.hasOwnProperty.call(s,u)&&l(u,s[u])},i.prototype.updateEChartsOption=function(){var r=this.props,s=r.option,l=r.notMerge,u=l===void 0?!1:l,a=r.lazyUpdate,h=a===void 0?!1:a,p=r.showLoading,g=r.loadingOption,I=g===void 0?null:g,_=this.getEchartsInstance();return _.setOption(s,u,h),p?_.showLoading(I):_.hideLoading(),_},i.prototype.resize=function(){var r=this.getEchartsInstance();if(!this.isInitialResize)try{r.resize()}catch(s){console.warn(s)}this.isInitialResize=!1},i.prototype.render=function(){var r=this,s=this.props,l=s.style,u=s.className,a=u===void 0?"":u,h=gt({height:300},l);return dt.createElement("div",{ref:function(p){r.ele=p},style:h,className:"echarts-for-react "+a})},i}(c.PureComponent),Mt=function(d){nt(i,d);function i(r){var s=d.call(this,r)||this;return s.echarts=ft,s}return i}(Et);const{Option:Dt}=de,{Text:Se}=Ce,Ot=({height:d=300,autoRefresh:i=!0,refreshInterval:r=5e3})=>{const[s,l]=c.useState(!1),[u,a]=c.useState(null),[h,p]=c.useState("cpu"),[g,I]=c.useState({cpu:[],memory:[],goroutines:[],dataPoints:[],errors:[]}),[_,F]=c.useState(null),A=c.useRef(null),j=async()=>{try{a(null);const b=await O.getLightweightMetrics();F(b);const E=Date.now(),C=b.system.heap_size_bytes>0?b.system.memory_usage_bytes/b.system.heap_size_bytes*100:0;I(v=>{const x=(U,o)=>[...U,{timestamp:E,value:o}].slice(-50);return{cpu:x(v.cpu,b.system.cpu_usage_percent),memory:x(v.memory,C),goroutines:x(v.goroutines,b.system.goroutine_count),dataPoints:x(v.dataPoints,b.data.data_points_per_second),errors:x(v.errors,b.errors.errors_per_second)}})}catch(b){a(b.message||"获取指标失败"),console.error("Failed to fetch metrics:",b)}},m=async()=>{l(!0),await j(),l(!1)};c.useEffect(()=>{j()},[]),c.useEffect(()=>{if(i)return A.current=setInterval(j,r),()=>{A.current&&clearInterval(A.current)}},[i,r]);const $=()=>{const b=g[h]||[],C=(v=>{switch(v){case"cpu":return{title:"CPU使用率 (%)",color:"#1890ff",yMax:100,formatter:R=>`${R.toFixed(1)}%`};case"memory":return{title:"内存使用率 (%)",color:"#52c41a",yMax:100,formatter:R=>`${R.toFixed(1)}%`};case"goroutines":return{title:"Goroutines数量",color:"#722ed1",yMax:null,formatter:R=>`${Math.round(R)}`};case"dataPoints":return{title:"数据点/秒",color:"#13c2c2",yMax:null,formatter:R=>`${R.toFixed(1)}/s`};case"errors":return{title:"错误/秒",color:"#f5222d",yMax:null,formatter:R=>`${R.toFixed(2)}/s`};default:return{title:"未知指标",color:"#d9d9d9",yMax:null,formatter:R=>`${R}`}}})(h);return{title:{text:C.title,left:"center",textStyle:{fontSize:14,fontWeight:"normal"}},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}},formatter:v=>{const R=v[0],x=new Date(R.axisValue).toLocaleTimeString(),U=C.formatter(R.value);return`${x}<br/>${C.title}: ${U}`}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:{type:"time",boundaryGap:!1,axisLabel:{formatter:v=>new Date(v).toLocaleTimeString()},splitLine:{show:!1}},yAxis:{type:"value",max:C.yMax,axisLabel:{formatter:C.formatter},splitLine:{lineStyle:{type:"dashed"}}},series:[{name:C.title,type:"line",data:b.map(v=>[v.timestamp,v.value]),smooth:!0,lineStyle:{color:C.color},itemStyle:{color:C.color},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:C.color+"40"},{offset:1,color:C.color+"10"}]}},symbol:"circle",symbolSize:4,showSymbol:!1}]}},G=[{value:"cpu",label:"CPU使用率"},{value:"memory",label:"内存使用率"},{value:"goroutines",label:"Goroutines"},{value:"dataPoints",label:"数据点/秒"},{value:"errors",label:"错误/秒"}],X=()=>{if(!_)return"N/A";switch(h){case"cpu":return`${_.system.cpu_usage_percent.toFixed(1)}%`;case"memory":return _.system.heap_size_bytes>0?`${(_.system.memory_usage_bytes/_.system.heap_size_bytes*100).toFixed(1)}%`:"N/A";case"goroutines":return`${_.system.goroutine_count}`;case"dataPoints":return`${_.data.data_points_per_second.toFixed(1)}/s`;case"errors":return`${_.errors.errors_per_second.toFixed(2)}/s`;default:return"N/A"}};return e.jsxs(y,{title:e.jsxs(L,{children:[e.jsx(oe,{}),e.jsx("span",{children:"系统指标趋势"})]}),extra:e.jsxs(L,{children:[e.jsx(de,{value:h,onChange:p,style:{width:120},size:"small",children:G.map(b=>e.jsx(Dt,{value:b.value,children:b.label},b.value))}),e.jsx(Q,{icon:e.jsx(_e,{}),onClick:m,loading:s,size:"small",children:"刷新"})]}),size:"small",children:[u&&e.jsx(pe,{message:"数据加载失败",description:u,type:"error",showIcon:!0,style:{marginBottom:16}}),e.jsx("div",{style:{marginBottom:16},children:e.jsxs(L,{children:[e.jsx(Se,{strong:!0,children:"当前值:"}),e.jsx(Se,{children:X()}),e.jsxs(Se,{type:"secondary",children:["(",g[h]?.length||0," 个数据点)"]})]})}),s&&g[h]?.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"40px 0"},children:[e.jsx(le,{size:"large"}),e.jsx("div",{style:{marginTop:16},children:e.jsx(Se,{children:"加载指标数据中..."})})]}):e.jsx(Mt,{option:$(),style:{height:d},notMerge:!0,lazyUpdate:!0})]})},Tt=[{label:"5分钟",value:"5m"},{label:"15分钟",value:"15m"},{label:"1小时",value:"1h"},{label:"6小时",value:"6h"},{label:"24小时",value:"24h"},{label:"7天",value:"7d"}],{Title:Lt,Text:D}=Ce,{Option:$t}=de,Vt=()=>{const[d,i]=c.useState(!0),[r,s]=c.useState([]),[l,u]=c.useState([]),[a,h]=c.useState(null),[p,g]=c.useState([]),[I,_]=c.useState("5m"),[F,A]=c.useState(null),[j,m]=c.useState(null),[$,G]=c.useState(!1),[X,b]=c.useState("overview"),[E,C]=c.useState(null),[v,R]=c.useState(null),[x,U]=c.useState(null),[o,S]=c.useState(null),P=!0,V=async()=>{try{const t=await O.getLightweightMetrics();S(t);const n={system_health:t.gateway.status==="running"?"healthy":"degraded",active_connections:t.connections.active_connections,total_adapters:t.gateway.total_adapters,running_adapters:t.gateway.running_adapters,healthy_adapters:t.gateway.running_adapters,total_sinks:t.gateway.total_sinks,running_sinks:t.gateway.running_sinks,healthy_sinks:t.gateway.running_sinks,total_data_points_per_sec:t.data.data_points_per_second,total_errors_per_sec:t.errors.errors_per_second,top_adapters_by_traffic:[]};h(n),console.log("从轻量级指标获取概览数据:",n)}catch(t){console.warn("轻量级指标不可用，使用默认概览数据:",t),S(null),h({system_health:"healthy",active_connections:0,total_adapters:0,running_adapters:0,healthy_adapters:0,total_sinks:0,running_sinks:0,healthy_sinks:0,total_data_points_per_sec:0,total_errors_per_sec:0,top_adapters_by_traffic:[]})}},Z=async()=>{try{const t=fe.getAuthState?fe.getAuthState():null;console.log("🔐 当前认证状态:",t);const[n,M,w]=await Promise.allSettled([fe.getStatus(),fe.getMetrics(),fe.getHealth()]);n.status==="fulfilled"?(C(n.value),console.log("✅ 系统状态加载成功:",n.value)):(console.warn("⚠️ 系统状态加载失败:",n.reason),C(null)),M.status==="fulfilled"?(R(M.value),console.log("✅ 系统指标加载成功:",M.value)):(console.warn("⚠️ 系统指标加载失败:",M.reason),R(null)),w.status==="fulfilled"?(U(w.value),console.log("✅ 健康检查加载成功:",w.value)):(console.warn("⚠️ 健康检查加载失败:",w.reason),U(null))}catch(t){console.error("❌ 系统监控数据加载失败:",t)}},K=async()=>{console.log("🚀 MonitoringPage loadData 开始");try{i(!0),console.log("📊 加载轻量级指标数据和系统监控数据..."),await Promise.all([V(),Z()]);try{console.log("🔍 开始加载插件数据...");const t=await z.getPlugins();console.log("✅ 插件数据加载完成:",t);const n=[...t.adapters].sort((w,Ie)=>w.name.localeCompare(Ie.name)),M=[...t.sinks].sort((w,Ie)=>w.name.localeCompare(Ie.name));s(n),u(M),console.log("📊 设置状态:",{adapters:t.adapters.length,sinks:t.sinks.length});try{const w=await z.getDataFlowMetrics({time_range:I});w.metrics&&w.metrics.length>0?(g(w.metrics),console.log("数据流指标获取成功:",w.metrics.length,"个数据流"),console.log("数据流详情:",w.metrics)):(g([]),console.log("当前没有数据流数据，API返回:",w))}catch(w){console.warn("数据流指标获取失败:",w),g([])}}catch(t){console.error("❌ 插件API调用失败:",t),te.error("获取插件数据失败: "+t.message),s([]),u([]),g([])}}catch(t){console.error("❌ 加载监控数据失败:",t),te.error("加载监控数据失败: "+t.message)}finally{i(!1)}},W=async()=>{await K(),te.success("数据已刷新")},Y=async t=>{try{const n=await z.testAdapterConnection(t);n.success?te.success(`${t} 连接测试成功`):te.error(`${t} 连接测试失败: ${n.error}`)}catch(n){te.error("连接测试失败: "+n.message)}},ke=async t=>{Ue.confirm({title:"确认重启",content:`确定要重启适配器 "${t}" 吗？`,onOk:async()=>{try{await z.restartAdapter(t),te.success("重启请求已提交"),setTimeout(K,2e3)}catch(n){te.error("重启失败: "+n.message)}}})},T=async t=>{try{A(t);const n=await z.getAdapterDiagnostics(t);m(n),G(!0)}catch(n){te.error("获取诊断信息失败: "+n.message)}},{isAuthenticated:N,isInitialized:ae}=lt();c.useEffect(()=>{ae?(console.log("🔐 认证状态已初始化，开始加载数据:",{isAuthenticated:N,isInitialized:ae}),K()):console.log("⏳ 等待认证状态初始化...")},[ae,N]),c.useEffect(()=>{I&&z.getDataFlowMetrics({time_range:I}).then(t=>{g(t.metrics),console.log("数据流指标已更新:",t.metrics)}).catch(t=>{console.error("获取数据流指标失败:",t),O.getLightweightMetrics().then(n=>{const M=new Date,w=[{adapter_name:"system_metrics",device_id:"gateway",key:"data_throughput",data_points_per_sec:n.data.data_points_per_second,bytes_per_sec:n.data.bytes_per_second,latency_ms:n.data.average_latency_ms,error_rate:n.errors.error_rate,last_value:n.data.data_points_per_second,last_timestamp:M.toISOString()}];g(w),console.log("使用轻量级指标作为数据流后备数据")}).catch(n=>{console.error("轻量级指标也失败:",n),g([])})})},[I]),c.useEffect(()=>{},[P]);const J=t=>{switch(t){case"healthy":return e.jsx(be,{style:{color:"#52c41a"}});case"degraded":return e.jsx(Fe,{style:{color:"#faad14"}});case"unhealthy":return e.jsx(rt,{style:{color:"#f5222d"}});default:return e.jsx(Re,{style:{color:"#d9d9d9"}})}},ee=[{title:"名称",dataIndex:"name",key:"name",render:(t,n)=>e.jsxs(L,{children:[e.jsx("span",{style:{fontSize:"16px"},children:z.getAdapterIcon(n.type)}),e.jsx(D,{strong:!0,children:t})]})},{title:"类型",dataIndex:"type",key:"type",render:t=>e.jsx(H,{children:t.toUpperCase()})},{title:"状态",dataIndex:"status",key:"status",render:t=>e.jsx(ce,{status:z.getStatusColor(t),text:z.getStatusText(t)})},{title:"健康状态",dataIndex:"health",key:"health",render:(t,n)=>e.jsx(ie,{title:n.health_message,children:e.jsx(H,{color:z.getHealthColor(t),children:z.getHealthText(t)})})},{title:"运行时间",dataIndex:"connection_uptime",key:"connection_uptime",render:t=>z.formatUptime(t)},{title:"数据点",dataIndex:"data_points_count",key:"data_points_count",render:t=>z.formatNumber(t)},{title:"错误数",dataIndex:"errors_count",key:"errors_count",render:(t,n)=>{const M=n.data_points_count>0?(t/n.data_points_count*100).toFixed(2):"0";return e.jsx(ie,{title:`错误率: ${M}%`,children:e.jsx(D,{type:t>0?"danger":"secondary",children:t})})}},{title:"响应时间",dataIndex:"response_time_ms",key:"response_time_ms",render:t=>z.formatLatency(t)},{title:"操作",key:"actions",render:(t,n)=>e.jsxs(L,{size:"small",children:[e.jsx(ie,{title:"测试连接",children:e.jsx(Q,{size:"small",icon:e.jsx(xt,{}),onClick:()=>Y(n.name),disabled:n.status!=="running"})}),e.jsx(ie,{title:"诊断",children:e.jsx(Q,{size:"small",icon:e.jsx($e,{}),onClick:()=>T(n.name)})}),e.jsx(ie,{title:"重启",children:e.jsx(Q,{size:"small",icon:e.jsx(pt,{}),onClick:()=>ke(n.name),disabled:n.status==="stopped",danger:!0})})]})}],ge=[{title:"名称",dataIndex:"name",key:"name",render:(t,n)=>e.jsxs(L,{children:[e.jsx("span",{style:{fontSize:"16px"},children:z.getSinkIcon(n.type)}),e.jsx(D,{strong:!0,children:t})]})},{title:"类型",dataIndex:"type",key:"type",render:t=>e.jsx(H,{children:t.toUpperCase()})},{title:"状态",dataIndex:"status",key:"status",render:t=>e.jsx(ce,{status:z.getStatusColor(t),text:z.getStatusText(t)})},{title:"健康状态",dataIndex:"health",key:"health",render:(t,n)=>e.jsx(ie,{title:n.health_message,children:e.jsx(H,{color:z.getHealthColor(t),children:z.getHealthText(t)})})},{title:"运行时间",dataIndex:"connection_uptime",key:"connection_uptime",render:t=>z.formatUptime(t)},{title:"消息发布",dataIndex:"messages_published",key:"messages_published",render:t=>z.formatNumber(t)},{title:"错误数",dataIndex:"errors_count",key:"errors_count",render:t=>e.jsx(D,{type:t>0?"danger":"secondary",children:t})},{title:"响应时间",dataIndex:"response_time_ms",key:"response_time_ms",render:t=>z.formatLatency(t)}],it=[{title:"适配器",dataIndex:"adapter_name",key:"adapter_name",render:t=>{const n=r.find(M=>M.name===t);return e.jsxs(L,{children:[e.jsx("span",{style:{fontSize:"16px"},children:n?z.getAdapterIcon(n.type):"📱"}),e.jsx(D,{strong:!0,children:t})]})}},{title:"设备ID",dataIndex:"device_id",key:"device_id",render:t=>e.jsx(H,{color:"blue",children:t})},{title:"数据键",dataIndex:"key",key:"key",render:t=>e.jsx(D,{code:!0,children:t})},{title:"数据点/秒",dataIndex:"data_points_per_sec",key:"data_points_per_sec",render:t=>e.jsx(B,{value:t.toFixed(1),valueStyle:{fontSize:"14px",color:t>0?"#1890ff":"#999"},suffix:"点/秒"})},{title:"字节/秒",dataIndex:"bytes_per_sec",key:"bytes_per_sec",render:t=>e.jsx(D,{style:{color:t>0?"#52c41a":"#999"},children:z.formatBytes(t)})},{title:"延迟",dataIndex:"latency_ms",key:"latency_ms",render:t=>e.jsx(H,{color:t>100?"red":t>50?"orange":"green",children:z.formatLatency(t)})},{title:"错误率",dataIndex:"error_rate",key:"error_rate",render:t=>e.jsxs(D,{type:t>.05?"danger":t>.01?"warning":"success",children:[(t*100).toFixed(2),"%"]})},{title:"最后数值",dataIndex:"last_value",key:"last_value",render:(t,n)=>{if(!t)return e.jsx(D,{type:"secondary",children:"-"});const M=typeof t=="number"?t.toFixed(2):JSON.stringify(t);return e.jsx(ie,{title:`时间: ${new Date(n.last_timestamp).toLocaleString()}`,children:e.jsx(D,{code:!0,style:{fontSize:"12px"},children:M})})}}],ot=[{key:"overview",label:e.jsxs("span",{children:[e.jsx(Re,{}),"系统概览"]}),children:e.jsxs("div",{children:[e.jsx(Ge,{autoRefresh:!0,refreshInterval:5e3}),a&&e.jsxs(q,{gutter:[24,24],style:{marginBottom:24},children:[e.jsx(f,{xs:24,sm:12,lg:6,children:e.jsx(y,{children:e.jsx(B,{title:"系统健康",value:a.system_health,prefix:J(a.system_health),valueStyle:{color:a.system_health==="healthy"?"#52c41a":a.system_health==="degraded"?"#faad14":"#f5222d"}})})}),e.jsx(f,{xs:24,sm:12,lg:6,children:e.jsx(y,{children:e.jsx(B,{title:"活跃连接",value:a.active_connections,prefix:e.jsx(we,{}),suffix:`/ ${a.total_adapters+a.total_sinks}`,valueStyle:{color:"#1890ff"}})})}),e.jsx(f,{xs:24,sm:12,lg:6,children:e.jsx(y,{children:e.jsx(B,{title:"数据点/秒",value:a.total_data_points_per_sec.toFixed(1),prefix:e.jsx(oe,{}),valueStyle:{color:"#722ed1"}})})}),e.jsx(f,{xs:24,sm:12,lg:6,children:e.jsx(y,{children:e.jsx(B,{title:"错误/秒",value:a.total_errors_per_sec.toFixed(2),prefix:e.jsx(Fe,{}),valueStyle:{color:a.total_errors_per_sec>0?"#f5222d":"#52c41a"}})})})]}),a&&e.jsxs(q,{gutter:[24,24],children:[e.jsx(f,{xs:24,lg:12,children:e.jsxs(y,{title:"适配器状态",size:"small",children:[e.jsxs(q,{gutter:16,children:[e.jsx(f,{span:8,children:e.jsx(B,{title:"总数",value:a.total_adapters,prefix:e.jsx(ze,{})})}),e.jsx(f,{span:8,children:e.jsx(B,{title:"运行中",value:a.running_adapters,valueStyle:{color:"#1890ff"}})}),e.jsx(f,{span:8,children:e.jsx(B,{title:"健康",value:a.healthy_adapters,valueStyle:{color:"#52c41a"}})})]}),e.jsx(Ne,{}),e.jsx(he,{percent:a.total_adapters>0?a.healthy_adapters/a.total_adapters*100:0,strokeColor:"#52c41a",format:()=>`${a.healthy_adapters}/${a.total_adapters} 健康`})]})}),e.jsx(f,{xs:24,lg:12,children:e.jsxs(y,{title:"连接器状态",size:"small",children:[e.jsxs(q,{gutter:16,children:[e.jsx(f,{span:8,children:e.jsx(B,{title:"总数",value:a.total_sinks,prefix:e.jsx(xe,{})})}),e.jsx(f,{span:8,children:e.jsx(B,{title:"运行中",value:a.running_sinks,valueStyle:{color:"#1890ff"}})}),e.jsx(f,{span:8,children:e.jsx(B,{title:"健康",value:a.healthy_sinks,valueStyle:{color:"#52c41a"}})})]}),e.jsx(Ne,{}),e.jsx(he,{percent:a.total_sinks>0?a.healthy_sinks/a.total_sinks*100:0,strokeColor:"#52c41a",format:()=>`${a.healthy_sinks}/${a.total_sinks} 健康`})]})})]})]})},{key:"adapters",label:e.jsxs("span",{children:[e.jsx(ze,{}),"适配器监控",r.filter(t=>t.status==="error").length>0&&e.jsx(ce,{count:r.filter(t=>t.status==="error").length,style:{marginLeft:8}})]}),children:e.jsx(y,{children:e.jsx(Ee,{columns:ee,dataSource:r,rowKey:"name",loading:d,pagination:{pageSize:10},scroll:{x:1200}})})},{key:"sinks",label:e.jsxs("span",{children:[e.jsx(xe,{}),"连接器监控",l.filter(t=>t.status==="error").length>0&&e.jsx(ce,{count:l.filter(t=>t.status==="error").length,style:{marginLeft:8}})]}),children:e.jsx(y,{children:e.jsx(Ee,{columns:ge,dataSource:l,rowKey:"name",loading:d,pagination:{pageSize:10},scroll:{x:1e3}})})},{key:"metrics",label:e.jsxs("span",{children:[e.jsx(oe,{}),"系统指标"]}),children:e.jsxs("div",{children:[e.jsxs(q,{gutter:[16,16],style:{marginBottom:24},children:[e.jsx(f,{xs:24,lg:8,children:e.jsx(y,{title:"系统基本信息",size:"small",children:E?e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"状态:"})," ",e.jsx(H,{color:E.status==="running"?"green":"red",children:E.status})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"版本:"})," ",E.version]}),e.jsxs("p",{children:[e.jsx("strong",{children:"运行时间:"})," ",E.uptime]}),e.jsxs("p",{children:[e.jsx("strong",{children:"启动时间:"})," ",new Date(E.start_time).toLocaleString()]})]}):e.jsx(le,{size:"small"})})}),e.jsx(f,{xs:24,lg:8,children:e.jsx(y,{title:"系统资源",size:"small",children:o?e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"内存使用:"})," ",O.formatBytes(o.system.memory_usage_bytes)," / 堆内存: ",O.formatBytes(o.system.heap_in_use_bytes)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"CPU使用率:"})," ",o.system.cpu_usage_percent.toFixed(1),"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"磁盘使用率:"})," ",o.system.disk_usage_percent.toFixed(1),"%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"协程数:"})," ",o.system.goroutine_count]})]}):v?e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"CPU使用率:"})," ",v.cpu_usage?v.cpu_usage.toFixed(1):"0.0","%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"内存使用率:"})," ",v.memory_usage?v.memory_usage.toFixed(1):"0.0","%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"磁盘使用率:"})," ",v.disk_usage?v.disk_usage.toFixed(1):"0.0","%"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"数据吞吐:"})," ",v.data_points_per_second||0," 点/秒"]})]}):e.jsxs("div",{children:[e.jsx(le,{size:"small"}),e.jsx("p",{style:{color:"#999",fontSize:"12px",marginTop:"8px"},children:"正在加载系统资源数据..."})]})})}),e.jsx(f,{xs:24,lg:8,children:e.jsx(y,{title:"连接状态",size:"small",children:o?e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"活跃连接:"})," ",o.connections.active_connections]}),e.jsxs("p",{children:[e.jsx("strong",{children:"总连接数:"})," ",o.connections.total_connections]}),e.jsxs("p",{children:[e.jsx("strong",{children:"失败连接:"})," ",o.connections.failed_connections]}),e.jsxs("p",{children:[e.jsx("strong",{children:"平均响应:"})," ",o.connections.average_response_time_ms.toFixed(1)," ms"]})]}):E?e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"活跃连接:"})," ",E.active_connections||0]}),e.jsxs("p",{children:[e.jsx("strong",{children:"总连接数:"})," ",E.total_connections||0]}),e.jsxs("p",{children:[e.jsx("strong",{children:"网络接收:"})," ",E.network_in?O.formatBytes(E.network_in):"0 B"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"网络发送:"})," ",E.network_out?O.formatBytes(E.network_out):"0 B"]})]}):e.jsxs("div",{children:[e.jsx(le,{size:"small"}),e.jsx("p",{style:{color:"#999",fontSize:"12px",marginTop:"8px"},children:"正在加载连接状态数据..."})]})})})]}),x&&e.jsx(q,{gutter:[16,16],style:{marginBottom:24},children:e.jsx(f,{span:24,children:e.jsxs(y,{title:"系统健康检查",size:"small",children:[e.jsxs("div",{style:{marginBottom:16},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"服务:"})," ",x.service]}),e.jsxs("p",{children:[e.jsx("strong",{children:"整体状态:"})," ",e.jsx(H,{color:x.status==="healthy"?"green":"red",children:x.status})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"检查时间:"})," ",new Date(x.timestamp).toLocaleString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"版本:"})," ",x.version]})]}),x.checks&&x.checks.length>0&&e.jsxs("div",{children:[e.jsx("strong",{children:"健康检查项:"}),e.jsx("div",{style:{marginTop:8},children:x.checks.map((t,n)=>e.jsxs(H,{color:t.status==="pass"?"green":t.status==="warn"?"orange":"red",style:{marginBottom:4},children:[t.name,": ",t.status," (",t.duration,"ms)"]},n))})]})]})})}),o&&e.jsxs(q,{gutter:[16,16],style:{marginBottom:24},children:[e.jsx(f,{xs:24,lg:12,children:e.jsx(y,{title:"数据处理指标",size:"small",children:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"总数据点:"})," ",O.formatNumber(o.data.total_data_points)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"处理速度:"})," ",o.data.data_points_per_second.toFixed(2)," 点/秒"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"数据流量:"})," ",O.formatBytes(o.data.bytes_per_second),"/秒"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"队列长度:"})," ",o.data.data_queue_length]})]})})}),e.jsx(f,{xs:24,lg:12,children:e.jsx(y,{title:"规则引擎状态",size:"small",children:e.jsxs("div",{children:[e.jsxs("p",{children:[e.jsx("strong",{children:"状态:"})," ",e.jsx(H,{color:o.rules.rule_engine_status==="running"?"green":o.rules.rule_engine_status===""?"orange":"red",children:o.rules.rule_engine_status||"未知"})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"规则总数:"})," ",o.rules.total_rules]}),e.jsxs("p",{children:[e.jsx("strong",{children:"启用规则:"})," ",o.rules.enabled_rules]}),e.jsxs("p",{children:[e.jsx("strong",{children:"执行动作:"})," ",o.rules.actions_executed]})]})})})]}),e.jsx(Ot,{height:400,autoRefresh:!0,refreshInterval:5e3}),e.jsx("div",{style:{marginTop:16},children:e.jsx(Ge,{autoRefresh:!0,refreshInterval:5e3,compact:!0})})]})},{key:"dataflow",label:e.jsxs("span",{children:[e.jsx(oe,{}),"数据流监控"]}),children:e.jsxs("div",{children:[e.jsx(jt,{height:400,autoRefresh:!0,refreshInterval:3e3}),e.jsxs(y,{title:"数据流详情",style:{marginTop:16},children:[e.jsx("div",{style:{marginBottom:16},children:e.jsxs(L,{children:[e.jsx(D,{children:"时间范围:"}),e.jsx(de,{value:I,onChange:_,style:{width:120},children:Tt.map(t=>e.jsx($t,{value:t.value,children:t.label},t.value))}),e.jsx(Q,{icon:e.jsx(_e,{}),onClick:W,children:"刷新"})]})}),p.length>0?e.jsxs(e.Fragment,{children:[e.jsx(pe,{message:"数据流说明",description:"每行显示一个数据点的指标。如果一个适配器配置了多个数据点（如温度、湿度），每个数据点都会单独显示。数据点/秒表示该特定数据点的生成频率。",type:"info",style:{marginBottom:16},showIcon:!0}),e.jsx(y,{title:"适配器聚合统计",size:"small",style:{marginBottom:16},children:e.jsx(q,{gutter:16,children:(()=>{const t=p.reduce((n,M)=>{const w=M.adapter_name;return n[w]||(n[w]={name:w,device_id:M.device_id,totalPoints:0,totalBytes:0,dataPointCount:0,avgLatency:0,avgErrorRate:0,keys:[]}),n[w].totalPoints+=M.data_points_per_sec,n[w].totalBytes+=M.bytes_per_sec,n[w].dataPointCount++,n[w].avgLatency+=M.latency_ms,n[w].avgErrorRate+=M.error_rate,n[w].keys.push(M.key),n},{});return Object.values(t).map(n=>e.jsx(f,{xs:24,sm:12,lg:8,children:e.jsxs(y,{size:"small",style:{marginBottom:8},children:[e.jsxs(L,{children:[e.jsx("span",{style:{fontSize:"16px"},children:r.find(M=>M.name===n.name)?.type==="mock"?"🎭":"📱"}),e.jsx(D,{strong:!0,children:n.name})]}),e.jsxs("div",{style:{marginTop:8,fontSize:"12px"},children:[e.jsxs("div",{children:["设备: ",e.jsx(D,{code:!0,children:n.device_id})]}),e.jsxs("div",{children:["数据点: ",e.jsx(D,{code:!0,children:n.keys.join(", ")})]}),e.jsxs("div",{children:["总频率: ",e.jsxs(D,{type:"success",children:[n.totalPoints.toFixed(1)," 点/秒"]})]}),e.jsxs("div",{children:["平均延迟: ",e.jsxs(D,{children:[(n.avgLatency/n.dataPointCount).toFixed(1)," ms"]})]})]})]})},n.name))})()})}),e.jsx(Ee,{columns:it,dataSource:p,rowKey:t=>`${t.adapter_name}-${t.device_id}-${t.key}`,pagination:{pageSize:10},scroll:{x:1e3},expandable:{expandedRowRender:t=>e.jsx("div",{style:{padding:"16px",background:"#fafafa"},children:e.jsxs(q,{gutter:16,children:[e.jsxs(f,{span:12,children:[e.jsx("strong",{children:"数据点详情："}),e.jsxs("ul",{style:{marginTop:8},children:[e.jsxs("li",{children:["适配器: ",t.adapter_name]}),e.jsxs("li",{children:["设备ID: ",t.device_id]}),e.jsxs("li",{children:["数据键: ",t.key]}),e.jsxs("li",{children:["最后更新: ",new Date(t.last_timestamp).toLocaleString()]})]})]}),e.jsxs(f,{span:12,children:[e.jsx("strong",{children:"性能指标："}),e.jsxs("ul",{style:{marginTop:8},children:[e.jsxs("li",{children:["数据点频率: ",t.data_points_per_sec.toFixed(2)," 点/秒"]}),e.jsxs("li",{children:["数据传输: ",z.formatBytes(t.bytes_per_sec),"/秒"]}),e.jsxs("li",{children:["网络延迟: ",t.latency_ms.toFixed(1)," ms"]}),e.jsxs("li",{children:["错误率: ",(t.error_rate*100).toFixed(2),"%"]})]})]})]})}),expandRowByClick:!0}})]}):e.jsx(ut,{description:"暂无数据流数据"})]})]})}];return d&&!r.length&&!l.length&&!a?e.jsx("div",{style:{textAlign:"center",padding:"50px"},children:e.jsx(le,{size:"large",tip:"加载监控数据中..."})}):e.jsxs("div",{children:[e.jsxs(q,{justify:"space-between",align:"middle",style:{marginBottom:24},children:[e.jsxs(f,{children:[e.jsxs(Lt,{level:2,style:{margin:0},children:[e.jsx(Re,{})," 连接监控"]}),e.jsx(D,{type:"secondary",children:"实时监控适配器和连接器状态"})]}),e.jsx(f,{children:e.jsxs(L,{children:[e.jsx(ce,{status:"success",text:"WebSocket已连接"}),e.jsx(Q,{icon:e.jsx(_e,{}),onClick:W,loading:d,children:"刷新数据"})]})})]}),!P,e.jsx(ht,{activeKey:X,onChange:b,items:ot,size:"large"}),e.jsx(Ue,{title:`适配器诊断 - ${F}`,open:$,onCancel:()=>G(!1),footer:[e.jsx(Q,{onClick:()=>G(!1),children:"关闭"},"close")],width:800,children:j?e.jsxs("div",{children:[j.connection_test&&e.jsx(y,{title:"连接测试",size:"small",style:{marginBottom:16},children:e.jsxs(L,{direction:"vertical",style:{width:"100%"},children:[e.jsxs("div",{children:[e.jsx(D,{strong:!0,children:"状态: "}),e.jsx(H,{color:j.connection_test.success?"success":"error",children:j.connection_test.success?"成功":"失败"})]}),e.jsxs("div",{children:[e.jsx(D,{strong:!0,children:"响应时间: "}),e.jsxs(D,{children:[j.connection_test.response_time,"ms"]})]}),j.connection_test.error&&e.jsxs("div",{children:[e.jsx(D,{strong:!0,children:"错误: "}),e.jsx(D,{type:"danger",children:j.connection_test.error})]})]})}),j.health_checks.length>0&&e.jsx(y,{title:"健康检查",size:"small",style:{marginBottom:16},children:e.jsx(L,{direction:"vertical",style:{width:"100%"},children:j.health_checks.map((t,n)=>e.jsx("div",{children:e.jsxs(L,{children:[e.jsx(H,{color:t.status==="pass"?"success":t.status==="warn"?"warning":"error",children:t.check_name}),e.jsx(D,{children:t.message}),e.jsxs(D,{type:"secondary",children:["(",t.duration,"ms)"]})]})},n))})}),j.performance_test&&e.jsx(y,{title:"性能测试",size:"small",style:{marginBottom:16},children:e.jsxs(q,{gutter:16,children:[e.jsx(f,{span:12,children:e.jsx(B,{title:"吞吐量",value:j.performance_test.throughput_per_sec,suffix:"ops/sec"})}),e.jsx(f,{span:12,children:e.jsx(B,{title:"平均延迟",value:j.performance_test.avg_latency,suffix:"ns"})})]})}),j.recommendations.length>0&&e.jsx(y,{title:"优化建议",size:"small",children:e.jsx("ul",{children:j.recommendations.map((t,n)=>e.jsx("li",{children:t},n))})})]}):e.jsx(le,{})})]})};export{Vt as default};
