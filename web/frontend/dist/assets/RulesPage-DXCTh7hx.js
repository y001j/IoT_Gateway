import{c as ge,j as e}from"./index-BEjgWUn2.js";import{a6 as $t,l as P,af as ce,ag as lt,U as Vt,w as p,k as I,T as pe,y as g,D as st,Z as Ft,ah as Me,ai as _e,aj as se,ak as Jt,a as b,F as u,z as O,B as E,a5 as $e,aa as oe,al as Ce,I as B,s as Z,u as R,am as W,ae as Ee,N as he,a8 as Te,W as at,h as be,f as na,an as oa,g as ca,ao as da,a1 as ke,ap as qt,aq as Bt,p as me,ar as vt,as as rt,at as pa,au as ua,Y as xa,a9 as ha,V as Y,b as Ht,H as jt,av as dt,aw as kt,ax as de,$ as De,X as pt,ab as Ie,ay as Ve,az as ma,a7 as je,ac as ya,aA as ga,aB as ut,aC as zt,aD as va,ad as ja}from"./antd-BFy_CllK.js";import"./vendor-DavUf6mE.js";const ve={async getRules(h){return(await ge.get("/plugins/rules",{params:h,headers:{"Cache-Control":"no-cache",Pragma:"no-cache","If-Modified-Since":"0"}})).data.data},async getRule(h){return(await ge.get(`/plugins/rules/${h}`,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache","If-Modified-Since":"0"}})).data.data},async createRule(h){return(await ge.post("/plugins/rules",h)).data.data},async updateRule(h,v){return(await ge.put(`/plugins/rules/${h}`,v)).data.data},async deleteRule(h){await ge.delete(`/plugins/rules/${h}`)},async enableRule(h){await ge.post(`/plugins/rules/${h}/enable`)},async disableRule(h){await ge.post(`/plugins/rules/${h}/disable`)},async validateRule(h){return(await ge.post("/plugins/rules/validate",h)).data.data},async testRule(h){return(await ge.post("/plugins/rules/test",h)).data.data},async getRuleTemplates(){return(await ge.get("/plugins/rules/templates")).data.data}},{Title:ie,Text:Ae,Paragraph:xe}=pe,{Panel:Se}=lt,fa=({visible:h,onClose:v})=>{const M=[{type:"simple",name:"简单条件",description:"基于单个字段的条件判断",example:{type:"simple",field:"temperature",operator:"gt",value:30}},{type:"and",name:"逻辑与",description:"所有子条件都必须满足",example:{type:"and",and:[{type:"simple",field:"temperature",operator:"gt",value:20},{type:"simple",field:"humidity",operator:"lt",value:80}]}},{type:"or",name:"逻辑或",description:"任意一个子条件满足即可",example:{type:"or",or:[{type:"simple",field:"status",operator:"eq",value:"error"},{type:"simple",field:"status",operator:"eq",value:"warning"}]}},{type:"expression",name:"表达式",description:"使用增强表达式引擎进行复杂判断，支持数学函数和内置函数",example:{type:"expression",expression:'abs(value - 25) > 5 && contains(device_id, "sensor") && len(device_id) > 5'}}],c=[{op:"eq",name:"等于",description:"字段值等于指定值"},{op:"ne",name:"不等于",description:"字段值不等于指定值"},{op:"gt",name:"大于",description:"字段值大于指定值（数值比较）"},{op:"gte",name:"大于等于",description:"字段值大于等于指定值"},{op:"lt",name:"小于",description:"字段值小于指定值"},{op:"lte",name:"小于等于",description:"字段值小于等于指定值"},{op:"contains",name:"包含",description:"字段值包含指定子字符串"},{op:"startswith",name:"开始于",description:"字段值以指定字符串开始"},{op:"endswith",name:"结束于",description:"字段值以指定字符串结束"},{op:"regex",name:"正则匹配",description:"字段值匹配正则表达式（支持缓存）"},{op:"in",name:"在范围内",description:"字段值在指定数组中"},{op:"exists",name:"字段存在",description:"检查字段是否存在"}],C=[{type:"alert",name:"告警",icon:e.jsx(Ft,{style:{color:"#ff4d4f"}}),description:"发送告警通知",config:{level:"warning | error | info | critical",message:"告警消息模板，支持变量 {{.DeviceID}}, {{.Key}}, {{.Value}}",channels:"通道配置数组，支持console, webhook, email, sms, nats",throttle:'限流时间，如 "5m"'},example:{type:"alert",config:{level:"warning",message:"设备{{.DeviceID}}温度异常: {{.Value}}°C",channels:[{type:"console",enabled:!0},{type:"nats",enabled:!0,config:{subject:"iot.alerts.temperature"}}]}}},{type:"transform",name:"数据转换",icon:e.jsx(Me,{style:{color:"#1890ff"}}),description:"增强的数据转换处理，支持表达式计算和NATS发布",config:{type:"scale | offset | expression | unit_convert | lookup | format",parameters:"转换参数配置",output_key:"输出字段名",publish_subject:"NATS发布主题（可选）",precision:"数值精度"},example:{type:"transform",config:{type:"expression",parameters:{expression:"(value - 32) * 5 / 9"},output_key:"celsius_temp",output_type:"float",precision:2,publish_subject:"iot.data.converted"}}},{type:"filter",name:"数据过滤",icon:e.jsx(_e,{style:{color:"#722ed1"}}),description:"过滤或丢弃数据",config:{type:"range | dedup | rate_limit",drop_on_match:"匹配时是否丢弃数据",pass_on_match:"匹配时是否通过数据"},example:{type:"filter",config:{type:"range",min:0,max:100,drop_on_match:!1}}},{type:"aggregate",name:"数据聚合",icon:e.jsx(se,{style:{color:"#52c41a"}}),description:"对数据进行聚合计算",config:{window_type:"time | count",window_size:"窗口大小",functions:"聚合函数，支持28个函数：基础统计(count,sum,avg,min,max)、百分位数(p25,p50,p75,p90,p95,p99)、数据质量(null_rate,completeness)、变化检测(change,change_rate)、阈值监控(above_count,below_count)等",group_by:"分组字段",output_key:"输出字段名",upper_limit:"上限阈值（用于阈值监控函数）",lower_limit:"下限阈值（用于阈值监控函数）",outlier_threshold:"异常值阈值（用于outlier_count函数）"},example:{type:"aggregate",config:{window_type:"count",window_size:10,functions:["avg","max","min","p90","null_rate"],group_by:["device_id"],output_key:"aggregated_value",upper_limit:100,lower_limit:0,forward:!0}}},{type:"forward",name:"数据转发",icon:e.jsx(Jt,{style:{color:"#fa8c16"}}),description:"简化的NATS数据转发，专注于消息总线转发",config:{subject:"NATS主题，支持变量模板",include_metadata:"是否包含元数据",transform_data:"数据转换配置"},example:{type:"forward",config:{subject:"iot.data.processed.{{.DeviceID}}",include_metadata:!0,transform_data:{add_timestamp:!0,add_rule_info:!0}}}}],V=[{field:"device_id",description:"设备ID标识符"},{field:"key",description:"数据点键名，如 temperature, humidity"},{field:"value",description:"数据点数值"},{field:"timestamp",description:"数据时间戳"},{field:"tags",description:"设备标签信息"},{field:"quality",description:"数据质量标识"},{field:"unit",description:"数据单位"},{field:"latitude",description:"纬度 (-90 ~ 90)"},{field:"longitude",description:"经度 (-180 ~ 180)"},{field:"altitude",description:"海拔高度 (米)"},{field:"accuracy",description:"GPS定位精度 (米)"},{field:"speed",description:"移动速度 (km/h)"},{field:"heading",description:"方向角 (度)"},{field:"elevation_category",description:"海拔等级分类"},{field:"speed_category",description:"速度等级分类"},{field:"x",description:"X轴数值"},{field:"y",description:"Y轴数值"},{field:"z",description:"Z轴数值"},{field:"magnitude",description:"向量模长/幅度"},{field:"x_ratio",description:"X轴比例分量"},{field:"y_ratio",description:"Y轴比例分量"},{field:"z_ratio",description:"Z轴比例分量"},{field:"dominant_axis",description:"主导轴 (x/y/z)"},{field:"r",description:"红色分量 (0-255)"},{field:"g",description:"绿色分量 (0-255)"},{field:"b",description:"蓝色分量 (0-255)"},{field:"a",description:"透明度 (0-255)"},{field:"hue",description:"色相 (0-360度)"},{field:"saturation",description:"饱和度 (0-1)"},{field:"lightness",description:"亮度 (0-1)"},{field:"dimension",description:"向量维度"},{field:"size",description:"数组大小"},{field:"length",description:"数据长度"},{field:"rows",description:"矩阵行数"},{field:"cols",description:"矩阵列数"},{field:"norm",description:"向量范数/模长"},{field:"dominant_dimension",description:"主导维度索引"},{field:"data_type",description:"元素数据类型"},{field:"numeric_count",description:"数值元素数量"},{field:"null_count",description:"空值数量"},{field:"duration",description:"时间序列总时长"},{field:"avg_interval",description:"平均采样间隔"},{field:"trend",description:"趋势方向 (increasing/decreasing/stable)"},{field:"trend_slope",description:"趋势斜率"}];return e.jsxs($t,{title:"规则配置帮助",width:800,open:h,onClose:v,styles:{body:{padding:24}},children:[e.jsx(P,{message:"增强规则引擎说明",description:"规则引擎用于实时处理IoT数据流，支持复杂条件匹配和多种动作执行。包含表达式引擎、正则缓存、增强转换动作和规则执行事件发布等功能。",type:"info",icon:e.jsx(ce,{}),style:{marginBottom:24}}),e.jsxs(lt,{defaultActiveKey:["1"],size:"large",children:[e.jsx(Se,{header:"📋 常用数据字段",children:e.jsx(Vt,{dataSource:V,columns:[{title:"字段名",dataIndex:"field",key:"field",width:120},{title:"说明",dataIndex:"description",key:"description"}],pagination:!1,size:"small"})},"1"),e.jsx(Se,{header:"🎯 条件类型配置",children:e.jsx(p,{direction:"vertical",size:"large",style:{width:"100%"},children:M.map(m=>e.jsxs(I,{size:"small",children:[e.jsxs(ie,{level:5,children:[e.jsx(g,{color:"blue",children:m.type}),m.name]}),e.jsx(xe,{children:m.description}),e.jsx(Ae,{strong:!0,children:"示例配置："}),e.jsx("pre",{style:{background:"#f5f5f5",padding:12,borderRadius:4,marginTop:8,fontSize:12},children:JSON.stringify(m.example,null,2)})]},m.type))})},"2"),e.jsx(Se,{header:"⚖️ 比较操作符",children:e.jsx(p,{wrap:!0,children:c.map(m=>e.jsxs(I,{size:"small",style:{width:200,marginBottom:8},children:[e.jsx(g,{color:"geekblue",children:m.op}),e.jsx(Ae,{strong:!0,children:m.name}),e.jsx("br",{}),e.jsx(Ae,{type:"secondary",style:{fontSize:12},children:m.description})]},m.op))})},"3"),e.jsxs(Se,{header:"🔗 复合数据格式支持",children:[e.jsx(P,{message:"IoT Gateway 复合数据格式全面支持",description:"系统现已支持7种复合数据格式，自动解析并提取衍生字段，可直接在规则条件中使用",type:"success",style:{marginBottom:16}}),e.jsxs(p,{direction:"vertical",size:"middle",style:{width:"100%"},children:[e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:"📍 GPS/地理位置数据 (location)"}),e.jsx(xe,{type:"secondary",children:"包含纬度、经度、海拔、精度、速度、方向角等字段，自动计算海拔等级和速度等级"}),e.jsxs(p,{wrap:!0,children:[e.jsx(g,{color:"blue",children:"latitude"}),e.jsx(g,{color:"blue",children:"longitude"}),e.jsx(g,{color:"blue",children:"altitude"}),e.jsx(g,{color:"blue",children:"accuracy"}),e.jsx(g,{color:"blue",children:"speed"}),e.jsx(g,{color:"blue",children:"heading"}),e.jsx(g,{color:"cyan",children:"elevation_category"}),e.jsx(g,{color:"cyan",children:"speed_category"})]}),e.jsx("pre",{style:{background:"#f5f5f5",padding:8,borderRadius:4,fontSize:11,marginTop:8},children:"示例规则: latitude > 39.9 && longitude > 116.3 && speed > 60"})]}),e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:"📐 三轴向量数据 (vector3d)"}),e.jsx(xe,{type:"secondary",children:"适用于加速度计、陀螺仪、磁力计等传感器，自动计算模长和主导轴"}),e.jsxs(p,{wrap:!0,children:[e.jsx(g,{color:"purple",children:"x"}),e.jsx(g,{color:"purple",children:"y"}),e.jsx(g,{color:"purple",children:"z"}),e.jsx(g,{color:"orange",children:"magnitude"}),e.jsx(g,{color:"orange",children:"dominant_axis"}),e.jsx(g,{color:"geekblue",children:"x_ratio"}),e.jsx(g,{color:"geekblue",children:"y_ratio"}),e.jsx(g,{color:"geekblue",children:"z_ratio"})]}),e.jsx("pre",{style:{background:"#f5f5f5",padding:8,borderRadius:4,fontSize:11,marginTop:8},children:'示例规则: magnitude > 10.0 && dominant_axis == "z"'})]}),e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:"🎨 颜色数据 (color)"}),e.jsx(xe,{type:"secondary",children:"RGB颜色数据，自动计算HSL色彩空间的色相、饱和度、亮度"}),e.jsxs(p,{wrap:!0,children:[e.jsx(g,{color:"red",children:"r"}),e.jsx(g,{color:"green",children:"g"}),e.jsx(g,{color:"blue",children:"b"}),e.jsx(g,{color:"gray",children:"a"}),e.jsx(g,{color:"magenta",children:"hue"}),e.jsx(g,{color:"orange",children:"saturation"}),e.jsx(g,{color:"gold",children:"lightness"})]}),e.jsx("pre",{style:{background:"#f5f5f5",padding:8,borderRadius:4,fontSize:11,marginTop:8},children:"示例规则: hue >= 120 && hue <= 240 && saturation > 0.5"})]}),e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:"🔢 向量/数组/矩阵数据"}),e.jsx(xe,{type:"secondary",children:"支持通用向量、数组、矩阵和时间序列数据，自动计算统计指标和结构特征"}),e.jsxs(p,{wrap:!0,children:[e.jsx(g,{color:"volcano",children:"dimension"}),e.jsx(g,{color:"volcano",children:"size"}),e.jsx(g,{color:"volcano",children:"length"}),e.jsx(g,{color:"lime",children:"norm"}),e.jsx(g,{color:"lime",children:"dominant_dimension"}),e.jsx(g,{color:"cyan",children:"numeric_count"}),e.jsx(g,{color:"cyan",children:"null_count"}),e.jsx(g,{color:"purple",children:"trend"}),e.jsx(g,{color:"purple",children:"trend_slope"})]}),e.jsx("pre",{style:{background:"#f5f5f5",padding:8,borderRadius:4,fontSize:11,marginTop:8},children:'示例规则: dimension > 3 && norm > 1.0 && trend == "increasing"'})]}),e.jsx(P,{message:"使用提示",description:e.jsxs("ul",{style:{margin:0,paddingLeft:20},children:[e.jsx("li",{children:"复合数据字段可直接在条件表达式中使用，无需特殊语法"}),e.jsx("li",{children:"系统自动解析复合数据并提取所有可用的衍生字段"}),e.jsx("li",{children:"支持与传统数据字段混合使用，如 temperature > 30 && magnitude > 10"}),e.jsx("li",{children:"聚合函数同样支持复合数据字段的统计分析"})]}),type:"info",style:{marginTop:16}})]})]},"4"),e.jsxs(Se,{header:"📊 聚合函数详解",children:[e.jsx(P,{message:"28个聚合函数完整支持",description:"规则引擎现已支持28个聚合函数，涵盖基础统计、百分位数、数据质量、变化检测和阈值监控等各个方面",type:"success",style:{marginBottom:16}}),e.jsxs(p,{direction:"vertical",size:"middle",style:{width:"100%"},children:[e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:"📊 基础统计函数 (10个)"}),e.jsxs(p,{wrap:!0,children:[e.jsx(g,{color:"blue",children:"count"}),e.jsx(g,{color:"blue",children:"sum"}),e.jsx(g,{color:"blue",children:"avg/mean/average"}),e.jsx(g,{color:"blue",children:"min"}),e.jsx(g,{color:"blue",children:"max"}),e.jsx(g,{color:"blue",children:"median"}),e.jsx(g,{color:"blue",children:"first"}),e.jsx(g,{color:"blue",children:"last"}),e.jsx(g,{color:"blue",children:"stddev/std"}),e.jsx(g,{color:"blue",children:"variance"})]}),e.jsx(xe,{type:"secondary",style:{marginTop:8},children:"日常统计分析的核心函数，包括计数、求和、平均值、极值、中位数和离散度指标"})]}),e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:"📈 分布统计函数 (2个)"}),e.jsxs(p,{wrap:!0,children:[e.jsx(g,{color:"geekblue",children:"volatility"}),e.jsx(g,{color:"geekblue",children:"cv"})]}),e.jsx(xe,{type:"secondary",style:{marginTop:8},children:"高级统计指标：volatility（波动率）= 变异系数×100，cv（变异系数）= 标准差/均值"})]}),e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:"📊 百分位数函数 (6个)"}),e.jsxs(p,{wrap:!0,children:[e.jsx(g,{color:"cyan",children:"p25"}),e.jsx(g,{color:"cyan",children:"p50"}),e.jsx(g,{color:"cyan",children:"p75"}),e.jsx(g,{color:"cyan",children:"p90"}),e.jsx(g,{color:"cyan",children:"p95"}),e.jsx(g,{color:"cyan",children:"p99"})]}),e.jsx(xe,{type:"secondary",style:{marginTop:8},children:"性能监控关键指标，用于延迟、响应时间等分布分析。p90/p95/p99常用于SLA监控"})]}),e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:"🔍 数据质量函数 (3个)"}),e.jsxs(p,{wrap:!0,children:[e.jsx(g,{color:"orange",children:"null_rate"}),e.jsx(g,{color:"orange",children:"completeness"}),e.jsx(g,{color:"orange",children:"outlier_count"})]}),e.jsx(xe,{type:"secondary",style:{marginTop:8},children:"数据健康度指标：null_rate（空值比例）、completeness（完整性=1-null_rate）、outlier_count（异常值数量，需配置outlier_threshold）"})]}),e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:"📉 变化检测函数 (2个)"}),e.jsxs(p,{wrap:!0,children:[e.jsx(g,{color:"purple",children:"change"}),e.jsx(g,{color:"purple",children:"change_rate"})]}),e.jsx(xe,{type:"secondary",style:{marginTop:8},children:"趋势分析：change（绝对变化量）= 最新值-第一个值，change_rate（变化率）= change/第一个值×100%"})]}),e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:"⚡ 阈值监控函数 (3个)"}),e.jsxs(p,{wrap:!0,children:[e.jsx(g,{color:"red",children:"above_count"}),e.jsx(g,{color:"red",children:"below_count"}),e.jsx(g,{color:"red",children:"in_range_count"})]}),e.jsx(xe,{type:"secondary",style:{marginTop:8},children:"阈值监控：需配置upper_limit和/或lower_limit参数。用于统计超标数据点数量"})]}),e.jsx(P,{message:"使用提示",description:e.jsxs("ul",{style:{margin:0,paddingLeft:20},children:[e.jsx("li",{children:"支持多选：可同时选择多个函数进行并行计算"}),e.jsx("li",{children:"搜索功能：在选择器中输入关键词快速查找函数"}),e.jsx("li",{children:"参数配置：阈值监控函数需要配置相应的阈值参数"}),e.jsx("li",{children:"性能优化：内置增量统计算法，支持滑动窗口和累积模式"})]}),type:"info",style:{marginTop:16}})]})]},"5"),e.jsx(Se,{header:"⚡ 动作类型配置",children:e.jsx(p,{direction:"vertical",size:"large",style:{width:"100%"},children:C.map(m=>e.jsxs(I,{size:"small",children:[e.jsx(ie,{level:5,children:e.jsxs(p,{children:[m.icon,e.jsx(g,{color:"green",children:m.type}),m.name]})}),e.jsx(xe,{children:m.description}),e.jsx(st,{size:"small"}),e.jsx(Ae,{strong:!0,children:"配置参数："}),e.jsx("ul",{style:{marginTop:8,marginBottom:12},children:Object.entries(m.config).map(([S,G])=>e.jsxs("li",{children:[e.jsx(Ae,{code:!0,children:S}),": ",G]},S))}),e.jsx(Ae,{strong:!0,children:"示例配置："}),e.jsx("pre",{style:{background:"#f5f5f5",padding:12,borderRadius:4,marginTop:8,fontSize:12},children:JSON.stringify(m.example,null,2)})]},m.type))})},"6"),e.jsx(Se,{header:"💡 配置技巧",children:e.jsxs(p,{direction:"vertical",size:"middle",style:{width:"100%"},children:[e.jsx(P,{message:"优先级设置",description:"数值越大优先级越高。建议：紧急告警 100+，重要处理 50-99，一般处理 1-49",type:"info"}),e.jsx(P,{message:"变量使用",description:"在告警消息中可以使用 {{.DeviceID}}, {{.Key}}, {{.Value}} 等变量",type:"info"}),e.jsx(P,{message:"表达式引擎",description:"支持数学函数：abs(), max(), min(), sqrt()；字符串函数：len(), contains(), startsWith()；时间函数：now(), timeFormat()",type:"info"}),e.jsx(P,{message:"性能优化",description:"正则表达式自动缓存，字符串操作已优化，避免过于复杂的表达式以保证性能",type:"warning"}),e.jsx(P,{message:"规则事件",description:"规则执行会自动发布到 iot.rules.* 主题，包含评估结果、执行时间等信息",type:"success"}),e.jsx(P,{message:"测试建议",description:"创建规则后建议先禁用状态下测试，确认无误后再启用",type:"success"})]})},"7"),e.jsxs(Se,{header:"📝 完整示例",children:[e.jsxs(I,{style:{marginBottom:16},children:[e.jsx(ie,{level:5,children:"复合数据示例：GPS位置监控"}),e.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4,fontSize:12,lineHeight:1.5},children:`{
  "name": "车辆位置和速度监控",
  "description": "监控车辆GPS位置、速度和区域限制",
  "priority": 90,
  "enabled": true,
  "conditions": {
    "type": "expression",
    "expression": "(latitude > 39.9 && longitude > 116.3) && (speed > 80 || altitude < 0)"
  },
  "actions": [
    {
      "type": "alert",
      "config": {
        "level": "warning",
        "message": "车辆{{.DeviceID}}位置异常: 纬度{{.latitude}}, 经度{{.longitude}}, 速度{{.speed}}km/h",
        "channels": ["console", "webhook"],
        "throttle": "2m"
      }
    },
    {
      "type": "aggregate",
      "config": {
        "window_size": 20,
        "functions": ["avg", "max", "p90"],
        "group_by": ["device_id"],
        "output_key": "location_stats"
      }
    }
  ]
}`})]}),e.jsxs(I,{style:{marginBottom:16},children:[e.jsx(ie,{level:5,children:"聚合函数示例：传感器性能监控"}),e.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4,fontSize:12,lineHeight:1.5},children:`{
  "name": "传感器性能监控",
  "description": "监控传感器数据质量和性能指标",
  "priority": 80,
  "enabled": true,
  "conditions": {
    "type": "simple",
    "field": "key",
    "operator": "eq",
    "value": "temperature"
  },
  "actions": [
    {
      "type": "aggregate",
      "config": {
        "window_type": "count",
        "window_size": 20,
        "functions": ["avg", "min", "max", "p90", "p95", "null_rate", "change_rate", "above_count"],
        "group_by": ["device_id"],
        "output_key": "sensor_stats",
        "upper_limit": 50,
        "lower_limit": 10,
        "outlier_threshold": 2.0,
        "forward": true
      }
    }
  ]
}`})]}),e.jsxs(I,{children:[e.jsx(ie,{level:5,children:"增强规则示例：智能温度监控"}),e.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4,fontSize:12,lineHeight:1.5},children:`{
  "name": "智能温度监控与转换",
  "description": "监控温度，使用表达式条件判断，转换单位并发布",
  "priority": 100,
  "enabled": true,
  "conditions": {
    "type": "expression",
    "expression": "key == \\"temperature\\" && abs(value - 25) > 10 && contains(device_id, \\"sensor\\")"
  },
  "actions": [
    {
      "type": "alert",
      "config": {
        "level": "warning",
        "message": "设备{{.DeviceID}}温度异常: {{.Value}}°C",
        "channels": [
          { "type": "console", "enabled": true },
          { 
            "type": "nats", 
            "enabled": true, 
            "config": { "subject": "iot.alerts.temperature" }
          }
        ]
      }
    },
    {
      "type": "transform",
      "config": {
        "type": "expression",
        "parameters": {
          "expression": "(value - 32) * 5 / 9"
        },
        "output_key": "celsius_temp",
        "output_type": "float",
        "precision": 2,
        "publish_subject": "iot.data.converted"
      }
    },
    {
      "type": "forward",
      "config": {
        "subject": "iot.data.processed.{{.DeviceID}}",
        "include_metadata": true,
        "transform_data": {
          "add_timestamp": true,
          "add_rule_info": true
        }
      }
    }
  ]
}`})]})]},"8")]})]})},{Option:T}=O,{TextArea:It}=B,ba=({value:h,onChange:v})=>{const M=b.useRef(),c=b.useRef({conditionType:"simple",simpleCondition:{field:"",operator:"eq",value:""},andConditions:[],orConditions:[],expression:""}),C=[{value:"eq",label:"等于 (=)",description:"字段值等于指定值"},{value:"ne",label:"不等于 (≠)",description:"字段值不等于指定值"},{value:"gt",label:"大于 (>)",description:"字段值大于指定值"},{value:"gte",label:"大于等于 (≥)",description:"字段值大于等于指定值"},{value:"lt",label:"小于 (<)",description:"字段值小于指定值"},{value:"lte",label:"小于等于 (≤)",description:"字段值小于等于指定值"},{value:"contains",label:"包含",description:"字符串包含子字符串"},{value:"regex",label:"正则匹配",description:"正则表达式匹配"},{value:"in",label:"在数组中",description:"值在指定数组中"},{value:"exists",label:"字段存在",description:"检查字段是否存在"}],V=b.useCallback((t,l)=>{if(t===l)return!0;if(!t||!l)return t===l;if(typeof t!=typeof l)return!1;if(typeof t!="object")return t===l;const r=Object.keys(t),n=Object.keys(l);if(r.length!==n.length)return!1;for(let i of r)if(!n.includes(i)||!V(t[i],l[i]))return!1;return!0},[]),m=b.useMemo(()=>{if(!h){const t={conditionType:"simple",simpleCondition:{field:"",operator:"eq",value:""},andConditions:[],orConditions:[],expression:""};return M.current=void 0,c.current=t,t}if(!V(h,M.current)){let t;return h.type==="simple"?t={conditionType:"simple",simpleCondition:{field:h.field||"",operator:h.operator||"eq",value:h.value||""},andConditions:[],orConditions:[],expression:""}:h.type==="and"&&h.and?t={conditionType:"and",simpleCondition:{field:"",operator:"eq",value:""},andConditions:h.and.map(l=>l.type==="simple"?{type:"simple",field:l.field||"",operator:l.operator||"eq",value:l.value||""}:l.type==="expression"?{type:"expression",expression:l.expression||""}:{type:"simple",field:"",operator:"eq",value:""}),orConditions:[],expression:""}:h.type==="or"&&h.or?t={conditionType:"or",simpleCondition:{field:"",operator:"eq",value:""},andConditions:[],orConditions:h.or.map(l=>l.type==="simple"?{type:"simple",field:l.field||"",operator:l.operator||"eq",value:l.value||""}:l.type==="expression"?{type:"expression",expression:l.expression||""}:{type:"simple",field:"",operator:"eq",value:""}),expression:""}:h.type==="expression"?t={conditionType:"expression",simpleCondition:{field:"",operator:"eq",value:""},andConditions:[],orConditions:[],expression:h.expression||""}:t={conditionType:"simple",simpleCondition:{field:"",operator:"eq",value:""},andConditions:[],orConditions:[],expression:""},M.current=JSON.parse(JSON.stringify(h)),c.current=t,t}return c.current},[h,V]),S=b.useCallback(t=>{let l;return t.conditionType==="simple"?l={type:"simple",field:t.simpleCondition.field,operator:t.simpleCondition.operator,value:t.simpleCondition.value}:t.conditionType==="and"?l={type:"and",and:t.andConditions.map(r=>r.type==="expression"?{type:"expression",expression:r.expression}:{type:"simple",field:r.field,operator:r.operator,value:r.value})}:t.conditionType==="or"?l={type:"or",or:t.orConditions.map(r=>r.type==="expression"?{type:"expression",expression:r.expression}:{type:"simple",field:r.field,operator:r.operator,value:r.value})}:t.conditionType==="expression"?l={type:"expression",expression:t.expression}:l={type:"simple",field:"",operator:"eq",value:""},l},[]),G=b.useCallback(t=>{if(m.conditionType!==t){const l={...m};l.conditionType=t,t==="and"&&l.andConditions.length===0?l.andConditions=[{type:"simple",field:"",operator:"eq",value:""},{type:"simple",field:"",operator:"eq",value:""}]:t==="or"&&l.orConditions.length===0&&(l.orConditions=[{type:"simple",field:"",operator:"eq",value:""},{type:"simple",field:"",operator:"eq",value:""}]),c.current=l;const r=S(l);v?.(r)}},[m,S,v]),J=(t,l,r=0)=>e.jsxs(Z,{gutter:8,children:[e.jsx(R,{span:7,children:e.jsxs(O,{placeholder:"选择字段",value:t.field,onChange:n=>{l.length===3?l(r,"field",n):l("field",n)},style:{width:"100%"},showSearch:!0,allowClear:!0,children:[e.jsxs(O.OptGroup,{label:"📊 基础数据字段",children:[e.jsx(T,{value:"device_id",children:"设备ID"},"device_id"),e.jsx(T,{value:"key",children:"数据键"},"key"),e.jsx(T,{value:"value",children:"数据值"},"value"),e.jsx(T,{value:"timestamp",children:"时间戳"},"timestamp"),e.jsx(T,{value:"quality",children:"质量码"},"quality"),e.jsx(T,{value:"unit",children:"单位"},"unit")]}),e.jsxs(O.OptGroup,{label:"🌡️ 传感器数据",children:[e.jsx(T,{value:"temperature",children:"温度"},"temperature"),e.jsx(T,{value:"humidity",children:"湿度"},"humidity"),e.jsx(T,{value:"pressure",children:"压力"},"pressure"),e.jsx(T,{value:"status",children:"状态"},"status")]}),e.jsxs(O.OptGroup,{label:"📍 GPS位置数据",children:[e.jsx(T,{value:"latitude",children:"纬度"},"latitude"),e.jsx(T,{value:"longitude",children:"经度"},"longitude"),e.jsx(T,{value:"altitude",children:"海拔"},"altitude"),e.jsx(T,{value:"accuracy",children:"GPS精度"},"accuracy"),e.jsx(T,{value:"speed",children:"移动速度"},"speed"),e.jsx(T,{value:"heading",children:"方向角"},"heading"),e.jsx(T,{value:"elevation_category",children:"海拔等级"},"elevation_category"),e.jsx(T,{value:"speed_category",children:"速度等级"},"speed_category")]}),e.jsxs(O.OptGroup,{label:"📐 三轴向量数据",children:[e.jsx(T,{value:"x",children:"X轴数值"},"x"),e.jsx(T,{value:"y",children:"Y轴数值"},"y"),e.jsx(T,{value:"z",children:"Z轴数值"},"z"),e.jsx(T,{value:"magnitude",children:"向量模长"},"magnitude"),e.jsx(T,{value:"x_ratio",children:"X轴比例"},"x_ratio"),e.jsx(T,{value:"y_ratio",children:"Y轴比例"},"y_ratio"),e.jsx(T,{value:"z_ratio",children:"Z轴比例"},"z_ratio"),e.jsx(T,{value:"dominant_axis",children:"主导轴"},"dominant_axis")]}),e.jsxs(O.OptGroup,{label:"🎨 颜色数据",children:[e.jsx(T,{value:"r",children:"红色分量"},"r"),e.jsx(T,{value:"g",children:"绿色分量"},"g"),e.jsx(T,{value:"b",children:"蓝色分量"},"b"),e.jsx(T,{value:"a",children:"透明度"},"a"),e.jsx(T,{value:"hue",children:"色相"},"hue"),e.jsx(T,{value:"saturation",children:"饱和度"},"saturation"),e.jsx(T,{value:"lightness",children:"亮度"},"lightness")]}),e.jsxs(O.OptGroup,{label:"🔢 向量/数组/矩阵",children:[e.jsx(T,{value:"dimension",children:"维度"},"dimension"),e.jsx(T,{value:"size",children:"大小"},"size"),e.jsx(T,{value:"length",children:"长度"},"length"),e.jsx(T,{value:"rows",children:"行数"},"rows"),e.jsx(T,{value:"cols",children:"列数"},"cols"),e.jsx(T,{value:"norm",children:"范数"},"norm"),e.jsx(T,{value:"dominant_dimension",children:"主导维度"},"dominant_dimension"),e.jsx(T,{value:"data_type",children:"数据类型"},"data_type"),e.jsx(T,{value:"numeric_count",children:"数值数量"},"numeric_count"),e.jsx(T,{value:"null_count",children:"空值数量"},"null_count")]}),e.jsxs(O.OptGroup,{label:"📈 时间序列",children:[e.jsx(T,{value:"duration",children:"总时长"},"duration"),e.jsx(T,{value:"avg_interval",children:"平均间隔"},"avg_interval"),e.jsx(T,{value:"trend",children:"趋势"},"trend"),e.jsx(T,{value:"trend_slope",children:"趋势斜率"},"trend_slope")]})]})}),e.jsx(R,{span:6,children:e.jsx(O,{value:t.operator,onChange:n=>{l.length===3?l(r,"operator",n):l("operator",n)},style:{width:"100%"},children:C.map(n=>e.jsx(T,{value:n.value,title:n.description,children:n.label},n.value))})}),e.jsx(R,{span:8,children:["exists"].includes(t.operator)?e.jsx(B,{disabled:!0,placeholder:"无需填写"}):["in"].includes(t.operator)?e.jsx(O,{mode:"tags",placeholder:"输入多个值",value:Array.isArray(t.value)?t.value:[],onChange:n=>{l.length===3?l(r,"value",n):l("value",n)},style:{width:"100%"}}):["gt","gte","lt","lte"].includes(t.operator)?e.jsx(W,{placeholder:"数值",value:t.value,onChange:n=>{l.length===3?l(r,"value",n):l("value",n)},style:{width:"100%"}}):e.jsx(B,{placeholder:"比较值",value:t.value,onChange:n=>{l.length===3?l(r,"value",n.target.value):l("value",n.target.value)}})})]},r),D=(t,l,r,n)=>e.jsxs("div",{style:{border:"1px solid #d9d9d9",padding:12,borderRadius:6,marginBottom:8},children:[e.jsxs(Z,{gutter:8,style:{marginBottom:8},children:[e.jsx(R,{span:6,children:e.jsxs(O,{placeholder:"条件类型",value:t.type,onChange:i=>l(r,"type",i),style:{width:"100%"},children:[e.jsx(T,{value:"simple",children:e.jsxs(p,{children:[e.jsx(g,{color:"blue",size:"small",children:"简单"}),"字段条件"]})},"simple"),e.jsx(T,{value:"expression",children:e.jsxs(p,{children:[e.jsx(g,{color:"purple",size:"small",children:"表达式"}),"自定义表达式"]})},"expression")]})}),e.jsx(R,{span:15,children:t.type==="simple"?e.jsxs(Z,{gutter:4,children:[e.jsx(R,{span:8,children:e.jsxs(O,{placeholder:"选择字段",value:t.field,onChange:i=>l(r,"field",i),style:{width:"100%"},showSearch:!0,allowClear:!0,children:[e.jsxs(O.OptGroup,{label:"📊 基础数据字段",children:[e.jsx(T,{value:"device_id",children:"设备ID"},"device_id"),e.jsx(T,{value:"key",children:"数据键"},"key"),e.jsx(T,{value:"value",children:"数据值"},"value"),e.jsx(T,{value:"timestamp",children:"时间戳"},"timestamp"),e.jsx(T,{value:"quality",children:"质量码"},"quality"),e.jsx(T,{value:"unit",children:"单位"},"unit")]}),e.jsxs(O.OptGroup,{label:"🌡️ 传感器数据",children:[e.jsx(T,{value:"temperature",children:"温度"},"temperature"),e.jsx(T,{value:"humidity",children:"湿度"},"humidity"),e.jsx(T,{value:"pressure",children:"压力"},"pressure"),e.jsx(T,{value:"status",children:"状态"},"status")]}),e.jsxs(O.OptGroup,{label:"📍 GPS位置数据",children:[e.jsx(T,{value:"latitude",children:"纬度"},"latitude"),e.jsx(T,{value:"longitude",children:"经度"},"longitude"),e.jsx(T,{value:"altitude",children:"海拔"},"altitude"),e.jsx(T,{value:"speed",children:"移动速度"},"speed"),e.jsx(T,{value:"heading",children:"方向角"},"heading")]}),e.jsxs(O.OptGroup,{label:"📐 三轴向量数据",children:[e.jsx(T,{value:"x",children:"X轴数值"},"x"),e.jsx(T,{value:"y",children:"Y轴数值"},"y"),e.jsx(T,{value:"z",children:"Z轴数值"},"z"),e.jsx(T,{value:"magnitude",children:"向量模长"},"magnitude"),e.jsx(T,{value:"dominant_axis",children:"主导轴"},"dominant_axis")]}),e.jsxs(O.OptGroup,{label:"🎨 颜色数据",children:[e.jsx(T,{value:"r",children:"红色分量"},"r"),e.jsx(T,{value:"g",children:"绿色分量"},"g"),e.jsx(T,{value:"b",children:"蓝色分量"},"b"),e.jsx(T,{value:"hue",children:"色相"},"hue")]})]})}),e.jsx(R,{span:6,children:e.jsx(O,{value:t.operator,onChange:i=>l(r,"operator",i),style:{width:"100%"},children:C.map(i=>e.jsx(T,{value:i.value,title:i.description,children:i.label},i.value))})}),e.jsx(R,{span:10,children:["exists"].includes(t.operator||"")?e.jsx(B,{disabled:!0,placeholder:"无需填写"}):["in"].includes(t.operator||"")?e.jsx(O,{mode:"tags",placeholder:"输入多个值",value:Array.isArray(t.value)?t.value:[],onChange:i=>l(r,"value",i),style:{width:"100%"}}):["gt","gte","lt","lte"].includes(t.operator||"")?e.jsx(W,{placeholder:"数值",value:t.value,onChange:i=>l(r,"value",i),style:{width:"100%"}}):e.jsx(B,{placeholder:"比较值",value:t.value,onChange:i=>l(r,"value",i.target.value)})})]}):e.jsx(It,{rows:2,placeholder:"例如: temperature > 30 && magnitude > 10.0 || hue between 120,240",value:t.expression,onChange:i=>l(r,"expression",i.target.value)})}),e.jsx(R,{span:3,children:n&&e.jsx(E,{type:"text",danger:!0,icon:e.jsx(Ee,{}),onClick:n})})]}),t.type==="expression"&&e.jsx("div",{style:{fontSize:12,color:"#666"},children:"支持的运算符：&& (且), || (或), ! (非), ==, !=, >, >=, <, <="})]},r),_=b.useCallback((t,l)=>{const r={...m};r.simpleCondition={...r.simpleCondition,[t]:l},c.current=r;const n=S(r);v?.(n)},[m,S,v]),k=b.useCallback((t,l,r)=>{const n={...m};n.andConditions=[...n.andConditions],l==="type"?r==="expression"?n.andConditions[t]={type:"expression",expression:""}:n.andConditions[t]={type:"simple",field:"",operator:"eq",value:""}:n.andConditions[t]={...n.andConditions[t],[l]:r},c.current=n;const i=S(n);v?.(i)},[m,S,v]),q=b.useCallback((t,l,r)=>{const n={...m};n.orConditions=[...n.orConditions],l==="type"?r==="expression"?n.orConditions[t]={type:"expression",expression:""}:n.orConditions[t]={type:"simple",field:"",operator:"eq",value:""}:n.orConditions[t]={...n.orConditions[t],[l]:r},c.current=n;const i=S(n);v?.(i)},[m,S,v]),X=b.useCallback(t=>{const l={...m};l.expression=t,c.current=l;const r=S(l);v?.(r)},[m,S,v]),N=b.useCallback(()=>{const t={...m};t.andConditions=[...t.andConditions,{type:"simple",field:"",operator:"eq",value:""}],c.current=t;const l=S(t);v?.(l)},[m,S,v]),$=b.useCallback(t=>{const l={...m};l.andConditions=l.andConditions.filter((n,i)=>i!==t),c.current=l;const r=S(l);v?.(r)},[m,S,v]),L=b.useCallback(()=>{const t={...m};t.orConditions=[...t.orConditions,{type:"simple",field:"",operator:"eq",value:""}],c.current=t;const l=S(t);v?.(l)},[m,S,v]),s=b.useCallback(t=>{const l={...m};l.orConditions=l.orConditions.filter((n,i)=>i!==t),c.current=l;const r=S(l);v?.(r)},[m,S,v]);return e.jsx(I,{title:"触发条件配置",size:"small",children:e.jsxs("div",{children:[e.jsx(u.Item,{label:"条件类型",children:e.jsxs(O,{value:m.conditionType,onChange:G,children:[e.jsx(T,{value:"simple",children:e.jsxs(p,{children:[e.jsx(g,{color:"blue",children:"简单"}),"单个字段条件"]})},"simple"),e.jsx(T,{value:"and",children:e.jsxs(p,{children:[e.jsx(g,{color:"green",children:"逻辑与"}),"所有条件都满足"]})},"and"),e.jsx(T,{value:"or",children:e.jsxs(p,{children:[e.jsx(g,{color:"orange",children:"逻辑或"}),"任一条件满足"]})},"or"),e.jsx(T,{value:"expression",children:e.jsxs(p,{children:[e.jsx(g,{color:"purple",children:"表达式"}),"自定义表达式"]})},"expression")]})}),m.conditionType==="simple"&&e.jsx(u.Item,{label:"条件设置",children:J(m.simpleCondition,_,0)}),m.conditionType==="and"&&e.jsx(u.Item,{label:e.jsxs(p,{children:["逻辑与条件",e.jsx(oe,{title:"所有条件都必须满足才会触发规则",children:e.jsx(Ce,{})})]}),children:e.jsxs(p,{direction:"vertical",style:{width:"100%"},children:[m.andConditions.map((t,l)=>e.jsxs("div",{children:[l>0&&e.jsx("div",{style:{textAlign:"center",margin:"8px 0"},children:e.jsx(g,{color:"green",children:"且"})}),D(t,k,l,l>1?()=>$(l):void 0)]},l)),e.jsx(E,{type:"dashed",icon:e.jsx($e,{}),onClick:N,style:{width:"100%"},children:"添加条件"})]})}),m.conditionType==="or"&&e.jsx(u.Item,{label:e.jsxs(p,{children:["逻辑或条件",e.jsx(oe,{title:"任意一个条件满足就会触发规则",children:e.jsx(Ce,{})})]}),children:e.jsxs(p,{direction:"vertical",style:{width:"100%"},children:[m.orConditions.map((t,l)=>e.jsxs("div",{children:[l>0&&e.jsx("div",{style:{textAlign:"center",margin:"8px 0"},children:e.jsx(g,{color:"orange",children:"或"})}),D(t,q,l,l>1?()=>s(l):void 0)]},l)),e.jsx(E,{type:"dashed",icon:e.jsx($e,{}),onClick:L,style:{width:"100%"},children:"添加条件"})]})}),m.conditionType==="expression"&&e.jsxs(u.Item,{label:e.jsxs(p,{children:["表达式条件",e.jsx(oe,{title:"使用表达式语言编写复杂条件，如: temperature > 30 && humidity < 60",children:e.jsx(Ce,{})})]}),children:[e.jsx(It,{rows:3,placeholder:"例如: temperature > 30 && magnitude > 10.0 || hue between 120,240",value:m.expression,onChange:t=>X(t.target.value)}),e.jsx("div",{style:{marginTop:8,fontSize:12,color:"#666"},children:"支持的运算符：&& (且), || (或), ! (非), ==, !=, >, >=, <, <="})]})]})})},{Option:w}=O,{TextArea:Qe}=B,{Text:_a}=pe,wa=({value:h,onChange:v})=>{const M=b.useRef(),c=b.useRef([]),C=b.useCallback((s,t)=>{if(s===t)return!0;if(!s||!t)return s===t;if(typeof s!=typeof t)return!1;if(typeof s!="object")return s===t;const l=Object.keys(s),r=Object.keys(t);if(l.length!==r.length)return!1;for(let n of l)if(!r.includes(n)||!C(s[n],t[n]))return!1;return!0},[]),V=b.useMemo(()=>{if(!h||h.length===0){const s=[{type:"alert",config:{},async:!1,timeout:"30s",retry:0}];return M.current=[],c.current=s,s}if(!C(h,M.current)){const s=h.map((t,l)=>{const r=JSON.parse(JSON.stringify(t.config||{}));return{type:t.type,config:r,async:t.async,timeout:t.timeout,retry:t.retry}});return M.current=JSON.parse(JSON.stringify(h)),c.current=s,s}return c.current},[h,C]),m=[{value:"alert",label:"告警通知",icon:e.jsx(Ft,{style:{color:"#ff4d4f"}}),description:"发送告警消息"},{value:"transform",label:"数据转换",icon:e.jsx(Me,{style:{color:"#1890ff"}}),description:"转换数据格式或值"},{value:"filter",label:"数据过滤",icon:e.jsx(_e,{style:{color:"#722ed1"}}),description:"过滤或丢弃数据"},{value:"aggregate",label:"数据聚合",icon:e.jsx(se,{style:{color:"#52c41a"}}),description:"聚合计算统计值"},{value:"forward",label:"数据转发",icon:e.jsx(Jt,{style:{color:"#fa8c16"}}),description:"转发到外部系统"}],S=b.useCallback(s=>s.map(t=>({type:t.type,config:t.config,async:t.async||!1,timeout:t.timeout||"30s",retry:t.retry||0})),[]),G=b.useCallback(()=>{const s=[...V,{type:"alert",config:{},async:!1,timeout:"30s",retry:0}];c.current=s;const t=S(s);v?.(t)},[V,v,S]),J=b.useCallback(s=>{const t=V.filter((r,n)=>n!==s);c.current=t;const l=S(t);v?.(l)},[V,v,S]),D=b.useCallback((s,t,l)=>{const r=[...V];r[s]={...r[s],[t]:l},c.current=r;const n=S(r);v?.(n)},[V,v,S]),_=b.useCallback((s,t,l)=>{const r=[...V];r[s]={...r[s],config:{...r[s].config,[t]:l}},c.current=r;const n=S(r);v?.(n)},[V,v,S]),k=(s,t)=>{let l=[];return s.config.channels&&Array.isArray(s.config.channels)&&(l=s.config.channels.map(r=>typeof r=="string"?r:typeof r=="object"&&r.type?r.type:r)),e.jsxs("div",{children:[e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"告警级别",children:e.jsxs(O,{value:s.config.level||"warning",onChange:r=>_(t,"level",r),children:[e.jsx(w,{value:"info",children:"信息"},"info"),e.jsx(w,{value:"warning",children:"警告"},"warning"),e.jsx(w,{value:"error",children:"错误"},"error"),e.jsx(w,{value:"critical",children:"严重"},"critical")]})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"限流时间",children:e.jsx(B,{placeholder:"如 5m, 1h",value:s.config.throttle||"",onChange:r=>_(t,"throttle",r.target.value)})})})]}),e.jsx(u.Item,{label:"告警消息",children:e.jsx(Qe,{rows:2,placeholder:"支持变量: {{.DeviceID}}, {{.Key}}, {{.Value}}",value:s.config.message||"",onChange:r=>_(t,"message",r.target.value)})}),e.jsx(u.Item,{label:"通知渠道",children:e.jsxs(O,{mode:"multiple",placeholder:"选择通知渠道",value:l,onChange:r=>_(t,"channels",r),children:[e.jsx(w,{value:"console",children:"控制台"},"console"),e.jsx(w,{value:"webhook",children:"Webhook"},"webhook"),e.jsx(w,{value:"email",children:"邮件"},"email"),e.jsx(w,{value:"sms",children:"短信"},"sms")]})})]})},q=(s,t)=>{const l=s.config.type||"scale";let r=s.config.parameters||{};!r.expression&&s.config.expression&&(r={...r,expression:s.config.expression}),!r.factor&&s.config.factor!==void 0&&(r={...r,factor:s.config.factor}),!r.offset&&s.config.offset!==void 0&&(r={...r,offset:s.config.offset});const n=(x,j)=>{const H={...r,[x]:j};_(t,"parameters",H)},i=()=>{switch(l){case"scale":return e.jsxs(u.Item,{label:"缩放因子",children:[e.jsx(W,{placeholder:"乘数，如 2.0",value:r.factor,onChange:x=>n("factor",x),style:{width:"100%"},step:.1}),e.jsx("div",{style:{fontSize:"12px",color:"#666",marginTop:"4px"},children:"将原始值乘以此因子"})]});case"offset":return e.jsxs(u.Item,{label:"偏移量",children:[e.jsx(W,{placeholder:"偏移值，如 32",value:r.offset,onChange:x=>n("offset",x),style:{width:"100%"},step:.1}),e.jsx("div",{style:{fontSize:"12px",color:"#666",marginTop:"4px"},children:"将原始值加上此偏移量"})]});case"expression":return e.jsxs(u.Item,{label:"表达式",children:[e.jsx(B,{placeholder:"数学表达式，如 x * 1.8 + 32",value:r.expression,onChange:x=>n("expression",x.target.value)}),e.jsx("div",{style:{fontSize:"12px",color:"#666",marginTop:"4px"},children:"使用 x 表示原始值，支持 +、-、*、/、()、函数调用如 abs(x)、sqrt(x)"})]});case"unit_convert":return e.jsx(e.Fragment,{children:e.jsxs(Z,{gutter:8,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"源单位",children:e.jsxs(O,{placeholder:"选择源单位",value:r.from,onChange:x=>n("from",x),style:{width:"100%"},children:[e.jsx(w,{value:"C",children:"摄氏度 (°C)"},"from-C"),e.jsx(w,{value:"F",children:"华氏度 (°F)"},"from-F"),e.jsx(w,{value:"K",children:"开尔文 (K)"},"from-K"),e.jsx(w,{value:"m",children:"米 (m)"},"from-m"),e.jsx(w,{value:"ft",children:"英尺 (ft)"},"from-ft"),e.jsx(w,{value:"kg",children:"千克 (kg)"},"from-kg"),e.jsx(w,{value:"lb",children:"磅 (lb)"},"from-lb")]})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"目标单位",children:e.jsxs(O,{placeholder:"选择目标单位",value:r.to,onChange:x=>n("to",x),style:{width:"100%"},children:[e.jsx(w,{value:"C",children:"摄氏度 (°C)"},"to-C"),e.jsx(w,{value:"F",children:"华氏度 (°F)"},"to-F"),e.jsx(w,{value:"K",children:"开尔文 (K)"},"to-K"),e.jsx(w,{value:"m",children:"米 (m)"},"to-m"),e.jsx(w,{value:"ft",children:"英尺 (ft)"},"to-ft"),e.jsx(w,{value:"kg",children:"千克 (kg)"},"to-kg"),e.jsx(w,{value:"lb",children:"磅 (lb)"},"to-lb")]})})})]})});case"lookup":return e.jsxs(e.Fragment,{children:[e.jsx(u.Item,{label:"查找表",children:e.jsx(Qe,{rows:4,placeholder:'JSON格式的映射表，如: {"0": "正常", "1": "警告", "2": "错误"}',value:r.table?JSON.stringify(r.table,null,2):"",onChange:x=>{try{const j=JSON.parse(x.target.value||"{}");n("table",j)}catch{}}})}),e.jsx(u.Item,{label:"默认值",children:e.jsx(B,{placeholder:"未找到映射时的默认值",value:r.default,onChange:x=>n("default",x.target.value)})})]});case"round":return e.jsx(u.Item,{label:"小数位数",children:e.jsx(W,{placeholder:"保留的小数位数",value:r.decimals||0,onChange:x=>n("decimals",x),min:0,max:10,style:{width:"100%"}})});case"clamp":return e.jsxs(Z,{gutter:8,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"最小值",children:e.jsx(W,{placeholder:"数值下限",value:r.min,onChange:x=>n("min",x),style:{width:"100%"}})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"最大值",children:e.jsx(W,{placeholder:"数值上限",value:r.max,onChange:x=>n("max",x),style:{width:"100%"}})})})]});case"format":return e.jsxs(u.Item,{label:"格式字符串",children:[e.jsx(B,{placeholder:"格式化模板，如 %.2f",value:r.format,onChange:x=>n("format",x.target.value)}),e.jsx("div",{style:{fontSize:"12px",color:"#666",marginTop:"4px"},children:"使用 Go 语言格式化语法"})]});case"map":return e.jsx(u.Item,{label:"映射表",children:e.jsx(Qe,{rows:4,placeholder:'JSON格式的映射表，如: {"high": 1, "low": 0}',value:r.mapping?JSON.stringify(r.mapping,null,2):"",onChange:x=>{try{const j=JSON.parse(x.target.value||"{}");n("mapping",j)}catch{}}})});default:return null}};return e.jsxs("div",{children:[e.jsx(u.Item,{label:"转换类型",children:e.jsxs(O,{placeholder:"选择转换类型",value:l,onChange:x=>_(t,"type",x),style:{width:"100%"},children:[e.jsx(w,{value:"scale",children:"数值缩放"},"scale"),e.jsx(w,{value:"offset",children:"数值偏移"},"offset"),e.jsx(w,{value:"expression",children:"表达式计算"},"expression"),e.jsx(w,{value:"unit_convert",children:"单位转换"},"unit_convert"),e.jsx(w,{value:"lookup",children:"查找表映射"},"lookup"),e.jsx(w,{value:"round",children:"四舍五入"},"round"),e.jsx(w,{value:"clamp",children:"数值限幅"},"clamp"),e.jsx(w,{value:"format",children:"格式化"},"format"),e.jsx(w,{value:"map",children:"值映射"},"map")]})}),i(),e.jsxs(u.Item,{label:e.jsxs(p,{children:["输出字段名",e.jsx(oe,{title:"不设置时将直接覆盖原始字段的值，原始数据将丢失。建议设置新的字段名以保留原始数据。",children:e.jsx(Ce,{style:{color:"#1890ff"}})})]}),children:[e.jsx(B,{placeholder:"转换后的字段名，如 temperature_fahrenheit（推荐设置）",value:s.config.output_key||"",onChange:x=>_(t,"output_key",x.target.value)}),e.jsx("div",{style:{fontSize:"12px",color:"#666",marginTop:"4px"},children:s.config.output_key?"✅ 将创建新字段，原始数据保留":"⚠️ 留空将直接覆盖原始字段的值，原始数据丢失"})]}),e.jsxs(u.Item,{label:"输出数据类型",children:[e.jsxs(O,{placeholder:"选择输出数据类型",value:s.config.output_type||void 0,onChange:x=>_(t,"output_type",x),allowClear:!0,children:[e.jsx(w,{value:"string",children:"字符串"},"string"),e.jsx(w,{value:"int",children:"整数"},"int"),e.jsx(w,{value:"float",children:"浮点数"},"float"),e.jsx(w,{value:"bool",children:"布尔值"},"bool")]}),e.jsx("div",{style:{fontSize:"12px",color:"#666",marginTop:"4px"},children:"不指定则保持原数据类型"})]}),e.jsxs(u.Item,{label:"数值精度",children:[e.jsx(W,{placeholder:"小数位数（仅对数值类型有效）",value:s.config.precision!==void 0?s.config.precision:void 0,onChange:x=>_(t,"precision",x),min:0,max:10,style:{width:"100%"}}),e.jsx("div",{style:{fontSize:"12px",color:"#666",marginTop:"4px"},children:"仅对数值类型有效，不设置则使用默认精度"})]}),e.jsx(u.Item,{label:"错误处理策略",children:e.jsxs(O,{placeholder:"转换出错时的处理方式",value:s.config.error_action||"error",onChange:x=>_(t,"error_action",x),children:[e.jsx(w,{value:"error",children:"抛出错误"},"error-handling"),e.jsx(w,{value:"ignore",children:"忽略错误，返回原值"},"ignore"),e.jsx(w,{value:"default",children:"使用默认值"},"default")]})}),s.config.error_action==="default"&&e.jsx(u.Item,{label:"默认值",children:e.jsx(B,{placeholder:"错误时使用的默认值",value:s.config.default_value!==void 0?String(s.config.default_value):"",onChange:x=>_(t,"default_value",x.target.value)})}),e.jsxs(u.Item,{label:"发布主题",children:[e.jsx(B,{placeholder:"NATS发布主题（可选），如 iot.data.transformed",value:s.config.publish_subject||"",onChange:x=>_(t,"publish_subject",x.target.value)}),e.jsxs("div",{style:{fontSize:"12px",color:"#666",marginTop:"4px"},children:["支持变量模板，如 iot.data.","{{.DeviceID}}"]})]})]})},X=(s,t)=>e.jsxs("div",{children:[e.jsx(u.Item,{label:"过滤类型",children:e.jsxs(O,{value:s.config.type||"range",onChange:l=>_(t,"type",l),children:[e.jsx(w,{value:"range",children:"范围过滤"},"range"),e.jsx(w,{value:"dedup",children:"去重过滤"},"dedup"),e.jsx(w,{value:"rate_limit",children:"速率限制"},"rate_limit")]})}),s.config.type==="range"&&e.jsxs("div",{children:[e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"最小值",children:e.jsx(W,{value:s.config.min,onChange:l=>_(t,"min",l),style:{width:"100%"}})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"最大值",children:e.jsx(W,{value:s.config.max,onChange:l=>_(t,"max",l),style:{width:"100%"}})})})]}),e.jsx(u.Item,{label:"匹配时动作",children:e.jsxs(O,{value:s.config.drop_on_match?"drop":"pass",onChange:l=>_(t,"drop_on_match",l==="drop"),children:[e.jsx(w,{value:"pass",children:"通过数据"},"pass"),e.jsx(w,{value:"drop",children:"丢弃数据"},"drop")]})})]}),s.config.type==="rate_limit"&&e.jsx("div",{children:e.jsx(u.Item,{label:"速率限制",children:e.jsxs(Z,{gutter:8,children:[e.jsx(R,{span:12,children:e.jsx(W,{placeholder:"数量",value:s.config.rate,onChange:l=>_(t,"rate",l),style:{width:"100%"}})}),e.jsx(R,{span:12,children:e.jsx(B,{placeholder:"时间窗口，如 1m",value:s.config.window,onChange:l=>_(t,"window",l.target.value)})})]})})})]}),N=(s,t)=>{const l=s.config.size||s.config.window_size;let r=s.config.output_key||s.config.output_field;return!r&&s.config.output&&typeof s.config.output=="object"&&(r=s.config.output.key_template),e.jsxs("div",{children:[e.jsxs(u.Item,{label:"窗口大小",children:[e.jsx(W,{placeholder:"数据点数量",value:l,onChange:n=>{_(t,"window_size",n),s.config.size!==void 0&&_(t,"size",n)},min:1,style:{width:"100%"},addonAfter:"个数据点"}),e.jsx("div",{style:{fontSize:"12px",color:"#666",marginTop:"4px"},children:"基于数据点计数的滑动窗口，如设置为10表示统计最近10个数据点"})]}),e.jsxs(u.Item,{label:e.jsxs(p,{children:["聚合函数",e.jsx(oe,{title:"支持28个聚合函数，包括基础统计、百分位数、数据质量、变化检测等",children:e.jsx(Ce,{style:{color:"#1890ff"}})})]}),children:[e.jsxs(O,{mode:"multiple",placeholder:"选择聚合函数（支持搜索）",value:s.config.functions||[],onChange:n=>_(t,"functions",n),showSearch:!0,filterOption:(n,i)=>i?.children?.toString().toLowerCase().includes(n.toLowerCase())||i?.value?.toString().toLowerCase().includes(n.toLowerCase()),style:{width:"100%"},children:[e.jsxs(O.OptGroup,{label:"📊 基础统计",children:[e.jsx(w,{value:"count",children:"计数 (count)"},"count"),e.jsx(w,{value:"sum",children:"求和 (sum)"},"sum"),e.jsx(w,{value:"avg",children:"平均值 (avg)"},"avg"),e.jsx(w,{value:"mean",children:"平均值 (mean)"},"mean"),e.jsx(w,{value:"average",children:"平均值 (average)"},"average"),e.jsx(w,{value:"min",children:"最小值 (min)"},"min"),e.jsx(w,{value:"max",children:"最大值 (max)"},"max"),e.jsx(w,{value:"median",children:"中位数 (median)"},"median"),e.jsx(w,{value:"first",children:"首个值 (first)"},"first"),e.jsx(w,{value:"last",children:"最后值 (last)"},"last")]}),e.jsxs(O.OptGroup,{label:"📈 分布统计",children:[e.jsx(w,{value:"stddev",children:"标准差 (stddev)"},"stddev"),e.jsx(w,{value:"std",children:"标准差 (std)"},"std"),e.jsx(w,{value:"variance",children:"方差 (variance)"},"variance"),e.jsx(w,{value:"volatility",children:"波动率 (volatility)"},"volatility"),e.jsx(w,{value:"cv",children:"变异系数 (cv)"},"cv")]}),e.jsxs(O.OptGroup,{label:"📊 百分位数",children:[e.jsx(w,{value:"p25",children:"25百分位 (p25)"},"p25"),e.jsx(w,{value:"p50",children:"50百分位 (p50)"},"p50"),e.jsx(w,{value:"p75",children:"75百分位 (p75)"},"p75"),e.jsx(w,{value:"p90",children:"90百分位 (p90)"},"p90"),e.jsx(w,{value:"p95",children:"95百分位 (p95)"},"p95"),e.jsx(w,{value:"p99",children:"99百分位 (p99)"},"p99")]}),e.jsxs(O.OptGroup,{label:"🔍 数据质量",children:[e.jsx(w,{value:"null_rate",children:"空值率 (null_rate)"},"null_rate"),e.jsx(w,{value:"completeness",children:"完整性 (completeness)"},"completeness"),e.jsx(w,{value:"outlier_count",children:"异常值计数 (outlier_count)"},"outlier_count")]}),e.jsxs(O.OptGroup,{label:"📉 变化检测",children:[e.jsx(w,{value:"change",children:"变化量 (change)"},"change"),e.jsx(w,{value:"change_rate",children:"变化率 (change_rate)"},"change_rate")]}),e.jsxs(O.OptGroup,{label:"⚡ 阈值监控",children:[e.jsx(w,{value:"above_count",children:"超过阈值计数 (above_count)"},"above_count"),e.jsx(w,{value:"below_count",children:"低于阈值计数 (below_count)"},"below_count"),e.jsx(w,{value:"in_range_count",children:"范围内计数 (in_range_count)"},"in_range_count")]})]}),e.jsxs("div",{style:{fontSize:"12px",color:"#666",marginTop:"8px"},children:["💡 提示：支持多选和搜索，包括基础统计、百分位数、数据质量检测等28个函数。",e.jsx("br",{}),"📊 ",e.jsx("strong",{children:"基础统计"}),": count, sum, avg, min, max 等日常统计",e.jsx("br",{}),"📈 ",e.jsx("strong",{children:"分布统计"}),": stddev, variance, volatility 等离散度指标",e.jsx("br",{}),"📊 ",e.jsx("strong",{children:"百分位数"}),": p25, p50, p75, p90, p95, p99 性能监控关键指标",e.jsx("br",{}),"🔍 ",e.jsx("strong",{children:"数据质量"}),": null_rate, completeness, outlier_count 数据健康度",e.jsx("br",{}),"📉 ",e.jsx("strong",{children:"变化检测"}),": change, change_rate 趋势分析",e.jsx("br",{}),"⚡ ",e.jsx("strong",{children:"阈值监控"}),": above_count, below_count, in_range_count 需配置阈值参数"]})]}),e.jsx(u.Item,{label:"分组字段",children:e.jsxs(O,{mode:"tags",placeholder:"按字段分组",value:s.config.group_by||[],onChange:n=>_(t,"group_by",n),children:[e.jsx(w,{value:"device_id",children:"设备ID"},"device_id"),e.jsx(w,{value:"key",children:"数据键"},"key"),e.jsx(w,{value:"tags",children:"标签"},"tags")]})}),e.jsx(u.Item,{label:e.jsxs(p,{children:["输出字段名",e.jsx(oe,{title:"聚合结果的字段名。支持模板变量，如 {{.Key}}_stats。留空将使用默认字段名。",children:e.jsx(Ce,{style:{color:"#1890ff"}})})]}),children:e.jsx(B,{placeholder:"如 {{.Key}}_stats（支持模板变量）",value:r||"",onChange:n=>{const i=n.target.value;s.config.output&&typeof s.config.output=="object"?_(t,"output",{...s.config.output,key_template:i}):_(t,"output_key",i),s.config.output_field!==void 0&&_(t,"output_field",i)}},`output-field-${t}-${r||"empty"}`)}),e.jsx(u.Item,{label:"窗口类型",tooltip:"计数窗口：基于数据点数量；时间窗口：基于时间范围",children:e.jsxs(O,{value:s.config.window_type||"count",onChange:n=>_(t,"window_type",n),children:[e.jsx(w,{value:"count",children:"计数窗口"}),e.jsx(w,{value:"time",children:"时间窗口"})]})}),s.config.window_type==="time"&&e.jsx(u.Item,{label:"时间窗口",tooltip:"时间格式：1s, 30s, 1m, 5m, 1h等",children:e.jsx(B,{placeholder:"如: 1m, 30s, 1h",value:s.config.window||"",onChange:n=>_(t,"window",n.target.value)})}),e.jsx(u.Item,{label:"上限阈值",tooltip:"用于above_count、in_range_count等阈值监控函数",children:e.jsx(W,{style:{width:"100%"},placeholder:"可选，用于阈值监控函数",value:s.config.upper_limit,onChange:n=>_(t,"upper_limit",n)})}),e.jsx(u.Item,{label:"下限阈值",tooltip:"用于below_count、in_range_count等阈值监控函数",children:e.jsx(W,{style:{width:"100%"},placeholder:"可选，用于阈值监控函数",value:s.config.lower_limit,onChange:n=>_(t,"lower_limit",n)})}),e.jsx(u.Item,{label:"异常值阈值",tooltip:"用于outlier_count函数，标准差的倍数，如2.0表示2倍标准差",children:e.jsx(W,{min:0,step:.1,style:{width:"100%"},placeholder:"如：2.0表示2倍标准差",value:s.config.outlier_threshold,onChange:n=>_(t,"outlier_threshold",n)})}),e.jsx(u.Item,{label:"转发结果",tooltip:"是否将聚合结果转发到NATS消息总线",children:e.jsx(he,{checked:s.config.forward!==!1,onChange:n=>_(t,"forward",n),checkedChildren:"是",unCheckedChildren:"否"})})]})},$=(s,t)=>e.jsxs("div",{children:[e.jsx(u.Item,{label:"转发目标",children:e.jsxs(O,{value:s.config.target_type||"http",onChange:l=>_(t,"target_type",l),children:[e.jsx(w,{value:"http",children:"HTTP接口"},"http"),e.jsx(w,{value:"file",children:"文件"},"file"),e.jsx(w,{value:"mqtt",children:"MQTT"},"mqtt"),e.jsx(w,{value:"kafka",children:"Kafka"},"kafka")]})}),s.config.target_type==="http"&&e.jsxs("div",{children:[e.jsx(u.Item,{label:"URL地址",children:e.jsx(B,{placeholder:"https://api.example.com/data",value:s.config.url,onChange:l=>_(t,"url",l.target.value)})}),e.jsx(u.Item,{label:"HTTP方法",children:e.jsxs(O,{value:s.config.method||"POST",onChange:l=>_(t,"method",l),children:[e.jsx(w,{value:"POST",children:"POST"},"POST"),e.jsx(w,{value:"PUT",children:"PUT"},"PUT"),e.jsx(w,{value:"PATCH",children:"PATCH"},"PATCH")]})}),e.jsx(u.Item,{label:"请求头",children:e.jsx(Qe,{rows:2,placeholder:'JSON格式，如: {"Content-Type": "application/json"}',value:s.config.headers?JSON.stringify(s.config.headers,null,2):"",onChange:l=>{try{const r=JSON.parse(l.target.value||"{}");_(t,"headers",r)}catch{}}})})]}),s.config.target_type==="file"&&e.jsx(u.Item,{label:"文件路径",children:e.jsx(B,{placeholder:"/var/log/iot_data.log",value:s.config.path,onChange:l=>_(t,"path",l.target.value)})}),s.config.target_type==="mqtt"&&e.jsxs("div",{children:[e.jsx(u.Item,{label:"MQTT代理",children:e.jsx(B,{placeholder:"tcp://localhost:1883",value:s.config.broker,onChange:l=>_(t,"broker",l.target.value)})}),e.jsx(u.Item,{label:"主题模板",children:e.jsx(B,{placeholder:"iot/{{.DeviceID}}/{{.Key}}",value:s.config.topic,onChange:l=>_(t,"topic",l.target.value)})})]}),e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"批处理大小",children:e.jsx(W,{placeholder:"1",value:s.config.batch_size||1,onChange:l=>_(t,"batch_size",l),min:1,style:{width:"100%"}})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"超时时间",children:e.jsx(B,{placeholder:"30s",value:s.config.timeout,onChange:l=>_(t,"timeout",l.target.value)})})})]})]}),L=(s,t)=>{switch(s.type){case"alert":return k(s,t);case"transform":return q(s,t);case"filter":return X(s,t);case"aggregate":return N(s,t);case"forward":return $(s,t);default:return e.jsx("div",{children:"请选择动作类型"})}};return e.jsx(I,{title:"执行动作配置",size:"small",children:e.jsxs(p,{direction:"vertical",style:{width:"100%"},children:[V.map((s,t)=>e.jsx(I,{size:"small",title:e.jsxs(p,{children:[m.find(l=>l.value===s.type)?.icon,e.jsxs("span",{children:["动作 ",t+1]}),e.jsx(g,{color:"blue",children:m.find(l=>l.value===s.type)?.label||s.type})]}),extra:V.length>1&&e.jsx(E,{type:"text",danger:!0,size:"small",icon:e.jsx(Ee,{}),onClick:()=>J(t)}),children:e.jsxs("div",{children:[e.jsx(u.Item,{label:"动作类型",children:e.jsx(O,{value:s.type,onChange:l=>{if(s.type!==l){let r={};switch(l){case"alert":r={level:"warning",message:"告警信息",channels:["console"]};break;case"transform":r={type:"scale",parameters:{factor:1},output_key:"",output_type:"float",precision:2,error_action:"default",default_value:0};break;case"filter":r={type:"range",min:0,max:100,drop_on_match:!1};break;case"aggregate":r={window_size:10,window_type:"count",functions:["avg","min","max"],group_by:["device_id"],output_key:"aggregated_value",forward:!0};break;case"forward":r={target_type:"http",url:"",method:"POST",batch_size:1,timeout:"30s"};break;default:r={}}const n=[...V];n[t]={...n[t],type:l,config:r},c.current=n;const i=S(n);v?.(i)}},style:{width:"100%"},children:m.map(l=>e.jsx(w,{value:l.value,children:e.jsxs(p,{children:[l.icon,l.label,e.jsxs(_a,{type:"secondary",children:["- ",l.description]})]})},l.value))})}),L(s,t),e.jsx(st,{size:"small"}),e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:8,children:e.jsx(u.Item,{label:e.jsxs(p,{children:["异步执行",e.jsx(oe,{title:"是否异步执行此动作",children:e.jsx(Ce,{})})]}),children:e.jsx(he,{checked:s.async,onChange:l=>D(t,"async",l),checkedChildren:"是",unCheckedChildren:"否"})})}),e.jsx(R,{span:8,children:e.jsx(u.Item,{label:"超时时间",children:e.jsx(B,{placeholder:"30s",value:s.timeout,onChange:l=>D(t,"timeout",l.target.value)})})}),e.jsx(R,{span:8,children:e.jsx(u.Item,{label:"重试次数",children:e.jsx(W,{value:s.retry,onChange:l=>D(t,"retry",l||0),min:0,max:10,style:{width:"100%"}})})})]})]})},t)),e.jsx(E,{type:"dashed",icon:e.jsx($e,{}),onClick:G,style:{width:"100%"},children:"添加动作"})]})})},{Text:et,Paragraph:Sa}=pe,{Search:Ca}=B,{Option:Ot}=O,Ta=({visible:h,onClose:v,onSelect:M})=>{const[c,C]=b.useState(""),[V,m]=b.useState("all"),[S,G]=b.useState("all"),J=[{id:"temperature_alert",name:"温度告警监控",description:"监控设备温度，超过阈值时发送告警通知",category:"monitoring",icon:e.jsx(at,{style:{color:"#ff4d4f"}}),difficulty:"beginner",tags:["温度","告警","监控"],rule:{name:"温度告警监控",description:"当设备温度超过指定阈值时发送告警",priority:100,enabled:!0,conditions:{type:"and",and:[{type:"simple",field:"key",operator:"eq",value:"temperature"},{type:"simple",field:"value",operator:"gt",value:35}]},actions:[{type:"alert",config:{level:"warning",message:"设备{{.DeviceID}}温度过高: {{.Value}}°C",channels:["console","webhook"]}}]}},{id:"humidity_control",name:"湿度控制规则",description:"根据湿度数据自动调节设备状态",category:"automation",icon:e.jsx(be,{style:{color:"#1890ff"}}),difficulty:"intermediate",tags:["湿度","自动化","控制"],rule:{name:"湿度自动控制",description:"根据湿度变化自动调节设备工作状态",priority:80,enabled:!0,conditions:{type:"or",or:[{type:"simple",field:"value",operator:"gt",value:80},{type:"simple",field:"value",operator:"lt",value:30}]},actions:[{type:"transform",config:{add_tags:{control_action:"humidity_adjust",timestamp:"{{.Timestamp}}"}}},{type:"forward",config:{target_type:"http",url:"http://localhost:8080/api/device/control",method:"POST",headers:{"Content-Type":"application/json"}}}]}},{id:"data_aggregation",name:"数据聚合统计",description:"对传感器数据进行实时聚合计算",category:"analytics",icon:e.jsx(se,{style:{color:"#52c41a"}}),difficulty:"intermediate",tags:["聚合","统计","分析"],rule:{name:"传感器数据聚合",description:"每10个数据点计算平均值、最大值和最小值",priority:50,enabled:!0,conditions:{type:"simple",field:"key",operator:"in",value:["temperature","humidity","pressure"]},actions:[{type:"aggregate",config:{window_type:"count",size:10,functions:["avg","max","min"],group_by:["device_id","key"],output_key:"{{.Key}}_stats",forward:!0}}]}},{id:"error_detection",name:"设备故障检测",description:"检测设备异常状态并记录故障信息",category:"monitoring",icon:e.jsx(na,{style:{color:"#fa8c16"}}),difficulty:"advanced",tags:["故障","检测","异常"],rule:{name:"设备故障检测",description:"检测设备状态异常并触发故障处理流程",priority:150,enabled:!0,conditions:{type:"or",or:[{type:"simple",field:"status",operator:"eq",value:"error"},{type:"simple",field:"quality",operator:"lt",value:50},{type:"expression",expression:"temperature > 60 || humidity > 95"}]},actions:[{type:"alert",config:{level:"critical",message:"设备{{.DeviceID}}发生故障: {{.Status}}",channels:["console","webhook","email"]}},{type:"transform",config:{add_tags:{alert_type:"device_fault",severity:"critical",processed_at:"{{.Timestamp}}"}}},{type:"forward",config:{target_type:"file",path:"/var/log/device_faults.log"}}]}},{id:"data_filtering",name:"数据质量过滤",description:"过滤低质量数据，只保留有效数据",category:"processing",icon:e.jsx(_e,{style:{color:"#722ed1"}}),difficulty:"beginner",tags:["过滤","质量","清洗"],rule:{name:"数据质量过滤",description:"过滤质量低于阈值的数据点",priority:200,enabled:!0,conditions:{type:"simple",field:"quality",operator:"exists",value:null},actions:[{type:"filter",config:{type:"range",min:70,max:100,drop_on_match:!1}}]}},{id:"data_conversion",name:"单位转换规则",description:"自动转换数据单位（如摄氏度转华氏度）",category:"processing",icon:e.jsx(Me,{style:{color:"#1890ff"}}),difficulty:"intermediate",tags:["转换","单位","格式"],rule:{name:"温度单位转换",description:"将摄氏度转换为华氏度",priority:60,enabled:!0,conditions:{type:"and",and:[{type:"simple",field:"key",operator:"eq",value:"temperature"},{type:"simple",field:"unit",operator:"eq",value:"celsius"}]},actions:[{type:"transform",config:{field:"value",scale_factor:1.8,offset:32,precision:1,add_tags:{unit:"fahrenheit",converted:"true"}}}]}},{id:"security_monitoring",name:"安全监控规则",description:"监控异常访问和安全事件",category:"security",icon:e.jsx(oa,{style:{color:"#f5222d"}}),difficulty:"advanced",tags:["安全","监控","异常"],rule:{name:"安全事件监控",description:"检测潜在的安全威胁和异常行为",priority:180,enabled:!0,conditions:{type:"or",or:[{type:"simple",field:"event_type",operator:"eq",value:"unauthorized_access"},{type:"simple",field:"failed_attempts",operator:"gt",value:5}]},actions:[{type:"alert",config:{level:"critical",message:"检测到安全威胁: {{.EventType}}",channels:["console","webhook","email","sms"]}},{type:"forward",config:{target_type:"http",url:"https://security.example.com/api/incidents",method:"POST"}}]}},{id:"performance_monitoring",name:"性能监控规则",description:"监控系统性能指标和资源使用情况",category:"monitoring",icon:e.jsx(ca,{style:{color:"#13c2c2"}}),difficulty:"intermediate",tags:["性能","监控","资源"],rule:{name:"系统性能监控",description:"监控CPU、内存使用率异常",priority:90,enabled:!0,conditions:{type:"and",and:[{type:"simple",field:"key",operator:"in",value:["cpu_usage","memory_usage"]},{type:"simple",field:"value",operator:"gt",value:85}]},actions:[{type:"alert",config:{level:"warning",message:"系统{{.Key}}过高: {{.Value}}%",channels:["console","webhook"],throttle:"5m"}},{type:"aggregate",config:{window_type:"time",size:"1m",functions:["avg","max"],group_by:["device_id"],output_key:"performance_stats"}}]}}],D=[{value:"all",label:"全部分类"},{value:"monitoring",label:"监控告警"},{value:"automation",label:"自动化控制"},{value:"analytics",label:"数据分析"},{value:"processing",label:"数据处理"},{value:"security",label:"安全监控"}],_=[{value:"all",label:"全部难度"},{value:"beginner",label:"初级",color:"green"},{value:"intermediate",label:"中级",color:"orange"},{value:"advanced",label:"高级",color:"red"}],k=J.filter(N=>{const $=c===""||N.name.toLowerCase().includes(c.toLowerCase())||N.description.toLowerCase().includes(c.toLowerCase())||N.tags.some(t=>t.toLowerCase().includes(c.toLowerCase())),L=V==="all"||N.category===V,s=S==="all"||N.difficulty===S;return $&&L&&s}),q=N=>{M(N),v()},X=N=>_.find(L=>L.value===N)?.color||"default";return e.jsxs(Te,{title:"选择规则模板",open:h,onCancel:v,footer:null,width:1e3,styles:{body:{maxHeight:"70vh",overflowY:"auto"}},children:[e.jsx(P,{message:"规则模板库",description:"选择预定义的规则模板快速开始，您可以在此基础上进行修改和定制。",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx(I,{size:"small",style:{marginBottom:16},children:e.jsxs(Z,{gutter:16,align:"middle",children:[e.jsx(R,{span:8,children:e.jsx(Ca,{placeholder:"搜索模板名称、描述或标签",value:c,onChange:N=>C(N.target.value),allowClear:!0})}),e.jsx(R,{span:6,children:e.jsx(O,{placeholder:"选择分类",value:V,onChange:m,style:{width:"100%"},children:D.map(N=>e.jsx(Ot,{value:N.value,children:N.label},N.value))})}),e.jsx(R,{span:6,children:e.jsx(O,{placeholder:"选择难度",value:S,onChange:G,style:{width:"100%"},children:_.map(N=>e.jsx(Ot,{value:N.value,children:N.label},N.value))})}),e.jsx(R,{span:4,children:e.jsxs(et,{type:"secondary",children:["共 ",k.length," 个模板"]})})]})}),e.jsx(Z,{gutter:[16,16],children:k.map(N=>e.jsx(R,{span:12,children:e.jsxs(I,{hoverable:!0,size:"small",title:e.jsxs(p,{children:[N.icon,e.jsx("span",{children:N.name}),e.jsx(g,{color:X(N.difficulty),children:_.find($=>$.value===N.difficulty)?.label})]}),extra:e.jsx(E,{type:"primary",size:"small",onClick:()=>q(N),children:"使用模板"}),style:{height:200},children:[e.jsx(Sa,{ellipsis:{rows:2,expandable:!1},style:{marginBottom:12,minHeight:40},children:N.description}),e.jsx(p,{wrap:!0,style:{marginBottom:8},children:N.tags.map($=>e.jsx(g,{children:$},$))}),e.jsx(st,{style:{margin:"8px 0"}}),e.jsxs(Z,{justify:"space-between",align:"middle",children:[e.jsx(R,{children:e.jsx(et,{type:"secondary",style:{fontSize:12},children:D.find($=>$.value===N.category)?.label})}),e.jsx(R,{children:e.jsxs(et,{type:"secondary",style:{fontSize:12},children:["优先级: ",N.rule.priority]})})]})]})},N.id))}),k.length===0&&e.jsx("div",{style:{textAlign:"center",padding:"40px 0"},children:e.jsx(et,{type:"secondary",children:"没有找到匹配的模板"})})]})},{Text:He,Title:ka}=pe,{TabPane:Nt}=ke,Rt=[{type:"simple",category:"basic",key:"numeric",name:"数值数据",icon:e.jsx(qt,{}),description:"温度、湿度、压力等单一数值",examples:["temperature: 25.5","humidity: 60","pressure: 1013"],color:"#1890ff"},{type:"simple",category:"basic",key:"status",name:"状态数据",icon:e.jsx(me,{}),description:"开关状态、设备状态等布尔或枚举值",examples:['status: "online"',"enabled: true",'level: "warning"'],color:"#52c41a"},{type:"complex",category:"geospatial",key:"location",name:"GPS位置",icon:e.jsx(vt,{}),description:"经纬度、海拔、速度等地理位置信息",examples:["location: {lat: 39.9042, lng: 116.4074}","gps: {lat: 39.9042, lng: 116.4074, alt: 50, speed: 60}"],color:"#fa8c16"},{type:"complex",category:"vector",key:"vector3d",name:"三维向量",icon:e.jsx(Bt,{}),description:"加速度、磁场、陀螺仪等三维向量数据",examples:["acceleration: {x: 1.2, y: -0.8, z: 9.8}","magnetic: {x: 25, y: -30, z: 45}"],color:"#722ed1"},{type:"complex",category:"visual",key:"color",name:"颜色数据",icon:e.jsx(rt,{}),description:"RGB、HSL颜色值和颜色空间数据",examples:["color: {r: 255, g: 128, b: 0}","hsl: {h: 30, s: 100, l: 50}"],color:"#eb2f96"},{type:"complex",category:"array",key:"vector_array",name:"向量数组",icon:e.jsx(pa,{}),description:"传感器阵列、频谱数据等数组类型",examples:["spectrum: [1.2, 2.5, 1.8, 3.1, 2.7]","sensors: [25.1, 25.3, 24.9, 25.2]"],color:"#13c2c2"},{type:"complex",category:"matrix",key:"matrix",name:"矩阵数据",icon:e.jsx(ua,{}),description:"二维矩阵数据、图像数据等",examples:["matrix: [[1,2,3], [4,5,6], [7,8,9]]","image: {rows: 100, cols: 100, data: [...]}"],color:"#2f54eb"},{type:"complex",category:"timeseries",key:"timeseries",name:"时间序列",icon:e.jsx(xa,{}),description:"历史趋势、采样序列等时间序列数据",examples:["trend: {timestamps: [...], values: [...]}",'history: {interval: "1m", data: [...]}'],color:"#f5222d"}],za=({visible:h,onTypeSelect:v,onCancel:M})=>{const c=C=>e.jsx(R,{span:C.type==="simple"?12:8,children:e.jsx(I,{hoverable:!0,onClick:()=>v(C),className:"data-type-card",style:{height:"100%",border:`2px solid ${C.color}20`,borderRadius:"8px"},bodyStyle:{padding:"16px"},children:e.jsx(I.Meta,{avatar:e.jsx(ha,{size:48,icon:C.icon,style:{backgroundColor:C.color}}),title:e.jsxs(p,{children:[C.name,e.jsx(g,{color:C.color,size:"small",children:C.type==="simple"?"简单":"复合"})]}),description:e.jsxs("div",{children:[e.jsx(He,{style:{fontSize:"13px",lineHeight:"1.4"},children:C.description}),e.jsx("div",{style:{marginTop:"8px"},children:C.examples.map((V,m)=>e.jsx(g,{style:{fontSize:"10px",margin:"2px",backgroundColor:`${C.color}15`,color:C.color,border:`1px solid ${C.color}30`},children:V},m))})]})})})},C.key);return h?e.jsx("div",{className:"data-type-selector-overlay",style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:1e3,display:"flex",alignItems:"center",justifyContent:"center"},onClick:M,children:e.jsxs(I,{style:{width:"90%",maxWidth:"1200px",maxHeight:"90vh",overflow:"auto"},onClick:C=>C.stopPropagation(),children:[e.jsxs("div",{style:{marginBottom:"24px",textAlign:"center"},children:[e.jsx(ka,{level:3,style:{margin:0},children:e.jsxs(p,{children:[e.jsx(da,{}),"选择数据类型"]})}),e.jsx(He,{type:"secondary",children:"选择适合您数据结构的规则编辑器类型"})]}),e.jsxs(ke,{defaultActiveKey:"simple",size:"large",children:[e.jsxs(Nt,{tab:e.jsxs(p,{children:[e.jsx(qt,{}),"单点数据规则",e.jsx(g,{color:"blue",size:"small",children:"简单高效"})]}),children:[e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(He,{type:"secondary",children:"适用于处理单一数值、状态等简单数据类型的规则"})}),e.jsx(Z,{gutter:[16,16],children:Rt.filter(C=>C.type==="simple").map(c)})]},"simple"),e.jsxs(Nt,{tab:e.jsxs(p,{children:[e.jsx(Bt,{}),"复合数据规则",e.jsx(g,{color:"purple",size:"small",children:"功能强大"})]}),children:[e.jsx("div",{style:{marginBottom:"16px"},children:e.jsx(He,{type:"secondary",children:"适用于处理GPS位置、向量、矩阵等复杂数据结构的高级规则"})}),e.jsx(Z,{gutter:[16,16],children:Rt.filter(C=>C.type==="complex").map(c)})]},"complex")]}),e.jsx("div",{style:{marginTop:"24px",textAlign:"center",padding:"16px",backgroundColor:"#f0f2f5",borderRadius:"6px"},children:e.jsx(He,{type:"secondary",style:{fontSize:"12px"},children:"💡 提示：选择数据类型后将进入对应的专用规则编辑器，提供最佳的编辑体验"})})]})}):null};class Ya extends Ht.Component{form=u.useForm?u.useForm()[0]:null;constructor(v){super(v),this.state={saving:!1,validationErrors:[]}}componentDidUpdate(v){this.props.visible&&!v.visible&&this.props.rule&&this.loadRuleData(this.props.rule)}loadRuleData(v){this.form&&this.form.setFieldsValue({name:v.name||"",description:v.description||"",priority:v.priority||50,enabled:v.enabled!==!1}),this.loadConditions(v.conditions),this.loadActions(v.actions||[])}validateRule(v){const M=[];return(!v.name||v.name.trim()==="")&&M.push("规则名称不能为空"),v.conditions||M.push("必须设置至少一个条件"),(!v.actions||v.actions.length===0)&&M.push("必须设置至少一个动作"),(typeof v.priority!="number"||v.priority<0||v.priority>100)&&M.push("优先级必须是0-100之间的数字"),M}handleSave=async()=>{try{this.setState({saving:!0,validationErrors:[]});const v=this.form?await this.form.validateFields():{},M={id:this.props.rule?.id||"",name:v.name||"",description:v.description||"",priority:v.priority||50,enabled:v.enabled!==!1,data_type:this.props.rule?.data_type,conditions:this.buildConditions(),actions:this.buildActions(),tags:this.props.rule?.tags||{},version:this.props.rule?.version||1,created_at:this.props.rule?.created_at||new Date().toISOString(),updated_at:new Date().toISOString()},c=this.validateRule(M);if(c.length>0){this.setState({validationErrors:c}),Y.error(`验证失败: ${c.join(", ")}`);return}await this.props.onSave(M),Y.success("规则保存成功"),this.props.onClose()}catch(v){console.error("保存规则失败:",v),Y.error("保存规则失败："+(v.message||"未知错误"))}finally{this.setState({saving:!1})}};handleCancel=()=>{this.form&&this.form.resetFields(),this.setState({validationErrors:[]}),this.props.onClose()};renderFooter(){return e.jsxs(p,{children:[e.jsx(E,{onClick:this.handleCancel,children:"取消"}),e.jsx(E,{type:"primary",loading:this.state.saving,onClick:this.handleSave,children:"保存规则"})]})}renderBaseForm(){return e.jsxs(u,{form:this.form,layout:"vertical",initialValues:{priority:50,enabled:!0},children:[e.jsx(u.Item,{label:"规则名称",name:"name",rules:[{required:!0,message:"请输入规则名称"}],children:e.jsx("input",{placeholder:"请输入规则名称"})}),e.jsx(u.Item,{label:"规则描述",name:"description",children:e.jsx("textarea",{placeholder:"请输入规则描述",rows:2})}),e.jsx(u.Item,{label:"优先级",name:"priority",rules:[{required:!0,message:"请输入优先级"},{type:"number",min:0,max:100,message:"优先级必须在0-100之间"}],children:e.jsx("input",{type:"number",min:0,max:100})}),e.jsx(u.Item,{label:"启用状态",name:"enabled",valuePropName:"checked",children:e.jsx("input",{type:"checkbox"})})]})}render(){return e.jsx(Te,{title:`${this.props.title} - ${this.props.dataTypeName}`,open:this.props.visible,onCancel:this.handleCancel,footer:this.renderFooter(),width:800,destroyOnHidden:!0,children:e.jsxs("div",{children:[this.renderBaseForm(),this.state.validationErrors.length>0&&e.jsxs("div",{style:{marginBottom:16,color:"#ff4d4f"},children:[e.jsx("strong",{children:"验证错误："}),e.jsx("ul",{children:this.state.validationErrors.map((v,M)=>e.jsx("li",{children:v},M))})]}),this.renderSpecializedContent()]})})}}const Pe=h=>{const[v]=u.useForm(),[M,c]=b.useState(!1),[C,V]=b.useState([]);b.useEffect(()=>{h.visible&&h.rule&&v.setFieldsValue({name:h.rule.name||"",description:h.rule.description||"",priority:h.rule.priority||50,enabled:h.rule.enabled!==!1})},[h.visible,h.rule,v]);const m=J=>{const D=[];return(!J.name||J.name.trim()==="")&&D.push("规则名称不能为空"),J.conditions||D.push("必须设置至少一个条件"),(!J.actions||J.actions.length===0)&&D.push("必须设置至少一个动作"),(typeof J.priority!="number"||J.priority<0||J.priority>100)&&D.push("优先级必须是0-100之间的数字"),D};return{form:v,saving:M,validationErrors:C,handleSave:async(J,D)=>{try{c(!0),V([]);const _=await v.validateFields(),k={id:h.rule?.id||"",name:_.name||"",description:_.description||"",priority:_.priority||50,enabled:_.enabled!==!1,data_type:h.rule?.data_type,conditions:J(),actions:D(),tags:h.rule?.tags||{},version:h.rule?.version||1,created_at:h.rule?.created_at||new Date().toISOString(),updated_at:new Date().toISOString()},q=m(k);if(q.length>0){V(q),Y.error(`验证失败: ${q.join(", ")}`);return}await h.onSave(k),Y.success("规则保存成功"),h.onClose()}catch(_){console.error("保存规则失败:",_),Y.error("保存规则失败："+(_.message||"未知错误"))}finally{c(!1)}},handleCancel:()=>{v.resetFields(),V([]),h.onClose()}}},{Option:tt}=O,{Text:fe}=pe,{TextArea:Ia}=B,Fe=({value:h,onChange:v,availableFields:M=["device_id","key","value","timestamp","quality"],customFieldOptions:c=[],allowedOperators:C=["eq","ne","gt","gte","lt","lte","contains","startswith","endswith","regex"],supportExpressions:V=!0,dataTypeName:m="数据"})=>{const[S,G]=b.useState(h);b.useEffect(()=>{G(h)},[h]);const J=[{value:"eq",label:"等于 (=)",description:"字段值等于指定值"},{value:"ne",label:"不等于 (≠)",description:"字段值不等于指定值"},{value:"gt",label:"大于 (>)",description:"字段值大于指定值"},{value:"gte",label:"大于等于 (≥)",description:"字段值大于等于指定值"},{value:"lt",label:"小于 (<)",description:"字段值小于指定值"},{value:"lte",label:"小于等于 (≤)",description:"字段值小于等于指定值"},{value:"contains",label:"包含",description:"字段值包含指定文本"},{value:"startswith",label:"开头匹配",description:"字段值以指定文本开头"},{value:"endswith",label:"结尾匹配",description:"字段值以指定文本结尾"},{value:"regex",label:"正则匹配",description:"字段值匹配正则表达式"}].filter(r=>C.includes(r.value)),D=[{value:"simple",label:"简单条件",description:"单个字段比较条件"},{value:"and",label:"逻辑AND",description:"所有子条件都必须满足"},{value:"or",label:"逻辑OR",description:"至少一个子条件满足"}];V&&D.push({value:"expression",label:"表达式条件",description:"使用表达式语言进行复杂计算"});const _=[...M.map(r=>({value:r,label:r})),...c],k=r=>{G(r),v?.(r)},q=r=>{let n;switch(r){case"simple":n={type:"simple",field:"",operator:"eq",value:""};break;case"and":n={type:"and",and:[{type:"simple",field:"",operator:"eq",value:""},{type:"simple",field:"",operator:"eq",value:""}]};break;case"or":n={type:"or",or:[{type:"simple",field:"",operator:"eq",value:""},{type:"simple",field:"",operator:"eq",value:""}]};break;case"expression":n={type:"expression",expression:""};break;default:n={type:"simple",field:"",operator:"eq",value:""}}k(n)},X=(r,n)=>{if(!S)return;const i={...S,[r]:n};k(i)},N=(r,n,i=!0)=>{if(!S)return;const x={...S},j=i?"and":"or",H=x[j]||[];H[r]=n,x[j]=H,k(x)},$=(r=!0)=>{if(!S)return;const n={...S},i=r?"and":"or",x=n[i]||[];x.push({type:"simple",field:"",operator:"eq",value:""}),n[i]=x,k(n)},L=(r,n=!0)=>{if(!S)return;const i={...S},x=n?"and":"or",j=i[x]||[];j.splice(r,1),i[x]=j,k(i)},s=(r,n)=>{const i=S,x=k;return!i||i.type!=="simple"?null:e.jsxs(I,{size:"small",style:{backgroundColor:"#fafafa",marginBottom:16},children:[e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:8,children:e.jsx(u.Item,{label:e.jsxs(p,{size:"small",children:[e.jsx(_e,{style:{color:"#1890ff"}}),e.jsx("span",{children:"字段"})]}),children:e.jsx(O,{placeholder:"选择字段",value:i.field,onChange:j=>x({...i,field:j}),showSearch:!0,size:"large",style:{width:"100%"},optionLabelProp:"label",children:_.map(j=>e.jsx(tt,{value:j.value,label:j.label,children:e.jsxs("div",{style:{padding:"6px 0",lineHeight:"1.4"},children:[e.jsx("div",{children:e.jsx(fe,{strong:!0,style:{fontSize:"14px"},children:j.label})}),j.description&&e.jsx("div",{children:e.jsx(fe,{type:"secondary",style:{fontSize:"12px"},children:j.description})})]})},j.value))})})}),e.jsx(R,{span:6,children:e.jsx(u.Item,{label:e.jsxs(p,{size:"small",children:[e.jsx(se,{style:{color:"#52c41a"}}),e.jsx("span",{children:"操作符"})]}),children:e.jsx(O,{placeholder:"选择操作符",value:i.operator,onChange:j=>x({...i,operator:j}),size:"large",style:{width:"100%"},optionLabelProp:"label",children:J.map(j=>e.jsx(tt,{value:j.value,label:j.label,children:e.jsxs("div",{style:{padding:"6px 0",lineHeight:"1.4"},children:[e.jsx("div",{children:e.jsx(fe,{strong:!0,style:{fontSize:"14px"},children:j.label})}),e.jsx("div",{children:e.jsx(fe,{type:"secondary",style:{fontSize:"12px"},children:j.description})})]})},j.value))})})}),e.jsx(R,{span:10,children:e.jsx(u.Item,{label:e.jsxs(p,{size:"small",children:[e.jsx(ce,{style:{color:"#fa8c16"}}),e.jsx("span",{children:"值"})]}),children:i.operator==="regex"?e.jsx(B,{placeholder:"输入正则表达式",value:i.value,onChange:j=>x({...i,value:j.target.value}),size:"large",style:{fontFamily:"Monaco, Consolas, monospace"}}):["gt","gte","lt","lte"].includes(i.operator||"")?e.jsx(W,{placeholder:"输入数字值",value:i.value,onChange:j=>x({...i,value:j}),style:{width:"100%"},size:"large",precision:2}):e.jsx(B,{placeholder:"输入比较值",value:i.value,onChange:j=>x({...i,value:j.target.value}),size:"large"})})})]}),i.field&&i.operator&&i.value!==""&&e.jsx(P,{message:"条件预览",description:e.jsxs(g,{color:"blue",style:{fontSize:"12px"},children:[i.field," ",J.find(j=>j.value===i.operator)?.label," ",i.value]}),type:"info",showIcon:!0,style:{marginTop:8},size:"small"})]})},t=(r=!0)=>{if(!S)return null;const i=S[r?"and":"or"]||[],x=r?"AND条件":"OR条件",j=r?"所有子条件都必须满足":"至少一个子条件满足",H=r?"blue":"green";return e.jsxs("div",{children:[e.jsx(P,{message:e.jsxs(p,{children:[e.jsx(g,{color:H,icon:r?e.jsx(_e,{}):e.jsx(se,{}),children:x}),e.jsx("span",{children:j}),V&&e.jsx(g,{color:"green",size:"small",children:"支持表达式"})]}),type:"info",showIcon:!0,style:{marginBottom:16}}),i.map((Q,A)=>e.jsx(I,{size:"small",style:{marginBottom:16,border:`2px dashed ${r?"#1890ff":"#52c41a"}`,borderRadius:8},title:e.jsxs(p,{children:[e.jsxs(g,{color:H,children:["条件 ",A+1]}),r?"AND":"OR"]}),extra:i.length>1&&e.jsx(oe,{title:"删除这个条件",children:e.jsx(E,{type:"link",icon:e.jsx(Ee,{}),danger:!0,size:"small",onClick:()=>L(A,r),children:"删除"})}),children:e.jsx(Fe,{value:Q,onChange:re=>re&&N(A,re,r),availableFields:M,customFieldOptions:c,allowedOperators:C,supportExpressions:V,dataTypeName:m})},A)),e.jsxs(E,{type:"dashed",icon:e.jsx($e,{}),onClick:()=>$(r),style:{width:"100%",height:"48px",borderColor:r?"#1890ff":"#52c41a",color:r?"#1890ff":"#52c41a"},size:"large",children:["添加",r?"AND":"OR","条件"]})]})},l=()=>!S||S.type!=="expression"?null:e.jsxs(I,{size:"small",style:{backgroundColor:"#f6ffed",marginBottom:16},children:[e.jsx(P,{message:"表达式模式",description:"使用表达式语言进行复杂计算，支持数学运算、字符串操作和逻辑判断",type:"success",showIcon:!0,style:{marginBottom:16}}),e.jsx(u.Item,{label:e.jsxs(p,{children:[e.jsx(se,{style:{color:"#52c41a"}}),e.jsxs("span",{children:[m,"表达式"]})]}),children:e.jsx(Ia,{placeholder:`输入${m}表达式，例如：value > 30 && contains(device_id, "sensor")`,value:S.expression,onChange:r=>X("expression",r.target.value),rows:4,style:{fontFamily:'Monaco, Consolas, "Courier New", monospace',fontSize:"13px",lineHeight:"1.5"}})}),e.jsx("div",{style:{marginTop:12},children:e.jsxs(fe,{type:"secondary",style:{fontSize:12},children:[e.jsx(ce,{style:{marginRight:4}}),"示例: value ",">"," 30 ","&&",' contains(device_id, "sensor") ',"||"," temperature ","<"," 0"]})})]});return S?e.jsxs(I,{title:e.jsxs(p,{children:[e.jsx(_e,{style:{color:"#1890ff"}}),e.jsx("span",{children:"规则条件"}),e.jsx(g,{color:"blue",children:m})]}),style:{border:"1px solid #e8f4fd",borderRadius:8,backgroundColor:"#fafcff"},children:[e.jsx(u.Item,{label:e.jsxs(p,{children:[e.jsx(se,{style:{color:"#52c41a"}}),e.jsx("span",{children:"条件类型"})]}),children:e.jsx(O,{value:S.type,onChange:q,size:"large",style:{width:"100%"},optionLabelProp:"label",children:D.map(r=>e.jsx(tt,{value:r.value,label:r.label,children:e.jsxs("div",{style:{padding:"6px 0",lineHeight:"1.4"},children:[e.jsx("div",{children:e.jsx(fe,{strong:!0,style:{fontSize:"14px"},children:r.label})}),e.jsx("div",{children:e.jsx(fe,{type:"secondary",style:{fontSize:"12px"},children:r.description})})]})},r.value))})}),e.jsx(st,{style:{margin:"16px 0"}}),S.type==="simple"&&s(),S.type==="and"&&t(!0),S.type==="or"&&t(!1),S.type==="expression"&&l()]}):e.jsxs(I,{title:e.jsxs(p,{children:[e.jsx(_e,{style:{color:"#1890ff"}}),e.jsx("span",{children:"设置条件"})]}),style:{border:"2px dashed #d9d9d9",borderRadius:8,backgroundColor:"#fafafa"},children:[e.jsx(P,{message:"选择条件类型开始配置",description:"选择适合的条件类型来定义规则的触发条件",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx(u.Item,{label:e.jsxs(p,{children:[e.jsx(se,{style:{color:"#52c41a"}}),e.jsx("span",{children:"条件类型"})]}),children:e.jsx(O,{placeholder:"选择条件类型",onChange:q,size:"large",style:{width:"100%"},optionLabelProp:"label",children:D.map(r=>e.jsx(tt,{value:r.value,label:r.label,children:e.jsxs("div",{style:{padding:"6px 0",lineHeight:"1.4"},children:[e.jsx("div",{children:e.jsx(fe,{strong:!0,style:{fontSize:"14px"},children:r.label})}),e.jsx("div",{children:e.jsx(fe,{type:"secondary",style:{fontSize:"12px"},children:r.description})})]})},r.value))})})]})},{Option:xt}=O,{Text:Dt}=pe,{TextArea:ht}=B,Le=({value:h=[],onChange:v,availableActionTypes:M=["alert","transform","filter","aggregate","forward"],customActionOptions:c=[],dataTypeName:C="数据"})=>{const[V,m]=b.useState(h),S=[{value:"alert",label:"告警动作",description:"发送告警通知",configSchema:{level:{type:"string",label:"告警级别",required:!0,options:[{value:"info",label:"信息"},{value:"warning",label:"警告"},{value:"error",label:"错误"},{value:"critical",label:"严重"}],defaultValue:"warning"},message:{type:"textarea",label:"告警消息",required:!0,placeholder:"告警消息模板，支持变量：{{.DeviceID}}, {{.Value}}",description:"支持模板变量，如 {{.DeviceID}}, {{.Value}}, {{.Timestamp}}"},type:{type:"string",label:"通知类型",options:[{value:"console",label:"控制台"},{value:"webhook",label:"Webhook"},{value:"email",label:"邮件"},{value:"sms",label:"短信"}],defaultValue:"console"}}},{value:"transform",label:"数据转换",description:"转换或修改数据",configSchema:{output_key:{type:"string",label:"输出字段",placeholder:"转换后的字段名",description:"转换结果存储的字段名"},output_type:{type:"string",label:"输出类型",options:[{value:"float",label:"浮点数"},{value:"int",label:"整数"},{value:"string",label:"字符串"},{value:"boolean",label:"布尔值"}],defaultValue:"float"},type:{type:"string",label:"转换类型",required:!0,options:[{value:"scale",label:"数值缩放"},{value:"offset",label:"数值偏移"},{value:"expression",label:"表达式计算"},{value:"lookup",label:"查找表映射"},{value:"format",label:"格式化"}]}}},{value:"filter",label:"数据过滤",description:"过滤或筛选数据",configSchema:{type:{type:"string",label:"过滤类型",required:!0,options:[{value:"range",label:"范围过滤"},{value:"pattern",label:"模式匹配"},{value:"deduplication",label:"去重过滤"},{value:"rate_limit",label:"速率限制"}]},drop_on_match:{type:"boolean",label:"匹配时丢弃",description:"true: 匹配条件时丢弃数据，false: 不匹配时丢弃",defaultValue:!1}}},{value:"aggregate",label:"数据聚合",description:"统计计算和聚合",configSchema:{functions:{type:"array",label:"聚合函数",required:!0,description:"选择要计算的统计函数",options:[{value:"count",label:"计数"},{value:"sum",label:"求和"},{value:"avg",label:"平均值"},{value:"min",label:"最小值"},{value:"max",label:"最大值"},{value:"stddev",label:"标准差"},{value:"p90",label:"90分位数"},{value:"p95",label:"95分位数"}]},window_type:{type:"string",label:"窗口类型",required:!0,options:[{value:"count",label:"计数窗口"},{value:"time",label:"时间窗口"},{value:"sliding",label:"滑动窗口"}]},window_size:{type:"number",label:"窗口大小",placeholder:"窗口大小（数量或秒数）"}}},{value:"forward",label:"数据转发",description:"转发数据到其他主题",configSchema:{subject:{type:"string",label:"目标主题",required:!0,placeholder:"iot.processed.{{device_id}}",description:"支持模板变量，如 {{device_id}}, {{key}}"}}}],G={visual:{alert:"visual_alert",transform:"color_transform"},vector_generic:{alert:"generic_vector_alert",transform:"generic_vector_transform"},geospatial:{alert:"geospatial_alert",transform:"geospatial_transform"},vector3d:{alert:"vector3d_alert",transform:"vector3d_transform"}},D=(()=>{if(c.length>0){const x=c[0].value;if(x.includes("color")||x.includes("visual"))return"visual";if(x.includes("vector")&&x.includes("generic"))return"vector_generic";if(x.includes("geospatial"))return"geospatial";if(x.includes("vector3d"))return"vector3d"}const i=C?.toLowerCase()||"";return i.includes("视觉")||i.includes("visual")||i.includes("颜色")||i.includes("color")?"visual":i.includes("通用向量")||i.includes("generic")||i.includes("vector")?"vector_generic":i.includes("地理")||i.includes("geospatial")||i.includes("位置")||i.includes("location")?"geospatial":i.includes("3d")||i.includes("向量3d")||i.includes("vector3d")?"vector3d":"unknown"})(),_=Ht.useCallback(i=>{if(c.some(j=>j.value===i))return i;const x=G[D];if(x&&x[i]){const j=x[i];return console.log(`ActionFormBuilder: 动作类型映射 "${i}" -> "${j}" (数据类型: ${D})`),j}return i},[c,D]),k=[...S.filter(i=>M.includes(i.value)),...c];b.useEffect(()=>{console.log("ActionFormBuilder接收到新的value:",h);const i=h.map(x=>{const j=_(x.type);return j!==x.type?(console.log(`ActionFormBuilder: 转换动作类型 "${x.type}" -> "${j}"`),{...x,type:j}):x});m(i),i.some((x,j)=>x.type!==h[j]?.type)&&(console.log("ActionFormBuilder: 动作类型已转换，异步通知父组件"),setTimeout(()=>{v?.(i)},0))},[h,_]);const q=i=>{console.log("ActionFormBuilder updateActions:",i),m(i),v?.(i)},X=()=>{const i={type:"alert",config:{},async:!1,timeout:"0s",retry:0};q([...V,i])},N=i=>{const x=V.filter((j,H)=>H!==i);q(x)},$=(i,x)=>{const j=[...V];j[i]=x,q(j)},L=(i,x,j,H)=>{const{type:Q,label:A,required:re,placeholder:U,description:le,options:te,defaultValue:ae}=x;switch(console.log(`渲染配置字段 ${i}:`,{type:Q,value:j,defaultValue:ae}),Q){case"string":return te?e.jsx(O,{placeholder:U||`选择${A}`,value:j!==void 0?j:ae,onChange:o=>{console.log(`Select字段 ${i} 变更:`,o),H(o)},size:"large",children:te.map(o=>e.jsx(xt,{value:o.value,children:o.label},o.value))}):e.jsx(B,{placeholder:U,value:j!==void 0?j:ae,onChange:o=>{console.log(`Input字段 ${i} 变更:`,o.target.value),H(o.target.value)},size:"large"});case"textarea":return e.jsx(ht,{rows:3,placeholder:U,value:j!==void 0?j:ae,onChange:o=>{console.log(`TextArea字段 ${i} 变更:`,o.target.value),H(o.target.value)},size:"large"});case"number":return e.jsx(W,{style:{width:"100%"},placeholder:U,value:j!==void 0?j:ae,onChange:o=>{console.log(`InputNumber字段 ${i} 变更:`,o),H(o)},size:"large"});case"boolean":return e.jsx(he,{checked:j!==void 0?j:ae,onChange:o=>{console.log(`Switch字段 ${i} 变更:`,o),H(o)}});case"array":return te?e.jsx(O,{mode:"multiple",placeholder:U||`选择${A}`,value:j||[],onChange:o=>{console.log(`多选字段 ${i} 变更:`,o),H(o)},size:"large",children:te.map(o=>e.jsx(xt,{value:o.value,children:o.label},o.value))}):e.jsx(ht,{rows:2,placeholder:"每行一个值",value:j!==void 0?j:ae,onChange:o=>{console.log(`数组TextArea字段 ${i} 变更:`,o.target.value),H(o.target.value)},size:"large"});case"object":return e.jsx(ht,{rows:3,placeholder:U||"JSON格式的对象",value:typeof j=="object"?JSON.stringify(j,null,2):j||"",onChange:o=>{try{const y=JSON.parse(o.target.value);console.log(`对象字段 ${i} 变更:`,y),H(y)}catch{console.log(`对象字段 ${i} 变更 (文本):`,o.target.value),H(o.target.value)}},size:"large"});default:return e.jsx(B,{placeholder:U,value:j!==void 0?j:ae,onChange:o=>{console.log(`默认Input字段 ${i} 变更:`,o.target.value),H(o.target.value)},size:"large"})}},s=i=>({level:e.jsx(kt,{style:{color:"#fa8c16"}}),message:e.jsx(ce,{style:{color:"#1890ff"}}),type:e.jsx(be,{style:{color:"#52c41a"}}),output_key:e.jsx(dt,{style:{color:"#722ed1"}}),output_type:e.jsx(Me,{style:{color:"#13c2c2"}}),transform_type:e.jsx(se,{style:{color:"#eb2f96"}}),subject:e.jsx(dt,{style:{color:"#fa541c"}}),functions:e.jsx(se,{style:{color:"#1890ff"}}),window_type:e.jsx(_e,{style:{color:"#52c41a"}}),window_size:e.jsx(ce,{style:{color:"#fa8c16"}})})[i]||e.jsx(be,{style:{color:"#666666"}}),t=(i,x)=>{const j=_(i.type),H=k.find(Q=>Q.value===j);return H?.configSchema?e.jsx(I,{size:"small",style:{marginTop:16,backgroundColor:"#fafcff",border:"1px solid #e8f4fd"},title:e.jsxs(p,{children:[e.jsx(be,{style:{color:"#1890ff"}}),e.jsx("span",{children:"动作配置"}),e.jsx(g,{color:"blue",children:H.label})]}),children:e.jsx(Z,{gutter:[16,16],children:Object.entries(H.configSchema).map(([Q,A])=>{if(A.conditionalDisplay){const{dependsOn:U,showWhen:le}=A.conditionalDisplay,te=i.config?.[U];if(!le.includes(te))return null}const re=A.type==="textarea"||A.type==="array"?24:(A.type==="boolean",12);return e.jsx(R,{span:re,children:e.jsxs(u.Item,{label:e.jsxs(p,{size:"small",children:[s(Q),e.jsx("span",{children:A.label}),A.required&&e.jsx(g,{color:"red",size:"small",children:"必填"})]}),children:[L(Q,A,i.config?.[Q],U=>{const le={...i,config:{...i.config,[Q]:U}};$(x,le)}),A.description&&e.jsx("div",{style:{marginTop:4},children:e.jsxs(Dt,{type:"secondary",style:{fontSize:11},children:[e.jsx(ce,{style:{marginRight:4}}),A.description]})})]})},Q)})})}):null},l=i=>({alert:e.jsx(kt,{style:{color:"#fa8c16"}}),transform:e.jsx(Me,{style:{color:"#52c41a"}}),filter:e.jsx(_e,{style:{color:"#1890ff"}}),aggregate:e.jsx(se,{style:{color:"#722ed1"}}),forward:e.jsx(dt,{style:{color:"#13c2c2"}})})[i]||e.jsx(be,{style:{color:"#666666"}}),r=i=>({alert:"#fa8c16",transform:"#52c41a",filter:"#1890ff",aggregate:"#722ed1",forward:"#13c2c2"})[i]||"#666666",n=(i,x)=>{const j=_(i.type),H=k.find(A=>A.value===j),Q=r(j);return H||(console.warn(`ActionFormBuilder: 找不到动作类型 "${j}" (原始: "${i.type}")，可用类型:`,k.map(A=>A.value)),console.warn(`ActionFormBuilder: 当前数据类型: ${D}, 映射规则:`,G[D])),e.jsxs(I,{size:"small",style:{marginBottom:16,border:`2px solid ${Q}20`,borderRadius:8},title:e.jsxs(p,{children:[l(j),e.jsxs("span",{children:["动作 ",x+1]}),H&&e.jsx(g,{color:Q.replace("#",""),style:{marginLeft:8},children:H.label})]}),extra:V.length>1&&e.jsx(oe,{title:"删除这个动作",children:e.jsx(E,{type:"link",icon:e.jsx(Ee,{}),danger:!0,size:"small",onClick:()=>N(x),children:"删除"})}),children:[e.jsxs(Z,{gutter:[16,16],children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:e.jsxs(p,{size:"small",children:[e.jsx(be,{style:{color:"#1890ff"}}),e.jsx("span",{children:"动作类型"})]}),children:e.jsx(O,{value:j,onChange:A=>{const re=k.find(le=>le.value===A),U={...i,type:A,config:re?.configSchema?{}:i.config};$(x,U)},size:"large",style:{width:"100%"},placeholder:"请选择动作类型",showSearch:!0,optionFilterProp:"children",optionLabelProp:"label",children:k.map(A=>e.jsx(xt,{value:A.value,label:A.label,title:A.description,children:e.jsxs(p,{size:"small",children:[l(A.value),e.jsx("span",{children:A.label}),A.description&&e.jsxs(Dt,{type:"secondary",style:{fontSize:"12px"},children:["- ",A.description]})]})},A.value))})})}),e.jsx(R,{span:6,children:e.jsx(u.Item,{label:e.jsxs(p,{size:"small",children:[e.jsx(jt,{style:{color:"#52c41a"}}),e.jsx("span",{children:"异步执行"})]}),children:e.jsx(he,{checked:i.async,onChange:A=>$(x,{...i,async:A}),checkedChildren:"异步",unCheckedChildren:"同步"})})}),e.jsx(R,{span:6,children:e.jsx(u.Item,{label:e.jsxs(p,{size:"small",children:[e.jsx(ce,{style:{color:"#fa8c16"}}),e.jsx("span",{children:"重试次数"})]}),children:e.jsx(W,{min:0,max:10,value:i.retry,onChange:A=>$(x,{...i,retry:A||0}),size:"large",style:{width:"100%"}})})})]}),i.type&&e.jsx(P,{message:"动作预览",description:e.jsxs(p,{direction:"vertical",size:"small",children:[e.jsxs(g,{color:r(i.type).replace("#",""),style:{fontSize:"12px"},children:["类型: ",H?.label||i.type]}),e.jsxs(p,{size:"small",children:[e.jsx(g,{color:i.async?"green":"blue",style:{fontSize:"11px"},children:i.async?"异步执行":"同步执行"}),i.retry>0&&e.jsxs(g,{color:"orange",style:{fontSize:"11px"},children:["重试 ",i.retry," 次"]})]})]}),type:"info",showIcon:!0,style:{marginTop:12,marginBottom:8},size:"small"}),t(i,x)]},x)};return e.jsxs(I,{title:e.jsxs(p,{children:[e.jsx(be,{style:{color:"#1890ff"}}),e.jsxs("span",{children:[C,"动作配置"]}),e.jsx(g,{color:"blue",children:"规则执行"})]}),style:{border:"1px solid #e8f4fd",borderRadius:8,backgroundColor:"#fafcff"},children:[e.jsx(P,{message:"动作执行说明",description:"配置规则触发时执行的动作，支持多种动作类型和执行策略",type:"info",showIcon:!0,style:{marginBottom:16},size:"small"}),V.map((i,x)=>n(i,x)),e.jsx(E,{type:"dashed",icon:e.jsx($e,{}),onClick:X,style:{width:"100%",height:"48px",borderColor:"#1890ff",color:"#1890ff"},size:"large",children:"添加动作"})]})},{TextArea:Oa}=B,{Text:ne,Paragraph:Xa}=pe,{Panel:Na}=lt,Ge=({value:h="",onChange:v,dataType:M="generic",availableFunctions:c=[],availableVariables:C=[],placeholder:V="输入表达式...",rows:m=4})=>{const[S,G]=b.useState(!1),J=[{name:"abs",description:"绝对值",syntax:"abs(number)",example:"abs(-5) // 返回 5",category:"数学函数"},{name:"max",description:"最大值",syntax:"max(a, b)",example:"max(10, 20) // 返回 20",category:"数学函数"},{name:"min",description:"最小值",syntax:"min(a, b)",example:"min(10, 20) // 返回 10",category:"数学函数"},{name:"sqrt",description:"平方根",syntax:"sqrt(number)",example:"sqrt(16) // 返回 4",category:"数学函数"},{name:"pow",description:"幂运算",syntax:"pow(base, exp)",example:"pow(2, 3) // 返回 8",category:"数学函数"},{name:"round",description:"四舍五入",syntax:"round(number)",example:"round(3.14) // 返回 3",category:"数学函数"},{name:"len",description:"字符串长度",syntax:"len(string)",example:'len("hello") // 返回 5',category:"字符串函数"},{name:"contains",description:"包含检查",syntax:"contains(str, substr)",example:'contains("hello", "ell") // 返回 true',category:"字符串函数"},{name:"startswith",description:"开头匹配",syntax:"startswith(str, prefix)",example:'startswith("hello", "he") // 返回 true',category:"字符串函数"},{name:"endswith",description:"结尾匹配",syntax:"endswith(str, suffix)",example:'endswith("hello", "lo") // 返回 true',category:"字符串函数"},{name:"upper",description:"转大写",syntax:"upper(string)",example:'upper("hello") // 返回 "HELLO"',category:"字符串函数"},{name:"lower",description:"转小写",syntax:"lower(string)",example:'lower("HELLO") // 返回 "hello"',category:"字符串函数"},{name:"now",description:"当前时间戳",syntax:"now()",example:"now() // 返回当前Unix时间戳",category:"时间函数"},{name:"timeFormat",description:"时间格式化",syntax:"timeFormat(timestamp, format)",example:'timeFormat(now(), "2006-01-02 15:04:05")',category:"时间函数"}],D=s=>{switch(s){case"vector3d":return[{name:"vectorMagnitude",description:"3D向量模长",syntax:"vectorMagnitude(x, y, z)",example:"vectorMagnitude(acceleration.x, acceleration.y, acceleration.z)",category:"向量函数"}];case"vector":case"vector_generic":return[{name:"genericVectorMagnitude",description:"通用向量模长",syntax:"genericVectorMagnitude(vector)",example:"genericVectorMagnitude(sensor_vector)",category:"向量函数"},{name:"vectorMean",description:"向量元素平均值",syntax:"vectorMean(vector)",example:"vectorMean(sensor_vector)",category:"向量函数"}];case"array":return[{name:"arraySum",description:"数组求和",syntax:"arraySum(array)",example:"arraySum(sensor_readings)",category:"数组函数"},{name:"arrayMean",description:"数组平均值",syntax:"arrayMean(array)",example:"arrayMean(sensor_readings)",category:"数组函数"},{name:"arrayMax",description:"数组最大值",syntax:"arrayMax(array)",example:"arrayMax(sensor_readings)",category:"数组函数"},{name:"arrayMin",description:"数组最小值",syntax:"arrayMin(array)",example:"arrayMin(sensor_readings)",category:"数组函数"}];case"geospatial":case"location":return[{name:"distance",description:"GPS距离计算",syntax:"distance(lat1, lon1, lat2, lon2)",example:"distance(location.latitude, location.longitude, 39.9, 116.4)",category:"地理函数"}];default:return[]}},_=[{name:"value",description:"当前数据值",type:"any",example:"value > 30"},{name:"device_id",description:"设备ID",type:"string",example:'contains(device_id, "sensor")'},{name:"key",description:"数据键名",type:"string",example:'key == "temperature"'},{name:"timestamp",description:"时间戳",type:"number",example:"timestamp > now() - 3600"},{name:"quality",description:"数据质量",type:"number",example:"quality == 0"}],k=[...J,...D(M),...c],q=[..._,...C],X=k.reduce((s,t)=>(s[t.category]||(s[t.category]=[]),s[t.category].push(t),s),{}),N=s=>{if(v){const t=h+s;v(t)}},$=()=>e.jsx(lt,{size:"small",children:Object.entries(X).map(([s,t])=>e.jsx(Na,{header:s,children:e.jsx(De,{size:"small",dataSource:t,renderItem:l=>e.jsx(De.Item,{actions:[e.jsx(E,{type:"link",size:"small",onClick:()=>N(l.syntax),children:"插入"})],children:e.jsx(De.Item.Meta,{title:e.jsxs(p,{children:[e.jsx(ne,{code:!0,children:l.name}),e.jsx(ne,{type:"secondary",children:l.description})]}),description:e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx(ne,{strong:!0,children:"语法："}),e.jsx(ne,{code:!0,children:l.syntax})]}),e.jsxs("div",{children:[e.jsx(ne,{strong:!0,children:"示例："}),e.jsx(ne,{code:!0,style:{color:"#52c41a"},children:l.example})]})]})})})})},s))}),L=()=>e.jsx(De,{size:"small",header:e.jsx(ne,{strong:!0,children:"可用变量"}),dataSource:q,renderItem:s=>e.jsx(De.Item,{actions:[e.jsx(E,{type:"link",size:"small",onClick:()=>N(s.name),children:"插入"})],children:e.jsx(De.Item.Meta,{title:e.jsxs(p,{children:[e.jsx(ne,{code:!0,children:s.name}),e.jsx(g,{color:"blue",children:s.type}),e.jsx(ne,{type:"secondary",children:s.description})]}),description:s.example&&e.jsxs("div",{children:[e.jsx(ne,{strong:!0,children:"示例："}),e.jsx(ne,{code:!0,style:{color:"#52c41a"},children:s.example})]})})})});return e.jsx("div",{children:e.jsxs(I,{title:e.jsxs(p,{children:[e.jsx(de,{}),e.jsx(ne,{children:"表达式编辑器"}),e.jsx(E,{type:"link",icon:e.jsx(ce,{}),onClick:()=>G(!S),children:S?"隐藏帮助":"显示帮助"})]}),size:"small",children:[e.jsx(Oa,{value:h,onChange:s=>v?.(s.target.value),placeholder:V,rows:m,style:{fontFamily:"Consolas, Monaco, monospace"}}),S&&e.jsxs("div",{style:{marginTop:16},children:[e.jsx(I,{size:"small",title:e.jsxs(ne,{children:[e.jsx(se,{})," 函数参考"]}),children:$()}),e.jsx(I,{size:"small",title:"变量参考",style:{marginTop:16},children:L()})]}),e.jsx("div",{style:{marginTop:8},children:e.jsx(ne,{type:"secondary",style:{fontSize:12},children:"支持JavaScript语法，使用 && (AND), || (OR), ! (NOT) 进行逻辑运算"})})]})})},{Option:ee}=O,{Text:Ra}=pe,{TextArea:Da}=B,Aa=({visible:h,onClose:v,onSave:M,rule:c,dataType:C="array"})=>{const V=z=>{if(z.data_type)return z.data_type;if(z.tags){const F=z.tags.data_type||z.tags.data_category;if(F)return F}if(z.conditions){const F=JSON.stringify(z.conditions).toLowerCase();if(F.includes("array")||F.includes("length")||F.includes("size"))return"array";if(F.includes("matrix")||F.includes("rows")||F.includes("cols"))return"matrix";if(F.includes("timeseries")||F.includes("trend")||F.includes("seasonality"))return"timeseries";if(F.includes("mixed")||F.includes("nested")||F.includes("field_count"))return"mixed"}if(z.actions&&z.actions.length>0){const F=z.actions[0];if(F.type.includes("array"))return"array";if(F.type.includes("matrix"))return"matrix";if(F.type.includes("timeseries"))return"timeseries"}return"array"},m=c&&h?V(c):typeof C=="string"?C:C&&typeof C=="object"&&"key"in C?C.key:"array",{form:S,saving:G,validationErrors:J,handleSave:D,handleCancel:_}=Pe({visible:h,onClose:v,onSave:M,rule:c,title:"复杂数据规则编辑器",dataTypeName:j(m)}),k=()=>{X(void 0),$([]),s("basic"),l(""),n(""),_()},[q,X]=b.useState(c?.conditions),[N,$]=b.useState(c?.actions||[]),[L,s]=b.useState("basic"),[t,l]=b.useState(""),[r,n]=b.useState("");b.useEffect(()=>{h&&c&&(console.log("复杂数据编辑器加载规则数据:",c),console.log("加载的动作配置:",c.actions),X(c.conditions),$(c.actions||[]),i())},[h,c]),b.useEffect(()=>{(L==="json"||L==="preview")&&i()},[N,q,L]);const i=()=>{try{const z={id:c?.id||"",name:S.getFieldValue("name")||"",description:S.getFieldValue("description")||"",priority:S.getFieldValue("priority")||50,enabled:S.getFieldValue("enabled")!==!1,data_type:m,conditions:q,actions:N,tags:{...c?.tags,data_type:m,data_category:"complex"},version:c?.version||1,created_at:c?.created_at||new Date().toISOString(),updated_at:new Date().toISOString()};l(JSON.stringify(z,null,2)),n("")}catch{n("JSON生成失败")}},x=z=>{l(z);try{const F=JSON.parse(z);F.name&&F.conditions&&F.actions?(n(""),S.setFieldsValue({name:F.name,description:F.description,priority:F.priority,enabled:F.enabled}),X(F.conditions),$(F.actions||[])):n("JSON格式不完整，缺少必要字段")}catch{n("JSON格式错误")}};function j(z){return{array:"数组数据",matrix:"矩阵数据",timeseries:"时间序列数据",mixed:"混合类型数据",json:"JSON数据",nested:"嵌套数据结构",graph:"图数据结构",tree:"树形数据结构"}[z]||"复杂数据"}const H=z=>{switch(z){case"array":return[{value:"array.length",label:"数组长度",description:"数组元素的总数"},{value:"array.size",label:"数组大小",description:"数组的字节大小"},{value:"array.sum",label:"数组求和",description:"数组所有元素的和"},{value:"array.mean",label:"数组均值",description:"数组元素的平均值"},{value:"array.median",label:"数组中位数",description:"数组的中位数"},{value:"array.min",label:"数组最小值",description:"数组中的最小元素"},{value:"array.max",label:"数组最大值",description:"数组中的最大元素"},{value:"array.std",label:"标准差",description:"数组元素的标准偏差"},{value:"array.variance",label:"方差",description:"数组元素的方差"},{value:"array[0]",label:"第一个元素",description:"数组的第一个元素"},{value:"array[-1]",label:"最后一个元素",description:"数组的最后一个元素"},{value:"array.type",label:"元素类型",description:"数组元素的数据类型"},{value:"array.unique_count",label:"唯一元素数",description:"数组中唯一元素的数量"},{value:"array.null_count",label:"空值数量",description:"数组中空值的数量"}];case"matrix":return[{value:"matrix.rows",label:"矩阵行数",description:"矩阵的行数"},{value:"matrix.cols",label:"矩阵列数",description:"矩阵的列数"},{value:"matrix.size",label:"矩阵大小",description:"矩阵的总元素数"},{value:"matrix.rank",label:"矩阵秩",description:"矩阵的秩"},{value:"matrix.determinant",label:"行列式",description:"矩阵的行列式值"},{value:"matrix.trace",label:"矩阵迹",description:"矩阵对角线元素的和"},{value:"matrix.norm",label:"矩阵范数",description:"矩阵的范数"},{value:"matrix.condition",label:"条件数",description:"矩阵的条件数"},{value:"matrix.eigenvalues",label:"特征值",description:"矩阵的特征值"},{value:"matrix.is_symmetric",label:"是否对称",description:"矩阵是否为对称矩阵"},{value:"matrix.is_positive_definite",label:"是否正定",description:"矩阵是否为正定矩阵"},{value:"matrix[0,0]",label:"第一个元素",description:"矩阵(0,0)位置的元素"},{value:"matrix.sparsity",label:"稀疏度",description:"矩阵的稀疏程度"}];case"timeseries":return[{value:"timeseries.length",label:"序列长度",description:"时间序列的数据点数量"},{value:"timeseries.duration",label:"时间跨度",description:"时间序列的总时长"},{value:"timeseries.frequency",label:"采样频率",description:"数据采样的频率"},{value:"timeseries.interval",label:"采样间隔",description:"相邻数据点的时间间隔"},{value:"timeseries.trend",label:"趋势方向",description:"时间序列的整体趋势"},{value:"timeseries.seasonality",label:"季节性",description:"是否具有季节性模式"},{value:"timeseries.volatility",label:"波动性",description:"时间序列的波动程度"},{value:"timeseries.autocorr",label:"自相关性",description:"时间序列的自相关系数"},{value:"timeseries.stationarity",label:"平稳性",description:"时间序列的平稳性"},{value:"timeseries.mean",label:"序列均值",description:"时间序列的平均值"},{value:"timeseries.std",label:"序列标准差",description:"时间序列的标准偏差"},{value:"timeseries.missing_rate",label:"缺失率",description:"缺失数据点的比例"},{value:"timeseries.outlier_count",label:"异常点数",description:"时间序列中异常点的数量"}];case"mixed":return[{value:"data.structure_type",label:"数据结构类型",description:"混合数据的主要结构类型"},{value:"data.complexity",label:"复杂度",description:"数据结构的复杂程度"},{value:"data.nested_levels",label:"嵌套层级",description:"数据嵌套的最大层数"},{value:"data.field_count",label:"字段数量",description:"数据中字段的总数"},{value:"data.type_diversity",label:"类型多样性",description:"包含的数据类型种类数"},{value:"data.size_bytes",label:"数据大小",description:"数据的字节大小"},{value:"data.null_fields",label:"空字段数",description:"值为空的字段数量"},{value:"data.array_fields",label:"数组字段数",description:"包含的数组类型字段数"},{value:"data.object_fields",label:"对象字段数",description:"包含的对象类型字段数"}];default:return[{value:"data.size",label:"数据大小",description:"数据结构的大小"},{value:"data.type",label:"数据类型",description:"数据的类型标识"},{value:"data.complexity",label:"复杂度",description:"数据结构的复杂程度"}]}},Q=z=>{switch(z){case"array":return[{value:"array_transform",label:"数组转换",description:"数组统计、排序、筛选等操作",configSchema:{transform_type:{type:"string",label:"转换类型",required:!0,options:[{value:"statistics",label:"统计计算"},{value:"sort",label:"数组排序"},{value:"filter",label:"数组筛选"},{value:"slice",label:"数组切片"},{value:"reshape",label:"数组重塑"},{value:"normalize",label:"数据标准化"},{value:"aggregate",label:"聚合操作"},{value:"deduplication",label:"去重处理"}]},functions:{type:"array",label:"统计函数",description:"选择要计算的统计函数",options:[{value:"mean",label:"平均值"},{value:"median",label:"中位数"},{value:"std",label:"标准差"},{value:"var",label:"方差"},{value:"min",label:"最小值"},{value:"max",label:"最大值"},{value:"sum",label:"求和"},{value:"count",label:"计数"}]},start_index:{type:"number",label:"开始索引",description:"切片操作的开始位置"},end_index:{type:"number",label:"结束索引",description:"切片操作的结束位置"},output_key:{type:"string",label:"输出字段",placeholder:"转换结果的字段名",description:"转换结果存储的字段名"}}},{value:"array_expression",label:"数组表达式操作",description:"使用表达式对数组数据进行复杂计算和处理",configSchema:{expression:{type:"textarea",label:"表达式",required:!0,placeholder:"arraySum(data_array) / arrayMean(data_array)",description:"支持数组函数和数学运算的表达式"},output_key:{type:"string",label:"输出字段",placeholder:"结果存储的字段名",description:"表达式计算结果存储的字段名"},output_type:{type:"string",label:"输出类型",options:[{value:"number",label:"数值"},{value:"array",label:"数组"},{value:"boolean",label:"布尔值"},{value:"string",label:"字符串"}],defaultValue:"number"}}}];case"matrix":return[{value:"matrix_transform",label:"矩阵转换",description:"矩阵运算、分解、变换等操作",configSchema:{transform_type:{type:"string",label:"转换类型",required:!0,options:[{value:"transpose",label:"矩阵转置"},{value:"inverse",label:"矩阵求逆"},{value:"multiply",label:"矩阵乘法"},{value:"decomposition",label:"矩阵分解"},{value:"eigendecomp",label:"特征分解"},{value:"svd",label:"奇异值分解"},{value:"flatten",label:"矩阵展平"},{value:"reshape",label:"矩阵重塑"}]},decomp_method:{type:"string",label:"分解方法",options:[{value:"lu",label:"LU分解"},{value:"qr",label:"QR分解"},{value:"cholesky",label:"Cholesky分解"},{value:"eigen",label:"特征分解"},{value:"svd",label:"奇异值分解"}]},target_shape:{type:"string",label:"目标形状",placeholder:"例如：[3, 4]",description:"重塑后的矩阵形状"},output_key:{type:"string",label:"输出字段",placeholder:"转换结果的字段名",description:"矩阵操作结果的字段名"}}},{value:"matrix_expression",label:"矩阵表达式操作",description:"使用表达式对矩阵数据进行复杂计算和处理",configSchema:{expression:{type:"textarea",label:"表达式",required:!0,placeholder:"matrixDeterminant(data_matrix) * matrixTrace(data_matrix)",description:"支持矩阵函数和数学运算的表达式"},output_key:{type:"string",label:"输出字段",placeholder:"结果存储的字段名",description:"表达式计算结果存储的字段名"},output_type:{type:"string",label:"输出类型",options:[{value:"number",label:"数值"},{value:"matrix",label:"矩阵"},{value:"array",label:"数组"},{value:"boolean",label:"布尔值"}],defaultValue:"number"}}}];case"timeseries":return[{value:"timeseries_transform",label:"时间序列转换",description:"时间序列分析、预测、特征提取",configSchema:{transform_type:{type:"string",label:"转换类型",required:!0,options:[{value:"trend_analysis",label:"趋势分析"},{value:"seasonality_decomp",label:"季节性分解"},{value:"smoothing",label:"数据平滑"},{value:"differencing",label:"差分处理"},{value:"resampling",label:"重采样"},{value:"interpolation",label:"数据插值"},{value:"outlier_detection",label:"异常检测"},{value:"feature_extraction",label:"特征提取"}]},window_size:{type:"number",label:"窗口大小",description:"分析窗口的大小"},method:{type:"string",label:"处理方法",options:[{value:"moving_average",label:"移动平均"},{value:"exponential_smoothing",label:"指数平滑"},{value:"linear_interpolation",label:"线性插值"},{value:"spline_interpolation",label:"样条插值"}]},output_key:{type:"string",label:"输出字段",placeholder:"转换结果的字段名",description:"时间序列分析结果的字段名"}}},{value:"timeseries_expression",label:"时序表达式操作",description:"使用表达式对时间序列数据进行复杂计算和处理",configSchema:{expression:{type:"textarea",label:"表达式",required:!0,placeholder:'trendDirection(ts_data) == "increasing" && volatility(ts_data) < 0.1',description:"支持时序函数和数学运算的表达式"},output_key:{type:"string",label:"输出字段",placeholder:"结果存储的字段名",description:"表达式计算结果存储的字段名"},output_type:{type:"string",label:"输出类型",options:[{value:"number",label:"数值"},{value:"timeseries",label:"时间序列"},{value:"boolean",label:"布尔值"},{value:"string",label:"字符串"}],defaultValue:"number"}}}];case"mixed":return[{value:"data_transform",label:"数据转换",description:"混合数据的解析、转换、重构",configSchema:{transform_type:{type:"string",label:"转换类型",required:!0,options:[{value:"flatten",label:"数据展平"},{value:"normalize",label:"数据标准化"},{value:"extract_fields",label:"字段提取"},{value:"type_conversion",label:"类型转换"},{value:"structure_analysis",label:"结构分析"},{value:"validation",label:"数据验证"}]},extract_paths:{type:"array",label:"提取路径",description:"JSON路径表达式，如$.data.array[*]"},target_type:{type:"string",label:"目标类型",options:[{value:"array",label:"数组"},{value:"object",label:"对象"},{value:"string",label:"字符串"},{value:"number",label:"数字"}]},output_key:{type:"string",label:"输出字段",placeholder:"转换结果的字段名",description:"数据转换结果的字段名"}}},{value:"mixed_expression",label:"混合数据表达式操作",description:"使用表达式对混合数据进行复杂计算和处理",configSchema:{expression:{type:"textarea",label:"表达式",required:!0,placeholder:'fieldCount(json_data) > 5 && hasField(json_data, "timestamp")',description:"支持结构函数和数学运算的表达式"},output_key:{type:"string",label:"输出字段",placeholder:"结果存储的字段名",description:"表达式计算结果存储的字段名"},output_type:{type:"string",label:"输出类型",options:[{value:"number",label:"数值"},{value:"object",label:"对象"},{value:"array",label:"数组"},{value:"boolean",label:"布尔值"},{value:"string",label:"字符串"}],defaultValue:"boolean"}}}];default:return[]}},A=z=>{const F=[{name:"size",description:"获取数据大小",syntax:"size(data)",example:"size(array) > 10",category:"通用函数",parameters:["data"]},{name:"type",description:"获取数据类型",syntax:"type(data)",example:'type(data) == "array"',category:"通用函数",parameters:["data"]}];switch(z){case"array":return[...F,{name:"arraySum",description:"数组求和",syntax:"arraySum(array)",example:"arraySum(data_array) > 100",category:"数组函数",parameters:["array"]},{name:"arrayMean",description:"数组平均值",syntax:"arrayMean(array)",example:"arrayMean(data_array) > 10.5",category:"数组函数",parameters:["array"]},{name:"arrayMax",description:"数组最大值",syntax:"arrayMax(array)",example:"arrayMax(data_array) < 50",category:"数组函数",parameters:["array"]},{name:"arrayMin",description:"数组最小值",syntax:"arrayMin(array)",example:"arrayMin(data_array) > 0",category:"数组函数",parameters:["array"]},{name:"arrayStd",description:"数组标准差",syntax:"arrayStd(array)",example:"arrayStd(data_array) > 2.0",category:"数组函数",parameters:["array"]}];case"matrix":return[...F,{name:"matrixRank",description:"矩阵秩",syntax:"matrixRank(matrix)",example:"matrixRank(data_matrix) == 3",category:"矩阵函数",parameters:["matrix"]},{name:"matrixDeterminant",description:"矩阵行列式",syntax:"matrixDeterminant(matrix)",example:"matrixDeterminant(data_matrix) != 0",category:"矩阵函数",parameters:["matrix"]},{name:"matrixTrace",description:"矩阵迹",syntax:"matrixTrace(matrix)",example:"matrixTrace(data_matrix) > 0",category:"矩阵函数",parameters:["matrix"]},{name:"matrixNorm",description:"矩阵范数",syntax:"matrixNorm(matrix, type)",example:'matrixNorm(data_matrix, "frobenius") > 1.0',category:"矩阵函数",parameters:["matrix","type"]}];case"timeseries":return[...F,{name:"trendDirection",description:"趋势方向",syntax:"trendDirection(timeseries)",example:'trendDirection(ts_data) == "increasing"',category:"时序函数",parameters:["timeseries"]},{name:"seasonality",description:"季节性检测",syntax:"seasonality(timeseries, period)",example:"seasonality(ts_data, 24) > 0.5",category:"时序函数",parameters:["timeseries","period"]},{name:"volatility",description:"波动性计算",syntax:"volatility(timeseries)",example:"volatility(ts_data) > 0.1",category:"时序函数",parameters:["timeseries"]},{name:"autocorrelation",description:"自相关性",syntax:"autocorrelation(timeseries, lag)",example:"autocorrelation(ts_data, 1) > 0.8",category:"时序函数",parameters:["timeseries","lag"]}];case"mixed":return[...F,{name:"fieldCount",description:"字段数量",syntax:"fieldCount(data)",example:"fieldCount(json_data) > 10",category:"结构函数",parameters:["data"]},{name:"nestedLevels",description:"嵌套层级",syntax:"nestedLevels(data)",example:"nestedLevels(nested_data) <= 5",category:"结构函数",parameters:["data"]},{name:"hasField",description:"字段存在检查",syntax:"hasField(data, fieldPath)",example:'hasField(json_data, "user.profile.name")',category:"结构函数",parameters:["data","fieldPath"]},{name:"extractField",description:"提取字段值",syntax:"extractField(data, fieldPath)",example:'extractField(json_data, "$.items[0].price") > 100',category:"结构函数",parameters:["data","fieldPath"]}];default:return F}},re=async()=>{i(),await D(()=>q,()=>N)},U=z=>{s(z),(z==="json"||z==="preview")&&setTimeout(i,50)},le=()=>{(L==="json"||L==="preview")&&setTimeout(i,100)},te=()=>e.jsxs(I,{title:e.jsxs(p,{children:[e.jsx(pt,{}),"复杂数据配置"]}),style:{marginTop:16},children:[e.jsx(Z,{gutter:[16,16],children:e.jsx(R,{span:24,children:e.jsx(u.Item,{label:"数据类型",children:e.jsxs(O,{value:m,disabled:!0,children:[e.jsx(ee,{value:"array",children:"数组 (Array)"}),e.jsx(ee,{value:"matrix",children:"矩阵 (Matrix)"}),e.jsx(ee,{value:"timeseries",children:"时间序列 (TimeSeries)"}),e.jsx(ee,{value:"mixed",children:"混合类型 (Mixed)"}),e.jsx(ee,{value:"json",children:"JSON数据"}),e.jsx(ee,{value:"nested",children:"嵌套结构"})]})})})}),m==="array"&&e.jsxs(Z,{gutter:[16,16],style:{marginTop:16},children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"预期数组大小",children:e.jsx(W,{placeholder:"元素数量",style:{width:"100%"},min:0,max:1e6})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"元素类型",children:e.jsxs(O,{defaultValue:"number",placeholder:"数组元素的数据类型",children:[e.jsx(ee,{value:"number",children:"数值类型"}),e.jsx(ee,{value:"string",children:"字符串类型"}),e.jsx(ee,{value:"boolean",children:"布尔类型"}),e.jsx(ee,{value:"object",children:"对象类型"}),e.jsx(ee,{value:"mixed",children:"混合类型"})]})})})]}),m==="matrix"&&e.jsxs(Z,{gutter:[16,16],style:{marginTop:16},children:[e.jsx(R,{span:8,children:e.jsx(u.Item,{label:"矩阵类型",children:e.jsxs(O,{defaultValue:"dense",placeholder:"矩阵存储类型",children:[e.jsx(ee,{value:"dense",children:"稠密矩阵"}),e.jsx(ee,{value:"sparse",children:"稀疏矩阵"}),e.jsx(ee,{value:"symmetric",children:"对称矩阵"}),e.jsx(ee,{value:"diagonal",children:"对角矩阵"})]})})}),e.jsx(R,{span:8,children:e.jsx(u.Item,{label:"预期维度",children:e.jsx(B,{placeholder:"例如：3x4, 100x100"})})}),e.jsx(R,{span:8,children:e.jsx(u.Item,{label:"数值精度",children:e.jsxs(O,{defaultValue:"float64",placeholder:"数值精度",children:[e.jsx(ee,{value:"int32",children:"32位整数"}),e.jsx(ee,{value:"float32",children:"32位浮点"}),e.jsx(ee,{value:"float64",children:"64位浮点"}),e.jsx(ee,{value:"complex",children:"复数"})]})})})]}),m==="timeseries"&&e.jsxs(Z,{gutter:[16,16],style:{marginTop:16},children:[e.jsx(R,{span:8,children:e.jsx(u.Item,{label:"时间粒度",children:e.jsxs(O,{defaultValue:"second",placeholder:"时间序列的粒度",children:[e.jsx(ee,{value:"millisecond",children:"毫秒"}),e.jsx(ee,{value:"second",children:"秒"}),e.jsx(ee,{value:"minute",children:"分钟"}),e.jsx(ee,{value:"hour",children:"小时"}),e.jsx(ee,{value:"day",children:"天"})]})})}),e.jsx(R,{span:8,children:e.jsx(u.Item,{label:"预期长度",children:e.jsx(W,{placeholder:"数据点数量",style:{width:"100%"},min:1,max:1e7})})}),e.jsx(R,{span:8,children:e.jsx(u.Item,{label:"是否实时",style:{display:"flex",alignItems:"center",height:"40px"},children:e.jsx(he,{defaultChecked:!0,checkedChildren:"实时",unCheckedChildren:"离线"})})})]}),e.jsx("div",{style:{marginTop:16},children:e.jsxs(Ra,{type:"secondary",children:[e.jsx(ce,{})," ",j(m),"支持复杂的数据结构分析和处理"]})})]}),ae=()=>e.jsxs(I,{title:`${j(m)}条件`,style:{marginTop:16},children:[e.jsx(Fe,{value:q,onChange:X,availableFields:["device_id","key","value","timestamp"],customFieldOptions:H(m),allowedOperators:["eq","ne","gt","gte","lt","lte","contains","exists","regex"],supportExpressions:!0,dataTypeName:j(m)}),e.jsx("div",{style:{marginTop:16},children:e.jsx(Ge,{value:q?.type==="expression"?q.expression:"",onChange:z=>X({type:"expression",expression:z}),dataType:m,availableFunctions:A(m),availableVariables:H(m).map(z=>({name:z.value,description:z.description,type:"number",example:`${z.value} > 0`})),placeholder:`输入${j(m)}表达式`,rows:3})})]}),o=()=>e.jsx(I,{title:`${j(m)}动作`,style:{marginTop:16},children:e.jsx(Le,{value:N,onChange:$,availableActionTypes:[],customActionOptions:Q(m),dataTypeName:j(m)})}),y=[{key:"basic",label:e.jsxs(p,{children:[e.jsx(ce,{}),"基本信息"]}),children:e.jsxs(I,{title:"基本信息",style:{border:"none",boxShadow:"none"},children:[e.jsxs(u,{form:S,layout:"vertical",initialValues:{priority:c?.priority||50,enabled:c?.enabled!==!1},onValuesChange:le,children:[e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"规则名称",name:"name",rules:[{required:!0,message:"请输入规则名称"}],children:e.jsx(B,{placeholder:`请输入${j(m)}规则名称`})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"优先级",name:"priority",rules:[{required:!0,message:"请输入优先级"},{type:"number",min:0,max:100,message:"优先级必须在0-100之间"}],children:e.jsx(W,{min:0,max:100,style:{width:"100%"}})})})]}),e.jsx(u.Item,{label:"规则描述",name:"description",children:e.jsx(B.TextArea,{placeholder:`请输入${j(m)}规则描述`,rows:3})}),e.jsx(u.Item,{label:"启用状态",name:"enabled",valuePropName:"checked",style:{display:"flex",alignItems:"center",height:"40px"},children:e.jsx(he,{checkedChildren:"启用",unCheckedChildren:"禁用"})})]}),te()]})},{key:"conditions",label:e.jsxs(p,{children:[e.jsx(pt,{}),"复杂条件"]}),children:ae()},{key:"actions",label:e.jsxs(p,{children:[e.jsx(me,{}),"执行动作"]}),children:o()},{key:"preview",label:e.jsxs(p,{children:[e.jsx(Ie,{}),"预览"]}),children:e.jsxs(I,{title:"规则预览",style:{border:"none",boxShadow:"none"},children:[e.jsx(P,{message:"规则JSON配置",description:"以下是当前规则的完整JSON配置预览",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx("pre",{style:{background:"#f5f5f5",padding:"16px",borderRadius:"6px",fontSize:"12px",lineHeight:"1.5",maxHeight:"400px",overflow:"auto",border:"1px solid #d9d9d9"},children:t})]})},{key:"json",label:e.jsxs(p,{children:[e.jsx(de,{}),"JSON编辑"]}),children:e.jsxs(I,{title:"JSON直接编辑",style:{border:"none",boxShadow:"none"},children:[e.jsx(P,{message:"JSON编辑模式",description:"可以直接编辑JSON配置，保存时会自动同步到表单",type:"warning",showIcon:!0,style:{marginBottom:16}}),r&&e.jsx(P,{message:"JSON格式错误",description:r,type:"error",showIcon:!0,style:{marginBottom:16}}),e.jsx(Da,{value:t,onChange:z=>x(z.target.value),rows:20,style:{fontFamily:'Monaco, Consolas, "Courier New", monospace',fontSize:"12px",lineHeight:"1.5"},placeholder:"输入或编辑JSON格式的规则配置..."}),e.jsx("div",{style:{marginTop:12},children:e.jsxs(p,{children:[e.jsx(E,{size:"small",onClick:i,icon:e.jsx(Ve,{}),children:"从表单更新JSON"}),e.jsx(E,{size:"small",type:"primary",ghost:!0,onClick:()=>{try{const z=JSON.stringify(JSON.parse(t),null,2);l(z)}catch{}},icon:e.jsx(de,{}),children:"格式化JSON"})]})})]})}];return e.jsxs(Te,{title:e.jsxs(p,{children:[e.jsx(pt,{style:{color:"#1890ff"}}),e.jsx("span",{children:"复杂数据规则编辑器"}),e.jsx(g,{color:"blue",icon:e.jsx(se,{}),children:j(m)})]}),open:h,onCancel:k,footer:e.jsxs(p,{children:[e.jsx(E,{onClick:k,size:"large",children:"取消"}),e.jsx(E,{type:"primary",loading:G,onClick:re,size:"large",icon:e.jsx(me,{}),children:"保存规则"})]}),width:1200,centered:!0,destroyOnHidden:!0,style:{maxHeight:"90vh",top:0},styles:{body:{padding:"20px",maxHeight:"calc(90vh - 140px)",overflowY:"auto",overflowX:"hidden"},header:{borderBottom:"1px solid #f0f0f0",paddingBottom:"16px"},content:{maxHeight:"90vh",display:"flex",flexDirection:"column"}},children:[J.length>0&&e.jsx(P,{message:"验证错误",description:e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:J.map((z,F)=>e.jsx("li",{children:z},F))}),type:"error",showIcon:!0,style:{marginBottom:16},closable:!0}),e.jsx(ke,{activeKey:L,onChange:U,items:y,size:"large"})]})},{Option:Za}=O,{Text:Ka,Title:Ua}=pe,{TextArea:$a}=B,Va=({visible:h,onClose:v,onSave:M,rule:c})=>{const{form:C,saving:V,validationErrors:m,handleSave:S}=Pe({visible:h,onClose:v,onSave:M,rule:c,title:"地理空间规则编辑器",dataTypeName:"地理位置数据"}),G=()=>{D(void 0),k([]),X("basic"),$(""),s(""),v()},[J,D]=b.useState(c?.conditions),[_,k]=b.useState(c?.actions||[]),[q,X]=b.useState("basic"),[N,$]=b.useState(""),[L,s]=b.useState(""),l=c?(o=>{if(o.data_type){if(typeof o.data_type=="string")return o.data_type;if(typeof o.data_type=="object"&&o.data_type!==null)return o.data_type.type||"location"}if(o.tags){const z=o.tags.data_type||o.tags.data_category;if(z)return z}const y=`${o.name||""} ${o.description||""}`.toLowerCase();return y.includes("location")||y.includes("地理")||y.includes("gps")||y.includes("位置")||y.includes("geo")||y.includes("坐标")||y.includes("latitude")||y.includes("longitude"),"location"})(c):"location";b.useEffect(()=>{h&&c&&(D(c.conditions),k(c.actions||[]),r())},[h,c]);const r=()=>{try{const o={id:c?.id||"",name:C.getFieldValue("name")||"",description:C.getFieldValue("description")||"",priority:C.getFieldValue("priority")||50,enabled:C.getFieldValue("enabled")!==!1,data_type:l,conditions:J,actions:_,tags:c?.tags||{},version:c?.version||1,created_at:c?.created_at||new Date().toISOString(),updated_at:new Date().toISOString()};$(JSON.stringify(o,null,2)),s("")}catch{s("JSON生成失败")}},n=o=>{$(o);try{const y=JSON.parse(o);y.name&&y.conditions&&y.actions?(s(""),C.setFieldsValue({name:y.name,description:y.description,priority:y.priority,enabled:y.enabled}),D(y.conditions),k(y.actions||[])):s("JSON格式不完整，缺少必要字段")}catch{s("JSON格式错误")}},i=[{value:"location.latitude",label:"纬度",description:"地理坐标纬度值 (-90 到 90)"},{value:"location.longitude",label:"经度",description:"地理坐标经度值 (-180 到 180)"},{value:"location.altitude",label:"海拔高度",description:"海拔高度值 (米)"},{value:"location.accuracy",label:"定位精度",description:"GPS定位精度 (米)"},{value:"location.speed",label:"移动速度",description:"移动速度 (公里/小时)"},{value:"location.heading",label:"方向角",description:"移动方向角度 (0-360度)"},{value:"location.distance",label:"距离",description:"距离参考点的距离"},{value:"location.zone",label:"地理区域",description:"地理围栏区域标识"}],x=[{value:"geo_transform",label:"地理数据转换",description:"地理坐标系转换、距离计算、区域判断",configSchema:{transform_type:{type:"string",label:"转换类型",required:!0,options:[{value:"distance_calculation",label:"距离计算"},{value:"coordinate_conversion",label:"坐标系转换"},{value:"geofence_check",label:"地理围栏检查"},{value:"area_calculation",label:"面积计算"}]},reference_point:{type:"object",label:"参考点坐标",description:"用于距离计算的参考点 (纬度,经度)",placeholder:'{"latitude": 39.9, "longitude": 116.4}'},geofence_zones:{type:"array",label:"地理围栏区域",description:"定义地理围栏的边界区域"}}},{value:"geo_expression",label:"地理表达式操作",description:"使用表达式对地理数据进行复杂计算和处理",configSchema:{expression:{type:"textarea",label:"表达式",required:!0,placeholder:"distance(location.latitude, location.longitude, 39.9, 116.4)",description:"支持地理函数和数学运算的表达式"},output_key:{type:"string",label:"输出字段",placeholder:"结果存储的字段名",description:"表达式计算结果存储的字段名"},output_type:{type:"string",label:"输出类型",options:[{value:"number",label:"数值"},{value:"string",label:"字符串"},{value:"boolean",label:"布尔值"},{value:"object",label:"地理对象"}],defaultValue:"number"}}},{value:"geo_alert",label:"地理位置告警",description:"基于地理位置的告警通知",configSchema:{alert_type:{type:"string",label:"告警类型",options:[{value:"geofence_entry",label:"进入地理围栏"},{value:"geofence_exit",label:"离开地理围栏"},{value:"distance_threshold",label:"距离阈值告警"},{value:"speed_limit",label:"超速告警"}]},message:{type:"textarea",label:"告警消息",required:!0,placeholder:"设备{{.DeviceID}}位置: 纬度{{.location.latitude}}, 经度{{.location.longitude}}"}}}],j=[{name:"distance",description:"计算两点间距离",syntax:"distance(lat1, lon1, lat2, lon2)",example:"distance(location.latitude, location.longitude, 39.9, 116.4) > 1000",category:"地理函数",parameters:["lat1","lon1","lat2","lon2"]},{name:"inGeofence",description:"检查是否在地理围栏内",syntax:"inGeofence(lat, lon, zoneName)",example:'inGeofence(location.latitude, location.longitude, "beijing_area")',category:"地理函数",parameters:["lat","lon","zoneName"]},{name:"bearing",description:"计算两点间方位角",syntax:"bearing(lat1, lon1, lat2, lon2)",example:"bearing(location.latitude, location.longitude, 39.9, 116.4)",category:"地理函数",parameters:["lat1","lon1","lat2","lon2"]}],H=[{name:"location.latitude",description:"当前纬度",type:"number",example:"location.latitude > 39.8"},{name:"location.longitude",description:"当前经度",type:"number",example:"location.longitude < 116.5"},{name:"location.altitude",description:"海拔高度",type:"number",example:"location.altitude > 100"},{name:"location.accuracy",description:"GPS精度",type:"number",example:"location.accuracy < 10"},{name:"location.speed",description:"移动速度",type:"number",example:"location.speed > 60"},{name:"location.heading",description:"移动方向",type:"number",example:"location.heading > 180"}],Q=async()=>{r(),await S(()=>J,()=>_)},A=o=>{X(o),(o==="json"||o==="preview")&&setTimeout(r,50)},re=()=>{(q==="json"||q==="preview")&&setTimeout(r,100)},U=()=>e.jsx(I,{title:e.jsxs(p,{children:[e.jsx(vt,{}),"地理位置配置"]}),style:{marginTop:16},children:e.jsx(P,{message:"地理空间数据类型",description:"此数据类型专门处理GPS、坐标、位置等地理空间数据，支持WGS84等多种坐标系统和地理围栏功能",type:"info",showIcon:!0})}),le=()=>e.jsxs(I,{title:"地理位置条件",style:{marginTop:16},children:[e.jsx(Fe,{value:J,onChange:D,availableFields:["device_id","key","value","timestamp"],customFieldOptions:i,allowedOperators:["eq","ne","gt","gte","lt","lte","contains","regex"],supportExpressions:!0,dataTypeName:"地理位置"}),e.jsx("div",{style:{marginTop:16},children:e.jsx(Ge,{value:J?.type==="expression"?J.expression:"",onChange:o=>D({type:"expression",expression:o}),dataType:"geospatial",availableFunctions:j,availableVariables:H,placeholder:"输入地理位置表达式，例如：distance(location.latitude, location.longitude, 39.9, 116.4) > 1000",rows:3})})]}),te=()=>e.jsx(I,{title:"地理位置动作",style:{marginTop:16},children:e.jsx(Le,{value:_,onChange:k,availableActionTypes:[],customActionOptions:x,dataTypeName:"地理位置"})}),ae=[{key:"basic",label:e.jsxs(p,{children:[e.jsx(ce,{}),"基本信息"]}),children:e.jsxs(I,{title:"基本信息",style:{border:"none",boxShadow:"none"},children:[e.jsxs(u,{form:C,layout:"vertical",initialValues:{priority:c?.priority||50,enabled:c?.enabled!==!1},onValuesChange:re,children:[e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"规则名称",name:"name",rules:[{required:!0,message:"请输入规则名称"}],children:e.jsx(B,{placeholder:"请输入地理位置规则名称"})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"优先级",name:"priority",rules:[{required:!0,message:"请输入优先级"},{type:"number",min:0,max:100,message:"优先级必须在0-100之间"}],children:e.jsx(W,{min:0,max:100,style:{width:"100%"}})})})]}),e.jsx(u.Item,{label:"规则描述",name:"description",children:e.jsx(B.TextArea,{placeholder:"请输入地理位置规则描述",rows:3})}),e.jsx(u.Item,{label:"启用状态",name:"enabled",valuePropName:"checked",children:e.jsx(he,{checkedChildren:"启用",unCheckedChildren:"禁用"})})]}),U()]})},{key:"conditions",label:e.jsxs(p,{children:[e.jsx(ma,{}),"地理条件"]}),children:le()},{key:"actions",label:e.jsxs(p,{children:[e.jsx(me,{}),"执行动作"]}),children:te()},{key:"preview",label:e.jsxs(p,{children:[e.jsx(Ie,{}),"预览"]}),children:e.jsxs(I,{title:"规则预览",style:{border:"none",boxShadow:"none"},children:[e.jsx(P,{message:"规则JSON配置",description:"以下是当前规则的完整JSON配置预览",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx("pre",{style:{background:"#f5f5f5",padding:"16px",borderRadius:"6px",fontSize:"12px",lineHeight:"1.5",maxHeight:"400px",overflow:"auto",border:"1px solid #d9d9d9"},children:N})]})},{key:"json",label:e.jsxs(p,{children:[e.jsx(de,{}),"JSON编辑"]}),children:e.jsxs(I,{title:"JSON直接编辑",style:{border:"none",boxShadow:"none"},children:[e.jsx(P,{message:"JSON编辑模式",description:"可以直接编辑JSON配置，保存时会自动同步到表单",type:"warning",showIcon:!0,style:{marginBottom:16}}),L&&e.jsx(P,{message:"JSON格式错误",description:L,type:"error",showIcon:!0,style:{marginBottom:16}}),e.jsx($a,{value:N,onChange:o=>n(o.target.value),rows:20,style:{fontFamily:'Monaco, Consolas, "Courier New", monospace',fontSize:"12px",lineHeight:"1.5"},placeholder:"输入或编辑JSON格式的规则配置..."}),e.jsx("div",{style:{marginTop:12},children:e.jsxs(p,{children:[e.jsx(E,{size:"small",onClick:r,icon:e.jsx(Ve,{}),children:"从表单更新JSON"}),e.jsx(E,{size:"small",type:"primary",ghost:!0,onClick:()=>{try{const o=JSON.stringify(JSON.parse(N),null,2);$(o)}catch{}},icon:e.jsx(de,{}),children:"格式化JSON"})]})})]})}];return e.jsxs(Te,{title:e.jsxs(p,{children:[e.jsx(vt,{style:{color:"#52c41a"}}),e.jsx("span",{children:"地理空间规则编辑器"}),e.jsx(g,{color:"success",children:"地理位置数据"})]}),open:h,onCancel:G,footer:e.jsxs(p,{children:[e.jsx(E,{onClick:G,size:"large",children:"取消"}),e.jsx(E,{type:"primary",loading:V,onClick:Q,size:"large",icon:e.jsx(me,{}),children:"保存规则"})]}),width:1200,centered:!0,destroyOnHidden:!0,style:{maxHeight:"90vh",top:0},styles:{body:{padding:"20px",maxHeight:"calc(90vh - 140px)",overflowY:"auto",overflowX:"hidden"},header:{borderBottom:"1px solid #f0f0f0",paddingBottom:"16px"},content:{maxHeight:"90vh",display:"flex",flexDirection:"column"}},children:[m.length>0&&e.jsx(P,{message:"验证错误",description:e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:m.map((o,y)=>e.jsx("li",{children:o},y))}),type:"error",showIcon:!0,style:{marginBottom:16},closable:!0}),e.jsx(ke,{activeKey:q,onChange:A,items:ae,size:"large"})]})},{Option:Wa}=O,{Text:Qa}=pe,{TextArea:Fa}=B,Ja=({visible:h,onClose:v,onSave:M,rule:c})=>{const{form:C,saving:V,validationErrors:m,handleSave:S}=Pe({visible:h,onClose:v,onSave:M,rule:c,title:"3D向量规则编辑器",dataTypeName:"3D向量数据"}),G=()=>{D(void 0),k([]),X("basic"),$(""),s(""),v()},[J,D]=b.useState(c?.conditions),[_,k]=b.useState(c?.actions||[]),[q,X]=b.useState("basic"),[N,$]=b.useState(""),[L,s]=b.useState(""),l=c?(o=>{if(o.data_type){if(typeof o.data_type=="string")return o.data_type;if(typeof o.data_type=="object"&&o.data_type!==null)return o.data_type.type||"vector3d"}if(o.tags){const z=o.tags.data_type||o.tags.data_category;if(z)return z}const y=`${o.name||""} ${o.description||""}`.toLowerCase();return y.includes("vector3d")||y.includes("三轴")||y.includes("xyz")||y.includes("三维")||y.includes("vector")||y.includes("向量")||y.includes("acceleration")||y.includes("加速度"),"vector3d"})(c):"vector3d";b.useEffect(()=>{h&&c&&(D(c.conditions),k(c.actions||[]),r())},[h,c]);const r=()=>{try{const o={id:c?.id||"",name:C.getFieldValue("name")||"",description:C.getFieldValue("description")||"",priority:C.getFieldValue("priority")||50,enabled:C.getFieldValue("enabled")!==!1,data_type:l,conditions:J,actions:_,tags:{...c?.tags,data_type:l,data_category:"vector"},version:c?.version||1,created_at:c?.created_at||new Date().toISOString(),updated_at:new Date().toISOString()};$(JSON.stringify(o,null,2)),s("")}catch{s("JSON生成失败")}},n=o=>{$(o);try{const y=JSON.parse(o);y.name&&y.conditions&&y.actions?(s(""),C.setFieldsValue({name:y.name,description:y.description,priority:y.priority,enabled:y.enabled}),D(y.conditions),k(y.actions||[])):s("JSON格式不完整，缺少必要字段")}catch{s("JSON格式错误")}},i=[{value:"acceleration.x",label:"加速度X分量",description:"加速度向量的X轴分量 (m/s²)"},{value:"acceleration.y",label:"加速度Y分量",description:"加速度向量的Y轴分量 (m/s²)"},{value:"acceleration.z",label:"加速度Z分量",description:"加速度向量的Z轴分量 (m/s²)"},{value:"acceleration.magnitude",label:"加速度模长",description:"加速度向量的模长"},{value:"velocity.x",label:"速度X分量",description:"速度向量的X轴分量 (m/s)"},{value:"velocity.y",label:"速度Y分量",description:"速度向量的Y轴分量 (m/s)"},{value:"velocity.z",label:"速度Z分量",description:"速度向量的Z轴分量 (m/s)"},{value:"velocity.magnitude",label:"速度模长",description:"速度向量的模长"},{value:"position.x",label:"位置X坐标",description:"位置向量的X轴坐标 (m)"},{value:"position.y",label:"位置Y坐标",description:"位置向量的Y轴坐标 (m)"},{value:"position.z",label:"位置Z坐标",description:"位置向量的Z轴坐标 (m)"},{value:"force.x",label:"力X分量",description:"力向量的X轴分量 (N)"},{value:"force.y",label:"力Y分量",description:"力向量的Y轴分量 (N)"},{value:"force.z",label:"力Z分量",description:"力向量的Z轴分量 (N)"},{value:"force.magnitude",label:"合力大小",description:"力向量的模长"},{value:"gyroscope.x",label:"陀螺仪X轴",description:"陀螺仪X轴角速度 (rad/s)"},{value:"gyroscope.y",label:"陀螺仪Y轴",description:"陀螺仪Y轴角速度 (rad/s)"},{value:"gyroscope.z",label:"陀螺仪Z轴",description:"陀螺仪Z轴角速度 (rad/s)"},{value:"magnetometer.x",label:"磁力计X轴",description:"磁力计X轴测量值 (μT)"},{value:"magnetometer.y",label:"磁力计Y轴",description:"磁力计Y轴测量值 (μT)"},{value:"magnetometer.z",label:"磁力计Z轴",description:"磁力计Z轴测量值 (μT)"}],x=[{value:"vector3d_transform",label:"3D向量转换",description:"向量模长计算、分量提取、向量归一化等",configSchema:{transform_type:{type:"string",label:"转换类型",required:!0,options:[{value:"vector_magnitude",label:"向量模长计算"},{value:"component_extract",label:"分量提取"},{value:"vector_normalize",label:"向量归一化"},{value:"vector_cross_product",label:"叉积计算"},{value:"vector_dot_product",label:"点积计算"}]},vector_field:{type:"string",label:"向量字段",required:!0,placeholder:"acceleration, velocity, position等",description:"要处理的向量字段名"},output_key:{type:"string",label:"输出字段",placeholder:"转换后的字段名",description:"转换结果存储的字段名"},component:{type:"string",label:"分量选择",options:[{value:"x",label:"X分量"},{value:"y",label:"Y分量"},{value:"z",label:"Z分量"}],description:"用于分量提取时选择特定分量",conditionalDisplay:{dependsOn:"transform_type",showWhen:["component_extract"]}},precision:{type:"number",label:"精度",placeholder:"小数点后位数",description:"计算结果的小数精度"}}},{value:"vector3d_expression",label:"3D向量表达式操作",description:"使用表达式对3D向量数据进行复杂计算和处理",configSchema:{expression:{type:"textarea",label:"表达式",required:!0,placeholder:"vectorMagnitude(acceleration.x, acceleration.y, acceleration.z)",description:"支持3D向量函数和数学运算的表达式"},output_key:{type:"string",label:"输出字段",placeholder:"结果存储的字段名",description:"表达式计算结果存储的字段名"},output_type:{type:"string",label:"输出类型",options:[{value:"number",label:"数值"},{value:"vector",label:"向量"},{value:"boolean",label:"布尔值"},{value:"string",label:"字符串"}],defaultValue:"number"}}},{value:"vector3d_alert",label:"3D向量告警",description:"基于向量数据的告警通知",configSchema:{alert_type:{type:"string",label:"告警类型",options:[{value:"magnitude_threshold",label:"模长阈值告警"},{value:"component_threshold",label:"分量阈值告警"},{value:"vector_angle",label:"向量角度告警"},{value:"vibration_anomaly",label:"振动异常告警"}]},threshold:{type:"number",label:"告警阈值",required:!0,placeholder:"触发告警的数值阈值"},message:{type:"textarea",label:"告警消息",required:!0,placeholder:"设备{{.DeviceID}}向量{{.VectorField}}异常: 当前值{{.CurrentValue}}，阈值{{.Threshold}}"}}}],j=[{name:"vectorMagnitude",description:"计算3D向量模长",syntax:"vectorMagnitude(x, y, z)",example:"vectorMagnitude(acceleration.x, acceleration.y, acceleration.z) > 9.8",category:"向量函数",parameters:["x","y","z"]},{name:"vectorAngle",description:"计算两向量夹角",syntax:"vectorAngle(x1, y1, z1, x2, y2, z2)",example:"vectorAngle(velocity.x, velocity.y, velocity.z, 1, 0, 0) < 45",category:"向量函数",parameters:["x1","y1","z1","x2","y2","z2"]},{name:"vectorDot",description:"计算向量点积",syntax:"vectorDot(x1, y1, z1, x2, y2, z2)",example:"vectorDot(force.x, force.y, force.z, 0, 0, 1) > 0",category:"向量函数",parameters:["x1","y1","z1","x2","y2","z2"]},{name:"vectorCross",description:"计算向量叉积模长",syntax:"vectorCross(x1, y1, z1, x2, y2, z2)",example:"vectorCross(velocity.x, velocity.y, velocity.z, acceleration.x, acceleration.y, acceleration.z)",category:"向量函数",parameters:["x1","y1","z1","x2","y2","z2"]}],H=[{name:"acceleration.x",description:"加速度X分量",type:"number",example:"acceleration.x > 2.0"},{name:"acceleration.y",description:"加速度Y分量",type:"number",example:"acceleration.y < -1.0"},{name:"acceleration.z",description:"加速度Z分量",type:"number",example:"acceleration.z > 9.8"},{name:"velocity.x",description:"速度X分量",type:"number",example:"velocity.x > 0"},{name:"velocity.y",description:"速度Y分量",type:"number",example:"velocity.y < 0"},{name:"velocity.z",description:"速度Z分量",type:"number",example:"velocity.z == 0"},{name:"position.x",description:"位置X坐标",type:"number",example:"position.x > 100"},{name:"position.y",description:"位置Y坐标",type:"number",example:"position.y < -50"},{name:"position.z",description:"位置Z坐标",type:"number",example:"position.z > 0"},{name:"force.magnitude",description:"合力大小",type:"number",example:"force.magnitude > 1000"},{name:"gyroscope.magnitude",description:"角速度模长",type:"number",example:"gyroscope.magnitude > 5.0"}],Q=async()=>{r(),await S(()=>J,()=>_)},A=o=>{X(o),(o==="json"||o==="preview")&&setTimeout(r,50)},re=()=>{(q==="json"||q==="preview")&&setTimeout(r,100)},U=()=>e.jsx(I,{title:e.jsxs(p,{children:[e.jsx(at,{}),"3D向量配置"]}),style:{marginTop:16},children:e.jsx(P,{message:"3D向量数据类型",description:"此数据类型专门处理三轴向量数据，如加速度、速度、位置、力等，支持实时模长计算、分量提取和向量运算",type:"info",showIcon:!0})}),le=()=>e.jsxs(I,{title:"3D向量条件",style:{marginTop:16},children:[e.jsx(Fe,{value:J,onChange:D,availableFields:["device_id","key","value","timestamp"],customFieldOptions:i,allowedOperators:["eq","ne","gt","gte","lt","lte","contains","regex"],supportExpressions:!0,dataTypeName:"3D向量"}),e.jsx("div",{style:{marginTop:16},children:e.jsx(Ge,{value:J?.type==="expression"?J.expression:"",onChange:o=>D({type:"expression",expression:o}),dataType:"vector3d",availableFunctions:j,availableVariables:H,placeholder:"输入3D向量表达式，例如：vectorMagnitude(acceleration.x, acceleration.y, acceleration.z) > 9.8",rows:3})})]}),te=()=>e.jsx(I,{title:"3D向量动作",style:{marginTop:16},children:e.jsx(Le,{value:_,onChange:k,availableActionTypes:[],customActionOptions:x,dataTypeName:"3D向量"})}),ae=[{key:"basic",label:e.jsxs(p,{children:[e.jsx(ce,{}),"基本信息"]}),children:e.jsxs(I,{title:"基本信息",style:{border:"none",boxShadow:"none"},children:[e.jsxs(u,{form:C,layout:"vertical",initialValues:{priority:c?.priority||50,enabled:c?.enabled!==!1},onValuesChange:re,children:[e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"规则名称",name:"name",rules:[{required:!0,message:"请输入规则名称"}],children:e.jsx(B,{placeholder:"请输入3D向量规则名称"})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"优先级",name:"priority",rules:[{required:!0,message:"请输入优先级"},{type:"number",min:0,max:100,message:"优先级必须在0-100之间"}],children:e.jsx(W,{min:0,max:100,style:{width:"100%"}})})})]}),e.jsx(u.Item,{label:"规则描述",name:"description",children:e.jsx(B.TextArea,{placeholder:"请输入3D向量规则描述",rows:3})}),e.jsx(u.Item,{label:"启用状态",name:"enabled",valuePropName:"checked",style:{display:"flex",alignItems:"center",height:"40px"},children:e.jsx(he,{checkedChildren:"启用",unCheckedChildren:"禁用"})})]}),U()]})},{key:"conditions",label:e.jsxs(p,{children:[e.jsx(at,{}),"向量条件"]}),children:le()},{key:"actions",label:e.jsxs(p,{children:[e.jsx(me,{}),"执行动作"]}),children:te()},{key:"preview",label:e.jsxs(p,{children:[e.jsx(Ie,{}),"预览"]}),children:e.jsxs(I,{title:"规则预览",style:{border:"none",boxShadow:"none"},children:[e.jsx(P,{message:"规则JSON配置",description:"以下是当前规则的完整JSON配置预览",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx("pre",{style:{background:"#f5f5f5",padding:"16px",borderRadius:"6px",fontSize:"12px",lineHeight:"1.5",maxHeight:"400px",overflow:"auto",border:"1px solid #d9d9d9"},children:N})]})},{key:"json",label:e.jsxs(p,{children:[e.jsx(de,{}),"JSON编辑"]}),children:e.jsxs(I,{title:"JSON直接编辑",style:{border:"none",boxShadow:"none"},children:[e.jsx(P,{message:"JSON编辑模式",description:"可以直接编辑JSON配置，保存时会自动同步到表单",type:"warning",showIcon:!0,style:{marginBottom:16}}),L&&e.jsx(P,{message:"JSON格式错误",description:L,type:"error",showIcon:!0,style:{marginBottom:16}}),e.jsx(Fa,{value:N,onChange:o=>n(o.target.value),rows:20,style:{fontFamily:'Monaco, Consolas, "Courier New", monospace',fontSize:"12px",lineHeight:"1.5"},placeholder:"输入或编辑JSON格式的规则配置..."}),e.jsx("div",{style:{marginTop:12},children:e.jsxs(p,{children:[e.jsx(E,{size:"small",onClick:r,icon:e.jsx(Ve,{}),children:"从表单更新JSON"}),e.jsx(E,{size:"small",type:"primary",ghost:!0,onClick:()=>{try{const o=JSON.stringify(JSON.parse(N),null,2);$(o)}catch{}},icon:e.jsx(de,{}),children:"格式化JSON"})]})})]})}];return e.jsxs(Te,{title:e.jsxs(p,{children:[e.jsx(at,{style:{color:"#1890ff"}}),e.jsx("span",{children:"3D向量规则编辑器"}),e.jsx(g,{color:"blue",icon:e.jsx(se,{}),children:"3D向量数据"})]}),open:h,onCancel:G,footer:e.jsxs(p,{children:[e.jsx(E,{onClick:G,size:"large",children:"取消"}),e.jsx(E,{type:"primary",loading:V,onClick:Q,size:"large",icon:e.jsx(me,{}),children:"保存规则"})]}),width:1200,centered:!0,destroyOnHidden:!0,style:{maxHeight:"90vh",top:0},styles:{body:{padding:"20px",maxHeight:"calc(90vh - 140px)",overflowY:"auto",overflowX:"hidden"},header:{borderBottom:"1px solid #f0f0f0",paddingBottom:"16px"},content:{maxHeight:"90vh",display:"flex",flexDirection:"column"}},children:[m.length>0&&e.jsx(P,{message:"验证错误",description:e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:m.map((o,y)=>e.jsx("li",{children:o},y))}),type:"error",showIcon:!0,style:{marginBottom:16},closable:!0}),e.jsx(ke,{activeKey:q,onChange:A,items:ae,size:"large"})]})},{Option:er}=O,{Text:tr}=pe,{TextArea:qa}=B,Ba=({visible:h,onClose:v,onSave:M,rule:c})=>{const{form:C,saving:V,validationErrors:m,handleSave:S}=Pe({visible:h,onClose:v,onSave:M,rule:c,title:"通用向量规则编辑器",dataTypeName:"通用向量数据"}),G=()=>{D(void 0),k([]),X("basic"),$(""),s(""),v()},[J,D]=b.useState(c?.conditions),[_,k]=b.useState(c?.actions||[]),[q,X]=b.useState("basic"),[N,$]=b.useState(""),[L,s]=b.useState(""),l=c?(o=>{if(o.data_type){if(typeof o.data_type=="string")return o.data_type;if(typeof o.data_type=="object"&&o.data_type!==null)return o.data_type.type||"vector_generic"}if(o.tags){const z=o.tags.data_type||o.tags.data_category;if(z)return z}const y=`${o.name||""} ${o.description||""}`.toLowerCase();return y.includes("vector")||y.includes("向量")||y.includes("array")||y.includes("数组")||y.includes("generic")||y.includes("通用")||y.includes("sequence")||y.includes("序列"),"vector_generic"})(c):"vector_generic";b.useEffect(()=>{h&&c&&(D(c.conditions),k(c.actions||[]),r())},[h,c]);const r=()=>{try{const o={id:c?.id||"",name:C.getFieldValue("name")||"",description:C.getFieldValue("description")||"",priority:C.getFieldValue("priority")||50,enabled:C.getFieldValue("enabled")!==!1,data_type:l,conditions:J,actions:_,tags:c?.tags||{},version:c?.version||1,created_at:c?.created_at||new Date().toISOString(),updated_at:new Date().toISOString()};$(JSON.stringify(o,null,2)),s("")}catch{s("JSON生成失败")}},n=o=>{$(o);try{const y=JSON.parse(o);y.name&&y.conditions&&y.actions?(s(""),C.setFieldsValue({name:y.name,description:y.description,priority:y.priority,enabled:y.enabled}),D(y.conditions),k(y.actions||[])):s("JSON格式不完整，缺少必要字段")}catch{s("JSON格式错误")}},i=[{value:"sensor_vector.dimension",label:"向量维度",description:"向量的维数"},{value:"sensor_vector.magnitude",label:"向量模长",description:"向量的欧几里德长度"},{value:"sensor_vector.mean",label:"向量均值",description:"所有元素的平均值"},{value:"sensor_vector.max",label:"向量最大值",description:"所有元素的最大值"},{value:"sensor_vector.min",label:"向量最小值",description:"所有元素的最小值"},{value:"signal_array.length",label:"数组长度",description:"数组元素个数"},{value:"signal_array.sum",label:"数组和",description:"所有元素的总和"},{value:"signal_array.avg",label:"数组平均值",description:"所有元素的平均值"},{value:"measurement_vector.stddev",label:"向量标准差",description:"元素的标准偏差"},{value:"measurement_vector.variance",label:"向量方差",description:"元素的方差"},{value:"data_sequence[0]",label:"第一个元素",description:"向量/数组的第一个元素"},{value:"data_sequence[1]",label:"第二个元素",description:"向量/数组的第二个元素"},{value:"data_sequence[-1]",label:"最后一个元素",description:"向量/数组的最后一个元素"},{value:"feature_vector.norm",label:"向量范数",description:"向量的2范数"},{value:"values.size",label:"元素数量",description:"向量中元素的数量"}],x=[{value:"generic_vector_transform",label:"通用向量转换",description:"向量模长、均值、元素提取等通用操作",configSchema:{transform_type:{type:"string",label:"转换类型",required:!0,options:[{value:"generic_magnitude",label:"通用向量模长"},{value:"vector_mean",label:"向量元素均值"},{value:"vector_sum",label:"向量元素求和"},{value:"vector_max",label:"向量最大值"},{value:"vector_min",label:"向量最小值"},{value:"vector_stddev",label:"向量标准差"},{value:"element_extract",label:"元素提取"},{value:"subvector_extract",label:"子向量提取"}]},vector_field:{type:"string",label:"向量字段",required:!0,placeholder:"sensor_vector, signal_array等",description:"要处理的向量字段名"},element_index:{type:"number",label:"元素索引",placeholder:"0, 1, 2...",description:"用于元素提取的索引位置",conditionalDisplay:{dependsOn:"transform_type",showWhen:["element_extract"]}},start_index:{type:"number",label:"开始索引",placeholder:"子向量开始位置",description:"子向量提取的开始位置",conditionalDisplay:{dependsOn:"transform_type",showWhen:["subvector_extract"]}},end_index:{type:"number",label:"结束索引",placeholder:"子向量结束位置",description:"子向量提取的结束位置",conditionalDisplay:{dependsOn:"transform_type",showWhen:["subvector_extract"]}},output_key:{type:"string",label:"输出字段",placeholder:"转换后的字段名",description:"转换结果存储的字段名"}}},{value:"generic_vector_expression",label:"通用向量表达式操作",description:"使用表达式对通用向量数据进行复杂计算和处理",configSchema:{expression:{type:"textarea",label:"表达式",required:!0,placeholder:"genericVectorMagnitude(sensor_vector) + vectorMean(signal_array)",description:"支持通用向量函数和数学运算的表达式"},output_key:{type:"string",label:"输出字段",placeholder:"结果存储的字段名",description:"表达式计算结果存储的字段名"},output_type:{type:"string",label:"输出类型",options:[{value:"number",label:"数值"},{value:"array",label:"数组"},{value:"boolean",label:"布尔值"},{value:"string",label:"字符串"}],defaultValue:"number"}}},{value:"generic_vector_alert",label:"通用向量告警",description:"基于向量统计特性的告警",configSchema:{alert_type:{type:"string",label:"告警类型",options:[{value:"magnitude_threshold",label:"模长阈值告警"},{value:"mean_threshold",label:"均值阈值告警"},{value:"element_threshold",label:"元素阈值告警"},{value:"dimension_check",label:"维度检查告警"},{value:"variance_anomaly",label:"方差异常告警"}]},threshold:{type:"number",label:"告警阈值",required:!0,placeholder:"触发告警的数值阈值"},message:{type:"textarea",label:"告警消息",required:!0,placeholder:"设备{{.DeviceID}}向量{{.VectorField}}异常: 当前值{{.CurrentValue}}"}}}],j=[{name:"genericVectorMagnitude",description:"计算通用向量模长",syntax:"genericVectorMagnitude(vector)",example:"genericVectorMagnitude(sensor_vector) > 10.5",category:"向量函数",parameters:["vector"]},{name:"vectorMean",description:"计算向量元素均值",syntax:"vectorMean(vector)",example:"vectorMean(signal_array) > 5.0",category:"向量函数",parameters:["vector"]},{name:"vectorMax",description:"获取向量最大元素",syntax:"vectorMax(vector)",example:"vectorMax(measurement_vector) < 100",category:"向量函数",parameters:["vector"]},{name:"vectorMin",description:"获取向量最小元素",syntax:"vectorMin(vector)",example:"vectorMin(measurement_vector) > -50",category:"向量函数",parameters:["vector"]},{name:"vectorStddev",description:"计算向量标准差",syntax:"vectorStddev(vector)",example:"vectorStddev(sensor_data) > 2.0",category:"向量函数",parameters:["vector"]},{name:"vectorDimension",description:"获取向量维度",syntax:"vectorDimension(vector)",example:"vectorDimension(feature_vector) == 128",category:"向量函数",parameters:["vector"]},{name:"vectorElement",description:"访问向量指定元素",syntax:"vectorElement(vector, index)",example:"vectorElement(data_sequence, 0) > 0",category:"向量函数",parameters:["vector","index"]}],H=[{name:"sensor_vector",description:"传感器向量数据",type:"vector",example:"genericVectorMagnitude(sensor_vector) > 5.0"},{name:"signal_array",description:"信号数组数据",type:"array",example:"vectorMean(signal_array) > 0"},{name:"measurement_vector",description:"测量向量",type:"vector",example:"vectorMax(measurement_vector) < 100"},{name:"data_sequence",description:"数据序列",type:"array",example:"vectorElement(data_sequence, 0) > threshold"},{name:"feature_vector",description:"特征向量",type:"vector",example:"vectorDimension(feature_vector) == 64"},{name:"values",description:"数值向量",type:"vector",example:"vectorStddev(values) < 1.0"}],Q=async()=>{r(),await S(()=>J,()=>_)},A=o=>{X(o),(o==="json"||o==="preview")&&setTimeout(r,50)},re=()=>{(q==="json"||q==="preview")&&setTimeout(r,100)},U=()=>e.jsx(I,{title:e.jsxs(p,{children:[e.jsx(se,{}),"通用向量配置"]}),style:{marginTop:16},children:e.jsx(P,{message:"通用向量数据类型",description:"此数据类型专门处理任意维度的向量、数组和序列数据，支持丰富的统计和数学运算功能",type:"info",showIcon:!0})}),le=()=>e.jsxs(I,{title:"通用向量条件",style:{marginTop:16},children:[e.jsx(Fe,{value:J,onChange:D,availableFields:["device_id","key","value","timestamp"],customFieldOptions:i,allowedOperators:["eq","ne","gt","gte","lt","lte","contains","regex"],supportExpressions:!0,dataTypeName:"通用向量"}),e.jsx("div",{style:{marginTop:16},children:e.jsx(Ge,{value:J?.type==="expression"?J.expression:"",onChange:o=>D({type:"expression",expression:o}),dataType:"vector_generic",availableFunctions:j,availableVariables:H,placeholder:"输入通用向量表达式，例如：genericVectorMagnitude(sensor_vector) > 10.0",rows:3})})]}),te=()=>e.jsx(I,{title:"通用向量动作",style:{marginTop:16},children:e.jsx(Le,{value:_,onChange:k,availableActionTypes:[],customActionOptions:x,dataTypeName:"通用向量"})}),ae=[{key:"basic",label:e.jsxs(p,{children:[e.jsx(ce,{}),"基本信息"]}),children:e.jsxs(I,{title:"基本信息",style:{border:"none",boxShadow:"none"},children:[e.jsxs(u,{form:C,layout:"vertical",initialValues:{priority:c?.priority||50,enabled:c?.enabled!==!1},onValuesChange:re,children:[e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"规则名称",name:"name",rules:[{required:!0,message:"请输入规则名称"}],children:e.jsx(B,{placeholder:"请输入通用向量规则名称"})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"优先级",name:"priority",rules:[{required:!0,message:"请输入优先级"},{type:"number",min:0,max:100,message:"优先级必须在0-100之间"}],children:e.jsx(W,{min:0,max:100,style:{width:"100%"}})})})]}),e.jsx(u.Item,{label:"规则描述",name:"description",children:e.jsx(B.TextArea,{placeholder:"请输入通用向量规则描述",rows:3})}),e.jsx(u.Item,{label:"启用状态",name:"enabled",valuePropName:"checked",children:e.jsx(he,{checkedChildren:"启用",unCheckedChildren:"禁用"})})]}),U()]})},{key:"conditions",label:e.jsxs(p,{children:[e.jsx(se,{}),"向量条件"]}),children:le()},{key:"actions",label:e.jsxs(p,{children:[e.jsx(me,{}),"执行动作"]}),children:te()},{key:"preview",label:e.jsxs(p,{children:[e.jsx(Ie,{}),"预览"]}),children:e.jsxs(I,{title:"规则预览",style:{border:"none",boxShadow:"none"},children:[e.jsx(P,{message:"规则JSON配置",description:"以下是当前规则的完整JSON配置预览",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx("pre",{style:{background:"#f5f5f5",padding:"16px",borderRadius:"6px",fontSize:"12px",lineHeight:"1.5",maxHeight:"400px",overflow:"auto",border:"1px solid #d9d9d9"},children:N})]})},{key:"json",label:e.jsxs(p,{children:[e.jsx(de,{}),"JSON编辑"]}),children:e.jsxs(I,{title:"JSON直接编辑",style:{border:"none",boxShadow:"none"},children:[e.jsx(P,{message:"JSON编辑模式",description:"可以直接编辑JSON配置，保存时会自动同步到表单",type:"warning",showIcon:!0,style:{marginBottom:16}}),L&&e.jsx(P,{message:"JSON格式错误",description:L,type:"error",showIcon:!0,style:{marginBottom:16}}),e.jsx(qa,{value:N,onChange:o=>n(o.target.value),rows:20,style:{fontFamily:'Monaco, Consolas, "Courier New", monospace',fontSize:"12px",lineHeight:"1.5"},placeholder:"输入或编辑JSON格式的规则配置..."}),e.jsx("div",{style:{marginTop:12},children:e.jsxs(p,{children:[e.jsx(E,{size:"small",onClick:r,icon:e.jsx(Ve,{}),children:"从表单更新JSON"}),e.jsx(E,{size:"small",type:"primary",ghost:!0,onClick:()=>{try{const o=JSON.stringify(JSON.parse(N),null,2);$(o)}catch{}},icon:e.jsx(de,{}),children:"格式化JSON"})]})})]})}];return e.jsxs(Te,{title:e.jsxs(p,{children:[e.jsx(se,{style:{color:"#fa8c16"}}),e.jsx("span",{children:"通用向量规则编辑器"}),e.jsx(g,{color:"orange",children:"通用向量数据"})]}),open:h,onCancel:G,footer:e.jsxs(p,{children:[e.jsx(E,{onClick:G,size:"large",children:"取消"}),e.jsx(E,{type:"primary",loading:V,onClick:Q,size:"large",icon:e.jsx(me,{}),children:"保存规则"})]}),width:1200,centered:!0,destroyOnHidden:!0,style:{maxHeight:"90vh",top:0},styles:{body:{padding:"20px",maxHeight:"calc(90vh - 140px)",overflowY:"auto",overflowX:"hidden"},header:{borderBottom:"1px solid #f0f0f0",paddingBottom:"16px"},content:{maxHeight:"90vh",display:"flex",flexDirection:"column"}},children:[m.length>0&&e.jsx(P,{message:"验证错误",description:e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:m.map((o,y)=>e.jsx("li",{children:o},y))}),type:"error",showIcon:!0,style:{marginBottom:16},closable:!0}),e.jsx(ke,{activeKey:q,onChange:A,items:ae,size:"large"})]})},{Option:ar}=O,{Text:rr}=pe,{TextArea:Ha}=B,Ma=({visible:h,onClose:v,onSave:M,rule:c})=>{const{form:C,saving:V,validationErrors:m,handleSave:S,handleCancel:G}=Pe({visible:h,onClose:v,onSave:M,rule:c,title:"视觉规则编辑器",dataTypeName:"视觉数据"}),J=()=>{console.log("VisualRuleEditor handleCancel 被调用"),_(void 0),q([]),N("basic"),L(""),t(""),console.log("调用 baseHandleCancel"),G()},[D,_]=b.useState(c?.conditions),[k,q]=b.useState(c?.actions||[]),[X,N]=b.useState("basic"),[$,L]=b.useState(""),[s,t]=b.useState(""),r=c?(y=>{if(y.data_type){if(typeof y.data_type=="string")return y.data_type;if(typeof y.data_type=="object"&&y.data_type!==null)return y.data_type.type||"color"}if(y.tags){const F=y.tags.data_type||y.tags.data_category;if(F)return F}const z=`${y.name||""} ${y.description||""}`.toLowerCase();return z.includes("color")||z.includes("颜色")||z.includes("rgb")||z.includes("hsl")||z.includes("visual")||z.includes("视觉")||z.includes("brightness")||z.includes("亮度"),"color"})(c):"color";b.useEffect(()=>{h&&c&&(_(c.conditions),q(c.actions||[]),n())},[h,c]);const n=()=>{try{const y={id:c?.id||"",name:C.getFieldValue("name")||"",description:C.getFieldValue("description")||"",priority:C.getFieldValue("priority")||50,enabled:C.getFieldValue("enabled")!==!1,data_type:r,conditions:D,actions:k,tags:c?.tags||{},version:c?.version||1,created_at:c?.created_at||new Date().toISOString(),updated_at:new Date().toISOString()};L(JSON.stringify(y,null,2)),t("")}catch{t("JSON生成失败")}},i=y=>{L(y);try{const z=JSON.parse(y);z.name&&z.conditions&&z.actions?(t(""),C.setFieldsValue({name:z.name,description:z.description,priority:z.priority,enabled:z.enabled}),_(z.conditions),q(z.actions||[])):t("JSON格式不完整，缺少必要字段")}catch{t("JSON格式错误")}},x=[{value:"color.r",label:"红色分量 (R)",description:"RGB颜色的红色分量 (0-255)"},{value:"color.g",label:"绿色分量 (G)",description:"RGB颜色的绿色分量 (0-255)"},{value:"color.b",label:"蓝色分量 (B)",description:"RGB颜色的蓝色分量 (0-255)"},{value:"color.a",label:"透明度 (Alpha)",description:"颜色透明度 (0.0-1.0)"},{value:"hsl.h",label:"色相 (Hue)",description:"HSL颜色的色相值 (0-360)"},{value:"hsl.s",label:"饱和度 (Saturation)",description:"HSL颜色的饱和度 (0-100)"},{value:"hsl.l",label:"亮度 (Lightness)",description:"HSL颜色的亮度 (0-100)"},{value:"hsv.h",label:"HSV色相",description:"HSV颜色的色相值 (0-360)"},{value:"hsv.s",label:"HSV饱和度",description:"HSV颜色的饱和度 (0-100)"},{value:"hsv.v",label:"明度 (Value)",description:"HSV颜色的明度值 (0-100)"},{value:"color.hex",label:"HEX颜色值",description:"十六进制颜色表示 (#RRGGBB)"},{value:"color.brightness",label:"整体亮度",description:"感知亮度值 (0.0-1.0)"},{value:"color.contrast",label:"对比度",description:"相对于参考色的对比度"},{value:"color.dominant",label:"主色调",description:"图像或区域的主色调分类"}],j=[{value:"color_transform",label:"颜色转换",description:"颜色空间转换、色彩调整、格式转换",configSchema:{transform_type:{type:"string",label:"转换类型",required:!0,options:[{value:"color_space_convert",label:"颜色空间转换"},{value:"brightness_adjust",label:"亮度调整"},{value:"saturation_adjust",label:"饱和度调整"},{value:"hue_shift",label:"色相偏移"},{value:"contrast_adjust",label:"对比度调整"},{value:"gamma_correction",label:"伽马校正"},{value:"color_invert",label:"颜色反转"},{value:"grayscale_convert",label:"灰度转换"}]},source_color_space:{type:"string",label:"源颜色空间",options:[{value:"RGB",label:"RGB"},{value:"HSL",label:"HSL"},{value:"HSV",label:"HSV"},{value:"CMYK",label:"CMYK"},{value:"LAB",label:"LAB"}],defaultValue:"RGB"},target_color_space:{type:"string",label:"目标颜色空间",options:[{value:"RGB",label:"RGB"},{value:"HSL",label:"HSL"},{value:"HSV",label:"HSV"},{value:"CMYK",label:"CMYK"},{value:"LAB",label:"LAB"}],defaultValue:"HSL"},adjustment_value:{type:"number",label:"调整数值",placeholder:"调整强度 (-100到100)",description:"颜色调整的强度值"},output_key:{type:"string",label:"输出字段",placeholder:"转换后的字段名",description:"转换结果存储的字段名"}}},{value:"color_analysis",label:"颜色分析",description:"颜色相似度、主色调提取、色彩统计",configSchema:{analysis_type:{type:"string",label:"分析类型",required:!0,options:[{value:"similarity_check",label:"颜色相似度检查"},{value:"dominant_color",label:"主色调提取"},{value:"color_histogram",label:"颜色直方图"},{value:"color_temperature",label:"色温分析"},{value:"color_palette",label:"调色板生成"}]},reference_color:{type:"object",label:"参考颜色",placeholder:'{"r": 255, "g": 0, "b": 0}',description:"用于相似度比较的参考颜色"},similarity_threshold:{type:"number",label:"相似度阈值",placeholder:"0.0-1.0之间的数值",description:"颜色相似度判断阈值"},distance_method:{type:"string",label:"距离算法",options:[{value:"euclidean",label:"欧氏距离"},{value:"manhattan",label:"曼哈顿距离"},{value:"cosine",label:"余弦距离"},{value:"cie2000",label:"CIE2000色差"}],defaultValue:"euclidean"}}},{value:"visual_expression",label:"视觉表达式操作",description:"使用表达式对视觉数据进行复杂计算和处理",configSchema:{expression:{type:"textarea",label:"表达式",required:!0,placeholder:"getBrightness(color.r, color.g, color.b) * 0.8",description:"支持颜色函数和数学运算的表达式"},output_key:{type:"string",label:"输出字段",placeholder:"结果存储的字段名",description:"表达式计算结果存储的字段名"},output_type:{type:"string",label:"输出类型",options:[{value:"number",label:"数值"},{value:"string",label:"字符串"},{value:"boolean",label:"布尔值"},{value:"object",label:"对象"}],defaultValue:"number"}}},{value:"visual_alert",label:"视觉告警",description:"基于视觉特征的告警通知",configSchema:{alert_type:{type:"string",label:"告警类型",options:[{value:"color_change",label:"颜色变化告警"},{value:"brightness_threshold",label:"亮度阈值告警"},{value:"contrast_anomaly",label:"对比度异常告警"},{value:"color_similarity",label:"颜色匹配告警"}]},threshold:{type:"number",label:"告警阈值",required:!0,placeholder:"触发告警的数值阈值"},message:{type:"textarea",label:"告警消息",required:!0,placeholder:"设备{{.DeviceID}}颜色异常: R={{.color.r}}, G={{.color.g}}, B={{.color.b}}"}}}],H=[{name:"colorSimilarity",description:"计算两种颜色的相似度",syntax:"colorSimilarity(r1, g1, b1, r2, g2, b2, method)",example:'colorSimilarity(color.r, color.g, color.b, 255, 0, 0, "euclidean") > 0.8',category:"颜色函数",parameters:["r1","g1","b1","r2","g2","b2","method"]},{name:"rgbToHsl",description:"RGB转HSL颜色空间",syntax:"rgbToHsl(r, g, b)",example:"rgbToHsl(color.r, color.g, color.b)",category:"颜色函数",parameters:["r","g","b"]},{name:"hslToRgb",description:"HSL转RGB颜色空间",syntax:"hslToRgb(h, s, l)",example:"hslToRgb(hsl.h, hsl.s, hsl.l)",category:"颜色函数",parameters:["h","s","l"]},{name:"getBrightness",description:"计算颜色亮度",syntax:"getBrightness(r, g, b)",example:"getBrightness(color.r, color.g, color.b) > 0.5",category:"颜色函数",parameters:["r","g","b"]},{name:"getContrast",description:"计算两种颜色的对比度",syntax:"getContrast(r1, g1, b1, r2, g2, b2)",example:"getContrast(color.r, color.g, color.b, 255, 255, 255) > 4.5",category:"颜色函数",parameters:["r1","g1","b1","r2","g2","b2"]},{name:"hexToRgb",description:"十六进制转RGB",syntax:"hexToRgb(hex)",example:"hexToRgb(color.hex)",category:"颜色函数",parameters:["hex"]},{name:"rgbToHex",description:"RGB转十六进制",syntax:"rgbToHex(r, g, b)",example:"rgbToHex(color.r, color.g, color.b)",category:"颜色函数",parameters:["r","g","b"]}],Q=[{name:"color.r",description:"红色分量",type:"number",example:"color.r > 128"},{name:"color.g",description:"绿色分量",type:"number",example:"color.g > 128"},{name:"color.b",description:"蓝色分量",type:"number",example:"color.b > 128"},{name:"color.a",description:"透明度",type:"number",example:"color.a > 0.5"},{name:"hsl.h",description:"HSL色相",type:"number",example:"hsl.h > 180"},{name:"hsl.s",description:"HSL饱和度",type:"number",example:"hsl.s > 50"},{name:"hsl.l",description:"HSL亮度",type:"number",example:"hsl.l > 50"},{name:"color.hex",description:"HEX颜色",type:"string",example:'contains(color.hex, "FF")'},{name:"color.brightness",description:"感知亮度",type:"number",example:"color.brightness > 0.5"},{name:"color.contrast",description:"对比度",type:"number",example:"color.contrast > 4.5"}],A=async()=>{n(),await S(()=>D,()=>k)},re=y=>{N(y),(y==="json"||y==="preview")&&setTimeout(n,50)},U=()=>{(X==="json"||X==="preview")&&setTimeout(n,100)},le=()=>e.jsx(I,{title:e.jsxs(p,{children:[e.jsx(rt,{}),"视觉数据配置"]}),style:{marginTop:16},children:e.jsx(P,{message:"视觉数据类型",description:"此数据类型专门处理颜色、图像等视觉相关数据，支持RGB、HSL、HSV等多种颜色空间的分析和转换",type:"info",showIcon:!0})}),te=()=>e.jsxs(I,{title:"视觉数据条件",style:{marginTop:16},children:[e.jsx(Fe,{value:D,onChange:_,availableFields:["device_id","key","value","timestamp"],customFieldOptions:x,allowedOperators:["eq","ne","gt","gte","lt","lte","contains","regex"],supportExpressions:!0,dataTypeName:"视觉数据"}),e.jsx("div",{style:{marginTop:16},children:e.jsx(Ge,{value:D?.type==="expression"?D.expression:"",onChange:y=>_({type:"expression",expression:y}),dataType:"visual",availableFunctions:H,availableVariables:Q,placeholder:"输入视觉数据表达式，例如：colorSimilarity(color.r, color.g, color.b, 255, 0, 0, 'euclidean') > 0.8",rows:3})})]}),ae=()=>e.jsx(I,{title:"视觉数据动作",style:{marginTop:16},children:e.jsx(Le,{value:k,onChange:q,availableActionTypes:[],customActionOptions:j,dataTypeName:"视觉数据"})}),o=[{key:"basic",label:e.jsxs(p,{children:[e.jsx(ce,{}),"基本信息"]}),children:e.jsxs(I,{title:"基本信息",style:{border:"none",boxShadow:"none"},children:[e.jsxs(u,{form:C,layout:"vertical",initialValues:{priority:c?.priority||50,enabled:c?.enabled!==!1},onValuesChange:U,children:[e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"规则名称",name:"name",rules:[{required:!0,message:"请输入规则名称"}],children:e.jsx(B,{placeholder:"请输入视觉规则名称"})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"优先级",name:"priority",rules:[{required:!0,message:"请输入优先级"},{type:"number",min:0,max:100,message:"优先级必须在0-100之间"}],children:e.jsx(W,{min:0,max:100,style:{width:"100%"}})})})]}),e.jsx(u.Item,{label:"规则描述",name:"description",children:e.jsx(B.TextArea,{placeholder:"请输入视觉规则描述",rows:3})}),e.jsx(u.Item,{label:"启用状态",name:"enabled",valuePropName:"checked",children:e.jsx(he,{checkedChildren:"启用",unCheckedChildren:"禁用"})})]}),le()]})},{key:"conditions",label:e.jsxs(p,{children:[e.jsx(rt,{}),"视觉条件"]}),children:te()},{key:"actions",label:e.jsxs(p,{children:[e.jsx(me,{}),"执行动作"]}),children:ae()},{key:"preview",label:e.jsxs(p,{children:[e.jsx(Ie,{}),"预览"]}),children:e.jsxs(I,{title:"规则预览",style:{border:"none",boxShadow:"none"},children:[e.jsx(P,{message:"规则JSON配置",description:"以下是当前规则的完整JSON配置预览",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx("pre",{style:{background:"#f5f5f5",padding:"16px",borderRadius:"6px",fontSize:"12px",lineHeight:"1.5",maxHeight:"400px",overflow:"auto",border:"1px solid #d9d9d9"},children:$})]})},{key:"json",label:e.jsxs(p,{children:[e.jsx(de,{}),"JSON编辑"]}),children:e.jsxs(I,{title:"JSON直接编辑",style:{border:"none",boxShadow:"none"},children:[e.jsx(P,{message:"JSON编辑模式",description:"可以直接编辑JSON配置，保存时会自动同步到表单",type:"warning",showIcon:!0,style:{marginBottom:16}}),s&&e.jsx(P,{message:"JSON格式错误",description:s,type:"error",showIcon:!0,style:{marginBottom:16}}),e.jsx(Ha,{value:$,onChange:y=>i(y.target.value),rows:20,style:{fontFamily:'Monaco, Consolas, "Courier New", monospace',fontSize:"12px",lineHeight:"1.5"},placeholder:"输入或编辑JSON格式的规则配置..."}),e.jsx("div",{style:{marginTop:12},children:e.jsxs(p,{children:[e.jsx(E,{size:"small",onClick:n,icon:e.jsx(Ve,{}),children:"从表单更新JSON"}),e.jsx(E,{size:"small",type:"primary",ghost:!0,onClick:()=>{try{const y=JSON.stringify(JSON.parse($),null,2);L(y)}catch{}},icon:e.jsx(de,{}),children:"格式化JSON"})]})})]})}];return e.jsxs(Te,{title:e.jsxs(p,{children:[e.jsx(rt,{style:{color:"#722ed1"}}),e.jsx("span",{children:"视觉规则编辑器"}),e.jsx(g,{color:"purple",children:"视觉数据"})]}),open:h,onCancel:J,footer:e.jsxs(p,{children:[e.jsx(E,{onClick:J,size:"large",children:"取消"}),e.jsx(E,{type:"primary",loading:V,onClick:A,size:"large",icon:e.jsx(me,{}),children:"保存规则"})]}),width:1200,centered:!0,destroyOnHidden:!0,style:{maxHeight:"90vh",top:0},styles:{body:{padding:"20px",maxHeight:"calc(90vh - 140px)",overflowY:"auto",overflowX:"hidden"},header:{borderBottom:"1px solid #f0f0f0",paddingBottom:"16px"},content:{maxHeight:"90vh",display:"flex",flexDirection:"column"}},children:[m.length>0&&e.jsx(P,{message:"验证错误",description:e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:m.map((y,z)=>e.jsx("li",{children:y},z))}),type:"error",showIcon:!0,style:{marginBottom:16},closable:!0}),e.jsx(ke,{activeKey:X,onChange:re,items:o,size:"large"})]})},{Title:mt,Text:yt}=pe,{Search:Ea}=B,{Option:At}=O,{TextArea:gt}=B,lr=()=>{const[h,v]=b.useState([]),[M,c]=b.useState(!1),[C,V]=b.useState(""),[m,S]=b.useState(),[G,J]=b.useState({current:1,pageSize:10,total:0}),[D,_]=b.useState(!1),[k,q]=b.useState(null),[X,N]=b.useState(!1),[$,L]=b.useState(!1),[s]=u.useForm(),[t,l]=b.useState(!1),[r,n]=b.useState(!1),[i,x]=b.useState(!1),[j,H]=b.useState(null),[Q,A]=b.useState(!1),[re,U]=b.useState(!1),[le,te]=b.useState(!1),[ae,o]=b.useState(!1),[y,z]=b.useState(!1),[F,it]=b.useState("visual"),[Ye,Je]=b.useState(),[Xe,qe]=b.useState([]),[Mt,Et]=b.useState(""),[ft,Be]=b.useState([]),Ze=a=>!a||!a.type?(console.error("条件缺少 type 字段"),!1):a.type==="simple"?a.and||a.or||a.expression?(console.error("simple 类型条件不应包含 and、or 或 expression 字段",a),!1):!0:a.type==="and"?!a.and||!Array.isArray(a.and)?(console.error("and 类型条件必须包含 and 数组",a),!1):a.field||a.operator||a.value||a.expression?(console.error("and 类型条件不应包含 field、operator、value 或 expression 字段",a),!1):a.and.every(Ze):a.type==="or"?!a.or||!Array.isArray(a.or)?(console.error("or 类型条件必须包含 or 数组",a),!1):a.field||a.operator||a.value||a.expression?(console.error("or 类型条件不应包含 field、operator、value 或 expression 字段",a),!1):a.or.every(Ze):a.type==="expression"?a.expression?a.field||a.operator||a.value||a.and||a.or?(console.error("expression 类型条件不应包含其他字段",a),!1):!0:(console.error("expression 类型条件必须包含 expression 字段",a),!1):(console.error("未知的条件类型:",a.type),!1),Oe=async()=>{c(!0);try{const a={page:G.current,page_size:G.pageSize,search:C||void 0,enabled:m},d=await ve.getRules(a);v(d.data),J(f=>({...f,total:d.pagination.total}))}catch(a){Y.error("获取规则列表失败："+(a.message||"未知错误"))}finally{c(!1)}},Pt=async a=>{try{a.enabled?(await ve.disableRule(a.id),Y.success("规则已禁用")):(await ve.enableRule(a.id),Y.success("规则已启用")),await new Promise(d=>setTimeout(d,300)),await Oe()}catch(d){Y.error("操作失败："+(d.message||"未知错误"))}},Lt=async a=>{try{await ve.deleteRule(a.id),Y.success("删除规则成功"),await new Promise(d=>setTimeout(d,300)),await Oe()}catch(d){Y.error("删除规则失败："+(d.message||"未知错误"))}},Gt=a=>{q(a),_(!0)},Yt=()=>{x(!0)},Xt=a=>{if(H(a),x(!1),a.type==="complex")switch(a.category){case"geospatial":U(!0);break;case"vector":te(!0);break;case"vector_generic":o(!0);break;case"visual":z(!0);break;default:A(!0);break}else nt()},nt=a=>{if(L(!!a),a)q(a),s.setFieldsValue({name:a.name,description:a.description,enabled:a.enabled,priority:a.priority,tags:a.tags?Object.entries(a.tags).map(([d,f])=>({key:d,value:f})):[]}),Je(a.conditions),qe(a.actions||[]),s.setFieldsValue({conditions:JSON.stringify(a.conditions,null,2),actions:JSON.stringify(a.actions,null,2)});else{s.resetFields();const d={type:"simple",field:"key",operator:"eq",value:"temperature"},f=[{type:"alert",config:{level:"warning",message:"告警信息"}}];s.setFieldsValue({enabled:!0,priority:100,conditions:JSON.stringify(d,null,2),actions:JSON.stringify(f,null,2)}),Je(d),qe(f)}it("visual"),Be([]),Ne(),N(!0)},Ne=()=>{try{const a=s.getFieldsValue();let d,f;F==="visual"?(d=Ye,f=Xe):(d=a.conditions?JSON.parse(a.conditions):void 0,f=a.actions?JSON.parse(a.actions):[]);const K={name:a.name||"",description:a.description||"",enabled:a.enabled??!0,priority:a.priority||100,conditions:d,actions:f,tags:a.tags?.reduce((we,ue)=>(ue.key&&ue.value&&(we[ue.key]=ue.value),we),{})||{}};Et(JSON.stringify(K,null,2)),Be([])}catch(a){Be([a.message||"JSON格式错误"])}},Zt=()=>{Ne()},Kt=a=>{Je(a),Ne()},Ut=a=>{qe(a),Ne()},Wt=a=>{if(a==="json"&&F==="visual")s.setFieldsValue({conditions:JSON.stringify(Ye,null,2),actions:JSON.stringify(Xe,null,2)});else if(a==="visual"&&F==="json")try{const d=s.getFieldsValue();if(d.conditions){const f=JSON.parse(d.conditions);Je(f)}if(d.actions){const f=JSON.parse(d.actions);qe(f)}Be([])}catch{Y.error("JSON格式错误，无法切换到可视化模式");return}it(a),setTimeout(Ne,0)},Qt=async()=>{try{const a=await s.validateFields();let d,f;if(F==="visual"){if(d=Ye,f=Xe,d&&!Ze(d)){Y.error("条件数据结构不正确，无法保存");return}}else if(d=JSON.parse(a.conditions),f=JSON.parse(a.actions),d&&!Ze(d)){Y.error("条件数据结构不正确，无法保存");return}if(!d){Y.error("请配置触发条件");return}if(!f||f.length===0){Y.error("请配置至少一个动作");return}const K=a.tags?.reduce((ue,Re)=>(Re.key&&Re.value&&(ue[Re.key]=Re.value),ue),{}),we={name:a.name,description:a.description,enabled:a.enabled,priority:a.priority,conditions:d,actions:f,tags:K};$&&k?(await ve.updateRule(k.id,{...we,version:k.version}),Y.success("规则更新成功")):(await ve.createRule(we),Y.success("规则创建成功")),N(!1),await new Promise(ue=>setTimeout(ue,500)),await Oe()}catch(a){if(console.error("保存规则失败:",a),a instanceof SyntaxError)Y.error("JSON 格式错误，请检查条件和动作配置");else if(a.response){const d=a.response.data?.message||a.response.data?.error||a.response.statusText||"服务器错误";Y.error(`保存规则失败: ${d} (状态码: ${a.response.status})`),console.error("API错误响应:",{status:a.response.status,data:a.response.data,headers:a.response.headers})}else a.request?(Y.error("网络请求失败，请检查网络连接"),console.error("网络请求失败:",a.request)):(Y.error("保存规则失败："+(a.message||"未知错误")),console.error("其他错误:",a.message))}},ea=a=>{const d={...a,name:`${a.name} (副本)`,id:""};Ue(d)?St(d):nt(d)},ta=a=>{const d=a.rule;s.setFieldsValue({name:d.name,description:d.description,enabled:d.enabled??!0,priority:d.priority||100,tags:d.tags?Object.entries(d.tags).map(([f,K])=>({key:f,value:K})):[]}),Je(d.conditions),qe(d.actions||[]),s.setFieldsValue({conditions:JSON.stringify(d.conditions,null,2),actions:JSON.stringify(d.actions,null,2)}),it("visual"),Be([]),L(!1),q(null),setTimeout(Ne,0),N(!0),Y.success(`已加载模板：${a.name}`)},aa=async a=>{try{$&&k?(await ve.updateRule(k.id,{...a,version:k.version}),Y.success("复合数据规则更新成功")):(await ve.createRule(a),Y.success("复合数据规则创建成功")),A(!1),H(null),await new Promise(d=>setTimeout(d,500)),await Oe()}catch(d){if(console.error("保存复合数据规则失败:",d),d.response){const f=d.response.data?.message||d.response.data?.error||d.response.statusText||"服务器错误";Y.error(`保存复合数据规则失败: ${f} (状态码: ${d.response.status})`)}else d.request?Y.error("网络请求失败，请检查网络连接"):Y.error("保存复合数据规则失败："+(d.message||"未知错误"))}},ra=()=>{A(!1),H(null),q(null),L(!1)},Ke=async a=>{try{$&&k?(await ve.updateRule(k.id,{...a,version:k.version}),Y.success("复合数据规则更新成功")):(await ve.createRule(a),Y.success("复合数据规则创建成功")),U(!1),te(!1),o(!1),z(!1),A(!1),H(null),await new Promise(d=>setTimeout(d,500)),await Oe()}catch(d){if(console.error("保存专门化规则失败:",d),d.response){const f=d.response.data?.message||d.response.data?.error||d.response.statusText||"服务器错误";Y.error(`保存规则失败: ${f} (状态码: ${d.response.status})`)}else d.request?Y.error("网络请求失败，请检查网络连接"):Y.error("保存规则失败："+(d.message||"未知错误"))}},bt=()=>{console.log("handleSpecializedRuleCancel 被调用，当前状态:"),console.log("- visualEditorVisible:",y),console.log("- geospatialEditorVisible:",re),console.log("- vector3dEditorVisible:",le),U(!1),te(!1),o(!1),z(!1),A(!1),H(null),q(null),L(!1),console.log("已设置所有编辑器为不可见")},Ue=a=>{const d=a.data_type,f=a.tags?a.tags.data_type||a.tags.data_category:null,K=d||f;if(K&&["geospatial","vector","visual","array","matrix","timeseries","location","vector3d","color","gps","vector_generic","mixed"].includes(K))return console.log(`检测到复合数据规则 [${a.name}]: 数据类型标记 = ${K}`),!0;const ue=["geo_transform","geo_aggregate","geo_filter","geospatial_transform","vector_transform","vector_aggregate","vector_filter","color_transform","color_aggregate","color_filter","visual_transform","array_transform","array_aggregate","array_filter","matrix_transform","matrix_aggregate","matrix_filter","timeseries_transform","timeseries_aggregate","timeseries_filter"];if(a.actions&&a.actions.some(ze=>ue.includes(ze.type))){const ze=a.actions.find(ye=>ue.includes(ye.type))?.type;return console.log(`检测到复合数据规则 [${a.name}]: 复合动作类型 = ${ze}`),!0}const Re=["latitude","longitude","altitude","lat","lng","coord","location","x","y","z","magnitude","direction","velocity","acceleration","r","g","b","hue","saturation","lightness","alpha","rgb","hsl","rows","cols","size","length","dimensions","matrix","array","duration","data_points","timestamps","series","trend"];if(a.conditions){const ze=ye=>!!(ye.field&&Re.includes(ye.field)||ye.and&&ye.and.some(ze)||ye.or&&ye.or.some(ze));if(ze(a.conditions)){const ye=We(a.conditions);return console.log(`检测到复合数据规则 [${a.name}]: 复合字段 = ${ye}`),!0}}return!1},We=a=>{const d=["latitude","longitude","altitude","lat","lng","coord","location","x","y","z","magnitude","direction","velocity","acceleration","r","g","b","hue","saturation","lightness","alpha","rgb","hsl","rows","cols","size","length","dimensions","matrix","array","duration","data_points","timestamps","series","trend"];if(a.field&&d.includes(a.field))return a.field;if(a.and)for(const f of a.and){const K=We(f);if(K)return K}if(a.or)for(const f of a.or){const K=We(f);if(K)return K}return"未知复合字段"},ot=a=>{const d=a.data_type;if(d){console.log(`规则 [${a.name}] 检测到 data_type 字段:`,d);const K={location:"geospatial",vector3d:"vector",vector_generic:"vector_generic",gps:"geospatial",color:"visual",array:"array",matrix:"matrix",timeseries:"timeseries",mixed:"mixed"}[d]||d;return console.log(`数据类型 ${d} 映射到类别:`,K),K}if(a.tags&&a.tags.data_category)return a.tags.data_category;if(a.actions&&a.actions.length>0){const f=a.actions[0].type;if(f.includes("geo"))return"geospatial";if(f.includes("vector"))return"vector";if(f.includes("color")||f.includes("visual"))return"visual";if(f.includes("array"))return"array";if(f.includes("matrix"))return"matrix";if(f.includes("timeseries")||f.includes("time"))return"timeseries"}if(a.conditions){const f=We(a.conditions);if(["latitude","longitude","altitude","lat","lng","coord","location"].includes(f))return"geospatial";if(["x","y","z","magnitude","direction","velocity","acceleration"].includes(f))return"vector";if(["r","g","b","hue","saturation","lightness","alpha","rgb","hsl"].includes(f))return"visual";if(["rows","cols","dimensions","matrix"].includes(f))return"matrix";if(["size","length","array"].includes(f))return"array";if(["duration","data_points","timestamps","series","trend"].includes(f))return"timeseries"}return"geospatial"},ct=a=>({geospatial:"GPS位置数据",vector:"向量数据",visual:"颜色数据",array:"数组数据",matrix:"矩阵数据",timeseries:"时间序列数据"})[a]||"复合数据",_t=a=>({geospatial:e.jsx(zt,{}),vector:e.jsx(ut,{}),visual:e.jsx(Ie,{}),array:e.jsx(de,{}),matrix:e.jsx(be,{}),timeseries:e.jsx(jt,{})})[a]||e.jsx(ut,{}),wt=a=>({geospatial:"#52c41a",vector:"#1890ff",visual:"#fa541c",array:"#722ed1",matrix:"#eb2f96",timeseries:"#13c2c2"})[a]||"#722ed1",St=a=>{if(Ue(a)){q(a),L(!0);let d=ot(a),f=ct(d),K=a.tags?.data_type||`${d}_data`;const we={type:"complex",category:d,key:K,name:f,icon:_t(d),description:`检测到的${f}规则`,examples:[],color:wt(d)};switch(H(we),console.log(`为规则 [${a.name}] 选择编辑器，数据类别:`,d),d){case"geospatial":console.log("使用地理数据专门编辑器"),U(!0);break;case"vector":console.log("使用3D向量专门编辑器"),te(!0);break;case"vector_generic":console.log("使用通用向量专门编辑器"),o(!0);break;case"visual":console.log("使用颜色数据专门编辑器"),z(!0);break;case"array":case"matrix":case"timeseries":case"mixed":console.log("使用复合数据通用编辑器"),A(!0);break;default:console.log("使用复合数据通用编辑器（默认）"),A(!0);break}}else nt(a)},Ct=a=>a>=150?"red":a>=100?"orange":a>=50?"blue":"green",Tt=a=>{const d={alert:"red",transform:"blue",filter:"purple",aggregate:"cyan",forward:"green"};return e.jsx(g,{color:d[a]||"default",children:a})},la=a=>{const{type:d,config:f}=a;switch(d){case"aggregate":return`窗口大小: ${f.size||f.window_size||"N/A"} 个数据点
聚合函数: ${Array.isArray(f.functions)?f.functions.join(", "):"N/A"}
分组字段: ${Array.isArray(f.group_by)?f.group_by.join(", "):"N/A"}
输出字段: ${f.output_key||"N/A"}
转发结果: ${f.forward?"是":"否"}`;case"transform":const K=f.transforms&&f.transforms[0];return`目标字段: ${f.field||"N/A"}
缩放因子: ${f.scale_factor||K?.scale_factor||"N/A"}
偏移量: ${f.offset||K?.offset||"N/A"}
精度: ${f.precision||K?.precision||"N/A"}
转换类型: ${K?.type||"N/A"}
添加标签: ${f.add_tags?JSON.stringify(f.add_tags):"N/A"}`;case"alert":return`告警级别: ${f.level||"N/A"}
告警消息: ${f.message||"N/A"}
限流时间: ${f.throttle||"N/A"}
通知渠道: ${Array.isArray(f.channels)?f.channels.join(", "):"N/A"}`;case"filter":return`过滤类型: ${f.type||"N/A"}
最小值: ${f.min!==void 0?f.min:"N/A"}
最大值: ${f.max!==void 0?f.max:"N/A"}
匹配动作: ${f.drop_on_match?"丢弃":"通过"}
速率限制: ${f.rate||"N/A"}
时间窗口: ${f.window||"N/A"}`;case"forward":return`转发目标: ${f.target_type||"N/A"}
URL地址: ${f.url||"N/A"}
HTTP方法: ${f.method||"N/A"}
MQTT代理: ${f.broker||"N/A"}
主题模板: ${f.topic||"N/A"}
文件路径: ${f.path||"N/A"}
批处理大小: ${f.batch_size||"N/A"}
超时时间: ${f.timeout||"N/A"}`;default:return JSON.stringify(f,null,2)}},sa=[{title:"规则名称",dataIndex:"name",key:"name",sorter:(a,d)=>a.name.localeCompare(d.name),render:(a,d)=>{const f=Ue(d),K=f?ot(d):null;return e.jsxs("div",{children:[e.jsxs("div",{children:[e.jsx("strong",{children:a}),f&&e.jsx(g,{size:"small",color:wt(K),icon:_t(K),style:{marginLeft:8},children:ct(K)})]}),e.jsx(yt,{type:"secondary",style:{fontSize:12},children:d.description})]})}},{title:"优先级",dataIndex:"priority",key:"priority",width:100,render:a=>e.jsx(g,{color:Ct(a),children:a}),sorter:(a,d)=>a.priority!==d.priority?d.priority-a.priority:a.name.localeCompare(d.name),defaultSortOrder:"ascend"},{title:"状态",dataIndex:"enabled",key:"enabled",width:100,render:(a,d)=>e.jsx(he,{checked:a,onChange:()=>Pt(d),checkedChildren:"启用",unCheckedChildren:"禁用"}),filters:[{text:"已启用",value:!0},{text:"已禁用",value:!1}]},{title:"动作类型",dataIndex:"actions",key:"actions",width:150,render:a=>e.jsx(p,{wrap:!0,children:a&&a.length>0?e.jsxs(e.Fragment,{children:[a.slice(0,2).map((d,f)=>e.jsx(oe,{title:la(d),overlayStyle:{maxWidth:"400px"},children:Tt(d.type)},f)),a.length>2&&e.jsxs(g,{children:["+",a.length-2]})]}):e.jsx(g,{color:"default",children:"无动作"})})},{title:"更新时间",dataIndex:"updated_at",key:"updated_at",width:180,render:a=>new Date(a).toLocaleString()},{title:"操作",key:"actions",width:200,render:(a,d)=>e.jsxs(p,{children:[e.jsx(oe,{title:"查看详情",children:e.jsx(E,{type:"link",icon:e.jsx(Ie,{}),onClick:()=>Gt(d)})}),e.jsx(oe,{title:Ue(d)?`编辑复合规则 (${ct(ot(d))})`:"编辑规则",children:e.jsx(E,{type:"link",icon:e.jsx(Ve,{}),onClick:()=>St(d)})}),e.jsx(oe,{title:"复制",children:e.jsx(E,{type:"link",icon:e.jsx(va,{}),onClick:()=>ea(d)})}),e.jsx(ja,{title:"确定要删除这个规则吗？",description:"删除后无法恢复",onConfirm:()=>Lt(d),okText:"确定",cancelText:"取消",children:e.jsx(oe,{title:"删除",children:e.jsx(E,{type:"link",danger:!0,icon:e.jsx(Ee,{})})})})]})}],ia=(a,d)=>{J(f=>({...f,current:a.current||1,pageSize:a.pageSize||10})),d.enabled!==void 0&&S(d.enabled?.[0])};return b.useEffect(()=>{Oe()},[G.current,G.pageSize,C,m]),e.jsxs("div",{children:[e.jsx(mt,{level:2,children:"规则管理"}),e.jsx(I,{style:{marginBottom:16},children:e.jsxs(Z,{gutter:16,align:"middle",children:[e.jsx(R,{flex:"auto",children:e.jsxs(p,{children:[e.jsx(Ea,{placeholder:"搜索规则名称或描述",allowClear:!0,style:{width:300},onSearch:V,onClear:()=>V("")}),e.jsxs(O,{placeholder:"状态筛选",allowClear:!0,style:{width:120},value:m,onChange:S,children:[e.jsx(At,{value:!0,children:"已启用"}),e.jsx(At,{value:!1,children:"已禁用"})]})]})}),e.jsx(R,{children:e.jsxs(p,{children:[e.jsx(E,{icon:e.jsx(Ce,{}),onClick:()=>l(!0),children:"帮助文档"}),e.jsx(E,{icon:e.jsx(jt,{}),children:"规则测试"}),e.jsx(E,{icon:e.jsx(be,{}),onClick:()=>n(!0),children:"模板库"}),e.jsx(E,{type:"primary",icon:e.jsx($e,{}),onClick:Yt,children:"创建规则"})]})})]})}),e.jsx(I,{children:e.jsx(Vt,{columns:sa,dataSource:h,rowKey:"id",loading:M,pagination:{current:G.current,pageSize:G.pageSize,total:G.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:(a,d)=>`第 ${d[0]}-${d[1]} 条，共 ${a} 条`},onChange:ia})}),e.jsx($t,{title:"规则详情",width:800,open:D,onClose:()=>_(!1),children:k&&e.jsx(ke,{defaultActiveKey:"1",items:[{key:"1",label:"基本信息",children:e.jsxs(je,{title:"基本信息",bordered:!0,children:[e.jsx(je.Item,{label:"规则名称",children:k.name}),e.jsx(je.Item,{label:"描述",span:2,children:k.description}),e.jsx(je.Item,{label:"状态",children:k.enabled?e.jsx(g,{color:"green",icon:e.jsx(me,{}),children:"已启用"}):e.jsx(g,{color:"red",icon:e.jsx(ya,{}),children:"已禁用"})}),e.jsx(je.Item,{label:"优先级",children:e.jsx(g,{color:Ct(k.priority),children:k.priority})}),e.jsxs(je.Item,{label:"版本",children:["v",k.version]}),e.jsx(je.Item,{label:"创建时间",children:new Date(k.created_at).toLocaleString()}),e.jsx(je.Item,{label:"更新时间",children:new Date(k.updated_at).toLocaleString()}),e.jsx(je.Item,{label:"标签",span:2,children:k.tags&&Object.entries(k.tags).map(([a,d])=>e.jsxs(g,{children:[a,": ",d]},a))})]})},{key:"2",label:"条件配置",children:e.jsxs("div",{children:[e.jsx(mt,{level:4,children:"触发条件"}),e.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4},children:JSON.stringify(k.conditions,null,2)})]})},{key:"3",label:"动作配置",children:e.jsxs("div",{children:[e.jsx(mt,{level:4,children:"执行动作"}),k.actions&&k.actions.length>0?k.actions.map((a,d)=>e.jsxs(I,{size:"small",style:{marginBottom:8},children:[e.jsxs(p,{children:[Tt(a.type),e.jsxs(yt,{strong:!0,children:["动作 ",d+1]})]}),e.jsx("pre",{style:{background:"#f5f5f5",padding:8,marginTop:8,borderRadius:4},children:JSON.stringify(a.config,null,2)})]},d)):e.jsx(yt,{type:"secondary",children:"该规则暂无配置动作"})]})}]})}),e.jsx(Te,{title:e.jsxs(p,{children:[$?"编辑规则":"创建规则",e.jsx(E,{type:"link",icon:e.jsx(zt,{}),onClick:()=>l(!0),size:"small",children:"帮助"})]}),open:X,onOk:Qt,onCancel:()=>N(!1),width:1200,okText:"保存",cancelText:"取消",styles:{body:{maxHeight:"70vh",overflowY:"auto"}},children:e.jsxs(Z,{gutter:16,children:[e.jsxs(R,{span:F==="visual"?24:14,children:[e.jsx(I,{size:"small",style:{marginBottom:16},children:e.jsxs(Z,{justify:"space-between",align:"middle",children:[e.jsx(R,{children:e.jsx(ga,{value:F,onChange:Wt,options:[{label:e.jsxs(p,{children:[e.jsx(ut,{}),"可视化编辑"]}),value:"visual"},{label:e.jsxs(p,{children:[e.jsx(de,{}),"JSON编辑"]}),value:"json"}]})}),e.jsx(R,{children:ft.length>0&&e.jsx(P,{message:"配置错误",description:ft.join(", "),type:"error",showIcon:!0})})]})}),e.jsxs(u,{form:s,layout:"vertical",onValuesChange:Zt,children:[e.jsxs(I,{title:"基本信息",size:"small",style:{marginBottom:16},children:[e.jsxs(Z,{gutter:16,children:[e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"规则名称",name:"name",rules:[{required:!0,message:"请输入规则名称"}],children:e.jsx(B,{placeholder:"输入规则名称"})})}),e.jsx(R,{span:12,children:e.jsx(u.Item,{label:"优先级",name:"priority",rules:[{required:!0,message:"请输入优先级"}],children:e.jsx(W,{placeholder:"数值越大优先级越高",style:{width:"100%"},min:1,max:999})})})]}),e.jsx(u.Item,{label:"描述",name:"description",rules:[{required:!0,message:"请输入规则描述"}],children:e.jsx(gt,{rows:2,placeholder:"输入规则描述"})}),e.jsx(u.Item,{label:"启用状态",name:"enabled",valuePropName:"checked",children:e.jsx(he,{checkedChildren:"启用",unCheckedChildren:"禁用"})})]}),F==="visual"?e.jsxs(e.Fragment,{children:[e.jsx(ba,{value:Ye,onChange:Kt}),e.jsx("div",{style:{marginBottom:16}}),e.jsx(wa,{value:Xe,onChange:Ut})]}):e.jsx(e.Fragment,{children:e.jsxs(I,{title:"JSON配置",size:"small",children:[e.jsx(u.Item,{label:"触发条件 (JSON 格式)",name:"conditions",rules:[{required:!0,message:"请输入触发条件"},{validator:(a,d)=>{try{return JSON.parse(d),Promise.resolve()}catch{return Promise.reject(new Error("JSON 格式错误"))}}}],children:e.jsx(gt,{rows:8,placeholder:'{"type": "simple", "field": "key", "operator": "eq", "value": "temperature"}',style:{fontFamily:"monospace"}})}),e.jsx(u.Item,{label:"执行动作 (JSON 格式)",name:"actions",rules:[{required:!0,message:"请输入执行动作"},{validator:(a,d)=>{try{return JSON.parse(d),Promise.resolve()}catch{return Promise.reject(new Error("JSON 格式错误"))}}}],children:e.jsx(gt,{rows:8,placeholder:'[{"type": "alert", "config": {"level": "warning", "message": "告警信息"}}]',style:{fontFamily:"monospace"}})})]})})]})]}),F==="json"&&e.jsx(R,{span:10,children:e.jsx(I,{title:"实时预览",size:"small",style:{position:"sticky",top:0},children:e.jsx("pre",{style:{background:"#f5f5f5",padding:12,borderRadius:4,fontSize:12,lineHeight:1.4,maxHeight:"60vh",overflow:"auto"},children:Mt})})})]})}),e.jsx(fa,{visible:t,onClose:()=>l(!1)}),e.jsx(Ta,{visible:r,onClose:()=>n(!1),onSelect:ta}),e.jsx(za,{visible:i,onTypeSelect:Xt,onCancel:()=>x(!1)}),e.jsx(Aa,{visible:Q,dataType:j,rule:k,onSave:aa,onClose:ra}),e.jsx(Va,{visible:re,rule:k,onSave:Ke,onClose:bt}),e.jsx(Ja,{visible:le,rule:k,mode:$?"edit":"create",onSave:Ke,onClose:()=>te(!1)}),e.jsx(Ba,{visible:ae,rule:k,mode:$?"edit":"create",onSave:Ke,onClose:()=>o(!1)}),e.jsx(Ma,{visible:y,rule:k,onSave:Ke,onClose:bt})]})};export{lr as default};
