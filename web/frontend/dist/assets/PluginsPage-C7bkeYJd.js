import{j as e}from"./index-BEjgWUn2.js";import{a as o,k as i,s as F,u as a,z as P,y as n,a4 as ce,B as g,K as L,v as c,U as X,w as T,V as u,T as Z,j as de,F as Y,I as ee,a5 as ue,a6 as xe,a1 as he,a7 as p,a8 as ge,a9 as je,aa as S,a0 as pe,a2 as fe,N as me,ab as ye,ac as q,H as ve,h as Se,ad as we,ae as ke,o as be,p as Ce}from"./antd-BFy_CllK.js";import{p as k}from"./pluginService-ChNb5F4s.js";import"./vendor-DavUf6mE.js";const{Option:w}=P,{RangePicker:ze}=ce,{Text:Q}=Z,_e=({pluginName:b})=>{const[f,M]=o.useState([]),[C,$]=o.useState(!1),[x,m]=o.useState({current:1,pageSize:20,total:0}),[h,z]=o.useState({level:"",source:"",dateRange:null}),_=async()=>{$(!0);try{const t={page:x.current,page_size:x.pageSize,level:h.level||void 0,source:h.source||void 0,from:h.dateRange?.[0]?.toISOString(),to:h.dateRange?.[1]?.toISOString()},d=await k.getPluginLogs(b,t);M(d.data),m(l=>({...l,total:d.total}))}catch(t){u.error("获取日志失败："+(t.message||"未知错误"))}finally{$(!1)}},j=t=>{switch(t.toLowerCase()){case"error":return e.jsx(n,{color:"red",children:t.toUpperCase()});case"warn":case"warning":return e.jsx(n,{color:"orange",children:t.toUpperCase()});case"info":return e.jsx(n,{color:"blue",children:t.toUpperCase()});case"debug":return e.jsx(n,{color:"default",children:t.toUpperCase()});default:return e.jsx(n,{children:t.toUpperCase()})}},D=[{title:"时间",dataIndex:"timestamp",key:"timestamp",width:180,render:t=>e.jsx(Q,{style:{fontSize:12,fontFamily:"monospace"},children:de(t).format("YYYY-MM-DD HH:mm:ss")})},{title:"级别",dataIndex:"level",key:"level",width:80,render:t=>j(t)},{title:"来源",dataIndex:"source",key:"source",width:120,render:t=>e.jsx(n,{color:"geekblue",children:t})},{title:"消息",dataIndex:"message",key:"message",render:t=>e.jsx(Q,{style:{fontFamily:"monospace",fontSize:12,wordBreak:"break-all"},children:t})}],A=t=>{m(d=>({...d,current:t.current||1,pageSize:t.pageSize||20}))},I=(t,d)=>{z(l=>({...l,[t]:d})),m(l=>({...l,current:1}))};return o.useEffect(()=>{_()},[x.current,x.pageSize,h]),e.jsxs(i,{title:e.jsxs(T,{children:[e.jsxs("span",{children:["插件日志 - ",b]}),e.jsxs(n,{color:"blue",children:[f.length," 条日志"]})]}),extra:e.jsx(g,{type:"primary",size:"small",icon:e.jsx(L,{}),onClick:_,loading:C,children:"刷新"}),children:[e.jsxs(F,{gutter:16,style:{marginBottom:16},children:[e.jsx(a,{xs:24,sm:6,md:4,children:e.jsxs(P,{placeholder:"日志级别",allowClear:!0,style:{width:"100%"},value:h.level,onChange:t=>I("level",t),children:[e.jsx(w,{value:"error",children:e.jsx(n,{color:"red",children:"ERROR"})}),e.jsx(w,{value:"warn",children:e.jsx(n,{color:"orange",children:"WARN"})}),e.jsx(w,{value:"info",children:e.jsx(n,{color:"blue",children:"INFO"})}),e.jsx(w,{value:"debug",children:e.jsx(n,{color:"default",children:"DEBUG"})})]})}),e.jsx(a,{xs:24,sm:6,md:4,children:e.jsxs(P,{placeholder:"日志来源",allowClear:!0,style:{width:"100%"},value:h.source,onChange:t=>I("source",t),children:[e.jsx(w,{value:b,children:b}),e.jsx(w,{value:"system",children:"系统"}),e.jsx(w,{value:"gateway",children:"网关"})]})}),e.jsx(a,{xs:24,sm:12,md:8,children:e.jsx(ze,{style:{width:"100%"},value:h.dateRange,onChange:t=>I("dateRange",t),showTime:!0,format:"YYYY-MM-DD HH:mm:ss",placeholder:["开始时间","结束时间"]})}),e.jsx(a,{xs:24,sm:12,md:4,children:e.jsx(g,{icon:e.jsx(L,{}),onClick:_,loading:C,style:{width:"100%"},children:"刷新"})}),e.jsx(a,{xs:24,sm:12,md:4,children:e.jsx(g,{type:"default",style:{width:"100%"},onClick:()=>{z({level:"",source:"",dateRange:null}),m(t=>({...t,current:1}))},children:"清空筛选"})})]}),f.length>0&&e.jsxs(F,{gutter:16,style:{marginBottom:16},children:[e.jsx(a,{span:6,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"总日志数",value:x.total,valueStyle:{fontSize:"16px"}})})}),e.jsx(a,{span:6,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"错误日志",value:f.filter(t=>t.level==="error").length,valueStyle:{color:"#f5222d",fontSize:"16px"}})})}),e.jsx(a,{span:6,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"警告日志",value:f.filter(t=>t.level==="warn"||t.level==="warning").length,valueStyle:{color:"#faad14",fontSize:"16px"}})})}),e.jsx(a,{span:6,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"信息日志",value:f.filter(t=>t.level==="info").length,valueStyle:{color:"#1890ff",fontSize:"16px"}})})})]}),e.jsx(X,{columns:D,dataSource:f,rowKey:"id",loading:C,size:"small",pagination:{current:x.current,pageSize:x.pageSize,total:x.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:(t,d)=>`第 ${d[0]}-${d[1]} 条，共 ${t} 条`,pageSizeOptions:["10","20","50","100"]},onChange:A,scroll:{y:400},rowClassName:t=>{switch(t.level.toLowerCase()){case"error":return"log-row-error";case"warn":case"warning":return"log-row-warning";case"debug":return"log-row-debug";default:return""}}}),e.jsx("style",{jsx:!0,global:!0,children:`
        .log-row-error {
          background-color: #fff2f0;
          border-left: 3px solid #f5222d;
        }
        .log-row-warning {
          background-color: #fffbe6;
          border-left: 3px solid #faad14;
        }
        .log-row-debug {
          background-color: #f6f6f6;
          border-left: 3px solid #d9d9d9;
        }
        .log-row-error:hover,
        .log-row-warning:hover,
        .log-row-debug:hover {
          background-color: #e6f7ff;
        }
      `})]})},{Title:G,Text:W}=Z,{Search:Ie}=ee,{Option:O}=P,Oe=()=>{const[b,f]=o.useState([]),[M,C]=o.useState(!1),[$,x]=o.useState(""),[m,h]=o.useState(""),[z,_]=o.useState(""),[j,D]=o.useState({current:1,pageSize:10,total:0}),[A,I]=o.useState(!1),[t,d]=o.useState(null),[l,V]=o.useState(null),[te,B]=o.useState(!1),[N]=Y.useForm(),R=async()=>{C(!0);try{const s={page:j.current,page_size:j.pageSize,search:$||void 0,type:m||void 0,status:z||void 0},r=await k.getPlugins(s);console.log(`📊 获取到 ${r.data?.length||0} 个插件:`,r.data?.map(v=>`${v.name}(${v.type})`).join(", "));const y=[...r.data||[]].sort((v,J)=>v.status==="running"&&J.status!=="running"?-1:v.status!=="running"&&J.status==="running"?1:v.name.localeCompare(J.name));f(y),D(v=>({...v,total:r.pagination.total}))}catch(s){u.error("获取插件列表失败："+(s.message||"未知错误"))}finally{C(!1)}},se=async s=>{try{console.log("正在获取插件统计:",s);const r=await k.getPluginStats(s);console.log("插件统计数据:",r),V(r)}catch(r){console.error("获取插件统计失败:",r),u.error("获取插件统计失败："+(r.message||"未知错误")),V({plugin_id:0,data_points_total:0,data_points_hour:0,errors_total:0,errors_hour:0,uptime_seconds:0,average_latency:0,memory_usage:0,cpu_usage:0,last_update:new Date().toISOString()})}},U=async(s,r)=>{try{const y=await k.executePluginAction(s.name,r);y.success?(u.success(`${E(r)}成功`),await R()):u.error(y.message||`${E(r)}失败`)}catch(y){u.error(`${E(r)}失败：`+(y.message||"未知错误"))}},re=async s=>{try{await k.deletePlugin(s.name),u.success("删除插件成功"),await R()}catch(r){u.error("删除插件失败："+(r.message||"未知错误"))}},le=async s=>{d(s),I(!0),await se(s.name)},ae=async s=>{try{const r=await k.getPluginConfig(s.name);d(s),N.setFieldsValue({config:JSON.stringify(r,null,2)}),B(!0)}catch(r){u.error("获取插件配置失败："+(r.message||"未知错误"))}},ne=async()=>{if(t)try{const s=await N.validateFields(),r=JSON.parse(s.config);await k.updatePluginConfig(t.name,r),u.success("配置保存成功"),B(!1),await R()}catch(s){s instanceof SyntaxError?u.error("配置格式错误，请检查 JSON 格式"):u.error("保存配置失败："+(s.message||"未知错误"))}},E=s=>{switch(s){case"start":return"启动";case"stop":return"停止";case"restart":return"重启";default:return"操作"}},H=s=>{switch(s){case"running":return e.jsx(n,{color:"green",icon:e.jsx(Ce,{}),children:"运行中"});case"stopped":return e.jsx(n,{color:"default",icon:e.jsx(q,{}),children:"已停止"});case"error":return e.jsx(n,{color:"red",icon:e.jsx(be,{}),children:"错误"});default:return e.jsx(n,{color:"default",children:s})}},K=s=>{switch(s){case"adapter":return e.jsx(n,{color:"blue",children:"适配器"});case"sink":return e.jsx(n,{color:"purple",children:"连接器"});default:return e.jsx(n,{children:s})}},oe=[{title:"插件名称",dataIndex:"name",key:"name",render:(s,r)=>e.jsxs(T,{children:[e.jsx(je,{shape:"square",style:{backgroundColor:r.type==="adapter"?"#1890ff":"#722ed1"},children:s.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("div",{children:e.jsx("strong",{children:s})}),e.jsx(W,{type:"secondary",style:{fontSize:12},children:r.description||"无描述"})]})]})},{title:"类型",dataIndex:"type",key:"type",render:s=>K(s),filters:[{text:"适配器",value:"adapter"},{text:"连接器",value:"sink"}]},{title:"版本",dataIndex:"version",key:"version"},{title:"状态",dataIndex:"status",key:"status",render:(s,r)=>e.jsxs(T,{children:[H(s),r.error_count&&r.error_count>0&&e.jsx(S,{title:`错误次数: ${r.error_count}`,children:e.jsx(pe,{count:r.error_count,size:"small",children:e.jsx(fe,{style:{color:"#ff4d4f"}})})})]}),filters:[{text:"运行中",value:"running"},{text:"已停止",value:"stopped"},{text:"错误",value:"error"}]},{title:"启用状态",dataIndex:"enabled",key:"enabled",render:s=>e.jsx(me,{checked:s,disabled:!0,size:"small"})},{title:"端口",dataIndex:"port",key:"port",render:s=>s||"-"},{title:"操作",key:"actions",width:200,render:(s,r)=>e.jsxs(T,{children:[e.jsx(S,{title:"查看详情",children:e.jsx(g,{type:"link",icon:e.jsx(ye,{}),onClick:()=>le(r)})}),r.status==="running"?e.jsx(S,{title:"停止",children:e.jsx(g,{type:"link",icon:e.jsx(q,{}),onClick:()=>U(r,"stop")})}):e.jsx(S,{title:"启动",children:e.jsx(g,{type:"link",icon:e.jsx(ve,{}),onClick:()=>U(r,"start")})}),e.jsx(S,{title:"重启",children:e.jsx(g,{type:"link",icon:e.jsx(L,{}),onClick:()=>U(r,"restart")})}),e.jsx(S,{title:"配置",children:e.jsx(g,{type:"link",icon:e.jsx(Se,{}),onClick:()=>ae(r)})}),e.jsx(we,{title:"确定要删除这个插件吗？",description:"删除后无法恢复",onConfirm:()=>re(r),okText:"确定",cancelText:"取消",children:e.jsx(S,{title:"删除",children:e.jsx(g,{type:"link",danger:!0,icon:e.jsx(ke,{})})})})]})}],ie=(s,r)=>{D(y=>({...y,current:s.current||1,pageSize:s.pageSize||10})),r.type&&h(r.type[0]||""),r.status&&_(r.status[0]||"")};return o.useEffect(()=>{R()},[j.current,j.pageSize,$,m,z]),e.jsxs("div",{children:[e.jsx(G,{level:2,children:"插件管理"}),e.jsx(i,{style:{marginBottom:16},children:e.jsxs(F,{gutter:16,align:"middle",children:[e.jsx(a,{flex:"auto",children:e.jsxs(T,{children:[e.jsx(Ie,{placeholder:"搜索插件名称或描述",allowClear:!0,style:{width:300},onSearch:x,onClear:()=>x("")}),e.jsxs(P,{placeholder:"插件类型",allowClear:!0,style:{width:120},value:m,onChange:h,children:[e.jsx(O,{value:"adapter",children:"适配器"}),e.jsx(O,{value:"sink",children:"连接器"})]}),e.jsxs(P,{placeholder:"状态",allowClear:!0,style:{width:120},value:z,onChange:_,children:[e.jsx(O,{value:"running",children:"运行中"}),e.jsx(O,{value:"stopped",children:"已停止"}),e.jsx(O,{value:"error",children:"错误"})]})]})}),e.jsx(a,{children:e.jsxs(T,{children:[e.jsx(g,{icon:e.jsx(L,{}),onClick:R,children:"刷新"}),e.jsx(g,{type:"primary",icon:e.jsx(ue,{}),children:"添加插件"})]})})]})}),e.jsx(i,{children:e.jsx(X,{columns:oe,dataSource:b,rowKey:"name",loading:M,pagination:{current:j.current,pageSize:j.pageSize,total:j.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:(s,r)=>`第 ${r[0]}-${r[1]} 条，共 ${s} 条`},onChange:ie})}),e.jsx(xe,{title:"插件详情",width:600,open:A,onClose:()=>I(!1),children:t&&e.jsx("div",{children:e.jsx(he,{defaultActiveKey:"1",items:[{key:"1",label:"基本信息",children:e.jsxs(p,{title:"基本信息",bordered:!0,children:[e.jsx(p.Item,{label:"名称",children:t.name}),e.jsx(p.Item,{label:"类型",children:K(t.type)}),e.jsx(p.Item,{label:"版本",children:t.version}),e.jsx(p.Item,{label:"状态",children:H(t.status)}),e.jsx(p.Item,{label:"端口",children:t.port||"无"}),e.jsx(p.Item,{label:"作者",children:t.author||"未知"}),e.jsx(p.Item,{label:"路径",span:3,children:t.path}),e.jsx(p.Item,{label:"描述",span:3,children:t.description||"无描述"})]})},{key:"2",label:"运行统计",children:l?e.jsxs("div",{style:{marginTop:24},children:[e.jsx(G,{level:4,children:"运行统计"}),e.jsxs(F,{gutter:[16,16],children:[e.jsx(a,{xs:24,sm:12,lg:8,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"总数据点",value:l.data_points_total,valueStyle:{color:"#1890ff"},formatter:s=>Number(s).toLocaleString()})})}),e.jsx(a,{xs:24,sm:12,lg:8,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"小时数据点",value:l.data_points_hour,valueStyle:{color:"#52c41a"},formatter:s=>Number(s).toLocaleString()})})}),e.jsx(a,{xs:24,sm:12,lg:8,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"运行时间",value:Math.floor(l.uptime_seconds/3600),suffix:"小时",valueStyle:{color:"#722ed1"}})})}),e.jsx(a,{xs:24,sm:12,lg:8,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"总错误",value:l.errors_total,valueStyle:{color:l.errors_total>0?"#f5222d":"#52c41a"}})})}),e.jsx(a,{xs:24,sm:12,lg:8,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"小时错误",value:l.errors_hour,valueStyle:{color:l.errors_hour>0?"#f5222d":"#52c41a"}})})}),e.jsx(a,{xs:24,sm:12,lg:8,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"平均延迟",value:l.average_latency,precision:2,suffix:"ms",valueStyle:{color:l.average_latency>100?"#f5222d":l.average_latency>50?"#faad14":"#52c41a"}})})}),e.jsx(a,{xs:24,sm:12,lg:8,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"内存使用",value:l.memory_usage/1024/1024,precision:1,suffix:"MB",valueStyle:{color:"#13c2c2"}})})}),e.jsx(a,{xs:24,sm:12,lg:8,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"CPU使用率",value:l.cpu_usage,precision:1,suffix:"%",valueStyle:{color:l.cpu_usage>80?"#f5222d":l.cpu_usage>50?"#faad14":"#52c41a"}})})}),e.jsx(a,{xs:24,sm:12,lg:8,children:e.jsx(i,{size:"small",children:e.jsx(c,{title:"最后更新",value:new Date(l.last_update).toLocaleString(),valueStyle:{color:"#666",fontSize:"14px"}})})})]})]}):e.jsx("div",{style:{padding:"24px",textAlign:"center",color:"#999"},children:e.jsx(W,{type:"secondary",children:"暂无统计数据"})})},{key:"3",label:"插件日志",children:e.jsx(_e,{pluginName:t.name})}]})})}),e.jsx(ge,{title:"插件配置",open:te,onOk:ne,onCancel:()=>B(!1),width:800,okText:"保存",cancelText:"取消",children:t&&e.jsx(Y,{form:N,layout:"vertical",children:e.jsx(Y.Item,{label:"配置 (JSON 格式)",name:"config",rules:[{required:!0,message:"请输入配置"},{validator:(s,r)=>{try{return JSON.parse(r),Promise.resolve()}catch{return Promise.reject(new Error("JSON 格式错误"))}}}],children:e.jsx(ee.TextArea,{rows:20,placeholder:'{"key": "value"}',style:{fontFamily:"monospace"}})})})})]})};export{Oe as default};
