import{j as e,b as Ne,a as Ie}from"./index-BEjgWUn2.js";import{a as l,k as f,E as Te,S as Fe,s as H,u as c,v as _,P as de,T as We,w as Q,x as Ae,y as ee,B as J,h as Ge,z as ue,b as Pe,G as ge,q as Ee,H as Je,J as Ye,K as Ce,N as Xe,O as Ze,Q as qe,l as ve,U as Qe,V as ke,W as Re,X as et,Y as Le,Z as tt,p as Be,_ as st,$ as be,a0 as we,c as Ue,g as at,a1 as nt,a2 as lt,a3 as rt}from"./antd-BFy_CllK.js";import{p as ot}from"./pluginService-ChNb5F4s.js";import{u as De,a as it}from"./useRealTimeData-BUsqV8Uu.js";import{L as ct,i as dt,f as ut}from"./charts-C6rMyrab.js";import{l as pe}from"./lightweightMetricsService-DToKI_sg.js";import{m as pt}from"./monitoringService-oOnaHWPi.js";import"./vendor-DavUf6mE.js";import"./websocketService-DUqqsEfN.js";const ce=["#1890ff","#52c41a","#faad14","#f5222d","#722ed1","#13c2c2","#eb2f96","#fa8c16"],fe=({title:b,series:A,height:C=300,width:j="100%",maxDataPoints:s=50,loading:g=!1,showLegend:z=!0,showGrid:E=!0,xAxisLabel:L="时间",yAxisLabel:y="数值",timeFormat:I="HH:mm:ss",className:D,style:P})=>{const d=l.useRef(null),$=l.useRef(null),O=l.useMemo(()=>!A||A.length===0?null:A.map((i,p)=>{const h=i.data.slice(-s).sort((t,r)=>new Date(t.timestamp).getTime()-new Date(r.timestamp).getTime());return{name:i.name,type:i.type==="area"?"line":i.type||"line",data:h.map(t=>[new Date(t.timestamp).getTime(),t.value]),smooth:i.smooth!==!1,lineStyle:{color:i.color||ce[p%ce.length],width:2},itemStyle:{color:i.color||ce[p%ce.length]},areaStyle:i.type==="area"?{color:new ct(0,0,0,1,[{offset:0,color:i.color||ce[p%ce.length]},{offset:1,color:"transparent"}]),opacity:.3}:void 0,symbol:"circle",symbolSize:4,showSymbol:!1,animation:!0,animationDuration:300}}),[A,s]);return l.useEffect(()=>{if(!d.current)return;$.current=dt(d.current);const i=()=>{$.current?.resize()};return window.addEventListener("resize",i),()=>{window.removeEventListener("resize",i),$.current?.dispose(),$.current=null}},[]),l.useEffect(()=>{if(!$.current||!O)return;const i={title:b?{text:b,left:"center",textStyle:{fontSize:14,fontWeight:"normal"}}:void 0,tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}},formatter:function(p){Array.isArray(p)||(p=[p]);let t=`时间: ${new Date(p[0].axisValue).toLocaleTimeString()}<br/>`;return p.forEach(r=>{const T=r.color,W=typeof r.value[1]=="number"?r.value[1].toFixed(2):r.value[1];t+=`<span style="color:${T}">●</span> ${r.seriesName}: ${W}<br/>`}),t}},legend:z?{data:A.map(p=>p.name),bottom:0,textStyle:{fontSize:12}}:void 0,grid:{left:"3%",right:"4%",bottom:z?"15%":"8%",containLabel:!0,show:E},xAxis:{type:"time",name:L,nameLocation:"middle",nameGap:25,axisLine:{show:!0,lineStyle:{color:"#d9d9d9"}},axisTick:{show:!0},axisLabel:{formatter:function(p){return ut(I,p)},fontSize:10},splitLine:{show:E,lineStyle:{type:"dashed",color:"#f0f0f0"}}},yAxis:{type:"value",name:y,nameLocation:"middle",nameGap:40,scale:!0,axisLine:{show:!0,lineStyle:{color:"#d9d9d9"}},axisTick:{show:!0},axisLabel:{fontSize:10,formatter:function(p){return Math.abs(p)>=1e6?(p/1e6).toFixed(1)+"M":Math.abs(p)>=1e3?(p/1e3).toFixed(1)+"K":p.toFixed(1)}},splitLine:{show:E,lineStyle:{type:"dashed",color:"#f0f0f0"}}},series:O,animation:!0,animationDuration:300,animationEasing:"cubicOut"};$.current.setOption(i,!0)},[O,b,z,E,L,y,I,A]),!A||A.length===0?e.jsx(f,{title:b,className:D,style:{height:C,width:j,...P},children:e.jsx("div",{style:{height:C-100,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(Te,{description:"暂无数据",image:Te.PRESENTED_IMAGE_SIMPLE})})}):e.jsx(f,{title:b,className:D,style:{height:C,width:j,...P},children:e.jsx(Fe,{spinning:g,children:e.jsx("div",{ref:d,style:{height:b?C-100:C-50,width:"100%"}})})})},mt=({height:b=300,showDetailedCharts:A=!0})=>{const{data:C,isConnected:j}=De(),[s,g]=l.useState(null),[z,E]=l.useState(null),[L,y]=l.useState([]),I=l.useCallback(async()=>{try{const[t,r]=await Promise.all([pe.getLightweightMetrics(),D()]);g(t),E(r);const T={timestamp:new Date,cpu:r?.cpu_usage||t.system.cpu_usage_percent,memory:r?.memory_usage||0,disk:r?.disk_usage||t.system.disk_usage_percent||0,cpu_percent:r?.cpu_usage||t.system.cpu_usage_percent,memory_percent:r?.memory_usage||0,disk_percent:r?.disk_usage||t.system.disk_usage_percent||0,memory_used:0,memory_total:0,disk_used:0,disk_total:0,network_rx:r?.network_in_bytes||0,network_tx:r?.network_out_bytes||0,process_count:t.system.goroutine_count||0,thread_count:0,heap_used:t.system.heap_in_use_bytes,heap_total:t.system.heap_size_bytes,heap_usage_percent:t.system.heap_size_bytes>0?t.system.heap_in_use_bytes/t.system.heap_size_bytes*100:0};y(W=>{const K=[...W,T];return K.length>50&&K.splice(0,K.length-50),K}),console.log("✅ SystemMonitor获取系统指标成功:",{metrics:t,systemStatus:r})}catch(t){console.error("❌ SystemMonitor获取指标失败:",t)}},[]),D=l.useCallback(async()=>{try{const t=Ne.getToken();if(!t)throw new Error("No auth token available");const r=await fetch("/api/v1/system/metrics",{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);return(await r.json()).data}catch(t){return console.error("❌ 获取系统指标失败:",t),null}},[]);l.useEffect(()=>{I();const t=setInterval(I,1e4);return()=>clearInterval(t)},[I]);const P=l.useMemo(()=>L&&L.length>0?L.map(t=>({timestamp:new Date(t.timestamp||Date.now()),cpu:t.cpu_percent||0,memory:t.memory_percent||0,disk:t.disk_percent||0})):C.systemMetricsHistory&&C.systemMetricsHistory.length>0?C.systemMetricsHistory.map(t=>({timestamp:new Date(t.timestamp||Date.now()),cpu:t.cpu_percent||0,memory:t.memory_percent||0,disk:t.disk_percent||0})):[],[L,C.systemMetricsHistory]),d=l.useMemo(()=>z&&s?{cpu_percent:z.cpu_usage||s.system.cpu_usage_percent,memory_percent:z.memory_usage||0,disk_percent:z.disk_usage||s.system.disk_usage_percent||0,network_rx:s.system.network_in_bytes||z.network_in_bytes||0,network_tx:s.system.network_out_bytes||z.network_out_bytes||0,network_rx_rate:s.system.network_in_bytes_per_sec||z.network_in_bytes_per_sec||0,network_tx_rate:s.system.network_out_bytes_per_sec||z.network_out_bytes_per_sec||0,process_count:s.system.goroutine_count||0,thread_count:0,heap_used:s.system.heap_in_use_bytes,heap_total:s.system.heap_size_bytes,heap_usage_percent:s.system.heap_size_bytes>0?s.system.heap_in_use_bytes/s.system.heap_size_bytes*100:0,status:s.gateway.status||"unknown",memory_used:0,memory_total:0,disk_used:0,disk_total:0}:C.systemMetrics||null,[z,s,C.systemMetrics]),$=l.useMemo(()=>[{name:"CPU 使用率",data:P.map(t=>({timestamp:t.timestamp,value:t.cpu})),color:"#1890ff",type:"area"}],[P]),O=l.useMemo(()=>[{name:"内存使用率",data:P.map(t=>({timestamp:t.timestamp,value:t.memory})),color:"#52c41a",type:"area"}],[P]),i=l.useMemo(()=>[{name:"磁盘使用率",data:P.map(t=>({timestamp:t.timestamp,value:t.disk})),color:"#faad14",type:"area"}],[P]),p=l.useMemo(()=>[{name:"CPU",data:P.map(t=>({timestamp:t.timestamp,value:t.cpu})),color:"#1890ff",type:"line"},{name:"内存",data:P.map(t=>({timestamp:t.timestamp,value:t.memory})),color:"#52c41a",type:"line"},{name:"磁盘",data:P.map(t=>({timestamp:t.timestamp,value:t.disk})),color:"#faad14",type:"line"}],[P]),h=t=>{if(t===0)return"0 B";const r=1024,T=["B","KB","MB","GB","TB"],W=Math.floor(Math.log(t)/Math.log(r));return Math.round(t/Math.pow(r,W)*100)/100+" "+T[W]};return e.jsxs("div",{children:[e.jsxs(H,{gutter:[16,16],style:{marginBottom:16},children:[e.jsx(c,{xs:24,sm:8,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"连接状态",value:j?"已连接":"未连接",valueStyle:{color:j?"#52c41a":"#f5222d",fontSize:"16px"}})})}),e.jsx(c,{xs:24,sm:8,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"最后更新",value:new Date().toLocaleTimeString(),valueStyle:{fontSize:"16px"}})})}),e.jsx(c,{xs:24,sm:8,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"系统状态",value:d?.status||C.systemStatus?.status||"--",valueStyle:{color:d?.status==="running"||C.systemStatus?.status==="running"?"#52c41a":"#faad14",fontSize:"16px"}})})})]}),d&&e.jsxs(H,{gutter:[16,16],style:{marginBottom:16},children:[e.jsx(c,{xs:24,md:8,children:e.jsx(f,{title:"CPU 使用率",size:"small",children:e.jsx(de,{type:"circle",percent:Math.round(d.cpu_percent||0),status:d.cpu_percent>80?"exception":"active",strokeColor:d.cpu_percent>80?"#ff4d4f":"#1890ff",size:80})})}),e.jsx(c,{xs:24,md:8,children:e.jsxs(f,{title:"内存使用率",size:"small",children:[e.jsx(de,{type:"circle",percent:Math.round(d.memory_percent||0),status:d.memory_percent>85?"exception":"active",strokeColor:d.memory_percent>85?"#ff4d4f":"#52c41a",size:80}),e.jsxs("div",{style:{textAlign:"center",marginTop:8,fontSize:"12px",color:"#666"},children:["系统内存使用率: ",d.memory_percent.toFixed(1),"%"]})]})}),e.jsx(c,{xs:24,md:8,children:e.jsxs(f,{title:"磁盘使用率",size:"small",children:[e.jsx(de,{type:"circle",percent:Math.round(d.disk_percent||0),status:d.disk_percent>90?"exception":"active",strokeColor:d.disk_percent>90?"#ff4d4f":"#faad14",size:80}),e.jsxs("div",{style:{textAlign:"center",marginTop:8,fontSize:"12px",color:"#666"},children:[h(d.disk_used||0)," / ",h(d.disk_total||0)]})]})})]}),A&&e.jsxs(H,{gutter:[16,16],children:[e.jsx(c,{xs:24,children:e.jsx(fe,{title:"系统资源使用趋势",series:p,height:b,yAxisLabel:"使用率 (%)",maxDataPoints:50,loading:!j&&!s})}),e.jsx(c,{xs:24,lg:8,children:e.jsx(fe,{title:"CPU 使用率",series:$,height:b-50,yAxisLabel:"使用率 (%)",maxDataPoints:30,loading:!j&&!s})}),e.jsx(c,{xs:24,lg:8,children:e.jsx(fe,{title:"内存使用率",series:O,height:b-50,yAxisLabel:"使用率 (%)",maxDataPoints:30,loading:!j&&!s})}),e.jsx(c,{xs:24,lg:8,children:e.jsx(fe,{title:"磁盘使用率",series:i,height:b-50,yAxisLabel:"使用率 (%)",maxDataPoints:30,loading:!j&&!s})})]}),d&&e.jsxs(H,{gutter:[16,16],style:{marginTop:16},children:[e.jsx(c,{xs:24,md:8,children:e.jsxs(f,{title:"Go堆内存使用率",size:"small",children:[e.jsx(de,{type:"circle",percent:Math.round(d.heap_usage_percent||0),status:d.heap_usage_percent>80?"exception":"active",strokeColor:d.heap_usage_percent>80?"#ff4d4f":"#722ed1",size:80}),e.jsxs("div",{style:{textAlign:"center",marginTop:8,fontSize:"12px",color:"#666"},children:[h(d.heap_used||0)," / ",h(d.heap_total||0)]})]})}),e.jsx(c,{xs:24,md:16,children:e.jsx(f,{title:"系统与应用指标",size:"small",children:e.jsxs(H,{gutter:[16,16],children:[e.jsx(c,{xs:24,sm:8,lg:4,children:e.jsx(_,{title:"网络接收(累计)",value:d?h(d.network_rx):"--",valueStyle:{fontSize:"12px",color:d.network_rx>0?"#52c41a":"#999"}})}),e.jsx(c,{xs:24,sm:8,lg:4,children:e.jsx(_,{title:"网络发送(累计)",value:d?h(d.network_tx):"--",valueStyle:{fontSize:"12px",color:d.network_tx>0?"#52c41a":"#999"}})}),e.jsx(c,{xs:24,sm:8,lg:4,children:e.jsx(_,{title:"接收速率",value:d&&d.network_rx_rate?`${h(d.network_rx_rate)}/s`:"--",valueStyle:{fontSize:"12px",color:d?.network_rx_rate>0?"#1890ff":"#999"}})}),e.jsx(c,{xs:24,sm:8,lg:4,children:e.jsx(_,{title:"发送速率",value:d&&d.network_tx_rate?`${h(d.network_tx_rate)}/s`:"--",valueStyle:{fontSize:"12px",color:d?.network_tx_rate>0?"#1890ff":"#999"}})}),e.jsx(c,{xs:24,sm:12,lg:6,children:e.jsx(_,{title:"Goroutines",value:d?d.process_count||0:"--",valueStyle:{fontSize:"14px",color:(d?.process_count||0)>0?"#1890ff":"#999"}})}),e.jsx(c,{xs:24,sm:12,lg:6,children:e.jsx(_,{title:"GC暂停时间",value:s&&s.system.gc_pause_ms>=0?`${s.system.gc_pause_ms.toFixed(2)}ms`:"--",valueStyle:{fontSize:"14px",color:s&&s.system.gc_pause_ms>10?"#faad14":s&&s.system.gc_pause_ms>0?"#52c41a":"#999"}})})]})})})]}),s&&e.jsxs(H,{gutter:[16,16],style:{marginTop:16},children:[e.jsx(c,{xs:24,sm:12,lg:6,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"系统版本",value:s.system.version||"--",valueStyle:{fontSize:"14px"}})})}),e.jsx(c,{xs:24,sm:12,lg:6,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"Go版本",value:s.system.go_version||"--",valueStyle:{fontSize:"14px"}})})}),e.jsx(c,{xs:24,sm:12,lg:6,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"堆内存",value:h(s.system.heap_in_use_bytes||0),valueStyle:{fontSize:"14px"}})})}),e.jsx(c,{xs:24,sm:12,lg:6,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"运行时间",value:pe.formatUptime(s.system.uptime_seconds),valueStyle:{fontSize:"14px"}})})})]})]})},{Option:zt}=ue,{Text:te}=We,ze=b=>{if(!b.data)return null;const A=b.data.device_id||"unknown",C=b.data.key||"unknown",j=b.data.data_type||"unknown",s=b.data.value;if(!s||typeof s!="object")return null;let g=[];switch(j){case"location":s.latitude!==void 0&&g.push({key:"latitude",label:"纬度",value:s.latitude,unit:"°",color:"#1890ff"}),s.longitude!==void 0&&g.push({key:"longitude",label:"经度",value:s.longitude,unit:"°",color:"#52c41a"}),s.altitude!==void 0&&g.push({key:"altitude",label:"高度",value:s.altitude,unit:"m",color:"#faad14"}),s.speed!==void 0&&g.push({key:"speed",label:"速度",value:s.speed,unit:"km/h",color:"#f5222d"});break;case"vector3d":s.x!==void 0&&g.push({key:"x",label:"X轴",value:s.x,color:"#1890ff"}),s.y!==void 0&&g.push({key:"y",label:"Y轴",value:s.y,color:"#52c41a"}),s.z!==void 0&&g.push({key:"z",label:"Z轴",value:s.z,color:"#faad14"}),s.magnitude!==void 0&&g.push({key:"magnitude",label:"模长",value:s.magnitude,color:"#722ed1"});break;case"color":s.r!==void 0&&g.push({key:"r",label:"红色",value:s.r,unit:"",color:"#ff4d4f"}),s.g!==void 0&&g.push({key:"g",label:"绿色",value:s.g,unit:"",color:"#52c41a"}),s.b!==void 0&&g.push({key:"b",label:"蓝色",value:s.b,unit:"",color:"#1890ff"}),s.hue!==void 0&&g.push({key:"hue",label:"色相",value:s.hue,unit:"°",color:"#722ed1"}),s.saturation!==void 0&&g.push({key:"saturation",label:"饱和度",value:s.saturation,unit:"%",color:"#fa8c16"}),s.lightness!==void 0&&g.push({key:"lightness",label:"亮度",value:s.lightness,unit:"%",color:"#13c2c2"});break;case"vector":if(s.values&&Array.isArray(s.values)){const z=s.labels||[],E=["#1890ff","#52c41a","#faad14","#f5222d","#722ed1","#fa8c16","#13c2c2","#eb2f96"];s.values.forEach((L,y)=>{const I=z[y]||`分量${y+1}`;g.push({key:`v${y}`,label:I,value:L,unit:s.unit==="mixed"?"":s.unit,color:E[y%E.length]})})}break;case"array":if(s.elements&&Array.isArray(s.elements)){const z=s.labels||[],E=["#1890ff","#52c41a","#faad14","#f5222d","#722ed1","#fa8c16","#13c2c2","#eb2f96"];s.elements.forEach((L,y)=>{const I=z[y]||`元素${y+1}`;g.push({key:`a${y}`,label:I,value:L,unit:s.unit==="mixed"?"":s.unit,color:E[y%E.length]})})}break;default:return null}return g.length===0?null:{deviceId:A,dataKey:C,dataType:j,timestamp:new Date(b.timestamp||Date.now()),components:g,rawData:s}},xt=({data:b,onComponentSelectionChange:A,onDataTypeFilter:C})=>{const[j,s]=l.useState([]),[g,z]=l.useState({}),[E,L]=l.useState(!1),{dataTypes:y,deviceDataKeys:I,totalComponents:D}=l.useMemo(()=>{const i=new Set,p=new Map;let h=0;return b.forEach(t=>{i.add(t.dataType);const r=`${t.deviceId}-${t.dataKey}`;p.has(r)||p.set(r,new Set),t.components.forEach(T=>{p.get(r).add(`${T.key}:${T.label}`),h++})}),{dataTypes:Array.from(i).sort(),deviceDataKeys:Array.from(p.entries()).map(([t,r])=>({deviceKey:t,components:Array.from(r)})),totalComponents:h}},[b]);l.useEffect(()=>{y.length>0&&j.length===0&&s([...y])},[y]),l.useEffect(()=>{C(j)},[j,C]);const P=(i,p,h)=>{z(t=>{const r={...t};return r[i]||(r[i]=[]),h?r[i].includes(p)||(r[i]=[...r[i],p]):r[i]=r[i].filter(T=>T!==p),A(r),r})},d=(i,p)=>{const h=p.every(t=>g[i]?.includes(t.split(":")[0])||!1);z(t=>{const r={...t};return h?r[i]=[]:r[i]=p.map(T=>T.split(":")[0]),A(r),r})},$=i=>({location:"#722ed1",vector3d:"#1890ff",color:"#f5222d",vector:"#52c41a",array:"#faad14"})[i]||"#666",O=i=>({location:"🌍",vector3d:"📐",color:"🎨",vector:"📊",array:"📋"})[i]||"📦";return e.jsxs(f,{title:e.jsxs(Q,{children:[e.jsx("span",{children:"复合数据类型分量选择器"}),e.jsxs(ee,{color:"blue",children:[b.length," 条复合数据"]}),e.jsxs(ee,{color:"green",children:[D," 个分量"]})]}),size:"small",extra:e.jsx(J,{size:"small",icon:e.jsx(Ge,{}),onClick:()=>L(!E),children:E?"简化":"高级"}),children:[e.jsxs("div",{style:{marginBottom:12},children:[e.jsx(te,{strong:!0,children:"数据类型过滤："}),e.jsx("div",{style:{marginTop:4},children:e.jsx(Q,{wrap:!0,children:y.map(i=>e.jsx(Ae,{checked:j.includes(i),onChange:p=>{p.target.checked?s(h=>[...h,i]):s(h=>h.filter(t=>t!==i))},children:e.jsxs(ee,{color:$(i),style:{margin:0},children:[O(i)," ",i]})},i))})})]}),E&&e.jsxs("div",{children:[e.jsx(te,{strong:!0,children:"分量选择："}),e.jsx("div",{style:{marginTop:8,maxHeight:200,overflowY:"auto"},children:I.map(({deviceKey:i,components:p})=>{const[h,t]=i.split("-"),r=g[i]?.length||0;return e.jsxs(f,{size:"small",style:{marginBottom:8},children:[e.jsx("div",{style:{marginBottom:8},children:e.jsxs(Q,{children:[e.jsx(te,{strong:!0,children:h}),e.jsx(te,{type:"secondary",children:"→"}),e.jsx(te,{code:!0,children:t}),e.jsxs(J,{size:"small",type:"text",onClick:()=>d(i,p),children:[r===p.length?"取消全选":"全选","(",r,"/",p.length,")"]})]})}),e.jsx(H,{gutter:[8,4],children:p.map(T=>{const[W,K]=T.split(":"),Z=g[i]?.includes(W)||!1;return e.jsx(c,{children:e.jsx(Ae,{checked:Z,onChange:ae=>P(i,W,ae.target.checked),children:e.jsx(te,{style:{fontSize:"12px"},children:K})})},W)})})]},i)})})]}),e.jsx("div",{style:{marginTop:8,padding:"8px",backgroundColor:"#fafafa",borderRadius:"4px"},children:e.jsxs(Q,{split:e.jsx("span",{style:{color:"#d9d9d9"},children:"|"}),children:[e.jsxs(te,{style:{fontSize:"12px"},children:["数据类型: ",j.length,"/",y.length]}),e.jsxs(te,{style:{fontSize:"12px"},children:["设备组合: ",I.length]}),e.jsxs(te,{style:{fontSize:"12px"},children:["已选分量: ",Object.values(g).reduce((i,p)=>i+p.length,0)]})]})})]})},{Option:se}=ue,ht=({height:b=350,showRawData:A=!0,maxChartPoints:C=100,maxTableRows:j=50,autoRefresh:s=!0,refreshInterval:g=3e3,preferWebSocket:z=!1,enableCompositeDataViewer:E=!0})=>{const{data:L,isConnected:y}=De(),[I,D]=l.useState("all"),[P,d]=l.useState("all"),[$,O]=l.useState(!1),[i,p]=l.useState([]),[h,t]=l.useState(!1),[r,T]=l.useState("api"),[W,K]=l.useState(null),[Z,ae]=l.useState(null),[B,je]=l.useState(!1),[oe,ye]=l.useState([]),[le,Y]=l.useState({}),[ie,_e]=l.useState("combined"),u=l.useCallback(async()=>{try{t(!0),ae(null);const n=await pt.getDataFlowMetrics({time_range:"5m",limit:100});p(n.metrics||[]),K(new Date)}catch(n){const a=n instanceof Error?n.message:"未知错误";ae(a),console.warn("❌ API数据获取失败:",a)}finally{t(!1)}},[]);l.useEffect(()=>{if(!s)return;u();const n=setInterval(u,g);return()=>clearInterval(n)},[s,g,u]);const U=l.useCallback(n=>n.map((a,v)=>{let o="unknown",x=a.last_value;if(typeof a.last_value=="string")try{const S=JSON.parse(a.last_value);S&&typeof S=="object"?(x=S,S.latitude!==void 0&&S.longitude!==void 0?o="location":S.x!==void 0&&S.y!==void 0&&S.z!==void 0?o="vector3d":S.r!==void 0&&S.g!==void 0&&S.b!==void 0?o="color":S.values&&Array.isArray(S.values)?o="vector":S.elements&&Array.isArray(S.elements)?o="array":o="object"):o="string"}catch{o="string"}else typeof a.last_value=="number"?o="float":typeof a.last_value=="object"&&a.last_value!==null&&(x=a.last_value,a.last_value.latitude!==void 0&&a.last_value.longitude!==void 0?o="location":a.last_value.x!==void 0&&a.last_value.y!==void 0&&a.last_value.z!==void 0?o="vector3d":a.last_value.r!==void 0&&a.last_value.g!==void 0&&a.last_value.b!==void 0?o="color":a.last_value.values&&Array.isArray(a.last_value.values)?o="vector":a.last_value.elements&&Array.isArray(a.last_value.elements)?o="array":o="object");return{timestamp:new Date(a.last_timestamp),subject:`iot.data.${a.adapter_name}.${a.device_id}.${a.key}`,data:{device_id:a.device_id,key:a.key,value:x,data_type:o,adapter_name:a.adapter_name,bytes_per_sec:a.bytes_per_sec,data_points_per_sec:a.data_points_per_sec,latency_ms:a.latency_ms,error_rate:a.error_rate,derived_values:{display_value:typeof x=="object"&&x!==null?`${o} 对象`:x,summary:`${a.data_points_per_sec.toFixed(2)} 点/秒, ${a.latency_ms.toFixed(1)}ms 延迟, ${(a.bytes_per_sec/1024).toFixed(1)}KB/s`}}}}),[]),m=l.useMemo(()=>{const n=L.iotData.length,a=i.length;if(r==="api"&&a>0)return U(i);if(r==="websocket"&&n>0&&y)return L.iotData;if(r==="mixed"){if(a>0)return U(i);if(n>0&&y)return L.iotData}return a>0?U(i):n>0&&y?L.iotData:[]},[L.iotData,i,r,z,y,U]),R=l.useMemo(()=>(m.filter(a=>{const v=a.data?.data_type;return["location","vector3d","color","vector","array","object"].includes(v)}),m.map((a,v)=>ze(a)).filter(Boolean)),[m]),ne=l.useMemo(()=>R.filter(n=>!(oe.length>0&&!oe.includes(n.dataType))),[R,oe]),{devices:me,dataKeys:Se}=l.useMemo(()=>{const n=new Set,a=new Set;return m.forEach(v=>{v.data?.device_id&&n.add(String(v.data.device_id)),v.data?.key&&(I==="all"||v.data.device_id===I)&&a.add(String(v.data.key))}),{devices:Array.from(n).sort(),dataKeys:Array.from(a).sort()}},[m,I]),[xe,$e]=l.useState([]),N=l.useMemo(()=>($?xe:m).filter(a=>{const v=I==="all"||a.data?.device_id===I,o=P==="all"||a.data?.key===P;return v&&o}),[$?xe:m,I,P,$,xe]),re=l.useMemo(()=>{const n=[];return N.forEach(a=>{const v=a.data?.data_type;if(["location","vector3d","color","vector","array"].includes(v)&&B){const o=ze(a);o&&o.components.length>0?o.components.forEach(x=>{n.push({...a,data:{...a.data,key:`${a.data.key}-${x.key}`,value:x.value,data_type:`${v}_component`,derived_values:{display_value:x.value,summary:`${x.label}: ${x.value}${x.unit||""}`},component_info:{parent_key:a.data.key,component_key:x.key,component_label:x.label,component_unit:x.unit||"",component_color:x.color}},_expanded_id:`${a.data?.device_id}-${a.data?.key}-${x.key}-${a.timestamp}`})}):n.push(a)}else n.push(a)}),n},[N,B,ze]);Pe.useEffect(()=>{$&&xe.length===0?$e([...m]):$||$e([])},[$,m,xe.length]),Pe.useEffect(()=>{d("all")},[I]);const Me=l.useMemo(()=>{const n=new Map,a=["#1890ff","#52c41a","#faad14","#f5222d","#722ed1","#13c2c2","#eb2f96","#fa8c16"];let v=0;return N.forEach(o=>{const x=o.data?.data_type||"unknown";let S,w=`${o.data?.device_id||"unknown"}-${o.data?.key||"value"}`;if(typeof o.data?.value=="number")S=o.data.value;else if(o.data?.derived_values?.display_value!==void 0){const k=o.data.derived_values.display_value;typeof k=="number"&&(S=k,w=`${w} (${x})`)}S!==void 0&&(n.has(w)||(n.set(w,{data:[],color:a[v%a.length]}),v++),n.get(w).data.push({timestamp:o.timestamp,value:S}))}),B&&ne.length>0&&ne.forEach(o=>{const x=`${o.deviceId}-${o.dataKey}`,S=le[x]||[];o.components.forEach(w=>{if(S.length===0||S.includes(w.key)){const k=ie==="separated"?`${o.deviceId}-${w.label} (${o.dataType})`:`${o.deviceId}-${o.dataKey}-${w.label}`;n.has(k)||(n.set(k,{data:[],color:w.color||a[v%a.length]}),v++),n.get(k).data.push({timestamp:o.timestamp,value:w.value})}})}),Array.from(n.entries()).map(([o,x])=>({name:o,data:x.data.slice(-C),color:x.color,type:"line",smooth:!0}))},[N,C,B,ne,le,ie]),F=l.useMemo(()=>{const n=new Date,a=new Date(n.getTime()-6e4),v=new Date(n.getTime()-3e5),o=B?re:N,x=o.filter(M=>new Date(M.timestamp||Date.now())>a),S=o.filter(M=>new Date(M.timestamp||Date.now())>v),w=o.filter(M=>typeof M.data?.value=="number"||typeof M.data?.derived_values?.display_value=="number"),k=w.map(M=>typeof M.data?.value=="number"?M.data.value:typeof M.data?.derived_values?.display_value=="number"?M.data.derived_values.display_value:0),he=k.length>0?k.reduce((M,V)=>M+V,0)/k.length:0,q=new Map;o.forEach(M=>{let V=M.data?.data_type||"unknown";V.endsWith("_component")&&(V=V.replace("_component","分量")),q.set(V,(q.get(V)||0)+1)});const G={totalCompositeItems:R.length,compositeDataTypes:[...new Set(R.map(M=>M.dataType))],totalComponents:R.reduce((M,V)=>M+V.components.length,0),selectedComponents:Object.values(le).reduce((M,V)=>M+V.length,0),expandedItems:B?re.length-N.length:0};return{totalPoints:o.length,recentPoints:x.length,recent5MinPoints:S.length,devicesCount:me.length,dataKeysCount:Se.length,avgValue:he,numericPointsCount:w.length,dataTypeStats:Object.fromEntries(q),composite:G}},[N,re,B,me.length,Se.length,R,le]),Oe=[{title:"时间",dataIndex:"timestamp",key:"timestamp",width:100,render:n=>{if(!n)return"--";try{return(typeof n=="string"?new Date(n):n).toLocaleTimeString()}catch{return console.warn("Invalid timestamp:",n),"--"}}},{title:"设备ID",dataIndex:["data","device_id"],key:"device_id",width:100,render:n=>e.jsx(ee,{color:"blue",children:n||"Unknown"})},{title:"数据字段",dataIndex:["data","key"],key:"key",width:120,render:(n,a)=>{const v=a.data?.data_type?.endsWith("_component"),o=a.data?.component_info;return v&&o?e.jsxs("div",{children:[e.jsx(ee,{color:"green",size:"small",children:o.parent_key}),e.jsx(ee,{color:"cyan",size:"small",children:o.component_label})]}):e.jsx(ee,{color:"green",children:n||"value"})}},{title:"数据类型",dataIndex:["data","data_type"],key:"data_type",width:100,render:(n,a)=>{const v={float:"blue",int:"cyan",string:"green",bool:"orange",location:"purple",vector3d:"magenta",color:"red",vector:"volcano",array:"geekblue",matrix:"gold",timeseries:"lime",location_component:"purple",vector3d_component:"magenta",color_component:"red",vector_component:"volcano",array_component:"geekblue",unknown:"default"},x=n?.endsWith("_component")?n.replace("_component","")+"分量":n;return e.jsx(ee,{color:v[n]||"default",size:"small",children:x||"unknown"})}},{title:"数值",dataIndex:["data"],key:"value",width:150,render:(n,a)=>{const v=n?.data_type||"unknown",o=n?.derived_values,x=n?.value,S=v?.endsWith("_component"),w=n?.component_info;return S&&w?e.jsxs("div",{style:{fontFamily:"monospace"},children:[e.jsxs("div",{style:{fontSize:"14px",fontWeight:"bold",color:w.component_color},children:[typeof x=="number"?x.toFixed(3):String(x),w.component_unit&&e.jsx("span",{style:{fontSize:"12px",color:"#999",marginLeft:"2px"},children:w.component_unit})]}),e.jsx("div",{style:{fontSize:"10px",color:"#666"},children:w.component_label})]}):o?.summary?e.jsxs("div",{style:{fontFamily:"monospace"},children:[e.jsx("div",{style:{fontSize:"13px",fontWeight:"bold"},children:o.summary}),o.display_value!==void 0&&e.jsxs("div",{style:{fontSize:"11px",color:"#666"},children:["值: ",typeof o.display_value=="number"?o.display_value.toFixed(2):String(o.display_value)]})]}):typeof x=="number"?e.jsx("span",{style:{fontFamily:"monospace"},children:x.toFixed(2)}):typeof x=="object"&&x!==null?e.jsxs("span",{style:{fontFamily:"monospace",fontSize:"11px",color:"#666"},children:[v," 对象"]}):e.jsx("span",{style:{fontFamily:"monospace"},children:String(x)})}},{title:"主题",dataIndex:["data","subject"],key:"subject",ellipsis:!0,render:n=>e.jsx("span",{style:{fontSize:"12px",color:"#666"},children:n})}],He=()=>{ke.info("数据清除功能需要后端支持，当前仅为演示")},Ve=()=>{try{let n="",a=0;const v=N.map(k=>{const he=k.data?.data_type||"unknown",q=k.data?.value,G=k.data?.derived_values;let M="";typeof q=="object"&&q!==null?M=JSON.stringify(q):M=String(q||"");const V=G?.display_value!==void 0?String(G.display_value):"",Ke=G?.summary||"";return[new Date(k.timestamp||Date.now()).toISOString(),k.data?.device_id||"",k.data?.key||"",he,"普通数据",`"${M.replace(/"/g,'""')}"`,V,`"${Ke.replace(/"/g,'""')}"`,k.data?.subject||""].join(",")}),o=[];B&&ne.length>0&&ne.forEach(k=>{const he=`${k.deviceId}-${k.dataKey}`,q=le[he]||[];k.components.forEach(G=>{(q.length===0||q.includes(G.key))&&o.push([k.timestamp.toISOString(),k.deviceId,`${k.dataKey}-${G.label}`,k.dataType,"复合数据分量",String(G.value),String(G.value),`分量: ${G.label}${G.unit?" ("+G.unit+")":""}`,`${k.deviceId}.${k.dataKey}.${G.key}`].join(","))})});const x=[...v,...o];a=x.length,n=[["时间","设备ID","数据字段","数据类型","数据来源","原始值","显示值","摘要","主题"].join(","),...x].join(`
`);const S=new Blob([n],{type:"text/csv;charset=utf-8;"}),w=document.createElement("a");if(w.download!==void 0){const k=URL.createObjectURL(S);w.setAttribute("href",k),w.setAttribute("download",`iot-data-enhanced-${new Date().toISOString().slice(0,10)}.csv`),w.style.visibility="hidden",document.body.appendChild(w),w.click(),document.body.removeChild(w),ke.success(`已导出 ${a} 条增强数据（包含 ${o.length} 个复合数据分量）`)}}catch(n){console.error("Export failed:",n),ke.error("导出失败")}};return e.jsxs("div",{children:[e.jsx(f,{size:"small",style:{marginBottom:16},children:e.jsxs(H,{gutter:[16,16],align:"middle",children:[e.jsxs(c,{xs:24,sm:12,md:6,children:[e.jsx("span",{style:{marginRight:8},children:"设备:"}),e.jsxs(ue,{value:I,onChange:D,style:{width:"100%"},size:"small",children:[e.jsx(se,{value:"all",children:"全部设备"}),me.map(n=>e.jsx(se,{value:n,children:n},n))]})]}),e.jsxs(c,{xs:24,sm:12,md:6,children:[e.jsx("span",{style:{marginRight:8},children:"字段:"}),e.jsxs(ue,{value:P,onChange:d,style:{width:"100%"},size:"small",children:[e.jsx(se,{value:"all",children:"全部字段"}),Se.map(n=>e.jsx(se,{value:n,children:n},n))]})]}),e.jsxs(c,{xs:24,sm:12,md:6,children:[e.jsx("span",{style:{marginRight:8},children:"数据源:"}),e.jsxs(ue,{value:r,onChange:T,style:{width:"100%"},size:"small",children:[e.jsxs(se,{value:"api",children:[e.jsx(ge,{})," API轮询 (推荐)"]}),e.jsxs(se,{value:"mixed",children:[e.jsx(Ee,{})," 智能混合"]}),e.jsxs(se,{value:"websocket",children:[e.jsx(Ee,{})," WebSocket"]})]})]}),e.jsx(c,{xs:24,sm:12,md:6,children:e.jsxs(Q,{children:[e.jsx(J,{size:"small",icon:$?e.jsx(Je,{}):e.jsx(Ye,{}),onClick:()=>O(!$),children:$?"恢复":"暂停"}),e.jsx(J,{size:"small",icon:e.jsx(Ce,{}),onClick:u,loading:h,children:"刷新"})]})}),E&&R.length>0&&e.jsx(c,{xs:24,sm:12,md:6,children:e.jsxs(Q,{children:[e.jsx("span",{style:{fontSize:"12px"},children:"复合数据:"}),e.jsx(Xe,{size:"small",checked:B,onChange:je,checkedChildren:"分量",unCheckedChildren:"隐藏"}),B&&e.jsxs(ue,{size:"small",value:ie,onChange:_e,style:{width:80},children:[e.jsx(se,{value:"combined",children:"合并"}),e.jsx(se,{value:"separated",children:"分离"})]})]})}),e.jsx(c,{xs:24,sm:12,md:6,children:e.jsxs(Q,{children:[e.jsx(J,{size:"small",icon:e.jsx(Ze,{}),onClick:Ve,disabled:N.length===0,children:"导出"}),e.jsx(J,{size:"small",icon:e.jsx(qe,{}),onClick:He,danger:!0,children:"清除"})]})}),e.jsx(c,{xs:24,sm:12,md:6,children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsxs("div",{style:{fontSize:"12px",marginBottom:"2px"},children:[e.jsxs("span",{style:{color:y?"#52c41a":"#f5222d"},children:["● WS: ",y?"已连接":"断开"]}),e.jsxs("span",{style:{marginLeft:"8px",color:Z?"#f5222d":"#52c41a"},children:["● API: ",Z?"错误":"正常"]})]}),e.jsx("div",{style:{fontSize:"11px",color:"#999"},children:N.length>0?`显示 ${N.length} 条记录`:"暂无数据"}),W&&e.jsxs("div",{style:{fontSize:"10px",color:"#ccc"},children:["API更新: ",W.toLocaleTimeString()]})]})})]})}),Z&&e.jsx(ve,{message:"API数据获取错误",description:`无法从监控API获取数据: ${Z}${y?"，当前使用WebSocket数据。":"，建议检查网络连接。"}`,type:"warning",showIcon:!0,style:{marginBottom:16},action:e.jsx(J,{size:"small",onClick:u,loading:h,children:"重试"})}),!y&&i.length===0&&e.jsx(ve,{message:"数据源不可用",description:"WebSocket连接断开且API数据获取失败。请检查网络连接或联系系统管理员。",type:"error",showIcon:!0,style:{marginBottom:16}}),m.length===0&&!h&&e.jsx(ve,{message:"暂无IoT数据",description:`当前${r==="websocket"?"WebSocket":r==="api"?"API":"所有数据源"}都没有可用数据。请检查设备连接状态和数据采集配置。`,type:"info",showIcon:!0,style:{marginBottom:16},action:e.jsxs(Q,{children:[e.jsx(J,{size:"small",onClick:u,loading:h,children:"刷新API"}),e.jsx(J,{size:"small",onClick:()=>T("mixed"),children:"切换到混合模式"})]})}),E&&B&&R.length>0&&e.jsx(xt,{data:ne,onComponentSelectionChange:Y,onDataTypeFilter:ye}),e.jsxs(H,{gutter:[12,12],style:{marginBottom:16},children:[e.jsx(c,{xs:12,sm:8,md:4,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"总数据点",value:F.totalPoints,valueStyle:{fontSize:"15px"},suffix:e.jsxs("span",{style:{fontSize:"10px",color:"#999"},children:["(",r==="websocket"?"WS":r==="api"?"API":"混合",")"]})})})}),e.jsx(c,{xs:12,sm:8,md:4,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"最近1分钟",value:F.recentPoints,valueStyle:{fontSize:"15px",color:F.recentPoints>0?"#52c41a":"#666"}})})}),e.jsx(c,{xs:12,sm:8,md:4,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"最近5分钟",value:F.recent5MinPoints,valueStyle:{fontSize:"15px",color:F.recent5MinPoints>0?"#1890ff":"#666"}})})}),e.jsx(c,{xs:12,sm:6,md:3,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"设备数量",value:F.devicesCount,valueStyle:{fontSize:"15px"}})})}),e.jsx(c,{xs:12,sm:6,md:3,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"数据字段",value:F.dataKeysCount,valueStyle:{fontSize:"15px"}})})}),e.jsx(c,{xs:24,sm:12,md:6,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"数值平均值",value:F.avgValue.toFixed(2),valueStyle:{fontSize:"15px",color:F.numericPointsCount>0?"#722ed1":"#666"},suffix:F.numericPointsCount>0?`(${F.numericPointsCount}个数值)`:"(无数值)"})})}),E&&F.composite.totalCompositeItems>0&&e.jsxs(e.Fragment,{children:[e.jsx(c,{xs:12,sm:8,md:4,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"复合数据项",value:F.composite.totalCompositeItems,valueStyle:{fontSize:"15px",color:"#13c2c2"},suffix:`(${F.composite.compositeDataTypes.length}种类型)`})})}),e.jsx(c,{xs:12,sm:8,md:4,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"数据分量",value:`${F.composite.selectedComponents}/${F.composite.totalComponents}`,valueStyle:{fontSize:"15px",color:B?"#52c41a":"#999"},suffix:B?"(已选择)":"(隐藏)"})})})]})]}),Object.keys(F.dataTypeStats).length>1&&e.jsx(f,{title:"数据类型分布",size:"small",style:{marginBottom:16},bodyStyle:{padding:"8px 16px"},children:e.jsx(H,{gutter:[8,8],children:Object.entries(F.dataTypeStats).map(([n,a])=>{const v={float:"blue",int:"cyan",string:"green",bool:"orange",location:"purple",vector3d:"magenta",color:"red",vector:"volcano",array:"geekblue",matrix:"gold",timeseries:"lime",unknown:"default"};return e.jsx(c,{children:e.jsxs(ee,{color:v[n]||"default",style:{margin:"2px"},children:[n,": ",a]})},n)})})}),e.jsx(H,{gutter:[16,16],children:e.jsx(c,{xs:24,children:Me.length>0?e.jsx(fe,{title:`IoT 数据流实时监控 ${$?"(已暂停)":""} - ${r==="websocket"?"WebSocket实时":r==="api"?"API轮询":"智能混合"}${B?" + 复合数据分量":""}`,series:Me,height:b,yAxisLabel:"数值",maxDataPoints:C,loading:h&&!y,timeFormat:"HH:mm:ss"}):e.jsx(f,{title:`IoT 数据流实时监控 ${$?"(已暂停)":""} - ${r==="websocket"?"WebSocket实时":r==="api"?"API轮询":"智能混合"}${B?" + 复合数据分量":""}`,style:{height:b},children:e.jsxs("div",{style:{height:b-100,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",color:"#999"},children:[e.jsx("div",{style:{fontSize:"16px",marginBottom:"8px"},children:"📊 暂无可视化数据"}),e.jsx("div",{style:{fontSize:"14px",textAlign:"center"},children:N.length===0?"当前筛选条件下没有数据":"当前数据中没有数值型字段，无法生成图表"}),!y&&!i.length&&e.jsx("div",{style:{fontSize:"12px",marginTop:"8px",color:"#f5222d"},children:"● WebSocket连接断开，API数据也不可用"}),!y&&i.length>0&&e.jsx("div",{style:{fontSize:"12px",marginTop:"8px",color:"#faad14"},children:"● WebSocket断开，正在使用API数据"}),y&&r==="api"&&e.jsx("div",{style:{fontSize:"12px",marginTop:"8px",color:"#1890ff"},children:"● 已切换到API轮询模式"})]})})})}),A&&e.jsx(f,{title:`原始数据流${B?" (含复合数据分量)":""}`,style:{marginTop:16},extra:e.jsxs("span",{style:{fontSize:"12px",color:"#666"},children:["显示最近 ",Math.min(re.length,j)," 条记录",B&&re.length>N.length&&` (${re.length-N.length} 个分量扩展)`]}),children:e.jsx(Qe,{columns:Oe,dataSource:re.slice(-j).reverse(),pagination:!1,size:"small",scroll:{y:300},rowKey:(n,a)=>n._expanded_id||`${a}-${n.timestamp||Date.now()}`})})]})},{Title:ft,Text:X}=We,Ct=()=>{const{user:b}=Ie(),[A,C]=l.useState([]),[j,s]=l.useState({uptime:"0h 0m",activeDevices:0,dataPoints:0,errorRate:0,cpuUsage:0,memoryUsage:0}),[g,z]=l.useState(!0),[E,L]=l.useState(null),[y,I]=l.useState([]),[D,P]=l.useState(null),[d,$]=l.useState(!0),O=l.useRef(null),i=l.useRef(""),p=l.useRef(!0),{data:h,isConnected:t,connectionState:r,reconnect:T}=De(),W=l.useCallback(async()=>{try{const u=await ot.getPlugins({page:1,page_size:50});C(u.data||[])}catch(u){console.error("❌ 获取插件列表失败:",u)}},[]),K=l.useCallback(async(u=!1)=>{try{u&&$(!0);const U=await pe.getLightweightMetrics(),m=U.last_updated;(m!==i.current||p.current)&&(P(U),i.current=m),p.current&&(p.current=!1)}catch(U){console.error("❌ Dashboard获取轻量级指标失败:",U)}finally{u&&$(!1)}},[]),Z=l.useCallback(async()=>{if(h?.systemStatus){const u=h.systemStatus;let U="0h 0m";if(u.uptime){if(typeof u.uptime=="string")U=u.uptime;else if(typeof u.uptime=="number"){const m=u.uptime,R=Math.floor(m/86400),ne=Math.floor(m%86400/3600),me=Math.floor(m%3600/60);U=`${R}天 ${ne}小时 ${me}分钟`}}s(m=>{const R={uptime:U,activeDevices:u.active_connections||u.active_plugins||0,dataPoints:h.iotData?.length||0,errorRate:u.error_rate||0,cpuUsage:u.cpu_usage||0,memoryUsage:u.memory_usage||0};return JSON.stringify(m)!==JSON.stringify(R)?R:m})}},[h?.systemStatus,h?.iotData]),ae=l.useCallback(async()=>{try{const u=await it.getAlerts({page:1,pageSize:5});I(u.alerts)}catch(u){console.error("❌ 获取告警数据失败:",u)}},[]);l.useEffect(()=>{(async()=>{z(!0),await Promise.all([W(),Z(),ae(),K(!0)]),z(!1)})()},[]),l.useEffect(()=>{(h?.systemStatus||h?.iotData)&&Z()},[Z]),l.useEffect(()=>(O.current&&clearInterval(O.current),O.current=setInterval(()=>{K(!1)},8e3),()=>{O.current&&(clearInterval(O.current),O.current=null)}),[K]);const B=u=>{switch(u){case"critical":case"error":return e.jsx(rt,{style:{color:"#f5222d"}});case"warning":return e.jsx(lt,{style:{color:"#faad14"}});default:return e.jsx(Be,{style:{color:"#52c41a"}})}},je=u=>{switch(u){case"critical":case"error":return"error";case"warning":return"warning";default:return"info"}},oe=l.useCallback(async()=>{z(!0),await Promise.all([W(),Z(),ae(),K(!0)]),t||await T(),z(!1)},[W,Z,ae,K,t,T]),ye=async()=>{try{const U=await(await fetch("/api/v1/system/status")).json()}catch(u){console.error("❌ API连接失败:",u)}T()},le=()=>{const{logout:u}=Ie.getState();u(),window.location.reload()};l.useEffect(()=>{const u=setTimeout(()=>{t||ye()},5e3);return()=>clearTimeout(u)},[t,T]);const Y=l.useMemo(()=>D?{uptime:pe.formatUptime(D.system.uptime_seconds),activeAdapters:`${D.gateway.running_adapters}/${D.gateway.total_adapters}`,dataPointsPerSecond:D.data.data_points_per_second.toFixed(1),rulesEnabled:`${D.rules.enabled_rules}/${D.rules.total_rules}`,rulesMatched:pe.formatNumber(D.rules.rules_matched),actionsExecuted:pe.formatNumber(D.rules.actions_executed),successRate:D.rules.actions_executed>0?`${(D.rules.actions_succeeded/D.rules.actions_executed*100).toFixed(1)}%`:"0%",cpuUsage:D.system.cpu_usage_percent,memoryUsagePercent:Math.round(D.system.memory_usage_bytes/1024/1024/1024*10),hasActionsFailed:D.rules.actions_failed>0}:null,[D]),ie=l.useMemo(()=>new Date().toLocaleTimeString(),[]),_e=l.useMemo(()=>[{key:"overview",label:e.jsxs("span",{children:[e.jsx(Ue,{}),"系统概览"]}),children:e.jsxs(H,{gutter:[12,12],children:[e.jsx(c,{xs:24,sm:12,md:8,lg:4,xl:3,children:e.jsx(f,{size:"small",loading:d,children:e.jsx(_,{title:"系统运行时间",value:Y?.uptime||j.uptime,prefix:e.jsx(Re,{}),valueStyle:{color:"#52c41a",fontSize:"16px"}})})}),e.jsx(c,{xs:24,sm:12,md:8,lg:4,xl:3,children:e.jsx(f,{size:"small",loading:d,children:e.jsx(_,{title:"活跃适配器",value:Y?.activeAdapters||j.activeDevices,prefix:e.jsx(et,{}),valueStyle:{color:"#1890ff",fontSize:"16px"}})})}),e.jsx(c,{xs:24,sm:12,md:8,lg:4,xl:3,children:e.jsx(f,{size:"small",loading:d,children:e.jsx(_,{title:"数据点/秒",value:Y?.dataPointsPerSecond||j.dataPoints,prefix:e.jsx(Le,{}),valueStyle:{color:"#722ed1",fontSize:"16px"}})})}),e.jsx(c,{xs:24,sm:12,md:8,lg:4,xl:3,children:e.jsx(f,{size:"small",children:e.jsx(_,{title:"连接状态",value:t?"已连接":"断开",prefix:e.jsx(ge,{}),valueStyle:{color:t?"#52c41a":"#f5222d",fontSize:"16px"}})})}),e.jsx(c,{xs:24,sm:12,md:8,lg:4,xl:3,children:e.jsx(f,{size:"small",loading:d,children:e.jsx(_,{title:"启用规则",value:Y?.rulesEnabled||"0/0",prefix:e.jsx(tt,{}),valueStyle:{color:"#fa8c16",fontSize:"16px"}})})}),e.jsx(c,{xs:24,sm:12,md:8,lg:4,xl:3,children:e.jsx(f,{size:"small",loading:d,children:e.jsx(_,{title:"规则匹配次数",value:Y?.rulesMatched||"0",prefix:e.jsx(Be,{}),valueStyle:{color:"#52c41a",fontSize:"16px"}})})}),e.jsx(c,{xs:24,sm:12,md:8,lg:4,xl:3,children:e.jsx(f,{size:"small",loading:d,children:e.jsx(_,{title:"动作执行次数",value:Y?.actionsExecuted||"0",prefix:e.jsx(Re,{}),valueStyle:{color:"#722ed1",fontSize:"16px"}})})}),e.jsx(c,{xs:24,sm:12,md:8,lg:4,xl:3,children:e.jsx(f,{size:"small",loading:d,children:e.jsx(_,{title:"执行成功率",value:Y?.successRate||"0%",prefix:e.jsx(st,{}),valueStyle:{color:Y?.hasActionsFailed?"#f5222d":"#52c41a",fontSize:"16px"}})})}),e.jsx(c,{xs:24,xl:12,children:e.jsx(f,{title:"系统资源",size:"small",extra:e.jsx(J,{size:"small",icon:e.jsx(Ce,{}),onClick:oe,loading:g}),children:e.jsxs(H,{gutter:[8,8],children:[e.jsx(c,{xs:24,sm:12,children:e.jsxs("div",{style:{marginBottom:8},children:[e.jsx(X,{style:{fontSize:"12px"},children:"CPU 使用率"}),e.jsx(de,{size:"small",percent:Math.round(Y?.cpuUsage||j.cpuUsage),status:j.cpuUsage>80?"exception":"active",strokeColor:j.cpuUsage>80?"#f5222d":"#1890ff",showInfo:!0})]})}),e.jsx(c,{xs:24,sm:12,children:e.jsxs("div",{style:{marginBottom:8},children:[e.jsx(X,{style:{fontSize:"12px"},children:"内存使用率"}),e.jsx(de,{size:"small",percent:Y?.memoryUsagePercent||Math.round(j.memoryUsage),status:j.memoryUsage>85?"exception":"active",strokeColor:j.memoryUsage>85?"#f5222d":"#52c41a",showInfo:!0})]})}),e.jsx(c,{xs:12,sm:6,children:e.jsx(_,{title:"连接状态",value:r,valueStyle:{fontSize:"12px",color:t?"#52c41a":"#f5222d"}})}),e.jsx(c,{xs:12,sm:6,children:e.jsx(_,{title:"最后更新",value:ie,valueStyle:{fontSize:"12px"}})})]})})}),e.jsx(c,{xs:24,xl:12,children:e.jsx(f,{title:"最近告警",size:"small",extra:e.jsx(we,{count:y.filter(u=>u.level==="error"||u.level==="critical").length}),children:e.jsx(be,{size:"small",dataSource:y.slice(0,3),renderItem:u=>e.jsx(be.Item,{style:{padding:"8px 0"},children:e.jsx(be.Item.Meta,{avatar:B(u.level),title:e.jsxs(Q,{children:[e.jsx(ee,{size:"small",color:je(u.level),children:u.level.toUpperCase()}),e.jsx(X,{style:{fontSize:"13px"},children:u.title||u.description})]}),description:e.jsxs(Q,{style:{fontSize:"11px"},children:[e.jsx(X,{type:"secondary",children:u.source}),e.jsx(X,{type:"secondary",children:"•"}),e.jsx(X,{type:"secondary",children:new Date(u.createdAt).toLocaleString()})]})})})})})}),e.jsx(c,{xs:24,children:e.jsx(f,{title:"插件状态",size:"small",loading:g,children:(()=>{const u=A.filter(m=>m.type==="adapter").sort((m,R)=>m.name.localeCompare(R.name)),U=A.filter(m=>m.type==="sink").sort((m,R)=>m.name.localeCompare(R.name));return e.jsxs(e.Fragment,{children:[u.length>0&&e.jsxs("div",{style:{marginBottom:16},children:[e.jsxs(X,{strong:!0,style:{fontSize:"14px",color:"#1890ff"},children:["数据适配器 (Adapters) - ",u.filter(m=>m.status==="running").length,"/",u.length]}),e.jsx(H,{gutter:[8,8],style:{marginTop:8},children:u.slice(0,8).map((m,R)=>e.jsx(c,{xs:24,sm:12,md:8,lg:6,xl:4,children:e.jsxs("div",{style:{border:"1px solid #e6f7ff",borderRadius:"6px",padding:"8px",backgroundColor:m.status==="running"?"#e6f7ff":"#fff2f0",minHeight:"50px"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",marginBottom:"4px"},children:e.jsx(we,{status:m.status==="running"?"success":"error",text:e.jsx(X,{style:{fontSize:"12px",fontWeight:500},children:m.name})})}),e.jsxs(X,{type:"secondary",style:{fontSize:"11px"},children:[m.type," • v",m.version]})]})},`adapter-${m.id||R}`))})]}),U.length>0&&e.jsxs("div",{children:[e.jsxs(X,{strong:!0,style:{fontSize:"14px",color:"#52c41a"},children:["数据输出 (Sinks) - ",U.filter(m=>m.status==="running").length,"/",U.length]}),e.jsx(H,{gutter:[8,8],style:{marginTop:8},children:U.slice(0,8).map((m,R)=>e.jsx(c,{xs:24,sm:12,md:8,lg:6,xl:4,children:e.jsxs("div",{style:{border:"1px solid #f6ffed",borderRadius:"6px",padding:"8px",backgroundColor:m.status==="running"?"#f6ffed":"#fff2f0",minHeight:"50px"},children:[e.jsx("div",{style:{display:"flex",alignItems:"center",marginBottom:"4px"},children:e.jsx(we,{status:m.status==="running"?"success":"error",text:e.jsx(X,{style:{fontSize:"12px",fontWeight:500},children:m.name})})}),e.jsxs(X,{type:"secondary",style:{fontSize:"11px"},children:[m.type," • v",m.version]})]})},`sink-${m.id||R}`))})]}),A.length===0&&e.jsx("div",{style:{textAlign:"center",padding:"20px",color:"#999"},children:"暂无插件数据"})]})})()})})]})},{key:"monitoring",label:e.jsxs("span",{children:[e.jsx(at,{}),"系统监控"]}),children:e.jsx(mt,{height:280,showDetailedCharts:!0})},{key:"iot-data",label:e.jsxs("span",{children:[e.jsx(Le,{}),"数据流监控"]}),children:e.jsx(ht,{height:280,showRawData:!0,maxChartPoints:100,enableCompositeDataViewer:!0,autoRefresh:!0,refreshInterval:3e3})}],[Y,d,j,t,r,ie,A,g,y]);return g?e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"50vh"},children:e.jsx(Fe,{size:"large"})}):e.jsxs("div",{children:[e.jsxs(H,{justify:"space-between",align:"middle",style:{marginBottom:16},children:[e.jsxs(c,{children:[e.jsxs(ft,{level:3,style:{margin:0,fontSize:"20px"},children:[e.jsx(Ue,{})," 仪表板"]}),e.jsxs(X,{type:"secondary",style:{fontSize:"13px"},children:["欢迎回来, ",b?.username]})]}),e.jsx(c,{children:e.jsxs(Q,{size:"small",children:[e.jsx(J,{size:"small",type:"primary",icon:e.jsx(Ce,{}),onClick:oe,loading:g,children:"刷新"}),e.jsx(J,{size:"small",icon:e.jsx(ge,{}),onClick:ye,children:"测试连接"}),!t&&e.jsx(J,{size:"small",type:"primary",icon:e.jsx(ge,{}),onClick:T,children:"重连"}),e.jsx(J,{size:"small",danger:!0,onClick:le,children:"重新登录"})]})})]}),!t&&e.jsx(ve,{message:"实时连接断开",description:"WebSocket连接已断开，部分实时功能可能不可用。",type:"warning",showIcon:!0,closable:!0,size:"small",style:{marginBottom:12}}),!1,e.jsx(nt,{defaultActiveKey:"overview",items:_e,size:"small",style:{marginTop:8}})]})};export{Ct as default};
