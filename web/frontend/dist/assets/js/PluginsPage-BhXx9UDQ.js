import{r as e,k as t}from"./react-vendor-XKB30K_c.js";import{p as a}from"./pluginService-DOYhogIr.js";import{d as s}from"./utils-vendor-DHyCJoYc.js";import{aj as r,R as n,N as l,B as i,av as o,ak as c,aq as d,ap as u,am as x,aw as h,au as j,ax as p,an as m,ay as g,az as y,T as v,at as f,aA as S,aB as w}from"./antd-vendor-BEPv5fMA.js";import{S as k}from"./antd-select-B9qIJAZm.js";import{D as C}from"./antd-date-picker-BA1qR6od.js";import{$ as z,A as b,a1 as I,C as _,a3 as O,U as T,P,a4 as $,a5 as N,a0 as R}from"./antd-icons-Cd9MHNVc.js";import{F}from"./antd-table-PbtM5e6h.js";import{a as U}from"./antd-form-D97X3GMQ.js";import"./vendor-CG-KndAb.js";import"./index-SZKmSCox.js";import"./state-vendor-DvJGcyIt.js";import"./antd-tree-U-o4Fj3K.js";const{Option:J}=k,{RangePicker:Y}=C,{Text:A}=c,B=({pluginName:c})=>{const[u,x]=e.useState([]),[h,j]=e.useState(!1),[p,m]=e.useState({current:1,pageSize:20,total:0}),[g,y]=e.useState({level:"",source:"",dateRange:null}),v=async()=>{j(!0);try{const e={page:p.current,page_size:p.pageSize,level:g.level||void 0,source:g.source||void 0,from:g.dateRange?.[0]?.toISOString(),to:g.dateRange?.[1]?.toISOString()},t=await a.getPluginLogs(c,e);x(t.data),m(e=>({...e,total:t.total}))}catch(e){o.error("获取日志失败："+(e.message||"未知错误"))}finally{j(!1)}},f=[{title:"时间",dataIndex:"timestamp",key:"timestamp",width:180,render:e=>t.jsx(A,{style:{fontSize:12,fontFamily:"monospace"},children:s(e).format("YYYY-MM-DD HH:mm:ss")})},{title:"级别",dataIndex:"level",key:"level",width:80,render:e=>(e=>{switch(e.toLowerCase()){case"error":return t.jsx(d,{color:"red",children:e.toUpperCase()});case"warn":case"warning":return t.jsx(d,{color:"orange",children:e.toUpperCase()});case"info":return t.jsx(d,{color:"blue",children:e.toUpperCase()});case"debug":return t.jsx(d,{color:"default",children:e.toUpperCase()});default:return t.jsx(d,{children:e.toUpperCase()})}})(e)},{title:"来源",dataIndex:"source",key:"source",width:120,render:e=>t.jsx(d,{color:"geekblue",children:e})},{title:"消息",dataIndex:"message",key:"message",render:e=>t.jsx(A,{style:{fontFamily:"monospace",fontSize:12,wordBreak:"break-all"},children:e})}],S=(e,t)=>{y(a=>({...a,[e]:t})),m(e=>({...e,current:1}))};return e.useEffect(()=>{v()},[p.current,p.pageSize,g]),t.jsxs(r,{title:`插件日志 - ${c}`,children:[t.jsxs(n,{gutter:16,style:{marginBottom:16},children:[t.jsx(l,{span:4,children:t.jsxs(k,{placeholder:"日志级别",allowClear:!0,style:{width:"100%"},value:g.level,onChange:e=>S("level",e),children:[t.jsx(J,{value:"error",children:"ERROR"}),t.jsx(J,{value:"warn",children:"WARN"}),t.jsx(J,{value:"info",children:"INFO"}),t.jsx(J,{value:"debug",children:"DEBUG"})]})}),t.jsx(l,{span:4,children:t.jsxs(k,{placeholder:"日志来源",allowClear:!0,style:{width:"100%"},value:g.source,onChange:e=>S("source",e),children:[t.jsx(J,{value:"main",children:"主程序"}),t.jsx(J,{value:"plugin",children:"插件"}),t.jsx(J,{value:"system",children:"系统"})]})}),t.jsx(l,{span:8,children:t.jsx(Y,{style:{width:"100%"},value:g.dateRange,onChange:e=>S("dateRange",e),showTime:!0,format:"YYYY-MM-DD HH:mm:ss"})}),t.jsx(l,{span:4,children:t.jsx(i,{icon:t.jsx(z,{}),onClick:v,style:{width:"100%"},children:"刷新"})})]}),t.jsx(F,{columns:f,dataSource:u,rowKey:"id",loading:h,size:"small",pagination:{current:p.current,pageSize:p.pageSize,total:p.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:(e,t)=>`第 ${t[0]}-${t[1]} 条，共 ${e} 条`,pageSizeOptions:["20","50","100"]},onChange:e=>{m(t=>({...t,current:e.current||1,pageSize:e.pageSize||20}))},scroll:{y:400}})]})},{Title:D,Text:E}=c,{Search:M}=x,{Option:H}=k,q=()=>{const[s,c]=e.useState([]),[C,J]=e.useState(!1),[Y,A]=e.useState(""),[q,K]=e.useState(""),[L,Q]=e.useState(""),[G,V]=e.useState({current:1,pageSize:10,total:0}),[W,X]=e.useState(!1),[Z,ee]=e.useState(null),[te,ae]=e.useState(null),[se,re]=e.useState(!1),[ne]=U.useForm(),le=async()=>{J(!0);try{const e={page:G.current,page_size:G.pageSize,search:Y||void 0,type:q||void 0,status:L||void 0},t=await a.getPlugins(e);c(t.data),V(e=>({...e,total:t.pagination.total}))}catch(e){o.error("获取插件列表失败："+(e.message||"未知错误"))}finally{J(!1)}},ie=async(e,t)=>{try{const s=await a.executePluginAction(e.name,t);s.success?(o.success(`${ce(t)}成功`),await le()):o.error(s.message||`${ce(t)}失败`)}catch(s){o.error(`${ce(t)}失败：`+(s.message||"未知错误"))}},oe=async e=>{ee(e),X(!0),await(async e=>{try{const t=await a.getPluginStats(e);ae(t)}catch(t){console.error("获取插件统计失败:",t)}})(e.name)},ce=e=>{switch(e){case"start":return"启动";case"stop":return"停止";case"restart":return"重启";default:return"操作"}},de=e=>{switch(e){case"running":return t.jsx(d,{color:"green",icon:t.jsx(R,{}),children:"运行中"});case"stopped":return t.jsx(d,{color:"default",icon:t.jsx(O,{}),children:"已停止"});case"error":return t.jsx(d,{color:"red",icon:t.jsx(N,{}),children:"错误"});default:return t.jsx(d,{color:"default",children:e})}},ue=e=>{switch(e){case"adapter":return t.jsx(d,{color:"blue",children:"适配器"});case"sink":return t.jsx(d,{color:"purple",children:"数据汇"});default:return t.jsx(d,{children:e})}},xe=[{title:"插件名称",dataIndex:"name",key:"name",render:(e,a)=>t.jsxs(u,{children:[t.jsx(y,{shape:"square",style:{backgroundColor:"adapter"===a.type?"#1890ff":"#722ed1"},children:e.charAt(0).toUpperCase()}),t.jsxs("div",{children:[t.jsx("div",{children:t.jsx("strong",{children:e})}),t.jsx(E,{type:"secondary",style:{fontSize:12},children:a.description||"无描述"})]})]})},{title:"类型",dataIndex:"type",key:"type",render:e=>ue(e),filters:[{text:"适配器",value:"adapter"},{text:"数据汇",value:"sink"}]},{title:"版本",dataIndex:"version",key:"version"},{title:"状态",dataIndex:"status",key:"status",render:(e,a)=>t.jsxs(u,{children:[de(e),a.error_count>0&&t.jsx(v,{title:`错误次数: ${a.error_count}`,children:t.jsx(f,{count:a.error_count,size:"small",children:t.jsx(I,{style:{color:"#ff4d4f"}})})})]}),filters:[{text:"运行中",value:"running"},{text:"已停止",value:"stopped"},{text:"错误",value:"error"}]},{title:"启用状态",dataIndex:"enabled",key:"enabled",render:e=>t.jsx(S,{checked:e,disabled:!0,size:"small"})},{title:"端口",dataIndex:"port",key:"port",render:e=>e||"-"},{title:"操作",key:"actions",width:200,render:(e,s)=>t.jsxs(u,{children:[t.jsx(v,{title:"查看详情",children:t.jsx(i,{type:"link",icon:t.jsx(_,{}),onClick:()=>oe(s)})}),"running"===s.status?t.jsx(v,{title:"停止",children:t.jsx(i,{type:"link",icon:t.jsx(O,{}),onClick:()=>ie(s,"stop")})}):t.jsx(v,{title:"启动",children:t.jsx(i,{type:"link",icon:t.jsx(T,{}),onClick:()=>ie(s,"start")})}),t.jsx(v,{title:"重启",children:t.jsx(i,{type:"link",icon:t.jsx(z,{}),onClick:()=>ie(s,"restart")})}),t.jsx(v,{title:"配置",children:t.jsx(i,{type:"link",icon:t.jsx(P,{}),onClick:()=>(async e=>{try{const t=await a.getPluginConfig(e.name);ee(e),ne.setFieldsValue({config:JSON.stringify(t,null,2)}),re(!0)}catch(t){o.error("获取插件配置失败："+(t.message||"未知错误"))}})(s)})}),t.jsx(w,{title:"确定要删除这个插件吗？",description:"删除后无法恢复",onConfirm:()=>(async e=>{try{await a.deletePlugin(e.name),o.success("删除插件成功"),await le()}catch(t){o.error("删除插件失败："+(t.message||"未知错误"))}})(s),okText:"确定",cancelText:"取消",children:t.jsx(v,{title:"删除",children:t.jsx(i,{type:"link",danger:!0,icon:t.jsx($,{})})})})]})}];return e.useEffect(()=>{le()},[G.current,G.pageSize,Y,q,L]),t.jsxs("div",{children:[t.jsx(D,{level:2,children:"插件管理"}),t.jsx(r,{style:{marginBottom:16},children:t.jsxs(n,{gutter:16,align:"middle",children:[t.jsx(l,{flex:"auto",children:t.jsxs(u,{children:[t.jsx(M,{placeholder:"搜索插件名称或描述",allowClear:!0,style:{width:300},onSearch:A,onClear:()=>A("")}),t.jsxs(k,{placeholder:"插件类型",allowClear:!0,style:{width:120},value:q,onChange:K,children:[t.jsx(H,{value:"adapter",children:"适配器"}),t.jsx(H,{value:"sink",children:"数据汇"})]}),t.jsxs(k,{placeholder:"状态",allowClear:!0,style:{width:120},value:L,onChange:Q,children:[t.jsx(H,{value:"running",children:"运行中"}),t.jsx(H,{value:"stopped",children:"已停止"}),t.jsx(H,{value:"error",children:"错误"})]})]})}),t.jsx(l,{children:t.jsxs(u,{children:[t.jsx(i,{icon:t.jsx(z,{}),onClick:le,children:"刷新"}),t.jsx(i,{type:"primary",icon:t.jsx(b,{}),children:"添加插件"})]})})]})}),t.jsx(r,{children:t.jsx(F,{columns:xe,dataSource:s,rowKey:"name",loading:C,pagination:{current:G.current,pageSize:G.pageSize,total:G.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:(e,t)=>`第 ${t[0]}-${t[1]} 条，共 ${e} 条`},onChange:(e,t)=>{V(t=>({...t,current:e.current||1,pageSize:e.pageSize||10})),t.type&&K(t.type[0]||""),t.status&&Q(t.status[0]||"")}})}),t.jsx(h,{title:"插件详情",width:600,open:W,onClose:()=>X(!1),children:Z&&t.jsx("div",{children:t.jsx(j,{defaultActiveKey:"1",items:[{key:"1",label:"基本信息",children:t.jsxs(p,{title:"基本信息",bordered:!0,children:[t.jsx(p.Item,{label:"名称",children:Z.name}),t.jsx(p.Item,{label:"类型",children:ue(Z.type)}),t.jsx(p.Item,{label:"版本",children:Z.version}),t.jsx(p.Item,{label:"状态",children:de(Z.status)}),t.jsx(p.Item,{label:"端口",children:Z.port||"无"}),t.jsx(p.Item,{label:"作者",children:Z.author||"未知"}),t.jsx(p.Item,{label:"路径",span:3,children:Z.path}),t.jsx(p.Item,{label:"描述",span:3,children:Z.description||"无描述"})]})},{key:"2",label:"运行统计",children:te?t.jsxs("div",{style:{marginTop:24},children:[t.jsx(D,{level:4,children:"运行统计"}),t.jsxs(n,{gutter:16,children:[t.jsx(l,{span:8,children:t.jsx(m,{title:"总数据点",value:te.data_points_total})}),t.jsx(l,{span:8,children:t.jsx(m,{title:"小时数据点",value:te.data_points_hour})}),t.jsx(l,{span:8,children:t.jsx(m,{title:"运行时间(秒)",value:te.uptime_seconds})}),t.jsx(l,{span:8,children:t.jsx(m,{title:"总错误",value:te.errors_total})}),t.jsx(l,{span:8,children:t.jsx(m,{title:"小时错误",value:te.errors_hour})}),t.jsx(l,{span:8,children:t.jsx(m,{title:"平均延迟(ms)",value:te.average_latency,precision:2})}),t.jsx(l,{span:8,children:t.jsx(m,{title:"内存使用(MB)",value:(te.memory_usage/1024/1024).toFixed(2)})}),t.jsx(l,{span:8,children:t.jsx(m,{title:"CPU使用率",value:te.cpu_usage,precision:2,suffix:"%"})})]})]}):t.jsx("div",{children:"暂无统计数据"})},{key:"3",label:"插件日志",children:t.jsx(B,{pluginName:Z.name})}]})})}),t.jsx(g,{title:"插件配置",open:se,onOk:async()=>{if(Z)try{const e=await ne.validateFields(),t=JSON.parse(e.config);await a.updatePluginConfig(Z.name,t),o.success("配置保存成功"),re(!1),await le()}catch(e){e instanceof SyntaxError?o.error("配置格式错误，请检查 JSON 格式"):o.error("保存配置失败："+(e.message||"未知错误"))}},onCancel:()=>re(!1),width:800,okText:"保存",cancelText:"取消",children:Z&&t.jsx(U,{form:ne,layout:"vertical",children:t.jsx(U.Item,{label:"配置 (JSON 格式)",name:"config",rules:[{required:!0,message:"请输入配置"},{validator:(e,t)=>{try{return JSON.parse(t),Promise.resolve()}catch{return Promise.reject(new Error("JSON 格式错误"))}}}],children:t.jsx(x.TextArea,{rows:20,placeholder:'{"key": "value"}',style:{fontFamily:"monospace"}})})})})]})};export{q as default};
//# sourceMappingURL=PluginsPage-BhXx9UDQ.js.map
