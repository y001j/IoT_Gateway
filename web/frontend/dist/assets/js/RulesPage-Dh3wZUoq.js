import{r as e,k as a}from"./react-vendor-XKB30K_c.js";import{b as t}from"./index-SZKmSCox.js";import{a as s}from"./antd-form-D97X3GMQ.js";import{ak as r,aj as i,R as l,N as n,ap as d,am as c,B as o,aw as u,au as p,ax as h,aq as x,ay as j,aA as m,av as g,T as y,aB as b}from"./antd-vendor-BEPv5fMA.js";import{S as w}from"./antd-select-B9qIJAZm.js";import{U as f,P as v,A as S,a0 as k,a3 as C,C as O,J as I,H as R,a4 as J}from"./antd-icons-Cd9MHNVc.js";import{F as N}from"./antd-table-PbtM5e6h.js";import"./vendor-CG-KndAb.js";import"./utils-vendor-DHyCJoYc.js";import"./state-vendor-DvJGcyIt.js";import"./antd-date-picker-BA1qR6od.js";import"./antd-tree-U-o4Fj3K.js";const z={getRules:async e=>(await t.get("/plugins/rules",{params:e})).data.data,getRule:async e=>(await t.get(`/plugins/rules/${e}`)).data.data,createRule:async e=>(await t.post("/plugins/rules",e)).data.data,updateRule:async(e,a)=>(await t.put(`/plugins/rules/${e}`,a)).data.data,async deleteRule(e){await t.delete(`/plugins/rules/${e}`)},async enableRule(e){await t.post(`/plugins/rules/${e}/enable`)},async disableRule(e){await t.post(`/plugins/rules/${e}/disable`)},validateRule:async e=>(await t.post("/plugins/rules/validate",e)).data.data,testRule:async e=>(await t.post("/plugins/rules/test",e)).data.data,getRuleTemplates:async()=>(await t.get("/plugins/rules/templates")).data.data},{Title:T,Text:$}=r,{Search:q}=c,{Option:F}=w,{TextArea:P}=c,_=()=>{const[t,r]=e.useState([]),[_,A]=e.useState(!1),[B,E]=e.useState(""),[D,L]=e.useState(),[K,V]=e.useState({current:1,pageSize:10,total:0}),[H,Q]=e.useState(!1),[U,G]=e.useState(null),[M,W]=e.useState(!1),[X,Y]=e.useState(!1),[Z]=s.useForm(),ee=async()=>{A(!0);try{const e={page:K.current,page_size:K.pageSize,search:B||void 0,enabled:D},a=await z.getRules(e);r(a.data),V(e=>({...e,total:a.pagination.total}))}catch(e){g.error("获取规则列表失败："+(e.message||"未知错误"))}finally{A(!1)}},ae=e=>{Y(!!e),e?(G(e),Z.setFieldsValue({name:e.name,description:e.description,enabled:e.enabled,priority:e.priority,conditions:JSON.stringify(e.conditions,null,2),actions:JSON.stringify(e.actions,null,2),tags:e.tags?Object.entries(e.tags).map(([e,a])=>({key:e,value:a})):[]})):(Z.resetFields(),Z.setFieldsValue({enabled:!0,priority:100,conditions:JSON.stringify({type:"simple",field:"key",operator:"eq",value:"temperature"},null,2),actions:JSON.stringify([{type:"alert",config:{level:"warning",message:"告警信息"}}],null,2)})),W(!0)},te=e=>e>=150?"red":e>=100?"orange":e>=50?"blue":"green",se=e=>a.jsx(x,{color:{alert:"red",transform:"blue",filter:"purple",aggregate:"cyan",forward:"green"}[e]||"default",children:e}),re=[{title:"规则名称",dataIndex:"name",key:"name",render:(e,t)=>a.jsxs("div",{children:[a.jsx("div",{children:a.jsx("strong",{children:e})}),a.jsx($,{type:"secondary",style:{fontSize:12},children:t.description})]})},{title:"优先级",dataIndex:"priority",key:"priority",width:100,render:e=>a.jsx(x,{color:te(e),children:e}),sorter:(e,a)=>e.priority-a.priority},{title:"状态",dataIndex:"enabled",key:"enabled",width:100,render:(e,t)=>a.jsx(m,{checked:e,onChange:()=>(async e=>{try{e.enabled?(await z.disableRule(e.id),g.success("规则已禁用")):(await z.enableRule(e.id),g.success("规则已启用")),await ee()}catch(a){g.error("操作失败："+(a.message||"未知错误"))}})(t),checkedChildren:"启用",unCheckedChildren:"禁用"}),filters:[{text:"已启用",value:!0},{text:"已禁用",value:!1}]},{title:"动作类型",dataIndex:"actions",key:"actions",width:150,render:e=>a.jsxs(d,{wrap:!0,children:[e.slice(0,2).map((e,t)=>a.jsx(y,{title:JSON.stringify(e.config,null,2),children:se(e.type)},t)),e.length>2&&a.jsxs(x,{children:["+",e.length-2]})]})},{title:"更新时间",dataIndex:"updated_at",key:"updated_at",width:180,render:e=>new Date(e).toLocaleString()},{title:"操作",key:"actions",width:200,render:(e,t)=>a.jsxs(d,{children:[a.jsx(y,{title:"查看详情",children:a.jsx(o,{type:"link",icon:a.jsx(O,{}),onClick:()=>(G(t),void Q(!0))})}),a.jsx(y,{title:"编辑",children:a.jsx(o,{type:"link",icon:a.jsx(I,{}),onClick:()=>ae(t)})}),a.jsx(y,{title:"复制",children:a.jsx(o,{type:"link",icon:a.jsx(R,{}),onClick:()=>(e=>{const a={...e,name:`${e.name} (副本)`,id:""};ae(a)})(t)})}),a.jsx(b,{title:"确定要删除这个规则吗？",description:"删除后无法恢复",onConfirm:()=>(async e=>{try{await z.deleteRule(e.id),g.success("删除规则成功"),await ee()}catch(a){g.error("删除规则失败："+(a.message||"未知错误"))}})(t),okText:"确定",cancelText:"取消",children:a.jsx(y,{title:"删除",children:a.jsx(o,{type:"link",danger:!0,icon:a.jsx(J,{})})})})]})}];return e.useEffect(()=>{ee()},[K.current,K.pageSize,B,D]),a.jsxs("div",{children:[a.jsx(T,{level:2,children:"规则管理"}),a.jsx(i,{style:{marginBottom:16},children:a.jsxs(l,{gutter:16,align:"middle",children:[a.jsx(n,{flex:"auto",children:a.jsxs(d,{children:[a.jsx(q,{placeholder:"搜索规则名称或描述",allowClear:!0,style:{width:300},onSearch:E,onClear:()=>E("")}),a.jsxs(w,{placeholder:"状态筛选",allowClear:!0,style:{width:120},value:D,onChange:L,children:[a.jsx(F,{value:!0,children:"已启用"}),a.jsx(F,{value:!1,children:"已禁用"})]})]})}),a.jsx(n,{children:a.jsxs(d,{children:[a.jsx(o,{icon:a.jsx(f,{}),children:"规则测试"}),a.jsx(o,{icon:a.jsx(v,{}),children:"模板库"}),a.jsx(o,{type:"primary",icon:a.jsx(S,{}),onClick:()=>ae(),children:"创建规则"})]})})]})}),a.jsx(i,{children:a.jsx(N,{columns:re,dataSource:t,rowKey:"id",loading:_,pagination:{current:K.current,pageSize:K.pageSize,total:K.total,showSizeChanger:!0,showQuickJumper:!0,showTotal:(e,a)=>`第 ${a[0]}-${a[1]} 条，共 ${e} 条`},onChange:(e,a)=>{V(a=>({...a,current:e.current||1,pageSize:e.pageSize||10})),void 0!==a.enabled&&L(a.enabled?.[0])}})}),a.jsx(u,{title:"规则详情",width:800,open:H,onClose:()=>Q(!1),children:U&&a.jsx(p,{defaultActiveKey:"1",items:[{key:"1",label:"基本信息",children:a.jsxs(h,{title:"基本信息",bordered:!0,children:[a.jsx(h.Item,{label:"规则名称",children:U.name}),a.jsx(h.Item,{label:"描述",span:2,children:U.description}),a.jsx(h.Item,{label:"状态",children:U.enabled?a.jsx(x,{color:"green",icon:a.jsx(k,{}),children:"已启用"}):a.jsx(x,{color:"red",icon:a.jsx(C,{}),children:"已禁用"})}),a.jsx(h.Item,{label:"优先级",children:a.jsx(x,{color:te(U.priority),children:U.priority})}),a.jsxs(h.Item,{label:"版本",children:["v",U.version]}),a.jsx(h.Item,{label:"创建时间",children:new Date(U.created_at).toLocaleString()}),a.jsx(h.Item,{label:"更新时间",children:new Date(U.updated_at).toLocaleString()}),a.jsx(h.Item,{label:"标签",span:2,children:U.tags&&Object.entries(U.tags).map(([e,t])=>a.jsxs(x,{children:[e,": ",t]},e))})]})},{key:"2",label:"条件配置",children:a.jsxs("div",{children:[a.jsx(T,{level:4,children:"触发条件"}),a.jsx("pre",{style:{background:"#f5f5f5",padding:16,borderRadius:4},children:JSON.stringify(U.conditions,null,2)})]})},{key:"3",label:"动作配置",children:a.jsxs("div",{children:[a.jsx(T,{level:4,children:"执行动作"}),U.actions.map((e,t)=>a.jsxs(i,{size:"small",style:{marginBottom:8},children:[a.jsxs(d,{children:[se(e.type),a.jsxs($,{strong:!0,children:["动作 ",t+1]})]}),a.jsx("pre",{style:{background:"#f5f5f5",padding:8,marginTop:8,borderRadius:4},children:JSON.stringify(e.config,null,2)})]},t))]})}]})}),a.jsx(j,{title:X?"编辑规则":"创建规则",open:M,onOk:async()=>{try{const e=await Z.validateFields(),a=JSON.parse(e.conditions),t=JSON.parse(e.actions),s=e.tags?.reduce((e,a)=>(a.key&&a.value&&(e[a.key]=a.value),e),{}),r={name:e.name,description:e.description,enabled:e.enabled,priority:e.priority,conditions:a,actions:t,tags:s};X&&U?(await z.updateRule(U.id,{...r,version:U.version}),g.success("规则更新成功")):(await z.createRule(r),g.success("规则创建成功")),W(!1),await ee()}catch(e){e instanceof SyntaxError?g.error("JSON 格式错误，请检查条件和动作配置"):g.error("保存规则失败："+(e.message||"未知错误"))}},onCancel:()=>W(!1),width:900,okText:"保存",cancelText:"取消",children:a.jsxs(s,{form:Z,layout:"vertical",children:[a.jsxs(l,{gutter:16,children:[a.jsx(n,{span:12,children:a.jsx(s.Item,{label:"规则名称",name:"name",rules:[{required:!0,message:"请输入规则名称"}],children:a.jsx(c,{placeholder:"输入规则名称"})})}),a.jsx(n,{span:12,children:a.jsx(s.Item,{label:"优先级",name:"priority",rules:[{required:!0,message:"请输入优先级"}],children:a.jsx(c,{type:"number",placeholder:"数值越大优先级越高"})})})]}),a.jsx(s.Item,{label:"描述",name:"description",rules:[{required:!0,message:"请输入规则描述"}],children:a.jsx(P,{rows:2,placeholder:"输入规则描述"})}),a.jsx(s.Item,{label:"启用状态",name:"enabled",valuePropName:"checked",children:a.jsx(m,{checkedChildren:"启用",unCheckedChildren:"禁用"})}),a.jsx(s.Item,{label:"触发条件 (JSON 格式)",name:"conditions",rules:[{required:!0,message:"请输入触发条件"},{validator:(e,a)=>{try{return JSON.parse(a),Promise.resolve()}catch{return Promise.reject(new Error("JSON 格式错误"))}}}],children:a.jsx(P,{rows:8,placeholder:'{"type": "simple", "field": "key", "operator": "eq", "value": "temperature"}',style:{fontFamily:"monospace"}})}),a.jsx(s.Item,{label:"执行动作 (JSON 格式)",name:"actions",rules:[{required:!0,message:"请输入执行动作"},{validator:(e,a)=>{try{return JSON.parse(a),Promise.resolve()}catch{return Promise.reject(new Error("JSON 格式错误"))}}}],children:a.jsx(P,{rows:8,placeholder:'[{"type": "alert", "config": {"level": "warning", "message": "告警信息"}}]',style:{fontFamily:"monospace"}})})]})})]})};export{_ as default};
//# sourceMappingURL=RulesPage-Dh3wZUoq.js.map
