import{u as E,a as j,j as e,b as A}from"./index-BEjgWUn2.js";import{F as a,a as n,k as R,T as C,l as r,D as I,I as w,m as z,n as F,B as k,o as $,p as q,q as G}from"./antd-BFy_CllK.js";import"./vendor-DavUf6mE.js";const{Title:D,Text:L}=C,M=()=>{const[T]=a.useForm(),[g,c]=n.useState(!1),[p,i]=n.useState(null),[h,f]=n.useState(null),[u,l]=n.useState("checking"),m=E(),{isAuthenticated:x,isInitialized:y,logout:S}=j(),d=async()=>{l("checking");try{const o=await fetch("/api/v1/plugins?page=1&page_size=1",{method:"GET",headers:{"Content-Type":"application/json"}});l("online"),console.log("✅ 后端服务在线，状态码:",o.status)}catch(o){l("offline"),console.log("❌ 后端服务离线:",o)}};n.useEffect(()=>{d();const o=setInterval(d,3e4);return()=>clearInterval(o)},[]),n.useEffect(()=>{y&&x&&(console.log("✅ 用户已认证，跳转到首页"),m("/",{replace:!0}))},[x,y,m]);const B=async o=>{if(console.log("🚀 开始登录流程，用户名:",o.username),c(!0),i(null),f(null),u==="offline"){i("后端服务不可用，请确认服务已启动。"),c(!1);return}try{console.log("📤 发送登录请求..."),S(),await new Promise(b=>setTimeout(b,100));const t=await A.login(o);console.log("✅ 登录成功:",t);const s=j.getState();if(console.log("📋 当前认证状态:",{hasAccessToken:!!s.accessToken,hasRefreshToken:!!s.refreshToken,hasUser:!!s.user,isAuthenticated:s.isAuthenticated,isInitialized:s.isInitialized}),console.log("💾 检查存储状态..."),s.isAuthenticated&&s.accessToken)f("登录成功！正在跳转到首页..."),setTimeout(()=>{console.log("🔄 跳转到首页"),m("/",{replace:!0})},1500);else throw new Error("登录响应正常，但认证状态未正确设置")}catch(t){console.error("❌ 登录失败:",t);let s="登录失败，请重试。";t.name==="NetworkError"?(s="网络连接失败，请检查后端服务是否运行。",l("offline")):t.name==="AuthExpiredError"?s="认证已过期，请重新登录。":t.response?.status===401?s="用户名或密码错误，请检查后重试。":t.response?.status===400?s=t.response.data?.message||"请求参数错误，请检查输入。":t.response?.status===500?s="服务器内部错误，请稍后重试。":t.message&&(s=t.message),i(s)}finally{c(!1)}},v=()=>{switch(u){case"checking":return e.jsx(r,{message:"检查后端服务状态中...",type:"info",showIcon:!0,icon:e.jsx(G,{spin:!0}),style:{marginBottom:16}});case"online":return e.jsx(r,{message:"后端服务正常",type:"success",showIcon:!0,icon:e.jsx(q,{}),style:{marginBottom:16}});case"offline":return e.jsx(r,{message:"后端服务不可用",description:"请确认IoT Gateway服务已启动，并运行在端口8081上。",type:"error",showIcon:!0,icon:e.jsx($,{}),style:{marginBottom:16},action:e.jsx(k,{size:"small",onClick:d,children:"重新检查"})})}};return e.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",padding:"20px"},children:e.jsxs(R,{style:{width:450,boxShadow:"0 10px 30px rgba(0,0,0,0.1)",borderRadius:"12px"},children:[e.jsxs("div",{style:{textAlign:"center",marginBottom:24},children:[e.jsx(D,{level:2,style:{color:"#1890ff",marginBottom:8},children:"IoT Gateway"}),e.jsx(L,{type:"secondary",children:"物联网网关管理系统"})]}),v(),p&&e.jsx(r,{message:p,type:"error",showIcon:!0,closable:!0,onClose:()=>i(null),style:{marginBottom:16}}),h&&e.jsx(r,{message:h,type:"success",showIcon:!0,style:{marginBottom:16}}),e.jsx(I,{}),e.jsxs(a,{form:T,name:"login",initialValues:{username:"admin",password:"admin123"},onFinish:B,size:"large",children:[e.jsx(a.Item,{name:"username",rules:[{required:!0,message:"请输入用户名"},{min:3,message:"用户名至少3个字符"}],children:e.jsx(w,{prefix:e.jsx(z,{}),placeholder:"用户名",autoComplete:"username"})}),e.jsx(a.Item,{name:"password",rules:[{required:!0,message:"请输入密码"},{min:6,message:"密码至少6个字符"}],children:e.jsx(w.Password,{prefix:e.jsx(F,{}),placeholder:"密码",autoComplete:"current-password"})}),e.jsx(a.Item,{children:e.jsx(k,{type:"primary",htmlType:"submit",loading:g,disabled:u==="offline",style:{width:"100%",height:"45px"},children:g?"登录中...":"登录"})})]}),e.jsx(I,{}),!1]})})};export{M as default};
